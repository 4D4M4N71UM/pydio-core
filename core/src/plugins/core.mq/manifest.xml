<?xml version="1.0" encoding="UTF-8"?>
<ajxp_plugin label="CONF_MESSAGE[Message Queuing]" description="CONF_MESSAGE[MQ Abstraction for dynamic dispatching]" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xsi:noNamespaceSchemaLocation="file:../core.ajaxplorer/ajxp_registry.xsd">
    <client_settings>
        <resources>
            <i18n namespace="core.mq" path="plugins/core.mq/i18n"/>
            <js className="PydioInstantMessenger" file="plugins/core.mq/class.PydioInstantMessenger.js"/>
        </resources>
    </client_settings>
    <server_settings>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="legend" name="PYDIO_BOOSTER_DESCRIPTION" label="CONF_MESSAGE[Legend]" description="CONF_MESSAGE[Pydio Booster is a dedicated binary built to power-up your application. It must be downloaded and installed manually.]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="button" name="PYDIO_BOOSTER_SWITCH_ON" choices="run_plugin_action:core.mq:switchPydioBoosterOn" label="CONF_MESSAGE[Start Process]" description="CONF_MESSAGE[Switch Booster ON]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="button" name="PYDIO_BOOSTER_SWITCH_OFF" choices="run_plugin_action:core.mq:switchPydioBoosterOff" label="CONF_MESSAGE[Stop Process]" description="CONF_MESSAGE[Switch Booster OFF]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="monitor" name="PYDIO_BOOSTER_STATUS" choices="run_plugin_action:core.mq:getPydioBoosterStatus" label="CONF_MESSAGE[Process Status]" description="CONF_MESSAGE[Process is running or not]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" name="CLI_PYDIO" type="string" label="CONF_MESSAGE[Command-line Pydio]" description="CONF_MESSAGE[On specific hosts, you may have to use a specific path to access the pydio command line]" mandatory="false" default="pydio"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" name="WS_ACTIVE" type="boolean" description="CONF_MESSAGE[WebSocket Server provides a server-to-client messaging feature, avoiding regular polling from browsers and sync applications, thus reducing the server load.]" label="CONF_MESSAGE[WebSocket Server]" default="true" expose="true"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" name="UPLOAD_ACTIVE" description="CONF_MESSAGE[Pydio Upload Server is a unique feature used to delegate file uploads to our dedicated binary, that will send the files directly to the storage.]" label="CONF_MESSAGE[Upload Server]" type="boolean" expose="true"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="legend" name="PYDIO_BOOSTER_DOWNLOAD_LEGEND" label="CONF_MESSAGE[Legend]" description="CONF_MESSAGE[Configuration files are generated each time your start the process, using the options saved in this plugin. If you handle the process manually, use the button below to download updated version of the files, and start process using '-conf /path/to/pydioconf' parameter.]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Pydio Booster]" type="button" name="PYDIO_BOOSTER_DOWNLOAD_CONF" choices="run_client_action:download_booster_conf" label="CONF_MESSAGE[Regenerate Config files and Download]" description="CONF_MESSAGE[Regenerate Config files and Download]" mandatory="false"/>

        <global_param group="CONF_MESSAGE[Network Main Configurations]" name="BOOSTER_MAIN_HOST" type="string" label="CONF_MESSAGE[Host]" description="CONF_MESSAGE[Host]" expose="true" default="127.0.0.1"/>
        <global_param group="CONF_MESSAGE[Network Main Configurations]" name="BOOSTER_MAIN_PORT" type="string" label="CONF_MESSAGE[Port]" description="CONF_MESSAGE[Port]" expose="true" default="8090"/>
        <global_param group="CONF_MESSAGE[Network Main Configurations]" name="BOOSTER_MAIN_SECURE" type="boolean" label="CONF_MESSAGE[SSL]" description="CONF_MESSAGE[Use secure connection]" expose="true" default="true"/>
        <global_param group="CONF_MESSAGE[Network Main Configurations]" name="NSQ_PORT" type="string" label="CONF_MESSAGE[NSQ Port]" description="CONF_MESSAGE[NSQ Port]" default="4150"/>
        <global_param group="CONF_MESSAGE[Network Main Configurations]" name="BOOSTER_INTERNAL_CONNECTION" type="group_switch:booster_internal_connection" label="CONF_MESSAGE[Internal Connection]" description="CONF_MESSAGE[If different from default host/port]" default="same" mandatory="true"/>
        <global_param group_switch_name="booster_internal_connection" group_switch_label="Same as external" group_switch_value="same" name="booster_internal_connection" type="hidden" label="same" description="custom" default="same"/>
        <global_param group_switch_name="booster_internal_connection" group_switch_label="Custom" group_switch_value="custom" name="booster_internal_connection" type="hidden" label="custom" description="custom" default="custom"/>
        <global_param group_switch_name="booster_internal_connection" group_switch_label="Custom" group_switch_value="custom" name="BOOSTER_INTERNAL_HOST" type="string" label="CONF_MESSAGE[Internal Host (if LAN IP is different from outside-world IP).]" description="CONF_MESSAGE[Internal Host]" default="127.0.0.1"/>
        <global_param group_switch_name="booster_internal_connection" group_switch_label="Custom" group_switch_value="custom" name="BOOSTER_INTERNAL_PORT" type="string" label="CONF_MESSAGE[Internal Port (if LAN Port is different from outside-world Port).]" description="CONF_MESSAGE[Internal Host]" default="8090"/>

        <global_param group="CONF_MESSAGE[Advanced Configurations]" name="BOOSTER_ADV_WS_LEGEND" type="legend" label="" description="Customize URL's depending on the features."/>

        <global_param group="CONF_MESSAGE[Advanced Configurations]" name="BOOSTER_WS_ADVANCED" type="group_switch:booster_ws_advanced" label="CONF_MESSAGE[Websocket Network Configuration]" description="CONF_MESSAGE[Use custom URL's for websocket feature]" expose="true" default="same" mandatory="true"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Use main configurations" group_switch_value="same" name="booster_ws_advanced" type="hidden" label="same" description="same" default="same"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" name="booster_ws_advanced" type="hidden" label="custom" description="custom" default="custom"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[WebSocket host]" label="CONF_MESSAGE[WS Hostname]" name="WS_HOST" type="string" expose="true" default="localhost"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[WebSocket port]" label="CONF_MESSAGE[WS Port]" name="WS_PORT" type="string" expose="true" default="8090"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[WebSocket host]" label="CONF_MESSAGE[WS Hostname]" name="WS_HOST_INTERNAL" type="string" expose="false" default="localhost"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[WebSocket port]" label="CONF_MESSAGE[WS Port]" name="WS_PORT_INTERNAL" type="string" expose="false" default="8090"/>
        <global_param group_switch_name="booster_ws_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[WebSocket secure]" label="CONF_MESSAGE[WS Client SSL]" name="WS_SECURE" type="boolean" expose="true" default="false"/>
        <global_param group="CONF_MESSAGE[Advanced Configurations]" description="CONF_MESSAGE[WebSocket path]" label="CONF_MESSAGE[WS Path]" name="WS_PATH" type="string" expose="true" default="ws"/>

        <global_param group="CONF_MESSAGE[Advanced Configurations]" name="BOOSTER_UPLOAD_ADVANCED" type="group_switch:booster_upload_advanced" label="CONF_MESSAGE[Uploader Network Configuration]" description="CONF_MESSAGE[Use custom URL's for uploader feature]" expose="true" default="same" mandatory="true"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Use main configurations" group_switch_value="same" name="booster_upload_advanced" type="hidden" label="same" description="same" default="same"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" name="booster_upload_advanced" type="hidden" label="custom" description="custom" default="custom"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[Upload Server host]" label="CONF_MESSAGE[Upload Server host]" name="UPLOAD_HOST" type="string" expose="true" default="localhost"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[Upload Server port]" label="CONF_MESSAGE[Upload Server port]" name="UPLOAD_PORT" type="string" expose="true" default="8090"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[Upload Server host]" label="CONF_MESSAGE[Upload Server host]" name="UPLOAD_HOST_INTERNAL" type="string" expose="false" default="localhost"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[Upload Server port]" label="CONF_MESSAGE[Upload Server port]" name="UPLOAD_PORT_INTERNAL" type="string" expose="false" default="8090"/>
        <global_param group_switch_name="booster_upload_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[Upload Server secure]" label="CONF_MESSAGE[Upload Server secure]" name="UPLOAD_SECURE" type="boolean" expose="true" default="false"/>
        <global_param group="CONF_MESSAGE[Advanced Configurations]" description="CONF_MESSAGE[Upload Server path]" label="CONF_MESSAGE[Upload Server path]" name="UPLOAD_PATH" type="string" expose="true" default="io"/>

        <global_param group="CONF_MESSAGE[Advanced Configurations]" name="BOOSTER_NSQ_ADVANCED" type="group_switch:booster_nsq_advanced" label="CONF_MESSAGE[Messaging Service Network Configuration]" description="CONF_MESSAGE[Use custom URL for nsq service]" default="same" mandatory="true"/>
        <global_param group_switch_name="booster_nsq_advanced" group_switch_label="Use main configurations" group_switch_value="same" name="booster_nsq_advanced" type="hidden" label="same" description="same" default="same"/>
        <global_param group_switch_name="booster_nsq_advanced" group_switch_label="Customize" group_switch_value="custom" name="booster_nsq_advanced" type="hidden" label="custom" description="custom" default="custom"/>
        <global_param group_switch_name="booster_nsq_advanced" group_switch_label="Customize" group_switch_value="custom" description="CONF_MESSAGE[NSQ Host]" label="CONF_MESSAGE[NSQ Host]" name="NSQ_HOST" type="string" default="localhost" />

        <global_param group="CONF_MESSAGE[Server Internals]" type="plugin_instance:mq" name="UNIQUE_MS_INSTANCE" label="CONF_MESSAGE[MQ Instance]" description="CONF_MESSAGE[Choose the plugin, sql should be the default value]" mandatory="false" default="mq.sql"/>
        <global_param group="CONF_MESSAGE[Server Internals]" description="CONF_MESSAGE[Post the notification in a temporary queue. You must set up the scheduler accordingly to make sure the queue is then consumed on a regularly basis.]" label="CONF_MESSAGE[Queue notifications]" name="USE_QUEUE" type="boolean" default="false"/>
        <global_param group="CONF_MESSAGE[Server Internals]" type="boolean" name="MQ_USE_WORKERS" label="CONF_MESSAGE[Use Workers (experimental)]" description="CONF_MESSAGE[Send commands in background to workers waiting to execute them]" mandatory="false" default="false"/>
        <global_param group="CONF_MESSAGE[Server Internals]" type="monitor" name="MQ_WORKER_STATUS" choices="run_plugin_action:core.mq:getWorkerStatus" label="CONF_MESSAGE[Worker Status]" description="CONF_MESSAGE[Try to detect if the worker is responding]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Server Internals]" type="button" name="MQ_WORKER_SWITCH_ON" choices="run_plugin_action:core.mq:switchWorkerOn" label="CONF_MESSAGE[Start Worker]" description="CONF_MESSAGE[Switch a worker ON]" mandatory="false"/>
        <global_param group="CONF_MESSAGE[Server Internals]" type="button" name="MQ_WORKER_SWITCH_OFF" choices="run_plugin_action:core.mq:switchWorkerOff" label="CONF_MESSAGE[Stop Worker]" description="CONF_MESSAGE[Switch a worker OFF]" mandatory="false"/>

    </server_settings>
    <class_definition classname="Pydio\Mq\Core\MqManager" filename="plugins/core.mq/vendor/autoload.php"/>
    <registry_contributions>
        <actions>
            <action name="consume_notification_queue">
                <rightsContext adminOnly="false" noUser="true" read="false" userLogged="true" write="false"/>
                <processing>
                    <serverCallback methodName="consumeQueue"/>
                </processing>
            </action>
            <action name="client_register_channel">
                <rightsContext adminOnly="false" noUser="true" read="false" userLogged="true" write="false"/>
                <processing>
                    <clientListener name="init"><![CDATA[
                        if(!pydio.mqObserver && !pydio.mqObserverLoading && !window.ajxpMinisite){
                            pydio.mqObserverLoading = true;
                            ResourcesManager.prototype.loadJSResource('plugins/core.mq/class.PydioInstantMessenger.js', 'PydioInstantMessenger', function(){
                                pydio.mqObserver = new PydioInstantMessenger();
                            }, true);
                        }
                    ]]></clientListener>
                    <serverCallback methodName="clientChannelMethod" restParams="/channel/client_id" developerComment="Subscribe to given queue of events.">
                        <input_param name="channel" type="string" description="Channel to connect to"/>
                        <input_param name="client_id" type="string"
                                     description="A unique identifier for the client connecting"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="client_unregister_channel">
                <rightsContext adminOnly="false" noUser="true" read="false" userLogged="true" write="false"/>
                <processing>
                    <serverCallback methodName="clientChannelMethod" restParams="/channel/client_id" developerComment="Subscribe to given queue of events.">
                        <input_param name="channel" type="string" description="Channel to connect to"/>
                        <input_param name="client_id" type="string"
                                     description="A unique identifier for the client connecting"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="client_consume_channel">
                <rightsContext adminOnly="false" noUser="true" read="false" userLogged="true" write="false"/>
                <processing>
                    <serverCallback methodName="clientChannelMethod" restParams="/channel/client_id" developerComment="Subscribe to given queue of events.">
                        <input_param name="channel" type="string" description="Channel to connect to"/>
                        <input_param name="client_id" type="string"
                                     description="A unique identifier for the client connecting"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="ws_authenticate" skipSecureToken="true">
                <processing>
                    <serverCallback restParams="/" methodName="wsAuthenticate"/>
                </processing>
            </action>
            <action name="tail_booster_log">
                <rightsContext adminOnly="true" noUser="false" read="true" userLogged="true" write="false"/>
                <processing>
                    <serverCallback methodName="tailBoosterLogs" restParams="/offset">
                        <input_param name="offset" type="integer"
                                     description="Offset where to start tail, other last 20 lines"/>
                    </serverCallback>
                </processing>
            </action>
            <action name="download_booster_conf">
                <gui src="" text="" title="">
                    <context dir="true" recycle="false" selection="false"/>
                </gui>
                <rightsContext adminOnly="true" noUser="false" read="true" userLogged="true" write="false"/>
                <processing>
                    <clientCallback><![CDATA[
                        var url = pydio.Parameters.get("ajxpServerAccess") + '&get_action=download_booster_conf';
                        document.location.href = url;
                    ]]></clientCallback>
                    <serverCallback methodName="pydioBoosterDownloadConf" restParams="/"/>
                </processing>
            </action>
        </actions>
        <hooks>
            <serverCallback methodName="publishNodeChange" hookName="node.change" defer="true"/>
            <serverCallback methodName="sendInstantMessage" hookName="msg.instant" />
            <serverCallback methodName="sendTaskMessage" hookName="msg.task" defer="true" dontBreakOnException="true"/>
            <serverCallback methodName="sendToQueue" hookName="msg.queue_notification" />
            <serverCallback methodName="appendRefreshInstruction" hookName="response.send" dontBreakOnException="true"/>
        </hooks>
    </registry_contributions>
    <dependencies>
        <activePlugin pluginName="core.notifications"/>
    </dependencies>
</ajxp_plugin>
