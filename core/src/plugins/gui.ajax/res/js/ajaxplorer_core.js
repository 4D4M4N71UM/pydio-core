"use strict";window.ProtoCompat={},ProtoCompat.map2hash=function(e){if(e.forEach){var t=$H();return e.forEach(function(e,i){t.set(i,e)}),t}return e},ProtoCompat.map2values=function(e){if(e.forEach){var t=$A();return e.forEach(function(e){t.push(e)}),t}return e},ProtoCompat.hash2map=function(e){try{var t=new Map;return e.each(function(e){t.set(e.key,e.value)}),t}catch(i){return e}};var _classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Observable=function(){function e(){_classCallCheck(this,e)}return e.prototype._objectEventSetup=function(e){this._observers=this._observers||{},this._observers[e]=this._observers[e]||[]},e.prototype.observe=function(e,t){if("string"==typeof e&&"undefined"!=typeof t)this._objectEventSetup(e),-1==this._observers[e].indexOf(t)&&this._observers[e].push(t);else for(var i in e)e.hasOwnProperty(i)&&this.observe(i,e[i])},e.prototype.stopObserving=function(e,t){this._objectEventSetup(e),e&&t?this._observers[e]=this._observers[e].filter(function(e){return e!=t}):e?this._observers[e]=[]:this._observers={}},e.prototype.observeOnce=function(e,t){var i=function(){t.apply(this,arguments),this.stopObserving(e,i)}.bind(this);this._objectEventSetup(e),this._observers[e].push(i)},e.prototype.notify=function(e){this._objectEventSetup(e);for(var t=[],i=Array.from(arguments).slice(1),o=0;o<this._observers[e].length;++o)t.push(this._observers[e][o].apply(this._observers[e][o],i)||null);return t},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Logger=function(){function e(){_classCallCheck(this,e)}return e.log=function(e){window.console&&console.log(e)},e.error=function(e){window.console&&console.error(e)},e.debug=function(e){window.console&&console.debug(e)},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},LangUtils=function(){function e(){_classCallCheck(this,e)}return e.objectMerge=function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);return e},e.parseUrl=function(e){var t=$A(),i=/(((ajxp\.)(\w+)):\/)?\/?([^:\/\s]+)((\/\w+)*\/)(.*)(#[\w\-]+)?/g,o=e.match(i);if(o&&o.length)for(var s=/^((ajxp\.(\w+)):\/)?\/?([^:\/\s]+)((\/\w+)*\/)(.*)(#[\w\-]+)?$/,r=0;r<o.length;r++)o[r].match(s)&&t.push({url:RegExp["$&"],protocol:RegExp.$2,host:RegExp.$4,path:RegExp.$5,file:RegExp.$7,hash:RegExp.$8});return t},e.computeStringSlug=function(t){for(var i=0,o=e.slugTable.length;o>i;i++)t=t.replace(e.slugTable[i].re,e.slugTable[i].ch);return t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"").replace(/\-{2,}/g,"-")},e}();LangUtils.slugTable=[{re:/[\xC0-\xC6]/g,ch:"A"},{re:/[\xE0-\xE6]/g,ch:"a"},{re:/[\xC8-\xCB]/g,ch:"E"},{re:/[\xE8-\xEB]/g,ch:"e"},{re:/[\xCC-\xCF]/g,ch:"I"},{re:/[\xEC-\xEF]/g,ch:"i"},{re:/[\xD2-\xD6]/g,ch:"O"},{re:/[\xF2-\xF6]/g,ch:"o"},{re:/[\xD9-\xDC]/g,ch:"U"},{re:/[\xF9-\xFC]/g,ch:"u"},{re:/[\xC7-\xE7]/g,ch:"c"},{re:/[\xD1]/g,ch:"N"},{re:/[\xF1]/g,ch:"n"}];var _classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},XMLUtils=function(){function e(){_classCallCheck(this,e)}return e.loadXPathReplacer=function(){document.createExpression||PydioApi.loadLibrary("plugins/gui.ajax/res/js/vendor/xpath-polyfill/javascript-xpath-cmp.js",null,!1)},e.XPathSelectSingleNode=function(t,i){try{var o=t.selectSingleNode(i);if(o)return o}catch(s){}if(!e.__xpe)try{e.__xpe=new XPathEvaluator}catch(s){}if(!e.__xpe){document.createExpression||e.loadXPathReplacer(),i=document.createExpression(i,null);var r=i.evaluate(t,7,null);return r.snapshotLength?r.snapshotItem(0):null}var n=e.__xpe;try{return n.evaluate(i,t,n.createNSResolver(t),XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue}catch(a){throw new Error("selectSingleNode: query: "+i+", element: "+t+", error: "+a)}},e.XPathSelectNodes=function(t,i){try{try{t.ownerDocument?t.ownerDocument.setProperty("SelectionLanguage","XPath"):t.setProperty("SelectionLanguage","XPath")}catch(o){}var s=Array.from(t.selectNodes(i));if(s)return s}catch(o){}var r=e.__xpe;if(!r)try{e.__xpe=r=new XPathEvaluator}catch(o){}var n,a,d=[];if(!e.__xpe){for(document.createExpression||e.loadXPathReplacer(),i=document.createExpression(i,null),n=i.evaluate(t,7,null),d=[],a=0;a<n.snapshotLength;a++)Element.extend?d[a]=Element.extend(n.snapshotItem(a)):d[a]=n.snapshotItem(a);return d}try{n=r.evaluate(i,t,r.createNSResolver(t),XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)}catch(c){throw new Error("selectNodes: query: "+i+", element: "+t+", error: "+c)}for(a=0;a<n.snapshotLength;a++)d[a]=n.snapshotItem(a);return d},e.XPathGetSingleNodeText=function(t,i){var o=XPathSelectSingleNode(t,i);return e.getDomNodeText(o)},e.getDomNodeText=function(t){var i=void 0===arguments[1]?!1:arguments[1];if(!t||!t.nodeType)return null;switch(t.nodeType){case 1:var o,s=[],r=t.childNodes,n=r.length;for(o=0;n>o;o++)s[o]=e.getDomNodeText(r[o],i);return s.join("");case 2:return t.value;case 3:return t.nodeValue;case 4:if(i)return t.nodeValue}return null},e.parseXml=function(e){if("undefined"!=typeof window.ActiveXObject&&new window.ActiveXObject("MSXML2.DOMDocument.6.0")){var t=new window.ActiveXObject("MSXML2.DOMDocument.6.0");return t.validateOnParse=!1,t.async=!1,t.loadXML(e),t.setProperty("SelectionLanguage","XPath"),t}return"undefined"!=typeof window.DOMParser?(new window.DOMParser).parseFromString(e,"text/xml"):void 0},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},PathUtils=function(){function e(){_classCallCheck(this,e)}return e.getBasename=function(e){if(null==e)return null;var t="/";return-1!=e.indexOf("\\")&&(t="\\"),e.substr(e.lastIndexOf(t)+1,e.length)},e.getDirname=function(e){return e.substr(0,e.lastIndexOf("/"))},e.getAjxpMimeType=function(t){return t?t instanceof Map?t.get("ajxp_mime")||e.getFileExtension(t.get("filename")):t.getMetadata?t.getMetadata().get("ajxp_mime")||e.getFileExtension(t.getPath()):t.getAttribute("ajxp_mime")||e.getFileExtension(t.getAttribute("filename")):""},e.getFileExtension=function(t){if(!t||""==t)return"";var i=e.getBasename(t).split(".");return i.length>1?i[i.length-1].toLowerCase():""},e.roundFileSize=function(e){var t=void 0===arguments[1]?"o":arguments[1];return e=e>=1073741824?Math.round(e/1073741824*100)/100+" G"+t:e>=1048576?Math.round(e/1048576*100)/100+" M"+t:e>=1024?Math.round(e/1024*100)/100+" K"+t:e+" "+t},e.formatModifDate=function(e,t){if(!t&&window&&window.pydio&&pydio.MessageHash&&(t=pydio.MessageHash.date_format),!t)return"no format";t=t.replace("d",e.getDate()<10?"0"+e.getDate():e.getDate()),t=t.replace("D",e.getDay()),t=t.replace("Y",e.getFullYear()),t=t.replace("y",e.getYear());var i=e.getMonth()+1;return t=t.replace("m",10>i?"0"+i:i),t=t.replace("H",(e.getHours()<10?"0":"")+e.getHours()),t=t.replace("h",e.getHours()%12||12),t=t.replace("p",e.getHours()<12?"am":"pm"),t=t.replace("P",e.getHours()<12?"AM":"PM"),t=t.replace("i",(e.getMinutes()<10?"0":"")+e.getMinutes()),t=t.replace("s",(e.getSeconds()<10?"0":"")+e.getSeconds())},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},HasherUtils=function(){function e(){_classCallCheck(this,e)}return e.hex_md5=function(t){return e.binl2hex(e.core_md5(e.str2binl(t),t.length*e.chrsz))},e.b64_md5=function(t){return e.binl2b64(e.core_md5(e.str2binl(t),t.length*e.chrsz))},e.str_md5=function(t){return e.binl2str(e.core_md5(e.str2binl(t),t.length*e.chrsz))},e.hex_hmac_md5=function(t,i){return e.binl2hex(e.core_hmac_md5(t,i))},e.b64_hmac_md5=function(t,i){return e.binl2b64(e.core_hmac_md5(t,i))},e.str_hmac_md5=function(t,i){return e.binl2str(e.core_hmac_md5(t,i))},e.base64_encode=function(t){var i,o,s,r,n,a,d,c,l,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",u=0,p=0,g=[];if(!t)return t;t=e.utf8_encode(t+"");do i=t.charCodeAt(u++),o=t.charCodeAt(u++),s=t.charCodeAt(u++),c=i<<16|o<<8|s,r=c>>18&63,n=c>>12&63,a=c>>6&63,d=63&c,g[p++]=h.charAt(r)+h.charAt(n)+h.charAt(a)+h.charAt(d);while(u<t.length);switch(l=g.join(""),t.length%3){case 1:l=l.slice(0,-2)+"==";break;case 2:l=l.slice(0,-1)+"="}return l},e.utf8_encode=function(e){e=(e+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");var t,i,o,s="";t=i=0,o=e.length;for(var r=0;o>r;r++){var n=e.charCodeAt(r),a=null;128>n?i++:a=n>127&&2048>n?String.fromCharCode(n>>6|192)+String.fromCharCode(63&n|128):String.fromCharCode(n>>12|224)+String.fromCharCode(n>>6&63|128)+String.fromCharCode(63&n|128),null!=a&&(i>t&&(s+=e.substring(t,i)),s+=a,t=i=r+1)}return i>t&&(s+=e.substring(t,e.length)),s},e.md5_vm_test=function(){return"900150983cd24fb0d6963f7d28e17f72"==e.hex_md5("abc")},e.core_md5=function(t,i){t[i>>5]|=128<<i%32,t[(i+64>>>9<<4)+14]=i;for(var o=1732584193,s=-271733879,r=-1732584194,n=271733878,a=0;a<t.length;a+=16){var d=o,c=s,l=r,h=n;o=e.md5_ff(o,s,r,n,t[a+0],7,-680876936),n=e.md5_ff(n,o,s,r,t[a+1],12,-389564586),r=e.md5_ff(r,n,o,s,t[a+2],17,606105819),s=e.md5_ff(s,r,n,o,t[a+3],22,-1044525330),o=e.md5_ff(o,s,r,n,t[a+4],7,-176418897),n=e.md5_ff(n,o,s,r,t[a+5],12,1200080426),r=e.md5_ff(r,n,o,s,t[a+6],17,-1473231341),s=e.md5_ff(s,r,n,o,t[a+7],22,-45705983),o=e.md5_ff(o,s,r,n,t[a+8],7,1770035416),n=e.md5_ff(n,o,s,r,t[a+9],12,-1958414417),r=e.md5_ff(r,n,o,s,t[a+10],17,-42063),s=e.md5_ff(s,r,n,o,t[a+11],22,-1990404162),o=e.md5_ff(o,s,r,n,t[a+12],7,1804603682),n=e.md5_ff(n,o,s,r,t[a+13],12,-40341101),r=e.md5_ff(r,n,o,s,t[a+14],17,-1502002290),s=e.md5_ff(s,r,n,o,t[a+15],22,1236535329),o=e.md5_gg(o,s,r,n,t[a+1],5,-165796510),n=e.md5_gg(n,o,s,r,t[a+6],9,-1069501632),r=e.md5_gg(r,n,o,s,t[a+11],14,643717713),s=e.md5_gg(s,r,n,o,t[a+0],20,-373897302),o=e.md5_gg(o,s,r,n,t[a+5],5,-701558691),n=e.md5_gg(n,o,s,r,t[a+10],9,38016083),r=e.md5_gg(r,n,o,s,t[a+15],14,-660478335),s=e.md5_gg(s,r,n,o,t[a+4],20,-405537848),o=e.md5_gg(o,s,r,n,t[a+9],5,568446438),n=e.md5_gg(n,o,s,r,t[a+14],9,-1019803690),r=e.md5_gg(r,n,o,s,t[a+3],14,-187363961),s=e.md5_gg(s,r,n,o,t[a+8],20,1163531501),o=e.md5_gg(o,s,r,n,t[a+13],5,-1444681467),n=e.md5_gg(n,o,s,r,t[a+2],9,-51403784),r=e.md5_gg(r,n,o,s,t[a+7],14,1735328473),s=e.md5_gg(s,r,n,o,t[a+12],20,-1926607734),o=e.md5_hh(o,s,r,n,t[a+5],4,-378558),n=e.md5_hh(n,o,s,r,t[a+8],11,-2022574463),r=e.md5_hh(r,n,o,s,t[a+11],16,1839030562),s=e.md5_hh(s,r,n,o,t[a+14],23,-35309556),o=e.md5_hh(o,s,r,n,t[a+1],4,-1530992060),n=e.md5_hh(n,o,s,r,t[a+4],11,1272893353),r=e.md5_hh(r,n,o,s,t[a+7],16,-155497632),s=e.md5_hh(s,r,n,o,t[a+10],23,-1094730640),o=e.md5_hh(o,s,r,n,t[a+13],4,681279174),n=e.md5_hh(n,o,s,r,t[a+0],11,-358537222),r=e.md5_hh(r,n,o,s,t[a+3],16,-722521979),s=e.md5_hh(s,r,n,o,t[a+6],23,76029189),o=e.md5_hh(o,s,r,n,t[a+9],4,-640364487),n=e.md5_hh(n,o,s,r,t[a+12],11,-421815835),r=e.md5_hh(r,n,o,s,t[a+15],16,530742520),s=e.md5_hh(s,r,n,o,t[a+2],23,-995338651),o=e.md5_ii(o,s,r,n,t[a+0],6,-198630844),n=e.md5_ii(n,o,s,r,t[a+7],10,1126891415),r=e.md5_ii(r,n,o,s,t[a+14],15,-1416354905),s=e.md5_ii(s,r,n,o,t[a+5],21,-57434055),o=e.md5_ii(o,s,r,n,t[a+12],6,1700485571),n=e.md5_ii(n,o,s,r,t[a+3],10,-1894986606),r=e.md5_ii(r,n,o,s,t[a+10],15,-1051523),s=e.md5_ii(s,r,n,o,t[a+1],21,-2054922799),o=e.md5_ii(o,s,r,n,t[a+8],6,1873313359),n=e.md5_ii(n,o,s,r,t[a+15],10,-30611744),r=e.md5_ii(r,n,o,s,t[a+6],15,-1560198380),s=e.md5_ii(s,r,n,o,t[a+13],21,1309151649),o=e.md5_ii(o,s,r,n,t[a+4],6,-145523070),n=e.md5_ii(n,o,s,r,t[a+11],10,-1120210379),r=e.md5_ii(r,n,o,s,t[a+2],15,718787259),s=e.md5_ii(s,r,n,o,t[a+9],21,-343485551),o=e.safe_add(o,d),s=e.safe_add(s,c),r=e.safe_add(r,l),n=e.safe_add(n,h)}return[o,s,r,n]},e.md5_cmn=function(t,i,o,s,r,n){return e.safe_add(e.bit_rol(e.safe_add(e.safe_add(i,t),e.safe_add(s,n)),r),o)},e.md5_ff=function(t,i,o,s,r,n,a){return e.md5_cmn(i&o|~i&s,t,i,r,n,a)},e.md5_gg=function(t,i,o,s,r,n,a){return e.md5_cmn(i&s|o&~s,t,i,r,n,a)},e.md5_hh=function(t,i,o,s,r,n,a){return e.md5_cmn(i^o^s,t,i,r,n,a)},e.md5_ii=function(t,i,o,s,r,n,a){return e.md5_cmn(o^(i|~s),t,i,r,n,a)},e.core_hmac_md5=function(t,i){var o=e.str2binl(t);o.length>16&&(o=e.core_md5(o,t.length*e.chrsz));for(var s=new Array(16),r=new Array(16),n=0;16>n;n++)s[n]=909522486^o[n],r[n]=1549556828^o[n];var a=e.core_md5(s.concat(e.str2binl(i)),512+i.length*e.chrsz);return e.core_md5(r.concat(a),640)},e.safe_add=function(e,t){var i=(65535&e)+(65535&t),o=(e>>16)+(t>>16)+(i>>16);return o<<16|65535&i},e.bit_rol=function(e,t){return e<<t|e>>>32-t},e.str2binl=function(t){for(var i=[],o=(1<<e.chrsz)-1,s=0;s<t.length*e.chrsz;s+=e.chrsz)i[s>>5]|=(t.charCodeAt(s/e.chrsz)&o)<<s%32;return i},e.binl2str=function(t){for(var i="",o=(1<<e.chrsz)-1,s=0;s<32*t.length;s+=e.chrsz)i+=String.fromCharCode(t[s>>5]>>>s%32&o);return i},e.binl2hex=function(t){for(var i=e.hexcase?"0123456789ABCDEF":"0123456789abcdef",o="",s=0;s<4*t.length;s++)o+=i.charAt(t[s>>2]>>s%4*8+4&15)+i.charAt(t[s>>2]>>s%4*8&15);return o},e.binl2b64=function(t){for(var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o="",s=0;s<4*t.length;s+=3)for(var r=(t[s>>2]>>8*(s%4)&255)<<16|(t[s+1>>2]>>8*((s+1)%4)&255)<<8|t[s+2>>2]>>8*((s+2)%4)&255,n=0;4>n;n++)o+=8*s+6*n>32*t.length?e.b64pad:i.charAt(r>>6*(3-n)&63);return o},e}();HasherUtils.hexcase=0,HasherUtils.b64pad="",HasherUtils.chrsz=8;var _classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Router=function e(t){if(_classCallCheck(this,e),window.Backbone&&window.Backbone.Router){var i=Backbone.Router.extend({routes:{":workspace/*path":"switchToWorkspace"},switchToWorkspace:function(e,i){if(t.user){i=i?"/"+i:"/";var o=t.user.getRepositoriesList();e=e.replace("ws-","");var s;o.forEach(function(t){t.getSlug()==e&&(s=t)}),s&&(t.repositoryId!=s.getId()?(i&&(t._initLoadRep=i),t.triggerRepositoryChange(s.getId())):i&&window.setTimeout(function(){t.goTo(i)},1e3))}}});this.router=new i;var o=t.Parameters.get("APPLICATION_ROOT");Backbone.history.start(o&&"/"!=o?{pushState:!0,root:o}:{pushState:!0});var s=function(e,i){if(i===!1)this.router.navigate("/.");else{var o=e.get(i);if(o){var s=o.getSlug();o.getAccessType().startsWith("ajxp_")||(s="ws-"+s),t.getContextNode()&&(s+=t.getContextNode().getPath()),this.router.navigate(s)}}}.bind(this);t.user&&s(t.user.getRepositoriesList(),t.user.getActiveRepository()),t.observe("repository_list_refreshed",function(e){var t=e.list,i=e.active;s(t,i)}),t.getContextHolder().observe("context_changed",function(e){if(t.user){var i=t.user.getRepositoriesList(),o=i.get(t.user.getActiveRepository());if(o){var s=o.getSlug();o.getAccessType().startsWith("ajxp_")||(s="ws-"+s);var r=t.getContextNode().getPath();this.router.navigate(s+r)}}}.bind(this))}},_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},AjxpNode=function(e){function t(i){var o=void 0===arguments[1]?!1:arguments[1],s=void 0===arguments[2]?"":arguments[2],r=void 0===arguments[3]?"":arguments[3],n=void 0===arguments[4]?null:arguments[4];_classCallCheck(this,t),e.call(this),this._path=i,this._path&&this._path.length&&this._path.length>1&&"/"==this._path[this._path.length-1]&&(this._path=this._path.substring(0,this._path.length-1)),this._isLeaf=o,this._label=s,this._icon=r,this._isRoot=!1,this._metadata=new Map,this._children=new Map,this._isLoaded=!1,this.fake=!1,this._iNodeProvider=n}return _inherits(t,e),t.prototype.isLoaded=function(){return this._isLoaded},t.prototype.setLoaded=function(e){this._isLoaded=e},t.prototype.load=function(e){return this._isLoading?void 0:(e||(e=this._iNodeProvider?this._iNodeProvider:new RemoteNodeProvider),this._isLoading=!0,this.notify("loading"),this._isLoaded?(this._isLoading=!1,void this.notify("loaded")):void e.loadNode(this,function(e){this._isLoaded=!0,this._isLoading=!1,this.notify("loaded"),this.notify("first_load")}.bind(this)))},t.prototype.reload=function(e){this._children.forEach(function(e,t){e.notify("node_removed"),e._parentNode=null,this._children["delete"](t),this.notify("child_removed",e)},this),this._isLoaded=!1,this.load(e)},t.prototype.clear=function(){this._children.forEach(function(e,t){e.notify("node_removed"),e._parentNode=null,this._children["delete"](t),this.notify("child_removed",e)},this),this._isLoaded=!1,this.notify("force_clear")},t.prototype.setRoot=function(){this._isRoot=!0},t.prototype.setChildren=function(e){this._children=new Map,e.forEach(function(e){this._children.set(e.getPath(),e),e.setParent(this)}.bind(this))},t.prototype.getChildren=function(){return this._children},t.prototype.getFirstChildIfExists=function(){return this._children.size?this._children.values().next().value:null},t.prototype.addChild=function(e){e.setParent(this),this._iNodeProvider&&(e._iNodeProvider=this._iNodeProvider);var t=this.findChildByPath(e.getPath());!t||t instanceof String?(this._children.set(e.getPath(),e),this.notify("child_added",e.getPath())):t.replaceBy(e,"override")},t.prototype.removeChild=function(e){var t=e.getPath();e.notify("node_removed"),e._parentNode=null,this._children["delete"](e.getPath()),this.notify("child_removed",t)},t.prototype.replaceBy=function(e,t){if(this._isLeaf=e._isLeaf,e.getPath()&&this._path!=e.getPath()){var i=this._path;if(this.getParent()){var o=this.getParent()._children;o.set(e.getPath(),this),o["delete"](i)}this._path=e.getPath();var s=!0}e._label&&(this._label=e._label),e._icon&&(this._icon=e._icon),e._iNodeProvider&&(this._iNodeProvider=e._iNodeProvider),this._isLoaded=e._isLoaded,this.fake=e.fake;var r=e.getMetadata();return"override"==t&&(this._metadata=new Map),r.forEach(function(e,i){if("override"==t)this._metadata.set(i,e);else{if(this._metadata.has(i)&&""===e)return;this._metadata.set(i,e)}}.bind(this)),s&&!this._isLeaf&&this.getChildren().size?void window.setTimeout(function(){this.reload(this._iNodeProvider)}.bind(this),100):(e.getChildren().forEach(function(e){this.addChild(e)}.bind(this)),void this.notify("node_replaced",this))},t.prototype.findChildByPath=function(e){return this._children.get(e)},t.prototype.setMetadata=function(e){this._metadata=e},t.prototype.getMetadata=function(){return this._metadata},t.prototype.isLeaf=function(){return this._isLeaf},t.prototype.getPath=function(){return this._path},t.prototype.getLabel=function(){return this._label},t.prototype.getIcon=function(){return this._icon},t.prototype.isRecycle=function(){return"ajxp_recycle"==this.getAjxpMime()},t.prototype.hasAjxpMimeInBranch=function(e){if(this.getAjxpMime()==e.toLowerCase())return!0;for(var t,i=this;t=i._parentNode;){if(t.getAjxpMime()==e.toLowerCase())return!0;i=t}return!1},t.prototype.hasMetadataInBranch=function(e,t){if(this.getMetadata().has(e))return t?this.getMetadata().get(e)==t:!0;for(var i,o=this;i=o._parentNode;){if(i.getMetadata().has(e))return t?i.getMetadata().get(e)==t:!0;o=i}return!1},t.prototype.setParent=function(e){this._parentNode=e},t.prototype.getParent=function(){return this._parentNode},t.prototype.findInArbo=function(e,i){if(this.getPath()){for(var o,s=this.getPath().split("/"),r="",n=e,a=0;a<s.length;a++)if(""!=s[a]){r=r+"/"+s[a];var d=n.findChildByPath(r);if(!d||d instanceof String){if(void 0===i)return void 0;o=new t(r,!1,PathUtils.getBasename(r)),o.fake=!0,o.getMetadata().set("text",PathUtils.getBasename(r)),i.push(o),n.addChild(o)}else o=d;n=o}return o}},t.prototype.isRoot=function(){return this._isRoot},t.prototype.isParentOf=function(e){var t=e.getPath(),i=this.getPath();return t.substring(0,i.length)==i},t.prototype.isChildOf=function(e){var t=this.getPath(),i=e.getPath();return t.substring(0,i.length)==i},t.prototype.getAjxpMime=function(){return this._metadata&&this._metadata.has("ajxp_mime")?this._metadata.get("ajxp_mime").toLowerCase():this._metadata&&this.isLeaf()?PathUtils.getAjxpMimeType(this._metadata).toLowerCase():""},t}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},User=function(){function e(t,i){_classCallCheck(this,e),this.id=t,this.activeRepository=void 0,this.read=!1,this.write=!1,this.crossRepositoryCopy=!1,this.preferences=new Map,this.repositories=new Map,this.crossRepositories=new Map,this.repoIcons=new Map,this.repoSearchEngines=new Map,this.isAdmin=!1,this.lock=!1,this._parsedJSONCache=new Map,i&&this.loadFromXml(i)}return e.prototype.setActiveRepository=function(e,t,i){this.activeRepository=e,this.read="1"==t,this.write="1"==i,this.repositories.has(e)&&(this.crossRepositoryCopy=this.repositories.get(e).allowCrossRepositoryCopy),this.crossRepositories.has(e)&&this.crossRepositories["delete"](e)},e.prototype.getActiveRepository=function(){return this.activeRepository},e.prototype.canRead=function(){return this.read},e.prototype.canWrite=function(){return this.write},e.prototype.canCrossRepositoryCopy=function(){return this.crossRepositoryCopy},e.prototype.getPreference=function(e,t){if(t){var i=this._parsedJSONCache.get(e);if(void 0!==i)return i}var o=this.preferences.get(e);if(t&&o)try{if("object"==typeof o)return o;var s=JSON.parse(o);return this._parsedJSONCache.set(e,s),s}catch(r){window.console?Logger.log("Error parsing JSON in preferences ("+e+"). You should contact system admin and clear user preferences."):alert("Error parsing JSON in preferences. You should contact system admin and clear user preferences.")}return o},e.prototype.getRepositoriesList=function(){return this.repositories},e.prototype.setPreference=function(e,t){var i=void 0===arguments[2]?!1:arguments[2];if(i){this._parsedJSONCache["delete"](e);try{t=JSON.stringify(t)}catch(o){if(console){var s=function(e){function t(e){if(e&&"object"==typeof e){if(-1!==i.indexOf(e))return!0;i.push(e);for(var o in e)if(e.hasOwnProperty(o)&&t(e[o]))return console.log(e,"cycle at "+o),!0}return!1}var i=[];return t(e)};console.log("Caught toJSON error "+o.message,t,s(t))}return}}this.preferences.set(e,t)},e.prototype.setRepositoriesList=function(e){this.repositories=e,this.crossRepositories=new Map,this.repositories.forEach(function(e,t){e.allowCrossRepositoryCopy&&this.crossRepositories.set(t,e)}.bind(this))},e.prototype.hasCrossRepositories=function(){return this.crossRepositories.size},e.prototype.getCrossRepositories=function(){return this.crossRepositories},e.prototype.getRepositoryIcon=function(e){return this.repoIcon.get(e)},e.prototype.getRepoSearchEngine=function(e){return this.repoSearchEngines.get(e)},e.prototype.savePreference=function(e){if(this.preferences.has(e)){var t=this.preferences.get(e);window.setTimeout(function(){PydioApi.getClient().userSavePreference(e,t)},250)}},e.prototype.savePreferences=function(e,t,i,o){e&&t?PydioApi.getClient().userSavePassword(e,t,i,o):PydioApi.getClient().userSavePreferences(this.preferences,o)},e.prototype.loadFromXml=function(e){var t,i,o=new Map;for(t=0;t<e.length;t++)if("active_repo"==e[t].nodeName)var s=e[t];else if("repositories"==e[t].nodeName){for(i=0;i<e[t].childNodes.length;i++){var r=e[t].childNodes[i];if("repo"==r.nodeName){var n=new Repository(r.getAttribute("id"),r);o.set(r.getAttribute("id"),n)}}this.setRepositoriesList(o)}else if("preferences"==e[t].nodeName)for(i=0;i<e[t].childNodes.length;i++){var a=e[t].childNodes[i];if("pref"==a.nodeName){var d=a.getAttribute("value");!d&&a.firstChild&&(d=a.firstChild.nodeValue),this.setPreference(a.getAttribute("name"),d)}}else if("special_rights"==e[t].nodeName){var c=e[t].getAttribute("is_admin");c&&"1"==c&&(this.isAdmin=!0),e[t].getAttribute("lock")&&(this.lock=e[t].getAttribute("lock"))}s&&this.setActiveRepository(s.getAttribute("id"),s.getAttribute("read"),s.getAttribute("write"))},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},ResourcesManager=function(){function e(){_classCallCheck(this,e),this.mainFormContainerId="all_forms",this.resources={},this.loaded=!1}return e.prototype.addJSResource=function(e,t){void 0===arguments[2]?!1:arguments[2];this.resources.js||(this.resources.js=[]),this.resources.js.push({fileName:e,className:t,autoload:!1})},e.prototype.addCSSResource=function(e){this.resources.css||(this.resources.css=[]),this.resources.css.push(e)},e.prototype.addGuiForm=function(e,t){this.resources.forms||(this.resources.forms=new Map),this.resources.forms.set(e,t)},e.prototype.addDependency=function(e){this.resources.dependencies||(this.resources.dependencies=[]),this.resources.dependencies.push(e)},e.prototype.hasDependencies=function(){return this.resources.dependencies||!1},e.prototype.load=function(e){var t=void 0===arguments[1]?!1:arguments[1];this.loaded||(this.hasDependencies()&&this.resources.dependencies.forEach(function(t){e[t]&&e[t].load(e)}.bind(this)),this.resources.forms&&this.resources.forms.forEach(function(e,t){this.loadGuiForm(t,e)}.bind(this)),this.resources.js&&this.resources.js.forEach(function(e){(!t||e.autoload)&&this.loadJSResource(e.fileName,e.className)}.bind(this)),this.resources.css&&this.resources.css.forEach(function(e){this.loadCSSResource(e)}.bind(this)),this.loaded=!0)},e.prototype.loadJSResource=function(e,t,i,o){window[t]?i&&i():("function"!=typeof t||"object"!=typeof t.prototype)&&PydioApi.loadLibrary(e,i,o)},e.prototype.loadWebComponents=function(e,t){if(!Polymer)throw Error("Cannot find Polymer library!");Polymer["import"](e,t)},e.prototype.loadCSSResource=function(e){var t=document.getElementsByTagName("head")[0];if(t&&t.down){pydio.Parameters.get("SERVER_PREFIX_URI")&&(e=pydio.Parameters.get("SERVER_PREFIX_URI")+e),e=e+"?v="+pydio.Parameters.get("ajxpVersion");var i=t.down('[href="'+e+'"]');if(!i){var o=new Element("link",{type:"text/css",rel:"stylesheet",href:e,media:"screen"});t.insert(o)}}},e.prototype.loadGuiForm=function(e,t){$(this.mainFormContainerId).select('[id="'+e+'"]').length||(t.evalScripts(),$(this.mainFormContainerId).insert(t.stripScripts()))},e.prototype.loadFromXmlNode=function(t){var i,o={};if("resources"==t.nodeName)for(i=0;i<t.childNodes.length;i++)"js"==t.childNodes[i].nodeName?this.addJSResource(t.childNodes[i].getAttribute("file"),t.childNodes[i].getAttribute("className"),t.childNodes[i].getAttribute("autoload")===!0):"css"==t.childNodes[i].nodeName?this.addCSSResource(t.childNodes[i].getAttribute("file")):"img_library"==t.childNodes[i].nodeName&&e.addImageLibrary(t.childNodes[i].getAttribute("alias"),t.childNodes[i].getAttribute("path"));else if("dependencies"==t.nodeName)for(i=0;i<t.childNodes.length;i++)"pluginResources"==t.childNodes[i].nodeName&&this.addDependency(t.childNodes[i].getAttribute("pluginName"));else"clientForm"==t.nodeName&&(t.getAttribute("theme")&&t.getAttribute("theme")!=pydio.Parameters.get("theme")||(o={formId:t.getAttribute("id"),formCode:t.firstChild.nodeValue}));o.formId&&this.addGuiForm(o.formId,o.formCode)},e.addImageLibrary=function(e,t){window.AjxpImageLibraries||(window.AjxpImageLibraries={}),window.AjxpImageLibraries[e]=t},e.loadAutoLoadResources=function(t){var i,o=new e,s=XMLUtils.XPathSelectNodes(t,"plugins/*/client_settings/resources/js");e.__modules=new Map,e.__dependencies=new Map,e.__components=new Map;for(var r=s,n=Array.isArray(r),a=0,r=n?r:r[Symbol.iterator]();;){if(n){if(a>=r.length)break;i=r[a++]}else{if(a=r.next(),a.done)break;i=a.value}e.__modules.set(i.getAttribute("className"),i.getAttribute("file")),"true"===i.getAttribute("autoload")&&o.loadJSResource(i.getAttribute("file"),i.getAttribute("className"),null,!1),i.getAttribute("depends")&&e.__dependencies.set(i.getAttribute("className"),i.getAttribute("depends").split(","))}for(var d=XMLUtils.XPathSelectNodes(t,"plugins/*/client_settings/resources/component"),c=d,l=Array.isArray(c),h=0,c=l?c:c[Symbol.iterator]();;){if(l){if(h>=c.length)break;i=c[h++]}else{if(h=c.next(),h.done)break;i=h.value}e.__components.set(i.getAttribute("componentName"),i.getAttribute("file")),"true"===i.getAttribute("autoload")&&o.loadWebComponents([i.getAttribute("file")])}for(var u=XMLUtils.XPathSelectNodes(t,"plugins/*/client_settings/resources/img_library"),p=u,g=Array.isArray(p),f=0,p=g?p:p[Symbol.iterator]();;){if(g){if(f>=p.length)break;i=p[f++]}else{if(f=p.next(),f.done)break;i=f.value}e.addImageLibrary(i.getAttribute("alias"),i.getAttribute("path"))}for(var m=XMLUtils.XPathSelectNodes(t,'plugins/*/client_settings/resources/css[@autoload="true"]'),y=m,_=Array.isArray(y),b=0,y=_?y:y[Symbol.iterator]();;){if(_){if(b>=y.length)break;i=y[b++]}else{if(b=y.next(),b.done)break;i=b.value}o.loadCSSResource(i.getAttribute("file"))}},e.findDependencies=function(t,i){if(e.__dependencies.has(t)){var o=e.__dependencies.get(t);o.forEach(function(t){!i.has(t)&&e.__modules.has(t)&&(i.add(t),e.findDependencies(t,i))})}},e.loadClassesAndApply=function(t,i){e.__modules||e.loadAutoLoadResources(pydio.Registry.getXML());var o=new Map;if(t.forEach(function(t){if(!window[t]&&e.__modules.has(t)){var i=new Set;e.findDependencies(t,i),i.size&&i.forEach(function(t){o.set(t,{className:t,fileName:e.__modules.get(t),require:e.__modules.get(t).replace(".js","")})}),o.set(t,{className:t,fileName:e.__modules.get(t),require:e.__modules.get(t).replace(".js","")})}}),!o.size)return void i();if(1==o.size)return void e.detectModuleToLoadAndApply(o.keys().next().value,i);if(window.requirejs){var s=[];o.forEach(function(e){s.push(e.require)}),requirejs(s,i)}else{var r=new e;o.forEach(function(e){r.loadJSResource(e.fileName,e.className,null,!1)}),i()}},e.detectModuleToLoadAndApply=function(t,i){e.__modules||e.loadAutoLoadResources(pydio.Registry.getXML());var o=t.split(".",1).shift();if(!window[o]&&e.__modules.has(o))if(window.requirejs)requirejs([e.__modules.get(o).replace(".js","")],i);else{var s=new e;s.loadJSResource(e.__modules.get(o),o,i,!0)}else i()},e.loadWebComponentsAndApply=function(t,i){e.__modules||e.loadAutoLoadResources(pydio.Registry.getXML());var o=[];if(t.forEach(function(t){e.__components.has(t)&&o.push(e.__components.get(t))}),o.length){var s=new e;s.loadWebComponents(o,i)}},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},RemoteNodeProvider=function(){function e(){_classCallCheck(this,e),this.discrete=!1}return e.prototype.initProvider=function(e){this.properties=new Map;for(var t in e)e.hasOwnProperty(t)&&this.properties.set(t,e[t]);this.properties&&this.properties.has("connexion_discrete")&&(this.discrete=!0,this.properties["delete"]("connexion_discrete"))},e.prototype.loadNode=function(e){var t=void 0===arguments[1]?null:arguments[1],i=void 0===arguments[2]?null:arguments[2],o=void 0===arguments[3]?!1:arguments[3],s=void 0===arguments[4]?-1:arguments[4],r={get_action:"ls",options:"al"};o&&(r.recursive=!0,r.depth=s);var n,a=e.getPath();e.getMetadata().has("paginationData")&&(n="%23"+e.getMetadata().get("paginationData").get("current"),a+=n,r.remote_order="true",e.getMetadata().get("remote_order")&&e.getMetadata().get("remote_order").forEach(function(e,t){r[t]=e})),r.dir=a,this.properties&&this.properties.forEach(function(e,t){r[t]=e+("dir"==t&&n?n:"")});var d=function(o){this.parseNodes(e,o,t,i)}.bind(this);PydioApi.getClient().request(r,d)},e.prototype.loadLeafNodeSync=function(e,t){var i=void 0===arguments[2]?!1:arguments[2],o={get_action:"ls",options:"al",dir:PathUtils.getDirname(e.getPath()),file:PathUtils.getBasename(e.getPath())};this.properties&&this.properties.forEach(function(e,t){o[t]=e});var s=function(i){try{e.isRoot()?this.parseNodes(e,i,t,null,!0):this.parseNodes(e,i,null,t,!0)}catch(o){Logger.error("Loading error :"+o.message)}}.bind(this);PydioApi.getClient().request(o,s,null,{async:i})},e.prototype.refreshNodeAndReplace=function(e,t){var i={get_action:"ls",options:"al",dir:PathUtils.getDirname(e.getPath()),file:PathUtils.getBasename(e.getPath())};this.properties&&this.properties.forEach(function(e,t){
i[t]=e});var o=function(i){e.replaceBy(i,"override"),t&&t(e)};PydioApi.getClient().request(i,function(t){try{e.isRoot()?this.parseNodes(e,t,o,null,!0):this.parseNodes(e,t,null,o,!0)}catch(i){Logger.error(i)}}.bind(this))},e.prototype.parseNodes=function(e,t,i,o,s){if(!t.responseXML||!t.responseXML.documentElement){if(!t.responseText)throw new Error("Empty response!");throw Logger.debug(t.responseText),i&&i(e),e.setLoaded(!1),new Error("Invalid XML Document (see console)")}var r=t.responseXML.documentElement;if(!s){var n=this.parseAjxpNode(r);e.replaceBy(n,"merge")}var a=XMLUtils.XPathSelectSingleNode(r,"error|message");if(a){var d;"message"==a.nodeName&&(d=a.getAttribute("type")),"ERROR"==d&&e.notify("error",a.firstChild.nodeValue+"(Source:"+e.getPath()+")")}var c=XMLUtils.XPathSelectSingleNode(r,"pagination");if(c){var l=new Map;Array.from(c.attributes).forEach(function(e){l.set(e.nodeName,e.value)}.bind(this)),e.getMetadata().set("paginationData",l)}else e.getMetadata().get("paginationData")&&e.getMetadata()["delete"]("paginationData");var h=XMLUtils.XPathSelectSingleNode(r,"client_configs");h&&e.getMetadata().set("client_configs",h);var u=XMLUtils.XPathSelectNodes(r,"tree");u.forEach(function(t){var i=this.parseAjxpNode(t);s||e.addChild(i);var r;XMLUtils.XPathSelectNodes(t,"tree").length&&(XMLUtils.XPathSelectNodes(t,"tree").forEach(function(e){var t=this.parseAjxpNode(e);t&&i.addChild(t)}.bind(this)),r=!0),o&&o(i),r&&i.setLoaded(!0)}.bind(this)),i&&i(e)},e.prototype.parseAjxpNodesDiffs=function(e,t){var i=void 0===arguments[2]?!1:arguments[2],o=XMLUtils.XPathSelectNodes(e,"remove/tree"),s=XMLUtils.XPathSelectNodes(e,"add/tree"),r=XMLUtils.XPathSelectNodes(e,"update/tree");o&&o.length&&o.forEach(function(e){var i=e.getAttribute("filename");t.removeNodeByPath(i)}),s&&s.length&&t.getAjxpNodeProvider().parseAjxpNode&&s.forEach(function(e){var o=t.getAjxpNodeProvider().parseAjxpNode(e);t.addNode(o,i)}),r&&r.length&&t.getAjxpNodeProvider().parseAjxpNode&&r.forEach(function(e){var o=t.getAjxpNodeProvider().parseAjxpNode(e);t.updateNode(o,i)})},e.prototype.parseAjxpNode=function(e){for(var t=new AjxpNode(e.getAttribute("filename"),"1"==e.getAttribute("is_file")||"true"==e.getAttribute("is_file"),e.getAttribute("text"),e.getAttribute("icon")),i=new Map,o=0;o<e.attributes.length;o++)i.set(e.attributes[o].nodeName,e.attributes[o].value);return t.setMetadata(i),t},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},EmptyNodeProvider=function(e){function t(){_classCallCheck(this,t),e.call(this)}return _inherits(t,e),t.prototype.initProvider=function(e){this.properties=e},t.prototype.loadNode=function(e,t,i){},t.prototype.loadLeafNodeSyncfunction=function(e,t){},t}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Repository=function(){function e(t,i){_classCallCheck(this,e),this.label="",this.id=t,this.accessType="",this.nodeProviderDef=void 0,this.allowCrossRepositoryCopy=!1,this.userEditable=!1,this.slug="",this.owner="",this.description="",window.ajxpResourcesFolder&&(this.icon=window.ajxpResourcesFolder+"/images/actions/16/network-wired.png"),this.resourcesManager=new ResourcesManager,i&&this.loadFromXml(i)}return e.prototype.getId=function(){return this.id},e.prototype.getLabel=function(){return this.label},e.prototype.setLabel=function(e){this.label=e},e.prototype.getHtmlBadge=function(){if(!this.label)return"";if(!this.badge){var e=this.label.split(" ").map(function(e){return e.substr(0,1)}).join("");this.badge="<span class='letter_badge'>"+e+"</span>"}return this.badge},e.prototype.getDescription=function(){return this.description},e.prototype.getIcon=function(){return this.icon},e.prototype.setIcon=function(e){this.icon=e},e.prototype.getOwner=function(){return this.owner},e.prototype.getAccessType=function(){return this.accessType},e.prototype.setAccessType=function(e){this.accessType=e},e.prototype.loadResources=function(){this.resourcesManager.load(null,!0)},e.prototype.getNodeProviderDef=function(){return this.nodeProviderDef},e.prototype.setSlug=function(e){this.slug=e},e.prototype.getSlug=function(){return this.slug},e.prototype.getOverlay=function(){return this.getOwner()?resolveImageSource("shared.png","/images/overlays/ICON_SIZE",8):""},e.prototype.loadFromXml=function(e){e.getAttribute("allowCrossRepositoryCopy")&&"true"==e.getAttribute("allowCrossRepositoryCopy")&&(this.allowCrossRepositoryCopy=!0),e.getAttribute("user_editable_repository")&&"true"==e.getAttribute("user_editable_repository")&&(this.userEditable=!0),e.getAttribute("access_type")&&this.setAccessType(e.getAttribute("access_type")),e.getAttribute("repositorySlug")&&this.setSlug(e.getAttribute("repositorySlug")),e.getAttribute("owner")&&(this.owner=e.getAttribute("owner"));for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t];if("label"==i.nodeName)this.setLabel(i.firstChild.nodeValue);else if("description"==i.nodeName)this.description=i.firstChild.nodeValue;else if("client_settings"==i.nodeName){this.setIcon(i.getAttribute("icon_tpl_id")?window.ajxpServerAccessPath+"&get_action=get_user_template_logo&template_id="+i.getAttribute("icon_tpl_id")+"&icon_format=small":i.getAttribute("icon"));for(var o=0;o<i.childNodes.length;o++){var s=i.childNodes[o];if("resources"==s.nodeName)this.resourcesManager.loadFromXmlNode(s);else if("node_provider"==s.nodeName){var r=s.getAttribute("ajxpClass"),n=JSON.parse(s.getAttribute("ajxpOptions"));this.nodeProviderDef={name:r,options:n}}}}}},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},BackgroundTasksManager=function(e){function t(i){_classCallCheck(this,t),e.call(this),this.queue=[],this.actionManager=i,this.working=!1}return _inherits(t,e),t.prototype.queueAction=function(e,t,i){var o={};o.name=e,o.messageId=i,o.parameters=t,this.queue.push(o)},t.prototype.next=function(){if(!this.queue.length)return void this.finished();if(!this.working){var e=this.queue[0];if("javascript_instruction"==e.name&&e.parameters.callback){var t=e.parameters.callback;this.notify("update_message",e.messageId),this.queue.shift(),t(),this.working=!1,this.next()}else{var i=PydioApi.getClient(),o={get_action:e.name};for(var s in e.parameters)e.parameters.hasOwnProperty(s)&&(o[s]=e.parameters[s]);i.request(o,function(e){var t=e.responseXML;return null==t||null==t.documentElement?(this.working=!1,void this.next()):(this.parseAnswer(e.responseXML),void(this.working=!1))}.bind(this),null,{method:"POST"}),this.notify("update_message",e.messageId),this.queue.shift(),this.working=!0}}},t.prototype.parseAnswer=function(e){for(var t=e.documentElement.childNodes,i=0,o=0;o<t.length;o++)if("message"==t[o].tagName){var s=t[o].getAttribute("type");"SUCCESS"!=s&&this.interruptOnError(t[o].firstChild.nodeValue)}else if("trigger_bg_action"==t[o].nodeName){var r=t[o].getAttribute("name"),n=t[o].getAttribute("messageId");i=parseInt(t[o].getAttribute("delay"));for(var a={},d=0;d<t[o].childNodes.length;d++){var c=t[o].childNodes[d];if("param"==c.tagName)a[c.getAttribute("name")]=c.getAttribute("value");else if("clientCallback"==c.tagName)var l=c.firstChild.nodeValue,h=new Function(l)}if("reload_node"==r){if(i)return void window.setTimeout(function(){this.actionManager.getDataModel().requireContextChange(this.actionManager.getDataModel().getContextNode(),!0),this.next()}.bind(this),1e3*i);this.actionManager.getDataModel().requireContextChange(this.actionManager.getDataModel().getContextNode(),!0)}else"info_message"==r?this.notify("update_message",n):"javascript_instruction"==r&&h?(a.callback=h,this.queueAction("javascript_instruction",a,n)):this.queueAction(r,a,n)}this.working=!1,i?window.setTimeout(this.next.bind(this),1e3*i):this.next()},t.prototype.interruptOnError=function(e){this.queue.length&&(this.queue=[]),this.notify("update_message_error",e),this.working=!1},t.prototype.finished=function(){this.working=!1,this.notify("tasks_finished")},t.prototype.addStub=function(){this.queueAction("local_to_remote",{},"Stubing a 10s bg action")},t}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},PydioApi=function(){function e(){_classCallCheck(this,e),this._secureToken=""}return e.prototype.setPydioObject=function(e){this._pydioObject=e,this._baseUrl=e.Parameters.get("serverAccessPath"),this._secureToken=e.Parameters.get("SECURE_TOKEN")},e.prototype.setSecureToken=function(e){this._secureToken=e},e.prototype.request=function(e){var t=void 0===arguments[1]?null:arguments[1],i=void 0===arguments[2]?null:arguments[2],o=void 0===arguments[3]?{}:arguments[3];if(e.secure_token=this._secureToken,window.Connexion){var s=new Connexion;s.setParameters($H(e)),o.method&&s.setMethod(o.method),s.onComplete=t,o.async===!1?s.sendSync():s.sendAsync()}else window.jQuery&&jQuery.ajax(this._baseUrl,{method:o.method||"post",data:e,async:o&&void 0!==o.async?o.async:!0,complete:t,error:i})},e.getClient=function(){if(e._PydioClient)return e._PydioClient;var t=new e;return e._PydioClient=t,t},e.loadLibrary=function(t,i,o){window.pydio&&pydio.Parameters.get("ajxpVersion")&&-1==t.indexOf("?")&&(t+="?v="+pydio.Parameters.get("ajxpVersion")),e._libUrl=!1,window.pydio&&pydio.Parameters.get("SERVER_PREFIX_URI")&&(e._libUrl=pydio.Parameters.get("SERVER_PREFIX_URI"));e._libUrl?e._libUrl+"/"+t:t;if(window.Connexion){var s=new Connexion;s._libUrl=!1,pydio.Parameters.get("SERVER_PREFIX_URI")&&(s._libUrl=pydio.Parameters.get("SERVER_PREFIX_URI")),s.loadLibrary(t,i,o)}},e.prototype.switchRepository=function(e,t){var i={get_action:"switch_repository",repository_id:e};this.request(i,t)},e.prototype.switchLanguage=function(e,t){var i={get_action:"get_i18n_messages",lang:e,format:"json"};this.request(i,t)},e.prototype.loadXmlRegistry=function(e){var t=void 0===arguments[1]?null:arguments[1],i={get_action:"get_xml_registry"};t&&(i[t]=t),this.request(i,e)},e.prototype.getBootConf=function(e){var t={get_action:"get_boot_conf"},i=function(t){t.responseJSON&&t.responseJSON.SECURE_TOKEN&&(this._pydioObject.Parameters.set("SECURE_TOKEN",t.responseJSON.SECURE_TOKEN),this.setSecureToken(t.responseJSON.SECURE_TOKEN)),e&&e(t)}.bind(this);this.request(t,i)},e.prototype.userSavePreference=function(e,t){var i=new Connexion;i.setMethod("post"),i.discrete=!0,i.addParameter("get_action","save_user_pref"),i.addParameter("pref_name_0",e),i.addParameter("pref_value_0",t),i.sendAsync()},e.prototype.userSavePreferences=function(e,t){var i=new Connexion;i.addParameter("get_action","save_user_pref");var o=0;e.forEach(function(e,t){i.addParameter("pref_name_"+o,t),i.addParameter("pref_value_"+o,e),o++}),i.onComplete=t,i.sendAsync()},e.prototype.userSavePassword=function(e,t,o,s){var r=new Connexion;r.addParameter("get_action","save_user_pref"),r.addParameter("pref_name_"+i,"password"),r.addParameter("pref_value_"+i,t),r.addParameter("crt",e),r.addParameter("pass_seed",o),r.onComplete=s,r.sendAsync()},e.prototype.applyCheckHook=function(e,t,i,o){var s={get_action:"apply_check_hook",file:e.getPath(),hook_name:t,hook_arg:i};this.request(s,o,null,{async:!1})},e.prototype.parseXmlMessage=function(e){if(null==e||null==e.documentElement)return null;var t=e.documentElement.childNodes,i=[],o=!1;this.LAST_ERROR_ID=null;for(var s=0;s<t.length;s++)if("message"==t[s].tagName){var r="No message";t[s].firstChild&&(r=t[s].firstChild.nodeValue),"ERROR"==t[s].getAttribute("type")?(Logger.error(r),o=!0):Logger.log(r)}else{if("prompt"==t[s].tagName){var n=(XMLUtils.XPathSelectSingleNode(t[s],"message").firstChild.nodeValue,XMLUtils.XPathSelectSingleNode(t[s],"data").firstChild.nodeValue);JSON.parse(n);throw new Error}if("reload_instruction"==t[s].tagName){var a=t[s].getAttribute("object");if("data"==a){var d=t[s].getAttribute("node");if(d)i.push(d);else{var c=t[s].getAttribute("file");c&&this._pydioObject.getContextHolder().setPendingSelection(c),i.push(this._pydioObject.getContextNode())}}else"repository_list"==a&&this._pydioObject.reloadRepositoriesList()}else if("nodes_diff"==t[s].nodeName){var l=this._pydioObject.getContextHolder();l.getAjxpNodeProvider().parseAjxpNodesDiffs&&l.getAjxpNodeProvider().parseAjxpNodesDiffs(t[s],l,!window.currentLightBox)}else if("logging_result"==t[s].tagName){if(t[s].getAttribute("secure_token")){var h=this._pydioObject.Parameters.get("ajxpServerAccess"),u=new RegExp(".*?[&\\?]minisite_session=(.*?)&.*"),p=h.replace(u,"$1"),g=p==h?!1:p,f=t[s].getAttribute("secure_token"),m=h.split("?secure_token");h=m[0]+"?secure_token="+f,g&&(h+="&minisite_session="+g),this.setSecureToken(f),this._pydioObject.Parameters.set("SECURE_TOKEN",f),window.ajxpServerAccessPath=h,this._pydioObject.Parameters.set("ajxpServerAccess",h),window.ajxpBootstrap&&ajxpBootstrap.parameters&&(ajxpBootstrap.parameters.set("ajxpServerAccess",h),ajxpBootstrap.parameters.set("SECURE_TOKEN",f)),window.Connexion&&(Connexion.SECURE_TOKEN=f)}var y=t[s].getAttribute("value"),_=!1;if("1"==y){try{}catch(b){Logger.error("Error after login, could prevent registry loading!",b)}this._pydioObject.loadXmlRegistry()}else"0"==y||"-1"==y?_=285:"2"==y?this._pydioObject.loadXmlRegistry():"-2"==y?_=285:"-3"==y?_=366:"-4"==y&&(_=386);_&&(o=!0,this.LAST_ERROR_ID=_,Logger.error(this._pydioObject.MessageHash[_]))}else if("trigger_bg_action"==t[s].tagName){for(var v=t[s].getAttribute("name"),x=t[s].getAttribute("messageId"),C={},N=0;N<t[s].childNodes.length;N++){var A=t[s].childNodes[N];"param"==A.tagName&&(C[A.getAttribute("name")]=A.getAttribute("value"))}var w=this._pydioObject.getController().getBackgroundTasksManager();w&&(w.queueAction(v,C,x),w.next())}}return i.length&&this._pydioObject.getContextHolder().multipleNodesReload(i),!o},e.prototype.submitForm=function(e,t,i){var o={};$(e).getElements().each(function(e){var t=e.getValue();if("get_action"==e.name&&"http"==t.substr(0,4)&&(t=getBaseName(t)),"radio"!=e.type||e.checked)if(o[e.name]&&e.name.endsWith("[]")){var i=o[e.name];"string"==typeof i&&(i=[i]),i.push(t),o[e.name]=i}else o[e.name]=t}),this._pydioObject.getContextNode()&&(o.dir=this._pydioObject.getContextNode().getPath());var s;s=i?i:function(e){this.parseXmlMessage(e.responseXML)}.bind(this),this.request(o,s,null,{method:t?"post":"get"})},e.prototype.triggerDownload=function(e){document.location.href=e},e}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},Action=function(_Observable){function Action(){_classCallCheck(this,Action),_Observable.call(this),this.__DEFAULT_ICON_PATH="/images/actions/ICON_SIZE",this.options=LangUtils.objectMerge({name:"",src:"",icon_class:"",text:"",title:"",text_id:"",title_id:"",hasAccessKey:!1,accessKey:"",subMenu:!1,subMenuUpdateImage:!1,subMenuUpdateTitle:!1,callbackCode:"",callbackDialogNode:null,callback:function(){},prepareModal:!1,listeners:[],activeCondition:null,formId:void 0,formCode:void 0},arguments[0]||{}),this.context=LangUtils.objectMerge({selection:!0,dir:!1,allowedMimes:[],evalMetadata:"",root:!0,inZip:!0,recycle:!1,behaviour:"hidden",actionBar:!1,actionBarGroup:"default",contextMenu:!1,ajxpWidgets:null,infoPanel:!1},arguments[1]||{}),this.selectionContext=LangUtils.objectMerge({dir:!1,file:!0,recycle:!1,behaviour:"disabled",allowedMimes:[],evalMetadata:"",unique:!0,multipleOnly:!1,enableRoot:!1},arguments[2]||{}),this.rightsContext=LangUtils.objectMerge({noUser:!0,userLogged:!0,guestLogged:!1,read:!1,write:!1,adminOnly:!1},arguments[3]||{}),this.subMenuItems=LangUtils.objectMerge({staticItems:null,dynamicItems:null,dynamicBuilderCode:null},arguments[4]||{}),this.elements=[],this.contextHidden=!1,this.deny=!1,this.context.subMenu&&(this.options.actionBar||alert("Warning, wrong action definition. Cannot use a subMenu if not displayed in the actionBar!"))}return _inherits(Action,_Observable),Action.prototype._evalScripts=function _evalScripts(data,localScopeMetadata){var metadata=localScopeMetadata;return eval(data)},Action.prototype.setManager=function(e){if(this.manager=e,this.options.subMenu&&(this.subMenuItems.staticItems&&this.buildSubmenuStaticItems(),(this.subMenuItems.dynamicItems||this.subMenuItems.dynamicBuilderCode)&&this.prepareSubmenuDynamicBuilder()),this.options.listeners.init)try{window.listenerContext=this,"string"==typeof this.options.listeners.init?this._evalScripts(this.options.listeners.init):this.options.listeners.init()}catch(t){Logger.error("Error while evaluating init script for action "+this.options.name)}},Action.prototype.apply=function(){if(!this.deny){if(this.manager.publishActionEvent("beforeApply-"+this.options.name),this.options.prepareModal){var e=this.manager.uiGetModal();e&&e.prepareHeader(this.options.title,this.options.src,this.options.icon_class)}if(window.actionArguments=[],window.actionManager=this.manager,arguments[0]&&(window.actionArguments=arguments[0]),this.options.callbackCode)try{this._evalScripts(this.options.callbackCode)}catch(t){Logger.error(t)}else if(this.options.callbackDialogNode){var i=this.options.callbackDialogNode,o=i.getAttribute("dialogOpenForm"),s="true"===i.getAttribute("dialogOkButtonOnly"),r="true"===i.getAttribute("dialogSkipButtons"),n=null,a=null,d=null,c=XMLUtils.XPathSelectSingleNode(i,"dialogOnOpen");c&&c.firstChild&&(n=new Function("oForm",c.firstChild.nodeValue));var l=XMLUtils.XPathSelectSingleNode(i,"dialogOnComplete");if(l&&l.firstChild){var h=l.firstChild.nodeValue;"true"===l.getAttribute("hideDialog")&&(h+="hideLightBox(true);"),a=new Function("oForm",h)}var u=XMLUtils.XPathSelectSingleNode(i,"dialogOnCancel");u&&u.firstChild&&(d=new Function("oForm",u.firstChild.nodeValue)),this.options.callback=function(){var e=this.manager.uiGetModal();e&&e.showDialogForm("Dialog",o,n,a,d,s,r)}.bind(this),this.options.callback(),this.options.callbackDialogNode=null}else this.options.callback&&this.options.callback();this.options.subMenu&&arguments[0]&&arguments[0][0]&&this.notify("submenu_active",arguments[0][0]),window.actionArguments=null,window.actionManager=null,this.manager.publishActionEvent("afterApply-"+this.options.name)}},Action.prototype.fireContextChange=function(){if(!(arguments.length<3)){var e=arguments[0],t=arguments[1],i=!1,o=!1,s=!1,r="",n=!1,a=arguments[2];if(a&&(i="ajxp_recycle"==a.getAjxpMime(),o=a.hasAjxpMimeInBranch("ajxp_browsable_archive"),s=a.isRoot(),r=a.getAjxpMime(),n=a.hasMetadataInBranch("ajxp_readonly","true")),this.options.listeners.contextChange){window.listenerContext=this;try{this._evalScripts(this.options.listeners.contextChange)}catch(d){Logger.error("Error while evaluating script for contextChange event - action "+this.options.name)}}var c=this.rightsContext;if(!c.noUser&&!e)return this.hideForContext();if("only"==c.userLogged&&null==t||c.guestLogged&&"hidden"==c.guestLogged&&null!=t&&"guest"==t.id)return this.hideForContext();if("hidden"==c.userLogged&&null!=t&&("guest"!=t.id||!c.guestLogged||"show"!=c.guestLogged))return this.hideForContext();if(c.adminOnly&&(null==t||!t.isAdmin))return this.hideForContext();if(c.read&&null!=t&&!t.canRead())return this.hideForContext();if(c.write&&null!=t&&!t.canWrite())return this.hideForContext();if(c.write&&n)return this.hideForContext();if(this.context.allowedMimes.length){if(-1==this.context.allowedMimes.indexOf("*")&&-1==this.context.allowedMimes.indexOf(r))return this.hideForContext();if(-1!=this.context.allowedMimes.indexOf("^"+r))return this.hideForContext()}if(this.context.recycle){if("only"==this.context.recycle&&!i)return this.hideForContext();if("hidden"==this.context.recycle&&i)return this.hideForContext()}return!this.context.inZip&&o?this.hideForContext():!this.context.root&&s?this.hideForContext():void this.showForContext()}},Action.prototype.fireSelectionChange=function(){if(this.options.listeners.selectionChange){window.listenerContext=this;try{this._evalScripts(this.options.listeners.selectionChange)}catch(e){Logger.error("Error while evaluating script for selectionChange event - action "+this.options.name)}}if(this.options.activeCondition)try{var t=this.options.activeCondition();t===!1?this.disable():t===!0&&this.enable()}catch(e){Logger.error("Error while evaluating activeCondition() script for action "+this.options.name)}if(!this.contextHidden&&this.context.selection){var i=arguments[0],o=!1;if(null!=i){o=i.selectionHasRootNode();var s=i.isUnique(),r=i.hasFile(),n=i.hasDir(),a=i.isRecycle()}var d=this.selectionContext;if(d.allowedMimes.length&&("hidden"==d.behaviour?this.hide():this.disable()),d.evalMetadata&&i&&i.isUnique()){var t=this._evalScripts(d.evalMetadata,i.getUniqueNode().getMetadata());if(!t)return void("hidden"==d.behaviour?this.hide():this.disable())}if(!d.enableRoot&&o)return this.disable();if(d.unique&&!s)return this.disable();if(d.multipleOnly&&s)return this.disable();if((d.file||d.dir)&&!r&&!n)return this.disable();if(d.dir&&!d.file&&r||!d.dir&&d.file&&n)return this.disable();if(!d.recycle&&a)return this.disable();if(this.rightsContext.write&&i.hasReadOnly())return this.disable();if(d.allowedMimes.length&&i&&-1==d.allowedMimes.indexOf("*")&&!i.hasMime(d.allowedMimes))return"hidden"==d.behaviour?this.hide():this.disable();if(d.allowedMimes.length&&i&&-1!==d.allowedMimes.indexOf("^")){var c=!1;if(d.allowedMimes.forEach(function(e){-1!=e.indexOf("^")&&i.hasMime([e.replace("^","")])&&(c=!0)}),c)return"hidden"==d.behaviour?this.hide():this.disable()}this.show(),this.enable()}},Action.prototype.createFromXML=function(e){this.options.name=e.getAttribute("name");for(var t=0;t<e.childNodes.length;t++){var i=e.childNodes[t],o={dir:"dirDefault",file:"fileDefault",dragndrop:"dragndropDefault",ctrldragndrop:"ctrlDragndropDefault",expire:"expireDefault"};for(var s in o)if(o.hasOwnProperty(s)){var r=o[s];e.getAttribute(r)&&"true"==e.getAttribute(r)&&(this.defaults||(this.defaults={}),this.defaults[s]=!0)}var n;if("processing"==i.nodeName){var a={};for(n=0;n<i.childNodes.length;n++){var d=i.childNodes[n];"clientForm"==d.nodeName?d.getAttribute("theme")&&pydio.Parameters.get("theme")!=d.getAttribute("theme")||(a.formId=d.getAttribute("id"),a.formCode=d.firstChild.nodeValue):"clientCallback"==d.nodeName?(d.getAttribute("prepareModal")&&"true"==d.getAttribute("prepareModal")&&(this.options.prepareModal=!0),d.getAttribute("dialogOpenForm")?this.options.callbackDialogNode=d:d.firstChild&&(this.options.callbackCode=d.firstChild.nodeValue.trim())):"clientListener"==d.nodeName&&d.firstChild?this.options.listeners[d.getAttribute("name")]=d.firstChild.nodeValue.trim():"activeCondition"==d.nodeName&&d.firstChild&&(this.options.activeCondition=new Function(d.firstChild.nodeValue.trim()))}a.formId&&(this.options.formId=a.formId,this.options.formCode=a.formCode,this.options.formCode&&this.options.formId&&this.manager.uiInsertForm(this.options.formId,this.options.formCode))}else if("gui"==i.nodeName)for(this.options.text_id=i.getAttribute("text"),this.options.title_id=i.getAttribute("title"),this.options.text=this.manager.getMessage(i.getAttribute("text"))||"not_found",this.options.title=this.manager.getMessage(i.getAttribute("title"))||"not_found",this.options.src=i.getAttribute("src"),this.options.icon_class=i.getAttribute("iconClass"),i.getAttribute("hasAccessKey")&&"true"==i.getAttribute("hasAccessKey")&&(this.options.accessKey=i.getAttribute("accessKey"),this.options.hasAccessKey=!0),i.getAttribute("specialAccessKey")&&(this.options.specialAccessKey=i.getAttribute("specialAccessKey")),n=0;n<i.childNodes.length;n++)"context"==i.childNodes[n].nodeName?(this.attributesToObject(this.context,i.childNodes[n]),this.context.ajxpWidgets?this.context.ajxpWidgets=this.context.ajxpWidgets.split(","):this.context.ajxpWidgets=[],this.context.infoPanel&&this.context.ajxpWidgets.push("InfoPanel"),this.context.actionBar&&this.context.ajxpWidgets.push("ActionsToolbar")):"selectionContext"==i.childNodes[n].nodeName&&this.attributesToObject(this.selectionContext,i.childNodes[n]);else if("rightsContext"==i.nodeName)this.attributesToObject(this.rightsContext,i);else if("subMenu"==i.nodeName)for(this.options.subMenu=!0,i.getAttribute("updateImageOnSelect")&&"true"==i.getAttribute("updateImageOnSelect")&&(this.options.subMenuUpdateImage=!0),i.getAttribute("updateTitleOnSelect")&&"true"==i.getAttribute("updateTitleOnSelect")&&(this.options.subMenuUpdateTitle=!0),n=0;n<i.childNodes.length;n++)if("staticItems"==i.childNodes[n].nodeName||"dynamicItems"==i.childNodes[n].nodeName){this.subMenuItems[i.childNodes[n].nodeName]=[];for(var c=0;c<i.childNodes[n].childNodes.length;c++)if(i.childNodes[n].childNodes[c].nodeName.startsWith("item")){for(var l={},h=0;h<i.childNodes[n].childNodes[c].attributes.length;h++){var u=i.childNodes[n].childNodes[c].attributes[h];l[u.nodeName]=u.value}this.subMenuItems[i.childNodes[n].nodeName].push(l)}}else"dynamicBuilder"==i.childNodes[n].nodeName&&(this.subMenuItems.dynamicBuilderCode=i.childNodes[n].firstChild.nodeValue)}this.options.hasAccessKey&&(""!=this.options.accessKey&&this.manager.getMessage(this.options.accessKey)&&-1!=this.options.text.indexOf(this.manager.getMessage(this.options.accessKey))?this.options.accessKey=this.manager.getMessage(this.options.accessKey):this.options.accessKey=this.options.text.charAt(0))},Action.prototype.buildSubmenuStaticItems=function(){var e=[];this.subMenuItems.staticItems&&this.subMenuItems.staticItems.forEach(function(t){var i=this.manager.getMessage(t.text);t.hasAccessKey&&("true"==t.hasAccessKey||t.hasAccessKey===!0)&&this.manager.getMessage(t.accessKey)&&(i=this.getKeyedText(this.manager.getMessage(t.text),!0,this.manager.getMessage(t.accessKey)),this.subMenuItems.accessKeys||(this.subMenuItems.accessKeys=[]),this.manager.registerKey(this.manager.getMessage(t.accessKey),this.options.name,t.command)),e.push({name:i,alt:this.manager.getMessage(t.title),image_unresolved:t.src,icon_class:t.icon_class,isDefault:t.isDefault?!0:!1,callback:function(){this.apply([t])}.bind(this)})},this),this.subMenuItems.staticOptions=e},Action.prototype.prepareSubmenuDynamicBuilder=function(){this.subMenuItems.dynamicBuilder=function(e){var t;setTimeout(function(){this.subMenuItems.dynamicBuilderCode?(window.builderContext=this,window.builderProtoMenu=e,this._evalScripts(this.subMenuItems.dynamicBuilderCode),t=this.builderMenuItems||[]):(t=[],this.subMenuItems.dynamicItems.forEach(function(e){if(e.separator)return void t.push(e);var i=this.manager.actions.get(e.actionId);if(!i.deny){var o={name:i.getKeyedText(),alt:i.options.title,icon_class:i.options.icon_class,image_unresolved:i.options.src,callback:function(){this.apply()}.bind(i)};i.options.subMenu&&(o.subMenu=[],i.subMenuItems.staticOptions&&(o.subMenu=i.subMenuItems.staticOptions),i.subMenuItems.dynamicBuilder&&(o.subMenuBeforeShow=i.subMenuItems.dynamicBuilder)),t.push(o)}},this)),e.options.menuItems=t,e.refreshList()}.bind(this),0)}.bind(this)},Action.prototype.setIconSrc=function(e,t){this.options.src=e;var i=this.options.icon_class;this.notify("update_icon",{new_src:e,new_class:t,previous_class:i}),t&&(this.options.icon_class=t)},Action.prototype.setLabel=function(e,t){this.options.text=this.manager.getMessage(e),this.notify("update_label",this.getKeyedText()),t&&(this.options.title=this.manager.getMessage(t),this.notify("update_title",this.options.title))},Action.prototype.refreshInstances=function(){},Action.prototype.refreshFromI18NHash=function(){this.setLabel(this.options.text_id,this.options.title_id)},Action.prototype.toInfoPanel=function(){return this.options},Action.prototype.toContextMenu=function(){return this.options},Action.prototype.hideForContext=function(){this.hide(),this.contextHidden=!0},Action.prototype.showForContext=function(){this.contextHidden=!1,this.show(),this.selectionContext&&this.fireSelectionChange()},Action.prototype.hide=function(){this.deny=!0,this.notify("hide")},Action.prototype.show=function(){this.deny=!1,this.notify("show")},Action.prototype.disable=function(){this.deny=!0,this.notify("disable")},Action.prototype.enable=function(){this.deny=!1,this.notify("enable")},Action.prototype.remove=function(){this.notify("remove"),this.options.formId&&this.manager.uiRemoveForm(this.options.formId)},Action.prototype.getKeyedText=function(e,t,i){if(e||(e=this.options.text),t||(t=this.options.hasAccessKey),i||(i=this.options.accessKey),!t)return e;var o=e.toLowerCase().indexOf(i.toLowerCase());if(-1==o)return e+" (<u>"+i+"</u>)";e.charAt(o)!=i&&(i=e.charAt(o));var s=e.substring(0,e.indexOf(i));return s+="<u>"+i+"</u>",s+=e.substring(e.indexOf(i)+1,e.length)},Action.prototype.attributesToObject=function(e,t){for(var i in e)if(e.hasOwnProperty(i)&&t.getAttribute(i)){var o=t.getAttribute(i);"true"==o?o=!0:"false"==o&&(o=!1),"allowedMimes"==i&&(o=o&&o.split(",").length?o.split(","):[]),e[i]=o}},Action}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},Controller=function(e){function t(i){var o=void 0===arguments[1]?null:arguments[1];if(_classCallCheck(this,t),e.call(this),this._pydioObject=i,this._registeredKeys=new Map,this.usersEnabled=i.Parameters.get("usersEnabled"),this.subMenus=[],this.actions=new Map,this.defaultActions=new Map,this.toolbars=new Map,this._guiActions=new Map,this.contextChangedObs=function(e){window.setTimeout(function(){this.fireContextChange()}.bind(this),0)}.bind(this),this.selectionChangedObs=function(e){window.setTimeout(function(){this.fireSelectionChange()}.bind(this),0)}.bind(this),o){this.localDataModel=!0;try{this._dataModel=document.getElementById(o).ajxpPaneObject.getDataModel()}catch(s){}this._dataModel?this._connectDataModel():this._pydioObject.observeOnce("datamodel-loaded-"+o,function(){this._dataModel=document.getElementById(o).ajxpPaneObject.getDataModel(),this._connectDataModel()}.bind(this))}else this.localDataModel=!1,this._connectDataModel();this.usersEnabled&&(this._pydioObject.observe("user_logged",function(e){this.setUser(e)}.bind(this)),this._pydioObject.user&&this.setUser(this._pydioObject.user))}return _inherits(t,e),t.prototype.publishActionEvent=function(e,t){this._pydioObject.fire(e,t)},t.prototype._connectDataModel=function(){this.localDataModel?(this._dataModel.observe("context_changed",this.contextChangedObs),this._dataModel.observe("selection_changed",this.selectionChangedObs),this.loadActionsFromRegistry(),this._pydioObject.observe("registry_loaded",function(e){this.loadActionsFromRegistry(e)}.bind(this))):(this._pydioObject.observe("context_changed",this.contextChangedObs),this._pydioObject.observe("selection_changed",this.selectionChangedObs),this._dataModel=this._pydioObject.getContextHolder())},t.prototype.updateGuiActions=function(e){e.forEach(function(e,t){this._guiActions.set(t,e)}.bind(this))},t.prototype.deleteFromGuiActions=function(e){this._guiActions["delete"](e)},t.prototype.refreshGuiActionsI18n=function(){
this._guiActions.forEach(function(e,t){e.refreshFromI18NHash()})},t.prototype.getBackgroundTasksManager=function(){return t._bgManager||(t._bgManager=new BackgroundTasksManager),t._bgManager},t.prototype.getDataModel=function(){return this._dataModel},t.prototype.destroy=function(){this.localDataModel&&this._dataModel&&(this._dataModel.stopObserving("context_changed",this.contextChangedObs),this._dataModel.stopObserving("selection_changed",this.selectionChangedObs))},t.prototype.getMessage=function(e){try{return this._pydioObject.MessageHash[e]}catch(t){return e}},t.prototype.uiInsertForm=function(e,t){this._pydioObject.UI&&this._pydioObject.UI.insertForm(e,t)},t.prototype.uiRemoveForm=function(e){this._pydioObject.UI&&this._pydioObject.UI.removeForm(e)},t.prototype.uiGetModal=function(){return this._pydioObject&&this._pydioObject.UI?this._pydioObject.UI.modal:null},t.prototype.parseXmlMessage=function(e){return Logger.log("Controller.parseXmlMessage() is deprecated, use PydioApi instead"),PydioApi.getClient().parseXmlMessage(e)},t.prototype.submitForm=function(e,t,i){return Logger.log("Controller.submitForm() is deprecated, use PydioApi instead"),PydioApi.getClient().submitForm(e,t,i)},t.prototype.setUser=function(e){this.oUser=e,null==e||"guest"==e.id||null==e.getPreference("lang")||""==e.getPreference("lang")||e.getPreference("lang")==this._pydioObject.currentLanguage||e.lock||this._pydioObject.loadI18NMessages(e.getPreference("lang"))},t.prototype.getContextActions=function(e,t){var i,o=[],s=new Map;this.actions.forEach(function(t){if(t.context.contextMenu&&("selectionContext"!=e||t.context.selection)&&("directoryContext"!=e||t.context.dir)&&!("genericContext"==e&&t.context.selection||t.contextHidden||t.deny)){t.context.actionBarGroup.split(",").forEach(function(e){s.has(e)||s.set(e,[])});var o=!1;if("selectionContext"==e){var r=this._dataModel;if(!r.isEmpty()){var n="file";r.isUnique()&&(r.hasDir()||r.hasMime(["ajxp_browsable_archive"]))&&(n="dir"),this.defaultActions.get(n)&&t.options.name==this.defaultActions.get(n)&&(o=!0)}}t.context.actionBarGroup.split(",").forEach(function(e){var r={name:t.getKeyedText(),alt:t.options.title,action_id:t.options.name,image_unresolved:t.options.src,isDefault:o,callback:function(e){this.apply()}.bind(t)};t.options.icon_class&&(r.icon_class=t.options.icon_class),t.options.subMenu&&(r.subMenu=[],t.subMenuItems.staticOptions&&(r.subMenu=t.subMenuItems.staticOptions),t.subMenuItems.dynamicBuilder&&(r.subMenuBeforeShow=t.subMenuItems.dynamicBuilder)),s.get(e).push(r),o&&(i=e)})}}.bind(this));var r=!0,n=[];i&&s.has(i)&&n.push(i);for(var a=s.keys(),d=Array.isArray(a),c=0,a=d?a:a[Symbol.iterator]();;){var l;if(d){if(c>=a.length)break;l=a[c++]}else{if(c=a.next(),c.done)break;l=c.value}var h=l;h!=i&&n.push(h)}return n.sort(),n.each(function(e){var i=s.get(e);r||o.push({separator:!0}),t&&-1!=t.indexOf(e)||(r=!1,i.forEach(function(e){o.push(e)}))}),o},t.prototype.getActionsForAjxpWidget=function(e,t){var i=[];return this.actions.forEach(function(o){!o.context.ajxpWidgets||-1==o.context.ajxpWidgets.indexOf(e+"::"+t)&&-1==o.context.ajxpWidgets.indexOf(e)||o.deny||i.push(o)}),i},t.prototype.fireDefaultAction=function(e){var t=this.defaultActions.get(e);if(t){if(arguments[0]=t,"ls"==t){var i=this.actions.get(t);i&&i.enable()}this.fireAction.apply(this,arguments)}},t.prototype.fireAction=function(e){var t=this.actions.get(e);if(null!=t){var i=Array.from(arguments).slice(1);t.apply(i)}},t.prototype.registerKey=function(e,t,i){i&&(t=t+"::"+i),this._registeredKeys.set(e.toLowerCase(),t)},t.prototype.clearRegisteredKeys=function(){this._registeredKeys=new Map},t.prototype.fireActionByKey=function(e,t){if(this._registeredKeys.get(t)){if(-1!==this._registeredKeys.get(t).indexOf("::")){var i=this._registeredKeys.get(t).split("::");this.fireAction(i[0],i[1])}else this.fireAction(this._registeredKeys.get(t));try{e.preventDefault(),e.stopPropagation()}catch(o){Logger.error("Error trying to stop event propagation")}}},t.prototype.applyDragMove=function(e,t,i,o){if((o||this.defaultActions.has("dragndrop")&&!this.getDefaultAction("dragndrop").deny)&&(!o||this.defaultActions.has("ctrldragndrop")&&!this.getDefaultAction("ctrldragndrop").deny)){var s;if(s=null==e?this._dataModel.getFileNames():[e],t==this._dataModel.getContextNode().getPath())return void this._pydioObject.displayMessage("ERROR",MessageHash[203]);for(var r=0;r<s.length;r++)if(0===t.lastIndexOf(s[r],0))return void this._pydioObject.displayMessage("ERROR",MessageHash[202]);var n={};n.get_action=this.defaultActions.get(o?"ctrldragndrop":"dragndrop"),n["nodes[]"]=s,n.dest=t,n.dir=this._dataModel.getContextNode().getPath(),PydioApi.getClient().request(n,function(e){this.parseXmlMessage(e.responseXML)}.bind(PydioApi.getClient()))}},t.prototype.getDefaultAction=function(e){return this.defaultActions.has(e)?this.actions.get(this.defaultActions.get(e)):null},t.prototype.fireSelectionChange=function(){var e=null;e=this._dataModel,e.isEmpty()&&(e=null),this.actions.forEach(function(t){t.fireSelectionChange(e)}),this.localDataModel?this.notify("actions_refreshed"):this._pydioObject.fire("actions_refreshed")},t.prototype.fireContextChange=function(){var e=this._dataModel.getContextNode();this.actions.forEach(function(t){t.fireContextChange(this.usersEnabled,this.oUser,e)}.bind(this)),this.localDataModel?this.notify("actions_refreshed"):this._pydioObject.fire("actions_refreshed")},t.prototype.removeActions=function(){this.actions.forEach(function(e){e.remove()}),this.actions=new Map,this.clearRegisteredKeys()},t.prototype.loadActionsFromRegistry=function(){var e=void 0===arguments[0]?null:arguments[0];e||(e=pydio.getXmlRegistry()),this.removeActions(),this.parseActions(e),this._guiActions.forEach(function(e){this.registerAction(e)}.bind(this)),this.localDataModel?this.notify("actions_loaded"):this._pydioObject.fire("actions_loaded",this.actions),this.fireContextChange(),this.fireSelectionChange()},t.prototype.registerAction=function(e){var t=e.options.name;if(this.actions.set(t,e),e.defaults)for(var i in e.defaults)e.defaults.hasOwnProperty(i)&&this.defaultActions.set(i,t);e.options.hasAccessKey&&this.registerKey(e.options.accessKey,t),e.options.specialAccessKey&&this.registerKey("key_"+e.options.specialAccessKey,t),e.setManager(this)},t.prototype.parseActions=function(e){for(var t=XMLUtils.XPathSelectNodes(e,"actions/action"),i=0;i<t.length;i++)if("action"==t[i].nodeName&&"false"!=t[i].getAttribute("enabled")){var o=new Action;o.setManager(this),o.createFromXML(t[i]),this.registerAction(o)}},t.prototype.getActionByName=function(e){return this.actions.get(e)},t}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},PydioDataModel=function(e){function t(){var i=void 0===arguments[0]?!0:arguments[0];_classCallCheck(this,t),e.call(this),this._currentRep="/",this._selectedNodes=[],this._bEmpty=!0,this._globalEvents=!i,this._bUnique=!1,this._bFile=!1,this._bDir=!1,this._isRecycle=!1,this._pendingSelection=null,this._selectionSource={},this._rootNode=null}return _inherits(t,e),t.prototype.setAjxpNodeProvider=function(e){this._iAjxpNodeProvider=e},t.prototype.getAjxpNodeProvider=function(){return this._iAjxpNodeProvider},t.prototype.requireContextChange=function(e){var t=void 0===arguments[1]?!1:arguments[1];if(null!=e){var i=e.getPath();if(""!=i&&"/"!=i||e==this._rootNode||(e=this._rootNode),e.getMetadata().has("paginationData")&&e.getMetadata().get("paginationData").has("new_page")&&e.getMetadata().get("paginationData").get("new_page")!=e.getMetadata().get("paginationData").get("current")){var o=e.getMetadata().get("paginationData").get("new_page");t=!0}if(e!=this._rootNode&&(!e.getParent()||e.fake)){var s=[];if(e=e.findInArbo(this._rootNode,s),s.length){var r=s.shift();return r.observeOnce("first_load",function(t){this.requireContextChange(e)}.bind(this)),r.observeOnce("error",function(e){Logger.error(e),r.notify("node_removed");var t=r.getParent();t.removeChild(r),this.requireContextChange(t)}.bind(this)),this.publish("context_loading"),void r.load(this._iAjxpNodeProvider)}}e.observeOnce("loaded",function(){if(this.setContextNode(e,!0),this.publish("context_loaded"),this.getPendingSelection()){var t=e.getPath()+("/"==e.getPath()?"":"/")+this.getPendingSelection(),i=e.findChildByPath(t);if(i)this.setSelectedNodes([i],this);else if(e.getMetadata().get("paginationData")&&arguments.length<3){var o,s=e.getMetadata().get("paginationData").get("current");if(this.loadPathInfoSync(t,function(e){o=e.getMetadata().get("page_position")}),o&&o!=s)return e.getMetadata().get("paginationData").set("new_page",o),void this.requireContextChange(e,!0,!0)}this.clearPendingSelection()}}.bind(this)),e.observeOnce("error",function(e){Logger.error(e),this.publish("context_loaded")}.bind(this)),this.publish("context_loading");try{t?(o&&e.getMetadata().get("paginationData").set("current",o),e.reload(this._iAjxpNodeProvider)):e.load(this._iAjxpNodeProvider)}catch(n){this.publish("context_loaded")}}},t.prototype.requireNodeReload=function(e,t){e instanceof String&&(e=new AjxpNode(e));var i=null;if(this._selectedNodes.length){var o=!1;this._selectedNodes.each(function(t){t.getPath()==e.getPath()&&(o=t)}),o&&(this._selectedNodes=this._selectedNodes.without(o),this.publish("selection_changed",this),i=function(e){this._selectedNodes.push(e),this._selectionSource={},this.publish("selection_changed",this),t&&t(e)}.bind(this))}this._iAjxpNodeProvider.refreshNodeAndReplace(e,i)},t.prototype.loadPathInfoSync=function(e,t){this._iAjxpNodeProvider.loadLeafNodeSync(new AjxpNode(e),t,!1)},t.prototype.loadPathInfoAsync=function(e,t){this._iAjxpNodeProvider.loadLeafNodeSync(new AjxpNode(e),t,!0)},t.prototype.setRootNode=function(e){this._rootNode=e,this._rootNode.setRoot(),this._rootNode.observe("child_added",function(e){}),this.publish("root_node_changed",this._rootNode),this.setContextNode(this._rootNode)},t.prototype.getRootNode=function(){return this._rootNode},t.prototype.setContextNode=function(e,t){(!this._contextNode||this._contextNode!=e||this._currentRep!=e.getPath()||t)&&e&&(this._contextNodeReplacedObserver&&this._contextNode&&this._contextNode.stopObserving("node_replaced",this._contextNodeReplacedObserver),this._contextNode=e,this._currentRep=e.getPath(),this.publish("context_changed",e),this._contextNodeReplacedObserver||(this._contextNodeReplacedObserver=this.contextNodeReplaced.bind(this)),e.observe("node_replaced",this._contextNodeReplacedObserver))},t.prototype.contextNodeReplaced=function(e){this.setContextNode(e)},t.prototype.publish=function(e,t){var i=[];this._globalEvents?(window.pydio?(i.push(e),t&&i.push(t),pydio.fire.apply(pydio,i)):document.fire&&(i.push("ajaxplorer:"+e),t&&i.push(t),document.fire.apply(document,i)),i=t?[e,{memo:t}]:[e],this.notify.apply(this,i)):(i=t?[e,{memo:t}]:[e],this.notify.apply(this,i))},t.prototype.getContextNode=function(){return this._contextNode},t.prototype.multipleNodesReload=function(e){for(var t=0;t<e.length;t++){var i,o=e[t];o instanceof String?(i=new AjxpNode(o),i=i.getPath()==this._rootNode.getPath()?this._rootNode:i.findInArbo(this._rootNode,[])):i=o,e[t]=i}var s=[];e.sort(function(e,t){return e.isParentOf(t)?(s.push(t),-1):e.isChildOf(t)?(s.push(e),1):0}),s.each(function(t){e=e.without(t)}),e.each(this.queueNodeReload.bind(this)),this.nextNodeReloader()},t.prototype.queueNodeReload=function(e){this.queue||(this.queue=[]),e&&this.queue.push(e)},t.prototype.nextNodeReloader=function(){if(!this.queue.length)return void window.setTimeout(function(){this.publish("context_changed",this._contextNode)}.bind(this),200);var e=this.queue.shift(),t=this.nextNodeReloader.bind(this);e.observeOnce("loaded",t),e.observeOnce("error",t),e==this._contextNode||e.isParentOf(this._contextNode)?this.requireContextChange(e,!0):e.reload(this._iAjxpNodeProvider)},t.prototype.addNode=function(e){var t=void 0===arguments[1]?!1:arguments[1],i=new AjxpNode(PathUtils.getDirname(e.getPath())),o=i.findInArbo(this.getRootNode(),void 0);o||""!=PathUtils.getDirname(e.getPath())||(o=this.getRootNode()),o&&(o.addChild(e),t&&this.getContextNode()==o&&this.setSelectedNodes([e],{}))},t.prototype.removeNodeByPath=function(e){var t=new AjxpNode(e),i=t.findInArbo(this.getRootNode(),void 0);return i?(i.getParent().removeChild(i),!0):!1},t.prototype.updateNode=function(e){var t,i,o=void 0===arguments[1]?!1:arguments[1],s=e.getMetadata().get("original_path");if(s&&s!=e.getPath()&&PathUtils.getDirname(s)!=PathUtils.getDirname(e.getPath())){t=new AjxpNode(s),i=t.findInArbo(this.getRootNode(),void 0),i&&i.getParent().removeChild(i);var r=new AjxpNode(getRepName(e.getPath())),n=r.findInArbo(this.getRootNode(),void 0);n||""!=getRepName(e.getPath())||(n=this.getRootNode()),n&&(e.getMetadata().set("original_path",void 0),n.addChild(e))}else t=new AjxpNode(s),i=t.findInArbo(this.getRootNode(),void 0),i&&(e._isLoaded=i._isLoaded,i.replaceBy(e,"override"),o&&this.getContextNode()==i.getParent()&&this.setSelectedNodes([i],{}))},t.prototype.setPendingSelection=function(e){this._pendingSelection=e},t.prototype.getPendingSelection=function(){return this._pendingSelection},t.prototype.clearPendingSelection=function(){this._pendingSelection=null},t.prototype.setSelectedNodes=function(e,t){if(t?this._selectionSource=t:this._selectionSource={},this._selectedNodes=e,this._bEmpty=e&&e.length?!1:!0,this._bFile=this._bDir=this._isRecycle=!1,!this._bEmpty){this._bUnique=1==e.length;for(var i=0;i<e.length;i++){var o=e[i];o.isLeaf()?this._bFile=!0:this._bDir=!0,o.isRecycle()&&(this._isRecycle=!0)}}this.publish("selection_changed",this)},t.prototype.getSelectedNodes=function(){return this._selectedNodes},t.prototype.getSelectionSource=function(){return this._selectionSource},t.prototype.setSelectionSource=function(e){this._selectionSource=e},t.prototype.getSelectedItems=function(){throw new Error("Deprecated : use getSelectedNodes() instead")},t.prototype.selectAll=function(){this.setSelectedNodes(this._contextNode.getChildren(),"dataModel")},t.prototype.isEmpty=function(){return this._selectedNodes?0==this._selectedNodes.length:!0},t.prototype.hasReadOnly=function(){var e=!1;try{this._selectedNodes.forEach(function(t){if(t.hasMetadataInBranch("ajxp_readonly","true"))throw e=!0,$break})}catch(t){}return e},t.prototype.selectionHasRootNode=function(){var e=!1;try{this._selectedNodes.forEach(function(t){if(t.isRoot())throw e=!0,new Error})}catch(t){}},t.prototype.isUnique=function(){return this._bUnique},t.prototype.hasFile=function(){return this._bFile},t.prototype.hasDir=function(){return this._bDir},t.prototype.isRecycle=function(){return this._isRecycle},t.prototype.isMultiple=function(){return this._selectedNodes&&this._selectedNodes.length>1},t.prototype.hasMime=function(e){if(1==e.length&&"*"==e[0])return!0;var t=!1;return e.each(function(e){t||(t=this._selectedNodes.any(function(t){return getAjxpMimeType(t)==e}))}.bind(this)),t},t.prototype.getFileNames=function(e){if(!this._selectedNodes.length)return alert("Please select a file!"),!1;for(var t=new Array(this._selectedNodes.length),i=0;i<this._selectedNodes.length;i++)t[i]=this._selectedNodes[i].getPath();return e?t.join(e):t},t.prototype.getContextFileNames=function(e){var t=this._contextNode.getChildren();if(!t.length)return!1;for(var i=[],o=0;o<t.length;o++)i.push(getBaseName(t[o].getPath()));return e?i.join(e):i},t.prototype.fileNameExists=function(e,t,i){if(i||(i=this._contextNode),t){var o=("/"==i.getPath()?"":i.getPath())+"/"+e,s=!1;try{i.getChildren().forEach(function(e){if(e.getPath()==o)throw s=!0,new Error})}catch(r){}return s}var n=!1;return this.loadPathInfoSync(i.getPath()+"/"+e,function(e){n=!0}),n},t.prototype.applyCheckHook=function(e){var t,i=PydioApi.getClient();if(i.applyCheckHook(e,"before_create",e.getMetadata().get("filesize")||-1,function(e){t=pydio.getController().parseXmlMessage(e.responseXML)}),t===!1)throw new Error("Check failed")},t.prototype.getUniqueFileName=function(){return this.getFileNames().length?this.getFileNames()[0]:null},t.prototype.getUniqueNode=function(){return this._selectedNodes.length?this._selectedNodes[0]:null},t.prototype.getNode=function(e){return this._selectedNodes[e]},t.prototype.updateFormOrUrl=function(e,t){if(e&&$(e).select('input[type="hidden"]').each(function(e){("nodes[]"==e.name||"file"==e.name)&&e.remove()}),e&&e.rep&&(e.rep.value=this._currentRep),t+="&dir="+encodeURIComponent(this._currentRep),this.isEmpty())return t;for(var i=this.getFileNames(),o=0;o<i.length;o++)t+="&nodes[]="+encodeURIComponent(i[o]),e&&this._addHiddenField(e,"nodes[]",i[o]);return 1==i.length&&(t+="&file="+encodeURIComponent(i[0]),e&&this._addHiddenField(e,"file",i[0])),t},t.prototype._addHiddenField=function(e,t,i){e.insert(new Element("input",{type:"hidden",name:t,value:i}))},t}(Observable),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Registry=function(){function Registry(e){_classCallCheck(this,Registry),this._registry=null,this._extensionsRegistry={editor:[],uploader:[]},this._resourcesRegistry={},this._pydioObject=e}return Registry.prototype.loadFromString=function(e){this._registry=XMLUtils.parseXml(e).documentElement},Registry.prototype.load=function(e,t,i){var o=function(t){null!=t.responseXML&&null!=t.responseXML.documentElement&&("ajxp_registry"==t.responseXML.documentElement.nodeName?(this._registry=t.responseXML.documentElement,e||i||this._pydioObject.fire("registry_loaded",this._registry)):"ajxp_registry_part"==t.responseXML.documentElement.nodeName&&this.refreshXmlRegistryPart(t.responseXML.documentElement),i&&i(this._registry))}.bind(this),s={get_action:"get_xml_registry"};t&&(s.xPath=t),PydioApi.getClient().request(s,o,null,{async:!e})},Registry.prototype.refreshXmlRegistryPart=function(e){var t,i=e.getAttribute("xPath"),o=XMLUtils.XPathSelectSingleNode(this._registry,i);if(o&&o.parentNode)t=o.parentNode,t.removeChild(o),e.firstChild&&t.appendChild(e.firstChild.cloneNode(!0));else if(i.indexOf("/")>-1){var s=i.substring(0,i.lastIndexOf("/"));t=XMLUtils.XPathSelectSingleNode(this._registry,s),t&&e.firstChild&&t.appendChild(e.firstChild.cloneNode(!0))}else e.firstChild&&this._registry.appendChild(e.firstChild.cloneNode(!0));this._pydioObject.fire("registry_part_loaded",i)},Registry.prototype.logXmlUser=function(e){this._pydioObject.user=null;var t;if(this._registry&&(t=XMLUtils.XPathSelectSingleNode(this._registry,"user")),t){var i=t.getAttribute("id"),o=t.childNodes;i&&(this._pydioObject.user=new User(i,o))}e||this._pydioObject.fire("user_logged",this._pydioObject.user)},Registry.prototype.getXML=function(){return this._registry},Registry.prototype.initExtension=function initExtension(xmlNode,extensionDefinition){var activeCondition=XMLUtils.XPathSelectSingleNode(xmlNode,"processing/activeCondition");if(activeCondition&&activeCondition.firstChild)try{var func=new Function(activeCondition.firstChild.nodeValue.trim());if(func()===!1)return!1}catch(e){}if("editor"==xmlNode.nodeName){var properties={openable:"true"==xmlNode.getAttribute("openable"),modalOnly:"true"==xmlNode.getAttribute("modalOnly"),previewProvider:"true"==xmlNode.getAttribute("previewProvider"),order:xmlNode.getAttribute("order")?parseInt(xmlNode.getAttribute("order")):0,formId:xmlNode.getAttribute("formId")||null,text:this._pydioObject.MessageHash[xmlNode.getAttribute("text")],title:this._pydioObject.MessageHash[xmlNode.getAttribute("title")],icon:xmlNode.getAttribute("icon"),icon_class:xmlNode.getAttribute("iconClass"),editorClass:xmlNode.getAttribute("className"),mimes:xmlNode.getAttribute("mimes").split(","),write:xmlNode.getAttribute("write")&&"true"==xmlNode.getAttribute("write")?!0:!1};for(var k in properties)properties.hasOwnProperty(k)&&(extensionDefinition[k]=properties[k])}else if("uploader"==xmlNode.nodeName){var th=this._pydioObject.Parameters.get("theme"),clientForm=XMLUtils.XPathSelectSingleNode(xmlNode,'processing/clientForm[@theme="'+th+'"]');clientForm||(clientForm=XMLUtils.XPathSelectSingleNode(xmlNode,"processing/clientForm")),clientForm&&clientForm.firstChild&&clientForm.getAttribute("id")&&(extensionDefinition.formId=clientForm.getAttribute("id"),this._pydioObject.UI.insertForm(clientForm.getAttribute("id"),clientForm.firstChild.nodeValue)),xmlNode.getAttribute("order")?extensionDefinition.order=parseInt(xmlNode.getAttribute("order")):extensionDefinition.order=0;var extensionOnInit=XMLUtils.XPathSelectSingleNode(xmlNode,"processing/extensionOnInit");if(extensionOnInit&&extensionOnInit.firstChild)try{eval(extensionOnInit.firstChild.nodeValue)}catch(e){Logger.error("Ignoring Error in extensionOnInit code:"),Logger.error(extensionOnInit.firstChild.nodeValue)}var dialogOnOpen=XMLUtils.XPathSelectSingleNode(xmlNode,"processing/dialogOnOpen");dialogOnOpen&&dialogOnOpen.firstChild&&(extensionDefinition.dialogOnOpen=dialogOnOpen.firstChild.nodeValue);var dialogOnComplete=XMLUtils.XPathSelectSingleNode(xmlNode,"processing/dialogOnComplete");dialogOnComplete&&dialogOnComplete.firstChild&&(extensionDefinition.dialogOnComplete=dialogOnComplete.firstChild.nodeValue)}return!0},Registry.prototype.refreshExtensionsRegistry=function(){this._extensionsRegistry={editor:[],uploader:[]};for(var e=XMLUtils.XPathSelectNodes(this._registry,"plugins/editor|plugins/uploader"),t=0;t<e.length;t++){var i={id:e[t].getAttribute("id"),xmlNode:e[t],resourcesManager:new ResourcesManager};this._resourcesRegistry[i.id]=i.resourcesManager;for(var o=XMLUtils.XPathSelectNodes(e[t],"client_settings/resources|dependencies|clientForm"),s=0;s<o.length;s++){var r=o[s];i.resourcesManager.loadFromXmlNode(r)}this.initExtension(e[t],i)&&this._extensionsRegistry[e[t].nodeName].push(i)}ResourcesManager.loadAutoLoadResources(this._registry)},Registry.prototype.getActiveExtensionByType=function(e){return this._extensionsRegistry[e]},Registry.prototype.findEditorById=function(e){return this._extensionsRegistry.editor.find(function(t){return t.id==e})},Registry.prototype.findEditorsForMime=function(e,t){var i=[],o=!1;return null==this.user||this.user.canWrite()||(o=!0),this._extensionsRegistry.editor.forEach(function(s){if(-1!==s.mimes.indexOf(e)||-1!==s.mimes.indexOf("*")){if(t&&!s.previewProvider)return;o&&s.write||i.push(s)}}),i.length&&i.length>1&&(i=i.sort(function(e,t){return(e.order||0)-(t.order||0)})),i},Registry.prototype.loadEditorResources=function(e){e.load(this._resourcesRegistry)},Registry.prototype.getPluginConfigs=function(e){var t='plugins/*[@id="core.'+e+'"]/plugin_configs/property | plugins/*[@id="'+e+'"]/plugin_configs/property';-1==e.indexOf(".")&&(t="plugins/"+e+"/plugin_configs/property |"+t);var i=XMLUtils.XPathSelectNodes(this._registry,t),o=new Map;return i.forEach(function(e){o.set(e.getAttribute("name"),JSON.parse(e.firstChild.nodeValue))}),o},Registry.prototype.getDefaultImageFromParameters=function(e,t){var i=XMLUtils.XPathSelectSingleNode(this._registry,"plugins/*[@id='"+e+"']/server_settings/global_param[@name='"+t+"']");return i?i.getAttribute("defaultImage")||"":""},Registry.prototype.hasPluginOfType=function(e,t){var i;return i=null==t?XMLUtils.XPathSelectSingleNode(this._registry,'plugins/ajxp_plugin[contains(@id, "'+e+'.")] | plugins/'+e+"[@id]"):XMLUtils.XPathSelectSingleNode(this._registry,'plugins/ajxp_plugin[@id="'+e+"."+t+'"] | plugins/'+e+'[@id="'+e+"."+t+'"]'),void 0!=i},Registry}(),_classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(e.__proto__=t)},Pydio=function(_Observable){function Pydio(e){_classCallCheck(this,Pydio),_Observable.call(this),this.Parameters=e,this._initLoadRep=e.get("initLoadRep")||null,this.usersEnabled=e.get("usersEnabled")||null,this.currentLanguage=e.get("currentLanguage")||null,this.appTitle="Pydio",this.Parameters.has("customWording")&&(this.appTitle=this.Parameters.get("customWording").title||"Pydio"),this.MessageHash={},window.MessageHash&&(this.MessageHash=window.MessageHash),this.ApiClient=PydioApi.getClient(),this.ApiClient.setPydioObject(this),this.Registry=new Registry(this),this._rootNode=new AjxpNode("/","Root"),this._dataModel=this._contextHolder=new PydioDataModel(!1),this._dataModel.setAjxpNodeProvider(new RemoteNodeProvider),this._dataModel.setRootNode(this._rootNode),this.Controller=new Controller(this)}return _inherits(Pydio,_Observable),Pydio.prototype.fire=function(e,t){this.notify(e,t),document.fire&&document.fire("ajaxplorer:"+e,t)},Pydio.prototype.init=function(){if(!this.Parameters.has("SECURE_TOKEN"))return void PydioApi.getClient().getBootConf(function(){this.init()}.bind(this));window.PydioUI?this.UI=new PydioUI(this):this.UI={guiLoaded:!0,modal:{setLoadingStepCounts:function(){},refreshDialogAppearance:function(){},displayMessage:function(){},initForms:function(){},updateLoadingProgress:function(e){Logger.log(e)},prepareHeader:function(){},showModalDialog:function(){}},refreshTemplateParts:function(){},initTemplates:function(){},initObjects:function(){},updateI18nTags:function(){},insertForm:function(e,t){},removeForm:function(e){}},this.observe("registry_loaded",function(){if(this.Registry.refreshExtensionsRegistry(),this.Registry.logXmlUser(!1),this.user){var e=this.user.getActiveRepository(),t=this.user.getRepositoriesList(),i=t.get(e);i&&i.loadResources()}if(this.UI.guiLoaded?(this.UI.refreshTemplateParts(),this.Registry.refreshExtensionsRegistry(),this.Controller.loadActionsFromRegistry(this.getXmlRegistry())):this.observe("gui_loaded",function(){this.UI.refreshTemplateParts(),this.Registry.refreshExtensionsRegistry(),this.Controller.loadActionsFromRegistry(this.getXmlRegistry())}.bind(this)),this.loadActiveRepository(),this.Parameters.has("USER_GUI_ACTION")){var o=this.Parameters.get("USER_GUI_ACTION");this.Parameters["delete"]("USER_GUI_ACTION");var s=this.Controller;window.setTimeout(function(){s.fireAction(o)},2e3)}}.bind(this)),this.UI.modal&&this.UI.modal.setLoadingStepCounts(5);var e=function(){this.UI.initTemplates(),this.UI.modal&&this.UI.modal.initForms(),this.UI.initObjects(),this.tryLogUserFromCookie(),this.fire("registry_loaded",this.Registry.getXML()),window.setTimeout(function(){this.fire("loaded")}.bind(this),200),this.Router=new Router(this)}.bind(this);this.Parameters.get("PRELOADED_REGISTRY")?(this.Registry.loadFromString(this.Parameters.get("PRELOADED_REGISTRY")),this.Parameters["delete"]("PRELOADED_REGISTRY"),this.UI.modal&&this.UI.modal.updateLoadingProgress("XML Registry loaded"),e()):this.loadXmlRegistry(!1,null,e),this.observe("server_message",function(e){XMLUtils.XPathSelectSingleNode(e,"tree/require_registry_reload")&&(this.repositoryId=null,this.loadXmlRegistry(!1))}.bind(this))},Pydio.prototype.loadXmlRegistry=function(e){var t=void 0===arguments[1]?null:arguments[1],i=void 0===arguments[2]?null:arguments[2];this.Registry.load(e,t,i)},Pydio.prototype.getXmlRegistry=function(){return this.Registry.getXML()},Pydio.prototype.tryLogUserFromCookie=function(){},Pydio.prototype.loadActiveRepository=function(){var e=new Repository(null);if(null!=this.user){var t=this.user.getActiveRepository(),i=this.user.getRepositoriesList();if(e=i.get(t),!e){if(this.user.lock)return this.Controller.loadActionsFromRegistry(this.getXmlRegistry()),void window.setTimeout(function(){this.Controller.fireAction(this.user.lock)}.bind(this),50);alert("No active repository found for user!")}if(this.user.getPreference("pending_folder")&&"-1"!=this.user.getPreference("pending_folder"))this._initLoadRep=this.user.getPreference("pending_folder"),this.user.setPreference("pending_folder","-1"),this.user.savePreference("pending_folder");else if(this.user.getPreference("ls_history",!0)){var o=this.user.getPreference("ls_history",!0);this._initLoadRep=o[t]}}this.loadRepository(e),i&&t?this.fire("repository_list_refreshed",{list:i,active:t}):this.fire("repository_list_refreshed",{list:!1,active:!1})},Pydio.prototype.reloadRepositoriesList=function(){this.user&&(this.observeOnce("registry_part_loaded",function(e){"user/repositories"==e&&(this.Registry.logXmlUser(!0),document.fire("ajaxplorer:repository_list_refreshed",{list:this.user.getRepositoriesList(),active:this.user.getActiveRepository()}))}.bind(this)),this.loadXmlRegistry(!1,"user/repositories"))},Pydio.prototype.loadRepository=function loadRepository(repository){if(null!=this.repositoryId&&this.repositoryId==repository.getId()&&Logger.debug("Repository already loaded, do nothing"),this._contextHolder.setSelectedNodes([]),null!=repository){repository.loadResources();var repositoryId=repository.getId(),newIcon=repository.getIcon();this.skipLsHistory=!0;var providerDef=repository.getNodeProviderDef(),rootNode;if(null!=providerDef){var provider=eval("new "+providerDef.name+"()");providerDef.options&&provider.initProvider(providerDef.options),this._contextHolder.setAjxpNodeProvider(provider),rootNode=new AjxpNode("/",!1,repository.getLabel(),newIcon,provider)}else rootNode=new AjxpNode("/",!1,repository.getLabel(),newIcon),this._contextHolder.setAjxpNodeProvider(new RemoteNodeProvider);if(this._contextHolder.setRootNode(rootNode),rootNode.observeOnce("first_load",function(){this._contextHolder.notify("context_changed",rootNode)}.bind(this)),this.repositoryId=repositoryId,this._initLoadRep)if(""!=this._initLoadRep&&"/"!=this._initLoadRep){var copy=this._initLoadRep.valueOf();this._initLoadRep=null,rootNode.observeOnce("first_load",function(){setTimeout(function(){this.goTo(copy),this.skipLsHistory=!1}.bind(this),1e3)}.bind(this))}else this.skipLsHistory=!1;else this.skipLsHistory=!1;rootNode.load()}},Pydio.prototype.goTo=function(e){var t;if("string"==typeof e)t=e;else if(t=e.getPath(),e.getMetadata().has("repository_id")&&e.getMetadata().get("repository_id")!=this.repositoryId&&"repository"!=e.getAjxpMime()&&"repository_editable"!=e.getAjxpMime())return this.user&&this.user.setPreference("pending_folder",e.getPath()),void this.triggerRepositoryChange(e.getMetadata().get("repository_id"));var i=this._contextHolder.getContextNode();if(!i||i.getPath()!=t){var o;return""==t||"/"==t?(o=new AjxpNode("/"),void this._contextHolder.requireContextChange(o)):void this._contextHolder.loadPathInfoAsync(t,function(e){e.isLeaf()&&"ajxp_browsable_archive"!=e.getAjxpMime()?(this._contextHolder.setPendingSelection(PathUtils.getBasename(t)),o=new AjxpNode(PathUtils.getDirname(t))):o=e,this._contextHolder.requireContextChange(o)}.bind(this))}},Pydio.prototype.triggerRepositoryChange=function(e){this.fire("trigger_repository_switch");var t=function(e){e.responseXML&&this.Controller.parseXmlMessage(e.responseXML),this.repositoryId=null,this.loadXmlRegistry()}.bind(this),i=this._contextHolder.getRootNode();i&&(this.skipLsHistory=!0,i.clear()),this.ApiClient.switchRepository(e,t)},Pydio.prototype.getPluginConfigs=function(e){return this.Registry.getPluginConfigs(e)},Pydio.prototype.loadI18NMessages=function(e){var t=function(t){if(t.responseJSON){this.MessageHash=t.responseJSON;for(var i in this.MessageHash)this.MessageHash.hasOwnProperty(i)&&(this.MessageHash[i]=this.MessageHash[i].replace("\\n","\n"));this.UI.updateI18nTags(),this.Controller.refreshGuiActionsI18n(),this.loadXmlRegistry(),this.fireContextRefresh(),this.currentLanguage=e}}.bind(this);this.ApiClient.switchLanguage(e,t)},Pydio.prototype.getController=function(){return this.Controller},Pydio.prototype.displayMessage=function(e,t){var i=LangUtils.parseUrl(t);
i.length&&this.user&&this.user.repositories&&i.forEach(function(e){var i=this.user.repositories.get(e.host);i&&(t=t.replace(e.url,i.label+":"+e.path+e.file))}.bind(this)),"ERROR"==e?Logger.error(t):Logger.log(t),this.UI.modal&&this.UI.modal.displayMessage(e,t)},Pydio.prototype.updateContextData=function(e,t,i){e&&this._contextHolder.requireContextChange(e),t&&this._contextHolder.setSelectedNodes(t,i)},Pydio.prototype.getContextHolder=function(){return this._contextHolder},Pydio.prototype.getContextNode=function(){return this._contextHolder.getContextNode()||new AjxpNode("")},Pydio.prototype.getUserSelection=function(){return this._contextHolder},Pydio.prototype.fireContextRefresh=function(){this.getContextHolder().requireContextChange(this.getContextNode(),!0)},Pydio.prototype.fireNodeRefresh=function(e,t){this.getContextHolder().requireNodeReload(e,t)},Pydio.prototype.fireContextUp=function(){this.getContextNode().isRoot()||this.updateContextData(this.getContextNode().getParent())},Pydio}(Observable);