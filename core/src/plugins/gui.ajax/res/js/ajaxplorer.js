function initializeLightbox(){addLightboxMarkup(),Event.observe(document,"keydown",function(e){return null==e&&(e=window.event),27==e.keyCode&&(modal.currentLightBoxElement?(removeLightboxFromElement(modal.currentLightBoxElement),modal.currentLightBoxModal&&modal.currentLightBoxModal.parentNode&&modal.currentLightBoxModal.remove(),modal.currentLightBoxElement=null,modal.currentLightBoxModal=null):hideLightBox()),9==e.keyCode?!1:!0})}function displayLightBoxById(id,overlayStyle,overlayClass){var valid=new lightbox(id);overlayStyle&&(valid.overlayStyle=overlayStyle),overlayClass&&(valid.overlayClass=overlayClass),valid.activate(),currentLightBox=valid}function hideLightBox(onFormSubmit){if(modal.closeValidation){var res=modal.closeValidation();if(res===!1)return!1;modal.closeValidation=null}return currentLightBox&&(currentLightBox.deactivate(),hideOverlay(),onFormSubmit||(currentLightBox=null),pydio.UI.enableNavigation(),pydio.UI.focusLast(),pydio.UI.enableShortcuts(),document.fire("ajaxplorer:selection_changed")),currentDraggable&&currentDraggable.destroy(),modal.closeFunction&&(modal.closeFunction(),modal.closeFunction=null),!0}function setOverlay(){currentLightBox=new lightbox(null),currentLightBox.activate()}function hideOverlay(){currentLightBox&&(currentLightBox.deactivate(),currentLightBox=null)}function addLightboxMarkup(){var bod=document.getElementsByTagName("body")[0],overlay=document.createElement("div");overlay.id="overlay",bod.appendChild(overlay)}function addLightboxMarkupToElement(element,skipElement){var overlay=document.createElement("div");overlay.id="element_overlay";var top,left,height,width;if(Prototype.Browser.IE){var position=Position.positionedOffset($(element));top=position[1],left=0}else{var position=Position.cumulativeOffset($(element));top=position[1],left=position[0]}if(width=element.getWidth(),height=element.getHeight(),skipElement){var addTop=top+parseInt(skipElement.getHeight()),addHeight=height+parseInt(skipElement.getHeight());top=addTop+"px",height=addHeight+"px"}var borders={top:parseInt(element.getStyle("borderTopWidth")),bottom:parseInt(element.getStyle("borderBottomWidth")),right:parseInt(element.getStyle("borderRightWidth")),left:parseInt(element.getStyle("borderLeftWidth"))};top+=borders.top,height-=borders.top+borders.bottom,left+=borders.left,width-=borders.left+borders.right,$(overlay).setStyle({top:top,left:left,height:height,width:width}),element.appendChild(overlay)}function removeLightboxFromElement(element){$(element).select("#element_overlay").invoke("remove")}function WebFXCookie(){document.cookie.length&&(this.cookies=" "+document.cookie)}function WebFXTreeAbstractNode(sText,sAction){this.childNodes=[],this.id=webFXTreeHandler.getId(),this.text=sText||webFXTreeConfig.defaultText,this.action=sAction||null,this.url="/",this._last=!1,webFXTreeHandler.all[this.id]=this}function WebFXTreeBufferTreeChange(){window.webfxtreebufferTimer&&window.clearTimeout(window.webfxtreebufferTimer),window.webfxtreebufferTimer=window.setTimeout(function(){document.fire("ajaxplorer:tree_change")},200)}function WebFXTree(sText,sAction,sBehavior,sIcon,sOpenIcon){this.base=WebFXTreeAbstractNode,this.base(sText,sAction),this.icon=sIcon||webFXTreeConfig.rootIcon,this.openIcon=sOpenIcon||webFXTreeConfig.openRootIcon,webFXTreeConfig.usePersistence?this.open="0"==webFXTreeHandler.cookies.getCookie(this.id.substr(18,this.id.length-18))?!1:!0:this.open=!0,this.folder=!0,this.rendered=!1,this.onSelect=null,webFXTreeHandler.behavior||(webFXTreeHandler.behavior=sBehavior||webFXTreeConfig.defaultBehavior)}function WebFXTreeItem(sText,sAction,eParent,sIcon,sOpenIcon,sOverlayIcon,sOverlayClasses){this.base=WebFXTreeAbstractNode,this.base(sText,sAction),webFXTreeConfig.usePersistence?this.open="1"==webFXTreeHandler.cookies.getCookie(this.id.substr(18,this.id.length-18))?!0:!1:this.open=!1,sIcon&&(this.icon=sIcon),sOpenIcon&&(this.openIcon=sOpenIcon),sOverlayIcon&&(this.overlayIcon=sOverlayIcon),sOverlayClasses&&(this.overlayClasses=sOverlayClasses),eParent&&eParent.add(this)}function splitOverlayIcons(ajxpNode){if(window.ajaxplorer.currentThemeUsesIconFonts||!ajxpNode.getMetadata().get("overlay_icon")||!Modernizr.multiplebgs)return!1;var ret=[];return $A(ajxpNode.getMetadata().get("overlay_icon").split(",")).each(function(el){ret.push(resolveImageSource(el,"/images/overlays/ICON_SIZE",8))}),ret}function splitOverlayClasses(ajxpNode){return ajxpNode.getMetadata().get("overlay_class")&&window.ajaxplorer.currentThemeUsesIconFonts?ajxpNode.getMetadata().get("overlay_class").split(","):!1}function AJXPTree(rootNode,sAction,filter){this.WebFXTree=WebFXTree,this.loaded=!0,this.ajxpNode=rootNode;var icon=rootNode.getIcon();0!=icon.indexOf(ajxpResourcesFolder+"/")&&(icon=resolveImageSource(icon,"/images/mimes/ICON_SIZE",16));var openIcon=rootNode.getMetadata().get("openicon");openIcon?0!=openIcon.indexOf(ajxpResourcesFolder+"/")&&(openIcon=resolveImageSource(openIcon,"/images/mimes/ICON_SIZE",16)):openIcon=icon,this.WebFXTree(rootNode.getLabel(),sAction,"explorer",icon,openIcon),this.loading=!1,this.loaded=!1,this.errorText="",filter&&(this.filter=filter),this.overlayIcon=splitOverlayIcons(rootNode),this.overlayClasses=splitOverlayClasses(rootNode),this._loadingItem=new WebFXTreeItem(MessageHash?MessageHash[466]:webFXTreeConfig.loadingText),this.open?this.ajxpNode.load():this.add(this._loadingItem)}function AJXPTreeItem(ajxpNode,sAction,eParent){this.WebFXTreeItem=WebFXTreeItem,this.ajxpNode=ajxpNode;var icon=ajxpNode.getIcon();0!=icon.indexOf(ajxpResourcesFolder+"/")&&(icon=resolveImageSource(icon,"/images/mimes/ICON_SIZE",16));var openIcon=ajxpNode.getMetadata().get("openicon");openIcon?0!=openIcon.indexOf(ajxpResourcesFolder+"/")&&(openIcon=resolveImageSource(openIcon,"/images/mimes/ICON_SIZE",16)):openIcon=icon,this.folder=!0,this.WebFXTreeItem(ajxpNode.getLabel(),sAction,eParent,icon,openIcon?openIcon:resolveImageSource("folder_open.png","/images/mimes/ICON_SIZE",16),splitOverlayIcons(ajxpNode),splitOverlayClasses(ajxpNode)),this.loading=!1,this.loaded=!1,this.errorText="",this._loadingItem=new WebFXTreeItem(MessageHash?MessageHash[466]:webFXTreeConfig.loadingText),this.open?this.ajxpNode.load():this.add(this._loadingItem),webFXTreeHandler.all[this.id]=this}function _ajxpNodeToTree(ajxpNode,parentNode){if(parentNode.filter&&!parentNode.filter(ajxpNode))return!1;var jsNode=new AJXPTreeItem(ajxpNode,null,parentNode);return ajxpNode.isLoaded()&&(jsNode.loaded=!0),jsNode.filename=ajxpNode.getPath(),parentNode.filter&&(jsNode.filter=parentNode.filter),jsNode.overlayIcon=splitOverlayIcons(ajxpNode),ProtoCompat.map2hash(ajxpNode.getChildren()).each(function(child){var newNode=_ajxpNodeToTree(child,jsNode);newNode&&(jsNode.filter&&(newNode.filter=jsNode.filter),newNode.overlayIcon=splitOverlayIcons(child),newNode.overlayClasses=splitOverlayClasses(child),jsNode.add(newNode,!1))}),jsNode}if(Interface.create("IAjxpNodeProvider",{initProvider:function(properties){},loadNode:function(nodePath,nodeCallback,childCallback){},loadLeafNodeSync:function(node,callback){}}),Interface.create("IAjxpWidget",{resize:function(){},showElement:function(show){},getDomNode:function(){},destroy:function(){}}),Interface.create("IActionProvider",{getActions:function(){}}),Interface.create("IFocusable",{setFocusBehaviour:function(){},focus:function(){},blur:function(){}}),Interface.create("IContextMenuable",{setContextualMenu:function(contextMenu){}}),Class.create("AjxpPane",{__implements:"IAjxpWidget",childrenPanes:null,initialize:function(htmlElement,options){if(this.htmlElement=$(htmlElement),!this.htmlElement)throw new Error("Cannot find element for AjxpPane : "+this.__className);this.options=options||{},this.htmlElement.ajxpPaneObject=this,this.htmlElement.getAttribute("ajxpPaneHeader")&&this.addPaneHeader(this.htmlElement.getAttribute("ajxpPaneHeader"),this.htmlElement.getAttribute("ajxpPaneIcon")),this.htmlElement&&this.options.elementStyle&&this.htmlElement.setStyle(this.options.elementStyle),this.scanChildrenPanes(this.htmlElement,!0),this.options.bindSizeTo&&(this.boundSizeEvents=$H(),this.options.bindSizeTo.width&&this.options.bindSizeTo.width.events.each(function(eventName){var binder=this.resizeBound.bind(this);this.boundSizeEvents.set("ajaxplorer:"+eventName,binder),document.observe("ajaxplorer:"+eventName,binder)}.bind(this))),this.options.resize_events&&(this.resizeEvents=$H(),this.options.resize_events.each(function(eventName){var binder=this.resize.bind(this);this.resizeEvents.set("ajaxplorer:"+eventName,binder),document.observe("ajaxplorer:"+eventName,binder)}.bind(this))),this.options.messageBoxReference&&ajaxplorer&&pydio.UI.registerAsMessageBoxReference(this.htmlElement),this.options.imageBackgroundFromConfigs&&this.buildImageBackgroundFromConfigs(this.options.imageBackgroundFromConfigs),this.configObserver=function(event){event.memo.className=="AjxpPane::"+htmlElement.id&&this.parseComponentConfig(event.memo.classConfig.get("all"))}.bind(this),document.observe("ajaxplorer:component_config_changed",this.configObserver),this.options.replaceScroller&&(this.scroller=new Element("div",{id:"scroller_"+this.htmlElement.id,className:"scroller_track"}),this.scroller.insert(new Element("div",{id:"scrollbar_handle_"+this.htmlElement.id,className:"scroller_handle"})),this.htmlElement.insert(this.scroller),this.htmlElement.setStyle({overflow:"hidden"}),Modernizr.flexbox||this.scroller.setStyle({height:this.htmlElement.getHeight()+"px"}),this.scrollbar=new Control.ScrollBar(this.htmlElement,this.scroller,{fixed_scroll_distance:50}));var cPref=this.getUserPreference("rootElementClassPreference");if(cPref){Object.isString(cPref)&&(cPref={className:cPref});var cName=cPref.className;cName&&("!"==cName[0]?(cName=cName.substring(1),this.htmlElement.removeClassName(cName)):this.htmlElement.addClassName(cName),cPref.externalButtonId&&$(cPref.externalButtonId)&&$(cPref.externalButtonId).toggleClassName(cPref.externalButtonClassName))}},parseComponentConfig:function(domNode){var contentNodes=XMLUtils.XPathSelectNodes(domNode,"additional_content"),detectedClasses=$H();contentNodes.each(function(n){var cdataContent=n.firstChild.nodeValue;cdataContent&&(detectedClasses=detectedClasses.merge(pydio.UI.findAjxpClassesInText(cdataContent)))}),ResourcesManager.loadClassesAndApply(detectedClasses.keys(),function(){var change=!1;contentNodes.each(function(addNode){var cdataContent=addNode.firstChild.nodeValue,anchor=this.htmlElement;if(cdataContent&&anchor&&!anchor.down("#"+addNode.getAttribute("id"))){anchor.insert(cdataContent);var compReg=$A();pydio.UI.buildGUI(anchor.down("#"+addNode.getAttribute("id")),compReg),compReg.length&&pydio.UI.initAjxpWidgets(compReg),change=!0}}.bind(this)),change&&(this.scanChildrenPanes(this.htmlElement,!0),this.resize(),this.reorderContents())}.bind(this))},reorderContents:function(){var pos={};this.htmlElement.select("> div[ajxp_position]").each(function(d){pos[parseInt(d.readAttribute("ajxp_position"))]=d});var keys=$H(pos).keys();keys.length&&(keys.sort(),keys.each(function(k){this.htmlElement.insert(pos[k])}.bind(this)))},resizeBound:function(event){"use strict";if($(this.options.bindSizeTo.width.id)&&this.htmlElement){var min=this.options.bindSizeTo.width.min;Object.isString(min)&&0!=min.indexOf("%")&&(min=this.htmlElement.parentNode.getWidth()*min/100);var w=Math.max($(this.options.bindSizeTo.width.id).getWidth()+this.options.bindSizeTo.width.offset,min);if(this.options.bindSizeTo.width.max){var max=this.options.bindSizeTo.width.max;Object.isString(max)&&0!=max.indexOf("%")&&(max=this.htmlElement.parentNode.getWidth()*max/100),w=Math.min(max,w)}this.options.bindSizeTo.width.checkSiblings&&(w=this.filterWidthFromSiblings(w)),this.htmlElement.setStyle({width:w+"px"}),this.resize(),this.options.bindSizeTo.width.checkSiblings&&this.htmlElement.siblings().each(function(s){s.ajxpPaneObject&&s.ajxpPaneObject.resize()})}},filterWidthFromSiblings:function(original){"use strict";if(!this.htmlElement||!this.htmlElement.parentNode)return null;var parentWidth=this.htmlElement.parentNode.getWidth(),siblingWidth=0;return this.htmlElement.siblings().each(function(s){s.hasClassName("skipSibling")||(siblingWidth+=s.ajxpPaneObject&&s.ajxpPaneObject.getActualWidth?s.ajxpPaneObject.getActualWidth():s.getWidth())}),original=Math.min(original,parentWidth-siblingWidth-20)},resize:function(){if(this.options.fit&&"height"==this.options.fit){var marginBottom=0;if(this.options.fitMarginBottom){var expr=this.options.fitMarginBottom;try{marginBottom=parseInt(eval(expr))}catch(e){}}var minOffsetTop=0;if(this.options.fitMinOffsetTop){var expr2=this.options.fitMinOffsetTop;try{minOffsetTop=parseInt(eval(expr2))}catch(e){}}fitHeightToBottom(this.htmlElement,this.options.fitParent,marginBottom,!1,minOffsetTop),this.scrollbar&&this.scrollbar.recalculateLayout(this.htmlElement.getHeight())}if(this.options.flexTo&&(!Modernizr.flexbox||!$(this.options.flexTo).hasClassName("horizontal_layout"))){var parentWidth=$(this.options.flexTo).getWidth(),siblingWidth=0;this.htmlElement.siblings().each(function(s){s.hasClassName("skipSibling")||"style"==s.tagName.toLowerCase()||(siblingWidth+=s.ajxpPaneObject&&s.ajxpPaneObject.getActualWidth?s.ajxpPaneObject.getActualWidth():s.getWidth())});var buttonsWidth=0;this.htmlElement.select("div.inlineBarButton,div.inlineBarButtonLeft,div.inlineBarButtonRight").each(function(el){buttonsWidth+=el.getWidth()});var newWidth=parentWidth-siblingWidth;this.options.flexToMargin&&(newWidth-=this.options.flexToMargin),5>newWidth?this.htmlElement.hide():(this.htmlElement.show(),this.htmlElement.setStyle({width:newWidth+"px"}))}if(this.options.imageBackgroundFromConfigs&&this.htmlElement.getHeight()){var ratio=this.htmlElement.getWidth()/this.htmlElement.getHeight();1>ratio?this.htmlElement.addClassName("fit_background_height"):this.htmlElement.removeClassName("fit_background_height")}this.childrenPanes.invoke("resize")},getDomNode:function(){return this.htmlElement},destroy:function(){if(this.childrenPanes.each(function(child){child.destroy()}),this.htmlElement){this.htmlElement.update("");try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}this.htmlElement=null,this.boundSizeEvents&&this.boundSizeEvents.each(function(pair){document.stopObserving(pair.key,pair.value)}),this.resizeEvents&&this.resizeEvents.each(function(pair){document.stopObserving(pair.key,pair.value)}),Class.objectImplements(this,"IFocusable")&&pydio.UI.unregisterFocusable(this),Class.objectImplements(this,"IActionProvider")&&this.getActions().each(function(act){pydio.getController().deleteFromGuiActions(act.key)}.bind(this)),this.configObserver&&document.stopObserving("ajaxplorer:component_config_changed",this.configObserver)}},scanChildrenPanes:function(element,reset){element.childNodes&&(reset&&(this.childrenPanes=$A()),$A(element.childNodes).each(function(c){c.ajxpPaneObject?(this.childrenPanes||(this.childrenPanes=$A()),this.childrenPanes.push(c.ajxpPaneObject)):this.scanChildrenPanes(c)}.bind(this)))},showElement:function(show){show?(this.htmlElement.show(),this.childrenPanes&&this.childrenPanes.invoke("showElement",show)):(this.childrenPanes&&this.childrenPanes.invoke("showElement",show),this.htmlElement.hide())},addPaneHeader:function(headerLabel,headerIcon){var ic,label=new Element("span",{ajxp_message_id:headerLabel}).update(MessageHash[headerLabel]),header=new Element("div",{className:"panelHeader"}).update(label);if(headerIcon&&(ic=resolveImageSource(headerIcon,"/images/actions/ICON_SIZE",16),header.insert({top:new Element("img",{src:ic,className:"panelHeaderIcon"})}),header.addClassName("panelHeaderWithIcon")),this.options.headerClose){ic=resolveImageSource(this.options.headerClose.icon,"/images/actions/ICON_SIZE",16);var img=new Element("img",{src:ic,className:"panelHeaderCloseIcon",title:MessageHash[this.options.headerClose.title]});header.insert({top:img});var sp=this.options.headerClose.splitter;img.observe("click",function(){window[sp].fold()})}if(this.htmlElement.insert({top:header}),disableTextSelection(header),this.options.headerToolbarOptions){var tbD=new Element("div",{id:"display_toolbar"});header.insert({top:tbD}),new ActionsToolbar(tbD,this.options.headerToolbarOptions)}},setFocusBehaviour:function(){this.htmlElement.observe("click",function(){pydio&&pydio.UI.focusOn(this)}.bind(this))},toggleClassNameSavingPref:function(className,externalButtonId,externalButtonClassName){var invert=!1;"!"==className[0]&&(className=className.substring(1),invert=!0),this.htmlElement.toggleClassName(className),externalButtonId&&$(externalButtonId).toggleClassName(externalButtonClassName);var pref={externalButtonId:externalButtonId,externalButtonClassName:externalButtonClassName};invert?pref.className=this.htmlElement.hasClassName(className)?"":"!"+className:pref.className=this.htmlElement.hasClassName(className)?className:"",this.setUserPreference("rootElementClassPreference",pref)},getUserPreference:function(prefName){if(!ajaxplorer||!ajaxplorer.user||!this.htmlElement)return null;var gui_pref=ajaxplorer.user.getPreference("gui_preferences",!0),classkey=this.htmlElement.id+"_"+this.__className;return gui_pref&&gui_pref[classkey]?ajaxplorer.user.activeRepository&&gui_pref[classkey]["repo-"+ajaxplorer.user.activeRepository]?gui_pref[classkey]["repo-"+ajaxplorer.user.activeRepository][prefName]:gui_pref[classkey][prefName]:null},setUserPreference:function(prefName,prefValue){if(ajaxplorer&&ajaxplorer.user&&this.htmlElement){var guiPref=ajaxplorer.user.getPreference("gui_preferences",!0);guiPref||(guiPref={});var classkey=this.htmlElement.id+"_"+this.__className;if(guiPref[classkey]||(guiPref[classkey]={}),ajaxplorer.user.activeRepository){var repokey="repo-"+ajaxplorer.user.activeRepository;if(guiPref[classkey][repokey]||(guiPref[classkey][repokey]={}),guiPref[classkey][repokey][prefName]&&guiPref[classkey][repokey][prefName]==prefValue)return;guiPref[classkey][repokey][prefName]=prefValue}else{if(guiPref[classkey][prefName]&&guiPref[classkey][prefName]==prefValue)return;guiPref[classkey][prefName]=prefValue}ajaxplorer.user.setPreference("gui_preferences",guiPref,!0),ajaxplorer.user.savePreference("gui_preferences")}},buildImageBackgroundFromConfigs:function(configName,forceConfigs){var bgrounds,paramPrefix,bStyles,index,i;if(forceConfigs){for(bgrounds=forceConfigs,paramPrefix=configName,bStyles=[],index=1;bgrounds[paramPrefix+index];)bStyles.push("background-image:url('"+bgrounds[paramPrefix+index]+"');"+(bgrounds[paramPrefix+"ATTRIBUTES_"+index]?bgrounds[paramPrefix+"ATTRIBUTES_"+index]:"")),index++;return void(bStyles.length&&(i=Math.floor(Math.random()*bStyles.length),this.htmlElement.setAttribute("style",bStyles[i])))}var exp=configName.split("/"),plugin=exp[0];paramPrefix=exp[1];var registry=ajaxplorer.getXmlRegistry(),configs=XPathSelectNodes(registry,"plugins/*[@id='"+plugin+"']/plugin_configs/property[contains(@name, '"+paramPrefix+"')]"),defaults=XPathSelectNodes(registry,"plugins/*[@id='"+plugin+"']/server_settings/global_param[contains(@name, '"+paramPrefix+"')]");for(bgrounds={},configs.each(function(c){bgrounds[c.getAttribute("name")]=c.firstChild.nodeValue.replace(/"/g,"")}),defaults.each(function(d){if(d.getAttribute("defaultImage")){var n=d.getAttribute("name");bgrounds[n]?getBaseName(bgrounds[n])==bgrounds[n]&&(bgrounds[n]=window.ajxpServerAccessPath+"&get_action=get_global_binary_param&binary_id="+bgrounds[n]):bgrounds[n]=d.getAttribute("defaultImage")}}),bStyles=[],index=1;bgrounds[paramPrefix+index];)bStyles.push("background-image:url('"+bgrounds[paramPrefix+index]+"');"+(bgrounds[paramPrefix+"ATTRIBUTES_"+index]?bgrounds[paramPrefix+"ATTRIBUTES_"+index]:"")),index++;if(bStyles.length){i=Math.floor(Math.random()*bStyles.length);var bg=bStyles[i];Modernizr.backgroundsize&&(bg=bg.replace("background-size:100%","background-size:cover").replace("background-size:140%","background-size:cover")),this.htmlElement.setAttribute("style",bg)}}}),Class.create("SelectableElements",{initialize:function(oElement,bMultiple){null!=oElement&&this.initSelectableItems(oElement,bMultiple)},initNonSelectableItems:function(oElement){this._htmlElement=oElement,this._multiple=!1,this._selectedItems=[],this._fireChange=!0,this.hasFocus=!1},initSelectableItems:function(oElement,bMultiple,dragSelectionElement,addTouch){this._htmlElement=oElement,this._multiple=Boolean(bMultiple),this._selectedItems=[],this._fireChange=!0,this.hasFocus=!1,this._onclick=function(e){null==e&&(e=oElement.ownerDocument.parentWindow.event),this.click(e)}.bind(this),$(this._htmlElement).observe("contextmenu",function(e){this._selectedItems.length>1||this.click(e)}.bind(this)),this._ondblclick=function(e){null==e&&(e=oElement.ownerDocument.parentWindow.event),this.dblClick(e)}.bind(this),oElement.addEventListener?("ondblclick"in document.documentElement&&oElement.addEventListener("dblclick",this._ondblclick,!1),oElement.addEventListener("click",this._onclick,!1)):oElement.attachEvent&&(oElement.attachEvent("onclick",this._onclick),oElement.attachEvent("ondblclick",this._ondblclick)),addTouch&&(oElement.observe("touchstart",function(event){var touchData=event.changedTouches[0];oElement.selectableTouchStart=touchData.clientY}.bind(this)),oElement.observe("touchend",function(event){if(oElement.selectableTouchStart){var touchData=event.changedTouches[0],delta=touchData.clientY-oElement.selectableTouchStart;if(Math.abs(delta)>2)return}oElement.selectableTouchStart=null,this._onclick(event)}.bind(this))),this.eventMouseUp=this.dragEnd.bindAsEventListener(this),this.eventMouseDown=this.dragStart.bindAsEventListener(this),this.eventMouseMove=this.drag.bindAsEventListener(this),this.selectorAdded=!1,dragSelectionElement?this.dragSelectionElement=$(dragSelectionElement):this.dragSelectionElement=$(oElement),Event.observe(this.dragSelectionElement,"mousedown",this.eventMouseDown)},dragStart:function(e){this.originalX=e.clientX,this.originalY=e.clientY,this.dSEPosition=Position.cumulativeOffset(this.dragSelectionElement),this.dSEDimension=Element.getDimensions(this.dragSelectionElement);var h=this.dSEDimension.height;this.dragSelectionElement.scrollHeight>h&&this.originalX>this.dSEPosition[0]+this.dSEDimension.width-18||this.dragSelectionElement.scrollWidth>this.dSEDimension.width&&this.originalY>this.dSEPosition[1]+this.dSEDimension.height-18||(Event.observe(document,"mousemove",this.eventMouseMove),Event.observe(document,"mouseup",this.eventMouseUp),this.divSelector||(this.divSelector=new Element("div",{style:"border : 1px dotted #999; background-color:#ddd;	filter:alpha(opacity=50);opacity: 0.5;-moz-opacity:0.5;z-index:100000;position:absolute;top:0px;left:0px;height:0px;width:0px;"})),$(this.dragSelectionElement).setStyle({cursor:"move"}))},drag:function(e){this.selectorAdded||(this.body=document.getElementsByTagName("body")[0],this.body.appendChild(this.divSelector),this.selectorAdded=!0);var crtX=e.clientX,crtY=e.clientY,minDSEX=this.dSEPosition[0],minDSEY=this.dSEPosition[1],maxDSEX=minDSEX+this.dSEDimension.width,maxDSEY=minDSEY+this.dSEDimension.height;crtX=Math.max(crtX,minDSEX),crtY=Math.max(crtY,minDSEY),crtX=Math.min(crtX,maxDSEX),crtY=Math.min(crtY,maxDSEY);var top,left,width,height;left=Math.min(this.originalX,crtX),width=Math.abs(this.originalX-crtX),top=Math.min(this.originalY,crtY),height=Math.abs(this.originalY-crtY),this.divSelector.setStyle({top:top+"px",left:left+"px",width:width+"px",height:height+"px"});for(var allItems=this.getItems(),minX=left,maxX=left+width,minY=top,maxY=top+height,i=0;i<allItems.length;i++){var element=$(allItems[i]),pos=Position.cumulativeOffset(element);pos[0]-=this.dragSelectionElement.scrollLeft,pos[1]-=this.dragSelectionElement.scrollTop;var dims=Element.getDimensions(element),x1=pos[0],x2=pos[0]+dims.width,y1=pos[1],y2=pos[1]+dims.height;(x1>=minX&&maxX>=x1||x2>=minX&&maxX>=x2||minX>=x1&&x2>=maxX)&&(y1>=minY&&maxY>=y1||y2>=minY&&maxY>=y2||minY>=y1&&y2>=maxY)?this.setItemSelected(allItems[i],!0):e.shiftKey||e.crtlKey||this.setItemSelected(allItems[i],!1)}},dragEnd:function(e){Event.stopObserving(document,"mousemove",this.eventMouseMove),Event.stopObserving(document,"mouseup",this.eventMouseUp),this.selectorAdded&&(this.body.removeChild(this.divSelector),this.selectorAdded=!1),$(this.dragSelectionElement).setStyle({cursor:"default"})},setItemSelected:function(oEl,bSelected){if(this._multiple){if(Boolean(oEl._selected)==Boolean(bSelected))return;if(this.setItemSelectedUi(oEl,bSelected),bSelected)this._selectedItems[this._selectedItems.length]=oEl;else{for(var tmp=[],j=0,i=0;i<this._selectedItems.length;i++)this._selectedItems[i]!=oEl&&(tmp[j++]=this._selectedItems[i]);this._selectedItems=tmp}this.fireChange()}else if(bSelected){var old=this._selectedItems[0];if(oEl==old)return;null!=old&&this.setItemSelectedUi(old,!1),this.setItemSelectedUi(oEl,!0),this._selectedItems=[oEl],this.fireChange()}else this._selectedItems[0]==oEl&&(this.setItemSelectedUi(oEl,!1),this._selectedItems=[])},setItemSelectedUi:function(oEl,bSelected){if(bSelected){if(this.options&&this.options.invisibleSelection||($(oEl).addClassName("selected"),$(oEl).addClassName("selected-focus")),!this.skipScroll){var parent=this._htmlElement;this._htmlElement.up(".table_rows_container")&&(parent=this._htmlElement.up(".table_rows_container"));var direction="offsetTop",dimMethod="getHeight",scrollDir="scrollTop";this.options&&this.options.horizontalScroll&&(parent=$(parent.parentNode),direction="offsetLeft",dimMethod="getWidth",scrollDir="scrollLeft");var scrollOffset=oEl[direction],parentHeight=parent[dimMethod](),parentScrollTop=parent[scrollDir],elHeight=$(oEl)[dimMethod](),sTop=-1;scrollOffset+elHeight>parentHeight+parentScrollTop?sTop=scrollOffset-parentHeight+elHeight:parentScrollTop>scrollOffset&&(sTop=scrollOffset-elHeight),-1!=sTop&&(parent.scrollerInstance?parent.scrollerInstance.scrollTo(sTop):parent[scrollDir]=sTop)}}else $(oEl).removeClassName("selected"),$(oEl).removeClassName("selected-focus");oEl._selected=bSelected},focus:function(){if(this.hasFocus=!0,this._selectedItems.length||this.options.skipSelectFirstOnFocus||this.selectFirst(),!this.options||!this.options.invisibleSelection)for(var i=0;i<this._selectedItems.length;i++)this._selectedItems[i]&&$(this._selectedItems[i]).addClassName("selected-focus")},blur:function(){if(this.hasFocus=!1,!this.options||!this.options.invisibleSelection)for(var i=0;i<this._selectedItems.length;i++)this._selectedItems[i]&&$(this._selectedItems[i]).removeClassName("selected-focus")},selectFirst:function(){this._selectedItems.length||null!=this.getItem(0)&&this.setItemSelected(this.getItem(0),!0)},selectAll:function(){for(var items=this.getItems(),i=0;i<items.length;i++)this.setItemSelected(items[i],!0)},getItemSelected:function(oEl){return Boolean(oEl._selected)},fireChange:function(){this._fireChange&&("string"==typeof this.onchange&&(this.onchange=new Function(this.onchange)),"function"==typeof this.onchange&&this.onchange())},fireDblClick:function(){this._fireChange&&("string"==typeof this.ondblclick&&""!=this.ondblclick&&(this.ondblclick=new Function(this.ondblclick)),"function"==typeof this.ondblclick&&this.ondblclick())},dblClick:function(e){this.hasFocus=!0,this.fireDblClick()},previousEventTime:null,previousEventTarget:null,ie10detailFilter:function(e){if(!Prototype.Browser.IE10)return!1;var result=!0;return this.previousEventTime||(result=!1),e.timeStamp-this.previousEventTime>300&&e.target!=this.previousEventTarget&&(result=!1),this.previousEventTarget=e.target,this.previousEventTime=e.timeStamp,result},click:function(e){this.hasFocus=!0,e.detail&&e.detail>1&&this.ie10detailFilter(e)&&this.fireDblClick();var oldFireChange=this._fireChange;this._fireChange=!1;var ctrlOrCmd=e.ctrlKey||e.metaKey,selectedBefore=this.getSelectedItems(),el=Event.findElement(e,".ajxpNodeProvider");if(null==el)return void(this._fireChange=oldFireChange);var items,item,i,dirUp,rIndex=el,aIndex=this._anchorIndex;if((0==this._selectedItems.length||ctrlOrCmd&&!e.shiftKey&&this._multiple)&&(aIndex=this._anchorIndex=rIndex),(ctrlOrCmd||e.shiftKey)&&this._multiple){if(this._multiple&&ctrlOrCmd&&!e.shiftKey)this.setItemSelected(el,!el._selected),this._anchorIndex=rIndex;else if(this._multiple&&ctrlOrCmd&&e.shiftKey){for(dirUp=this.isBefore(rIndex,aIndex),item=aIndex;null!=item&&item!=rIndex;)item._selected||item==el||this.setItemSelected(item,!0),item=dirUp?this.getPrevious(item):this.getNext(item);el._selected||this.setItemSelected(el,!0)}else if(this._multiple&&!ctrlOrCmd&&e.shiftKey){for(dirUp=this.isBefore(rIndex,aIndex),items=this._selectedItems,i=items.length-1;i>=0;i--)this.setItemSelectedUi(items[i],!1);for(this._selectedItems=[],item=aIndex,this.skipScroll=!0;null!=item&&(this.setItemSelected(item,!0),item==rIndex-1&&(this.skipScroll=!1),item!=rIndex);)item=dirUp?this.getPrevious(item):this.getNext(item);this.skipScroll=!1}}else{for(items=this._selectedItems,i=items.length-1;i>=0;i--)items[i]._selected&&items[i]!=el&&this.setItemSelectedUi(items[i],!1);this._anchorIndex=rIndex,el._selected||this.setItemSelectedUi(el,!0),this._selectedItems=[el]}var found,changed=selectedBefore.length!=this._selectedItems.length;if(!changed)for(i=0;i<selectedBefore.length;i++){found=!1;for(var j=0;j<this._selectedItems.length;j++)if(selectedBefore[i]==this._selectedItems[j]){found=!0;break}if(!found){changed=!0;break}}this._fireChange=oldFireChange,changed&&this._fireChange&&this.fireChange()},getSelectedItems:function(){for(var items=this._selectedItems,l=items.length,tmp=new Array(l),i=0;l>i;i++)tmp[i]=items[i];return tmp},getSelectedNodes:function(){for(var items=this._selectedItems,nodes=$A([]),i=0;i<items.length;i++)items[i].ajxpNode&&nodes.push(items[i].ajxpNode);return nodes},setSelectedNodes:function(ajxpNodes){for(var items=this.getItems(),i=0;i<items.length;i++)items[i].ajxpNode&&ajxpNodes.detect(function(el){return el.getPath()==items[i].ajxpNode.getPath()})?this.setItemSelected(items[i],!0):this.setItemSelected(items[i],!1)},isItem:function(node){return null!=node&&node.up("#"+this._htmlElement.id)},findSelectableParent:function(el,setSelected){for(;null!=el&&!this.isItem(el);)el=el.parentNode;return null!=el&&setSelected&&this.setItemSelected(el,!0),el},destroy:function(){this._htmlElement&&(this._htmlElement.removeEventListener?this._htmlElement.removeEventListener("click",this._onclick,!1):this._htmlElement.detachEvent&&this._htmlElement.detachEvent("onclick",this._onclick),this._htmlElement=null,this._onclick=null,this._selectedItems=null)},getNext:function(el){var n=el.nextSibling;return null==n||this.isItem(n)?n:this.getNext(n)},getPrevious:function(el){var p=el.previousSibling;return null==p||this.isItem(p)?p:this.getPrevious(p)},isBefore:function(n1,n2){for(var next=this.getNext(n1);null!=next;){if(next==n2)return!0;next=this.getNext(next)}return!1},getItems:function(){for(var tmp=[],j=0,cs=this._htmlElement.select(".ajxpNodeProvider"),l=cs.length,i=0;l>i;i++)1==cs[i].nodeType&&(tmp[j++]=cs[i]);return tmp},getItem:function(nIndex){for(var j=0,cs=this._htmlElement.select(".ajxpNodeProvider"),l=cs.length,i=0;l>i;i++)if(1==cs[i].nodeType){if(j==nIndex)return cs[i];j++}return null},getSelectedIndexes:function(){for(var items=this.getSelectedItems(),l=items.length,tmp=new Array(l),i=0;l>i;i++)tmp[i]=this.getItemIndex(items[i]);return tmp},getItemIndex:function(el){for(var j=0,cs=this._htmlElement.select(".ajxpNodeProvider"),l=cs.length,i=0;l>i;i++){if(cs[i]==el)return j;1==cs[i].nodeType&&j++}return-1}}),Class.create("SortableTable",{groupByData:null,initialize:function(oTable,oSortTypes,oTHead){this.gecko=Prototype.Browser.Gecko,this.msie=Prototype.Browser.IE,this.removeBeforeSort=this.gecko,this.sortTypes=oSortTypes||[],this.sortColumn=null,this.descending=null,this._headerOnclick=function(e){this.headerOnclick(e)}.bind(this),oTable&&"table"==oTable.nodeName.toLowerCase()?(this.setTable(oTable,oTHead),this.document=oTable.ownerDocument||oTable.document):oTable?(this.container=oTable,
this.document=document):this.document=document;var win=this.document.defaultView||this.document.parentWindow;this._onunload=function(){this.destroy()}.bind(this),win&&"undefined"!=typeof win.attachEvent&&win.attachEvent("onunload",this._onunload),this.addSortType("Number",Number),this.addSortType("CaseInsensitiveString",this.toUpperCase),this.addSortType("Date",this.toDate),this.addSortType("String")},setGroupByData:function(groupByData){this.groupByData=groupByData},setMetaSortType:function(columnsDefs){this.columnsDefs=columnsDefs,this.sortTypes=[],this.columnsDefs.each(function(a){this.sortTypes.push("NodeMeta")}.bind(this))},onsort:function(){},defaultDescending:!1,_sortTypeInfo:{},setTable:function(oTable,oTHead){this.tHead&&this.uninitHeader(),this.element=oTable,this.setTHead(oTHead?oTHead:oTable.tHead),this.setTBody(oTable.tBodies[0])},setTHead:function(oTHead){this.tHead&&this.tHead!=oTHead&&this.uninitHeader(),this.tHead=$(oTHead),this.initHeader(this.sortTypes)},setTBody:function(oTBody){this.tBody=$(oTBody)},setSortTypes:function(oSortTypes){this.tHead&&this.uninitHeader(),this.sortTypes=oSortTypes||[],this.tHead&&this.initHeader(this.sortTypes)},getHeaderCells:function(){return!this.headerCells&&this.tHead&&(this.headerCells=this.tHead.select("div.header_cell"),this.headerCells.each(function(cell){var prev=cell.previous("div");prev&&prev.hasClassName("resizer")&&(cell.resizer=prev),cell.down("span.ajxp-order-icon")||cell.down("div.header_label").insert('<span class="ajxp-order-icon icon-caret-up"></span><span class="ajxp-order-icon icon-caret-down"></span>')})),this.headerCells},initHeader:function(oSortTypes){if(this.tHead){var cells=this.getHeaderCells();this.sortTypes=oSortTypes||[];for(var c,l=cells.length,i=0;l>i;i++)c=cells[i],c.cellIndex=i,null!=this.sortTypes[i]&&"None"!=this.sortTypes[i]?(null!=this.sortTypes[i]&&(c._sortType=this.sortTypes[i]),c.observe("click",this._headerOnclick.bind(this))):(c.setAttribute("_sortType",oSortTypes[i]),c._sortType="None");this.updateHeaderArrows()}},onHeaderResize:function(headerCells){},setGridCellWidth:function(cell,width){var label=cell.down(".text_label");if(!label)return void(width&&cell.setStyle({width:width+"px"}));var computedWidth;computedWidth=width?parseInt(width):cell.getWidth()-3;var cellPaddLeft=cell.getStyle("paddingLeft")||0,cellPaddRight=cell.getStyle("paddingRight")||0,labelPaddLeft=label.getStyle("paddingLeft")||0,labelPaddRight=label.getStyle("paddingRight")||0,siblingWidth=1;label.siblings().each(function(sib){siblingWidth+=sib.getWidth()}),label.setStyle({width:computedWidth-siblingWidth-parseInt(cellPaddLeft)-parseInt(cellPaddRight)-parseInt(labelPaddLeft)-parseInt(labelPaddRight)+"px"}),width&&cell.setStyle({width:computedWidth+"px"})},uninitHeader:function(){try{var cells=this.getHeaderCells()}catch(e){return}if(cells&&cells.length)for(var c,l=cells.length,i=0;l>i;i++)c=cells[i],null!=c._sortType&&"None"!=c._sortType&&(c.firstChild&&c.removeChild(c.firstChild),"undefined"!=typeof c.removeEventListener?c.removeEventListener("click",this._headerOnclick,!1):"undefined"!=typeof c.detachEvent&&c.detachEvent("onclick",this._headerOnclick),c._sortType=null,c.removeAttribute("_sortType"))},updateHeaderArrows:function(){if(this.tHead)for(var cells=this.getHeaderCells(),l=cells.length,i=0;l>i;i++)null!=cells[i]._sortType&&"None"!=cells[i]._sortType&&(cells[i].removeClassName("descending"),cells[i].removeClassName("ascending"),cells[i].resizer&&cells[i].resizer.removeClassName("resizer_sortable"),i==this.sortColumn&&(cells[i].addClassName(this.descending?"descending":"ascending"),cells[i].resizer&&cells[i].resizer.addClassName("resizer_sortable")))},headerOnclick:function(e){var el=Event.findElement(e);this.sort(el.cellIndex)},getCellIndex:function(oTd){var i,cells=oTd.parentNode.childNodes,l=cells.length;for(i=0;cells[i]!=oTd&&l>i;i++);return i},getSortType:function(nColumn){return this.columnsDefs&&this.columnsDefs[nColumn]&&this.columnsDefs[nColumn].sortType?this.columnsDefs[nColumn].sortType:this.sortTypes[nColumn]||"String"},sort:function(nColumn,bDescending,sSortType){if((this.tBody||this.container)&&(null==sSortType&&(sSortType=this.getSortType(nColumn)),"None"!=sSortType)){null==bDescending?this.sortColumn!=nColumn?this.descending=this.defaultDescending:this.descending=!this.descending:this.descending=bDescending,this.sortColumn=nColumn,"function"==typeof this.onbeforesort&&this.onbeforesort();var f=this.getSortFunction(sSortType,nColumn),a=this.getCache(sSortType,nColumn),tBody=this.tBody?this.tBody:this.container;if(a.sort(f),this.descending&&a.reverse(),this.removeBeforeSort){var nextSibling=tBody.nextSibling,p=tBody.parentNode;p&&p.removeChild(tBody)}tBody.select("div[data-groupbyvalue]").invoke("remove");var groupColIndex,groupType,allBlocks,blockType,l=a.length;if(this.groupByData)if(this.columnsDefs){var col=this.columnsDefs.detect(function(c){return c.attributeName==this.groupByData}.bind(this));col&&(groupColIndex=this.columnsDefs.indexOf(col),groupType=this.getSortType(groupColIndex),allBlocks=[],blockType="div")}else groupColIndex=this.groupByData,groupType=this.getSortType(groupColIndex),allBlocks=[],blockType="tr";for(var i=0;l>i;i++)if(groupColIndex){var fieldValue=this.getRowValue(a[i].element,groupType,groupColIndex);fieldValue||(fieldValue="N/A"),fieldValue=fieldValue.trim();var block;block=tBody.down("tr"==blockType?'tr[data-groupbyvalue="'+fieldValue+'"]':'div[data-groupbyvalue="'+fieldValue+'"]'),block||(block=new Element(blockType,{"data-groupbyvalue":fieldValue}),tBody.insert(block),MessageHash[fieldValue]&&(fieldValue=MessageHash[fieldValue]),"div"==blockType?block.insert(new Element("h3").update(fieldValue)):"tr"==blockType&&block.insert(new Element("td",{colspan:this.sortTypes.length}).update(new Element("h3").update(fieldValue))),allBlocks[fieldValue]=block),block.insert("tr"==blockType?{after:a[i].element}:a[i].element)}else tBody.appendChild(a[i].element);if(allBlocks&&"div"==blockType){var keys=Object.keys(allBlocks);keys.sort();for(var z=0;z<keys.length;z++)tBody.insert(allBlocks[keys[z]]),allBlocks[keys[z]].down("h3").insert('<span class="groupBy-count"> ('+allBlocks[keys[z]].select(".ajxpNodeProvider").length+")</span>")}this.removeBeforeSort&&p&&p.insertBefore(tBody,nextSibling),this.updateHeaderArrows(),this.destroyCache(a),"function"==typeof this.onsort&&this.onsort()}},asyncSort:function(nColumn,bDescending,sSortType){var oThis=this;this._asyncsort=function(){oThis.sort(nColumn,bDescending,sSortType)},window.setTimeout(this._asyncsort,1)},getCache:function(sType,nColumn){if(!this.tBody&&!this.container)return[];var rows;if(this.tBody)rows=this.tBody.rows;else{if(!this.container)return[];rows=this.container.select(".ajxpNodeProvider")}for(var r,l=rows.length,a=new Array(l),i=0;l>i;i++)r=rows[i],a[i]={value:this.getRowValue(r,sType,nColumn),element:r};return a},destroyCache:function(oArray){for(var l=oArray.length,i=0;l>i;i++)oArray[i].value=null,oArray[i].element=null,oArray[i]=null},getRowValue:function(oRow,sType,nColumn){if(!this._sortTypeInfo[sType])return 0;if(this.columnsDefs){var stringValue,colDef=this.columnsDefs[nColumn],attName=colDef.attributeName;return this._sortTypeInfo[sType].getNodeValue?stringValue=this._sortTypeInfo[sType].getNodeValue(oRow.ajxpNode,attName):(this._sortTypeInfo[sType].getRowValue&&(stringValue=this._sortTypeInfo[sType].getRowValue(oRow,nColumn,attName)),void 0===stringValue&&(stringValue=oRow.ajxpNode.getMetadata().get(attName))),this.getValueFromString(stringValue)}if(this._sortTypeInfo[sType]&&this._sortTypeInfo[sType].getRowValue)return this._sortTypeInfo[sType].getRowValue(oRow,nColumn);var s,c=oRow.cells[nColumn],tC=c.textContent||c.innerText;return s=c&&"undefined"!=typeof tC?tC:this.getInnerText(c),this.getValueFromString(s,sType)},getInnerText:function(oNode){for(var s="",cs=oNode.childNodes,l=cs.length,i=0;l>i;i++)switch(cs[i].nodeType){case 1:s+=this.getInnerText(cs[i]);break;case 3:s+=cs[i].nodeValue}return s},getValueFromString:function(sText,sType){return this._sortTypeInfo[sType]?this._sortTypeInfo[sType].getValueFromString(sText):sText},getSortFunction:function(sType,nColumn){return this._sortTypeInfo[sType]?this._sortTypeInfo[sType].compare:this.basicCompare},destroy:function(){this.uninitHeader();var win=this.document.parentWindow;win&&"undefined"!=typeof win.detachEvent&&win.detachEvent("onunload",this._onunload),this._onunload=null,this.element=null,this.tHead=null,this.tBody=null,this.headerCells=null,this.document=null,this._headerOnclick=null,this.sortTypes=null,this._asyncsort=null,this.onsort=null},addSortType:function(sType,fGetValueFromString,fCompareFunction,fGetRowValue,fGetNodeValue){this._sortTypeInfo[sType]={type:sType,getValueFromString:fGetValueFromString||this.idFunction,compare:fCompareFunction||this.basicCompare,getRowValue:fGetRowValue,getNodeValue:fGetNodeValue||null}},removeSortType:function(sType){delete this._sortTypeInfo[sType]},basicCompare:function(n1,n2){return n1.value<n2.value?-1:n2.value<n1.value?1:0},idFunction:function(x){return x},toUpperCase:function(s){return s.toUpperCase()},toDate:function(s){var parts=s.split("-"),d=new Date(0);return d.setFullYear(parts[0]),d.setDate(parts[2]),d.setMonth(parts[1]-1),d.valueOf()}}),Object.isUndefined(Proto))var Proto={};Proto.Menu=Class.create({initialize:function(){var e=Prototype.emptyFunction;this.ie=Prototype.Browser.IE&&-1==navigator.userAgent.indexOf("MSIE 10"),this.options=Object.extend({selector:".contextmenu",className:"protoMenu",mouseClick:"right",anchor:"mouse",pageOffset:25,topOffset:0,leftOffset:0,submenuArrow:ajxpResourcesFolder+"/images/arrow_right.png",position:"bottom",menuTitle:"",detailedItems:!1,fade:!1,zIndex:100,createAnchor:!1,anchorContainer:null,anchorSrc:"",anchorTitle:"",anchorPosition:"last",beforeShow:e,beforeHide:e,beforeSelect:e,shadowOptions:{distance:4,angle:130,opacity:.3,nestedShadows:3,color:"#000000"}},arguments[0]||{}),this.subMenus=$A(),this.shim=new Element("iframe",{style:"position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);display:none",src:"javascript:false;",frameborder:0}),this.options.createAnchor?this.createAnchor():"string"==typeof this.options.anchor&&"mouse"!=this.options.anchor?this.options.selector='[id="'+this.options.anchor+'"]':"string"!=typeof this.options.anchor&&(this.options.selector=this.options.anchor),this.eventToObserve="right"!=this.options.mouseClick?"click":"contextmenu","over"==this.options.mouseClick&&(this.eventToObserve="mouseover"),this.options.fade=this.options.fade&&!Object.isUndefined(Effect),this.container=new Element("div",{className:this.options.className,style:"display:none"}),this.observerFunctionBound=this.observerFunction.bind(this),this.mouseoverFunctionBound=this.mouseoverFunction.bind(this),this.mouseoutFunctionBound=this.mouseoutFunction.bind(this),"right"==this.options.mouseClick?($(document.body).observe("contextmenu",function(e){Event.stop(e)}),$(document.body).insert(this.container.observe("contextmenu",Event.stop))):$(document.body).insert(this.container),this.ie&&$(document.body).insert(this.shim),"mouseover"==this.eventToObserve&&(this.container.observe("mouseover",this.mouseoverFunctionBound),this.container.observe("mouseout",this.mouseoutFunctionBound)),document.observe("click",function(e){!this.container.visible()||e.isRightClick()||"over"==this.options.mouseClick&&!Object.isString(this.options.anchor)&&this.options.anchor.id&&Event.findElement(e,"#"+this.options.anchor.id)||this.hide()}.bind(this)),this.addElements(this.options.selector)},destroy:function(){try{this.subMenus.length&&this.subMenus.invoke("destroy"),this.ie&&this.shim.remove(),this.container.remove(),this.options.createAnchor&&this.options.anchor&&this.options.anchor.remove()}catch(e){}},observerFunction:function(e){"left"==this.options.mouseClick&&Event.findElement(e,".protomenu_selector")&&Event.findElement(e,".protomenu_selector").hasClassName("disabled")||this.show(e)},mouseoverFunction:function(e){this.timer&&(window.clearTimeout(this.timer),this.timer=null),this.options.parent&&this.options.parent.timer&&(window.clearTimeout(this.options.parent.timer),this.options.parent.timer=null)},mouseoutFunction:function(e){this.timer=window.setTimeout(function(){this.hide(e)}.bind(this),300)},removeElements:function(selectorOrObject){"string"==typeof selectorOrObject?$$(selectorOrObject).each(function(oc){oc.removeClassName("protomenu_selector"),oc.stopObserving(this.eventToObserve,this.observerFunctionBound)}.bind(this)):selectorOrObject.removeClassName("protomenu_selector").stopObserving(this.eventToObserve,this.observerFunctionBound)},addElements:function(selectorOrObject){"string"==typeof selectorOrObject?($$(selectorOrObject).invoke("observe",this.eventToObserve,this.observerFunctionBound),$$(selectorOrObject).invoke("addClassName","protomenu_selector"),"mouseover"==this.eventToObserve&&($$(selectorOrObject).invoke("observe","mouseover",this.mouseoverFunctionBound),$$(selectorOrObject).invoke("observe","mouseout",this.mouseoutFunctionBound))):($(selectorOrObject).observe(this.eventToObserve,this.observerFunctionBound),$(selectorOrObject).addClassName("protomenu_selector"),"mouseover"==this.eventToObserve&&($(selectorOrObject).observe("mouseover",this.mouseoverFunctionBound),$(selectorOrObject).observe("mouseout",this.mouseoutFunctionBound)))},refreshList:function(){this.container.childElements().invoke("remove");var list=new Element("ul");if(""!=this.options.menuTitle){var text=this.options.menuTitle;list.insert(new Element("li",{text:text,className:"menuTitle"}).update(text))}var registeredKeys=$A();this.options.menuItems.each(function(item){if(!item.separator){var key=item.name;if(-1!==registeredKeys.indexOf(key))return;registeredKeys.push(key)}var newItem=new Element("li",{className:item.separator?"separator":""});if(item.moreActions){var actionsContainer=new Element("div",{className:"menuActions moreActions",style:"padding-top:4px;"});item.moreActions.each(function(action){action.icon_class?actionsContainer.insert(new Element("span",{title:action.name,className:action.icon_class}).observe("click",action.callback)):(action.image_unresolved&&(action.image=resolveImageSource(action.image_unresolved,"/images/actions/ICON_SIZE",22)),actionsContainer.insert(new Element("a",{title:action.name,href:"#"}).writeAttribute("onclick","return false;").observe("click",action.callback).insert('<img src="'+action.image+'" width="16" height="16" border="0">')))}),newItem.insert(actionsContainer),newItem.setStyle({position:"relative"}),actionsContainer.observe("mouseover",function(){newItem.select("a.enabled")[0].addClassName("hovered")}),actionsContainer.observe("mouseout",function(){newItem.select("a.enabled")[0].removeClassName("hovered")})}if(item.subMenu){var arrowContainer=new Element("div",{className:"menuActions"+(window.ajaxplorer.currentThemeUsesIconFonts?" icon-caret-right":""),style:"padding-right:7px;"});arrowContainer.insert(new Element("img",{src:this.options.submenuArrow,width:6,height:10})),newItem.insert(arrowContainer),newItem.setStyle({position:"relative"})}if(item.action_id&&ajaxplorer&&pydio.getController()&&pydio.getController().getActionByName(item.action_id)){var actionObject=pydio.getController().getActionByName(item.action_id);this.options.detailedItems?item.name='<span class="menu_label">'+actionObject.getKeyedText()+'</span><span class="menu_description">'+actionObject.options.title+"</span>":item.name=actionObject.getKeyedText(),item.title=actionObject.options.title}var img="";item.icon_class&&window.ajaxplorer.currentThemeUsesIconFonts?img=new Element("span",{className:item.icon_class+" ajxp_icon_span",title:item.alt}):item.image?item.separator||(item.image_unresolved&&(item.image=resolveImageSource(item.image_unresolved,"/images/actions/ICON_SIZE",16)),img=new Element("img",{src:item.image,border:"0",height:16,width:16,align:"absmiddle"})):item.pFactory&&item.ajxpNode&&(img=item.pFactory.generateBasePreview(item.ajxpNode)),item.separator&&item.menuTitle?(newItem.insert(item.menuTitle),newItem.addClassName("menuTitle")):newItem.insert(Object.extend(new Element("a",{href:"#",title:item.alt,id:item.action_id?"action_instance_"+item.action_id:"",className:(item.className?item.className+" ":"")+(item.disabled?"disabled":"enabled"),style:item.isDefault?"font-weight:bold":""}),{_callback:item.callback}).writeAttribute("onclick","return false;").observe("click",this.onClick.bind(this)).observe("contextmenu",Event.stop).update(Object.extend(img,{_callback:item.callback})).insert(item.name)),newItem.down("u")&&(newItem.down("u")._callback=item.callback),item.overlay&&(newItem.down("img")&&newItem.down("img").insert({after:Object.extend(new Element("img",{src:item.overlay,style:"position:relative;margin-left:-12px;top:5px;"}),{_callback:item.callback})}),newItem.down("span")&&newItem.down("span").insert({after:Object.extend(new Element("img",{src:item.overlay,style:"position:relative;margin-left:-12px;top:5px;"}),{_callback:item.callback})})),newItem._callback=item.callback,item.subMenu&&(item.subMenuBeforeShow||(item.subMenuBeforeShow=Prototype.emptyFunction),item.subMenuBeforeHide||(item.subMenuBeforeHide=Prototype.emptyFunction),newItem.subMenu=new Proto.Menu({mouseClick:"over",anchor:newItem,className:this.options.className,topOffset:0,leftOffset:-1,menuItems:item.subMenu,fade:!1,zIndex:2010,position:"right",parent:this,beforeShow:function(){var object=newItem.subMenu;object.options.parent&&object.options.parent.subMenus&&object.options.parent.subMenus.invoke("hide"),object.options.anchor&&object.options.anchor.addClassName("menuAnchorSelected"),window.setTimeout(function(){item.subMenuBeforeShow(object)},0)},beforeHide:function(){var object=newItem.subMenu;object.options.anchor&&object.options.anchor.removeClassName("menuAnchorSelected"),window.setTimeout(function(){item.subMenuBeforeHide(object)},0)}}),window.setTimeout(function(){item.subMenuBeforeShow(newItem.subMenu)},0),this.subMenus.push(newItem.subMenu)),list.insert(newItem),item.pFactory&&item.ajxpNode&&img&&(newItem.IMAGE_ELEMENT=img,item.pFactory.enrichBasePreview(item.ajxpNode,newItem))}.bind(this)),this.container.insert(list),list.select("li.separator").each(function(sep){var next=sep.next("li"),prev=sep.previous("li");return!prev||prev.hasClassName("separator")||prev.hasClassName("menuTitle")?void sep.remove():void((!next||next.hasClassName("separator")||prev.hasClassName("menuTitle"))&&sep.remove())})},show:function(e){this.options.parent&&this.options.parent.subMenus&&this.options.parent.subMenus.map(function(el){el!=this&&el.hide()}.bind(this)),this.options.beforeShow(e),this.refreshList();var elOff={},elDim=this.container.getDimensions();elOff="mouse"==this.options.anchor?this.computeMouseOffset(e):this.computeAnchorOffset(),this.container.setStyle(elOff),this.container.setStyle({zIndex:this.options.zIndex}),this.ie&&this.shim.setStyle(Object.extend(Object.extend(elDim,elOff),{zIndex:this.options.zIndex-1})).show(),this.options.fade?(this.checkHeight(elOff.top),this.correctWindowClipping(this.container,elOff,elDim),Effect.Appear(this.container,{duration:this.options.fadeTime||.15,afterFinish:function(e){this.checkHeight(elOff.top),this.correctWindowClipping(this.container,elOff,elDim)}.bind(this)})):(this.container.show(),this.checkHeight(elOff.top),this.correctWindowClipping(this.container,elOff,elDim)),this.event=e,window.setTimeout(function(){this.container.select("li").length||this.hide()}.bind(this),150)},correctWindowClipping:function(container,position,dim){var viewPort=document.viewport.getDimensions();parseInt(position.left)+dim.width>viewPort.width&&(position.left=parseInt(position.left)+(viewPort.width-(parseInt(position.left)+dim.width)-5),container.setStyle({left:position.left+"px"}))},checkHeight:function(offsetTop){if(offsetTop=parseInt(offsetTop),"mouse"!=this.options.anchor){var vpHeight=getViewPortHeight()-10;this.options.menuMaxHeight?vpHeight=Math.min(this.options.menuMaxHeight,vpHeight):this.options.menuFitHeight&&(vpHeight=getViewPortHeight());var vpOff=document.viewport.getScrollOffsets(),elDim=this.container.getDimensions(),y=parseInt(offsetTop);y-vpOff.top+elDim.height>=vpHeight||this.options.menuFitHeight?(this.container.setStyle({height:vpHeight-(y-vpOff.top)+"px",overflowY:"scroll"}),this.containerShrinked||this.container.setStyle({width:elDim.width+16+"px"}),this.containerShrinked=!0):this.container.setStyle({height:"auto",overflowY:"hidden"}),attachMobileScroll(this.container,"vertical")}},computeMouseOffset:function(e){var x=Event.pointer(e).x,y=Event.pointer(e).y,vpDim=document.viewport.getDimensions(),vpOff=document.viewport.getScrollOffsets(),elDim=this.container.getDimensions();return{left:(x+elDim.width+this.options.pageOffset>vpDim.width?vpDim.width-elDim.width-this.options.pageOffset:x)+"px",top:(y-vpOff.top+elDim.height>vpDim.height&&y-vpOff.top>elDim.height?y-elDim.height:y)+"px"}},computeAnchorOffset:function(){var topPos,leftPos,anchorPosition=Position.cumulativeOffset($(this.options.anchor)),anchorScroll=this.options.anchor.cumulativeScrollOffset();if("bottom"==this.options.position||"bottom right"==this.options.position||"bottom middle"==this.options.position)topPos=anchorPosition[1]+$(this.options.anchor).getHeight()+this.options.topOffset-anchorScroll[1],leftPos=anchorPosition[0]+this.options.leftOffset-anchorScroll[0],"bottom right"==this.options.position?(leftPos=anchorPosition[0]+$(this.options.anchor).getWidth()+this.options.leftOffset-anchorScroll[0],leftPos-=this.container.getWidth()):"bottom middle"==this.options.position&&(leftPos=anchorPosition[0]+$(this.options.anchor).getWidth()/2+this.options.leftOffset-anchorScroll[0],leftPos-=this.container.getWidth()/2);else if("right"==this.options.position){var vpDim=document.viewport.getDimensions();topPos=anchorPosition[1]+this.options.topOffset-anchorScroll[1],leftPos=anchorPosition[0]+$(this.options.anchor).getWidth()+this.options.leftOffset-anchorScroll[0],leftPos+this.container.getDimensions().width>vpDim.width&&(leftPos=anchorPosition[0]-this.container.getDimensions().width)}return this.anchorOffset={top:topPos+"px",left:leftPos+"px"},this.anchorOffset},createAnchor:function(){this.options.createAnchor&&"mouse"!=this.options.anchor&&(this.options.anchor=new Element("img",{id:this.options.anchor,src:this.options.anchorSrc,alt:this.options.anchorTitle,align:"absmiddle"}).setStyle({cursor:"pointer"}),this.options.anchorContainer.appendChild(this.options.anchor),this.options.selector=this.options.anchor)},onClick:function(e){var target=e.target;!e.target._callback&&e.target.up("li")&&e.target.up("li")._callback&&(target=e.target.up("li")),target._callback&&!target.hasClassName("disabled")&&(this.options.beforeSelect(e),this.options.anchor&&"string"!=typeof this.options.anchor&&this.options.anchor.removeClassName("menuAnchorSelected"),this.ie&&this.shim.hide(),this.container.hide(),target._callback(this.event))},hide:function(e){this.options.beforeHide(e),this.ie&&this.shim.hide(),this.container.setStyle({height:"auto",overflowY:"hidden"}),this.container.hide(),this.subMenus.length&&($A(this.subMenus).invoke("destroy"),this.subMenus=$A())}}),Class.create("Splitter",AjxpPane,{__implements:["IActionProvider"],initialize:function(container,options){this.options=Object.extend({direction:"vertical",activeClass:"active",fit:null,minSize:16,foldingButton:null,foldingAlternateClose:null,foldingMinSize:null,foldingButtonText:null,invisibleBar:!1,onDrag:Prototype.EmptyFunction,endDrag:Prototype.EmptyFunction,startDrag:Prototype.EmptyFunction},arguments[1]||{});var verticalOpts={cursor:"e-resize",splitbarClass:"vsplitbar",eventPointer:Event.pointerX,set:"left",adjust:"width",getAdjust:this.getWidth,offsetAdjust:"offsetWidth",adjSide1:"Left",adjSide2:"Right",fixed:"height",getFixed:this.getHeight,offsetFixed:"offsetHeight",fixSide1:"Top",fixSide2:"Bottom"},horizontalOpts={cursor:"n-resize",splitbarClass:"hsplitbar",eventPointer:Event.pointerY,set:"top",adjust:"height",getAdjust:this.getHeight,offsetAdjust:"offsetHeight",adjSide1:"Top",adjSide2:"Bottom",fixed:"width",getFixed:this.getWidth,offsetFixed:"offsetWidth",fixSide1:"Left",fixSide2:"Right"};"vertical"==this.options.direction?Object.extend(this.options,verticalOpts):Object.extend(this.options,horizontalOpts),this.htmlElement=$(container),this.htmlElement.ajxpPaneObject=this,this.group=$(container).setStyle({position:"relative"});var divs=this.group.childElements();divs.each(function(div){div.setStyle({position:"absolute"})}),this.paneA=divs[0],this.paneB=divs[1],this.initBorderA=parseInt(this.paneA.getStyle("border"+this.options.adjSide1+"Width"))+parseInt(this.paneA.getStyle("border"+this.options.adjSide2+"Width"))||0,this.initBorderA+=parseInt(this.paneA.getStyle("margin"+this.options.adjSide1))+parseInt(this.paneA.getStyle("margin"+this.options.adjSide2)),this.initBorderB=parseInt(this.paneB.getStyle("border"+this.options.adjSide1+"Width"))+parseInt(this.paneB.getStyle("border"+this.options.adjSide2+"Width"))||0,this.initBorderB+=parseInt(this.paneB.getStyle("margin"+this.options.adjSide1))+parseInt(this.paneB.getStyle("margin"+this.options.adjSide2)),this.initBorderA||(this.initBorderA=0),this.initBorderB||(this.initBorderB=0),this.splitbar=new Element("div",{unselectable:"on"});(this.options.invisibleBar?parseInt(this.group.getStyle("zIndex"))+1:"inherit")||"10000";this.splitbar.addClassName(this.options.splitbarClass).setStyle({position:"absolute",cursor:this.options.cursor,fontSize:"1px"}),this.paneA.insert({after:this.splitbar}),this.startSplitFunc=this.startSplit.bind(this),this.endSplitFunc=this.endSplit.bind(this),this.splitbar.observe("mousedown",this.startSplitFunc),this.splitbar.observe("mouseup",this.endSplitFunc),this.initCaches(),this.paneA._init=(1==this.options.initA?parseInt(this.options.getAdjust(this.paneA)):this.options.initA)||0,this.paneB._init=(1==this.options.initB?parseInt(this.options.getAdjust(this.paneB)):this.options.initB)||0,this.paneB._init&&this.paneB.setStyle(this.makeStyleObject(this.options.adjust,this.paneB._init)),this.paneA._init&&this.paneA.setStyle(this.makeStyleObject(this.options.adjust,this.paneA._init)),this.resizeGroup(null,this.paneB._init||this.paneA._init||Math.round((this.group[this.options.offsetAdjust]-this.group._borderAdjust-this.splitbar._adjust)/2)),this.userLoggedObs=function(){var sizePref=this.getUserPreference("size"),folded=this.getUserPreference("folded");sizePref&&(folded?this.moveSplitter(parseInt(sizePref)):(this.prefoldValue=parseInt(sizePref),this.resizeAnimated(parseInt(sizePref)))),folded&&this.foldWithoutAnim()}.bind(this),document.observe("ajaxplorer:user_logged",this.userLoggedObs),this.compConfigObs=function(event){if(!this.htmlElement)return void document.stopObserving("ajaxplorer:component_config_changed",this.compConfigObs);if(event.memo.className=="Splitter::"+this.htmlElement.id){var node=event.memo.classConfig.get("all"),size=XPathSelectSingleNode(node,'property[@name="resize"]'),folded=XPathSelectSingleNode(node,'property[@name="folded"]');if(size){var sizeValue=parseInt(size.getAttribute("value"));size.getAttribute("value").indexOf("%")&&(sizeValue=this.htmlElement.getWidth()*sizeValue/100),folded&&"true"==folded.getAttribute("value")?this.moveSplitter(sizeValue):(this.effectWorking=!1,this.resizeAnimated(sizeValue))}folded&&"true"==folded.getAttribute("value")&&this.foldWithoutAnim()}}.bind(this),document.observe("ajaxplorer:component_config_changed",this.compConfigObs),this.doSplitFunc=this.doSplitMouse.bind(this),Event.observe(this.group,"mousemove",this.doSplitFunc),Event.observe(this.group,"mouseup",this.endSplitFunc),this.splitbar.draggable=!1,disableTextSelection(this.group),this.options.startFolded&&this.foldWithoutAnim()},destroy:function($super){Event.stopObserving(this.group,"mousemove",this.doSplitFunc),this.splitbar.stopObserving("mousedown",this.startSplitFunc),this.splitbar.stopObserving("mouseup",this.endSplitFunc),document.stopObserving("ajaxplorer:user_logged",this.userLoggedObs),document.stopObserving("ajaxplorer:component_config_changed",this.compConfigObs),this.splitbar.remove(),this.getActions().each(function(act){pydio.getController().deleteFromGuiActions(act.key)}.bind(this)),this.paneA.ajxpPaneObject&&(this.paneA.ajxpPaneObject.destroy(),this.paneA.remove(),this.paneA=null),this.paneB.ajxpPaneObject&&(this.paneB.ajxpPaneObject.destroy(),this.paneB.remove(),this.paneB=null);try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}},getFoldingAction:function(){return pydio.getController().getActionByName(this.htmlElement.id+"_folding_action")},getActions:function(){if(!this.options.foldingButton)return $H();var foldingValue=this.options.foldingButton,butts=$H(),oThis=this,options={name:oThis.htmlElement.id+"_folding_action",src:"view_left_close.png",icon_class:"icon-remove-sign",text_id:oThis.options.foldingButtonText?oThis.options.foldingButtonText:416,title_id:oThis.options.foldingButtonText?oThis.options.foldingButtonText:415,text:MessageHash[oThis.options.foldingButtonText?oThis.options.foldingButtonText:416],title:MessageHash[oThis.options.foldingButtonText?oThis.options.foldingButtonText:415],hasAccessKey:!1,subMenu:!1,subMenuUpdateImage:!1,callback:function(){oThis.toggleFolding("B"==foldingValue?oThis.paneB:oThis.paneA)},listeners:{init:function(){this.refreshFoldingAction("B"==foldingValue?this.paneB:this.paneA)}.bind(this)}},context={selection:!1,dir:!0,actionBar:!0,actionBarGroup:oThis.htmlElement.id+"-actions",contextMenu:!1,infoPanel:!1},foldingAction=new Action(options,context);if(butts.set(this.htmlElement.id+"_folding_button",foldingAction),this.options.foldingAlternateClose){var options2={name:"folding_close_action",src:"view_left_close.png",icon_class:"icon-remove-sign",text_id:416,title_id:415,text:MessageHash[416],title:MessageHash[415],hasAccessKey:!1,subMenu:!1,subMenuUpdateImage:!1,callback:function(){oThis.toggleFolding("B"==foldingValue?oThis.paneB:oThis.paneA);oThis.getFoldingAction().enable()},listeners:{init:function(){"use strict";window.setTimeout(function(){if(!oThis.splitbar.hasClassName("folded"))try{oThis.getFoldingAction().disable()}catch(e){}},1500)}}},context2={selection:!1,dir:!0,actionBar:!0,actionBarGroup:this.options.foldingAlternateClose,contextMenu:!1,infoPanel:!1},foldingCloseAction=new Action(options2,context2);butts.set(this.htmlElement.id+"_folding_close_button",foldingCloseAction),this.splitbar.hasClassName("folded")?foldingAction.deny=!0:(foldingAction.deny=!0,foldingAction.disable())}return butts},resizeGroup:function(event,size,keepPercents){var groupInitAdjust=this.group._adjust;this.group._fixed=this.options.getFixed(this.group)-this.group._borderFixed,this.group._adjust=this.group[this.options.offsetAdjust]-this.group._borderAdjust;var optName=this.options.fixed,borderAdjA=this.initBorderA;this.paneA.setStyle(this.makeStyleObject(optName,this.group._fixed-this.paneA._padFixed-borderAdjA+"px"));var borderAdjB=this.initBorderB;if(this.paneB.setStyle(this.makeStyleObject(optName,this.group._fixed-this.paneB._padFixed-borderAdjB+"px")),this.splitbar.setStyle(this.makeStyleObject(optName,this.group._fixed+"px")),this.splitbar.hasClassName("folded")){if(this.foldedPane==this.paneA){var hiddenWidth=parseInt(this.paneA.getStyle(this.options.set));return void this.moveSplitter(0,!0,-hiddenWidth)}return void this.moveSplitter(this.group._adjust,this.paneB,0)}size=keepPercents&&!size&&groupInitAdjust?parseInt(this.paneA[this.options.offsetAdjust]*this.group._adjust/groupInitAdjust)+this.initBorderA:size||(this.options.initB?this.group._adjust-this.paneB[this.options.offsetAdjust]-this.splitbar._adjust:this.paneA[this.options.offsetAdjust]),this.moveSplitter(size)},toggleFolding:function(pane){if(this.splitbar.hasClassName("folded")){var afE=this.options.autoFoldOnEvent;return this.options.autoFoldOnEvent=!1,
this.unfold(),this.options.autoFoldOnEvent=afE,!1}return this.foldPane(pane),!0},refreshFoldingAction:function(pane){if(pane||(pane=this.foldedPane),this.paneA){var state=this.splitbar.hasClassName("folded");this.getFoldingAction()&&(this.options.foldingAlternateClose?this.getFoldingAction()[state?"enable":"disable"]():this.getFoldingAction().setIconSrc("view_left_"+(state?"right":"close")+".png",state?pane==this.paneA?"icon-caret-right":"icon-caret-left":"icon-remove-sign"),pane==this.paneA&&$(this.paneA).ajxpPaneObject&&$(this.paneA).ajxpPaneObject.resize(),pane==this.paneB&&$(this.paneB).ajxpPaneObject&&$(this.paneB).ajxpPaneObject.resize())}},fold:function(){this.foldPane(this.paneA)},foldPane:function(pane){if(!this.effectWorking&&!this.options.noFolding){var realFoldValue;"A"==this.options.foldingButton?realFoldValue=this.prefoldValue=this.options.getAdjust(this.paneA):(this.prefoldValue=this.options.getAdjust(this.paneB),realFoldValue=this.group._adjust-this.prefoldValue),this.foldedPane=pane,this.effectWorking=!0;var target=pane==this.paneA?0:this.group._adjust;new Effect.Tween(null,realFoldValue,target,{afterFinish:function(){this.splitbar.addClassName("folded"),this.foldedPane.addClassName("folded"),this.effectWorking=!1,this.setUserPreference("folded",!0),this.refreshFoldingAction(pane)}.bind(this),duration:.8},function(p){p==target-3&&this.foldedPane.addClassName("folded"),this.moveSplitter(p,this.options.minA?!1:pane,realFoldValue)}.bind(this))}},unfold:function(){if(!this.effectWorking){this.prefoldValue||(this.prefoldValue=150,"A"==this.options.foldingButton&&this.paneA._min&&void 0!==this.options.foldingMinSize?this.prefoldValue=this.paneA._min:"B"==this.options.foldingButton&&this.paneB._min&&void 0!==this.options.foldingMinSize&&(this.prefoldValue=this.paneB._min));var target="A"==this.options.foldingButton?this.prefoldValue:this.group._adjust-this.prefoldValue,presetAdjust=this.prefoldValue;if("B"==this.options.foldingButton&&(presetAdjust-=this.paneB._padAdjust+this.splitbar._adjust,this["A"==this.options.foldingButton?"paneA":"paneB"].setStyle(this.makeStyleObject(this.options.adjust,presetAdjust+"px"))),this.effectWorking=!0,new Effect.Tween(null,this.foldedPane==this.paneA?0:this.group._adjust,target,{afterFinish:function(){this.splitbar.removeClassName("folded"),this.effectWorking=!1,this.setUserPreference("folded",!1),this.refreshFoldingAction(this.foldedPane)}.bind(this),duration:.8},function(p){this.paneA&&this.paneB&&this.moveSplitter(p,this.options.minA?!1:this.foldedPane,target)}.bind(this)),this.foldedPane){var fPane=this.foldedPane;window.setTimeout(function(){fPane.removeClassName("folded")},200)}this.options.autoFoldOnEvent&&document.observeOnce(this.options.autoFoldOnEvent,this.fold.bind(this))}},foldWithoutAnim:function(){this.options.noFolding||("A"==this.options.foldingButton?(this.prefoldValue=this.options.getAdjust(this.paneA),this.moveSplitter(0,this.options.minA?!1:this.paneA,this.prefoldValue),this.foldedPane=this.paneA,this.paneA.addClassName("folded")):(this.prefoldValue=this.options.getAdjust(this.paneB),this.moveSplitter(this.group._adjust,this.paneB,this.prefoldValue),this.foldedPane=this.paneB,this.paneB.addClassName("folded")),this.splitbar.addClassName("folded"),this.setUserPreference("folded",!0),this.refreshFoldingAction())},resizeAnimated:function(size){if(!this.effectWorking&&!this.splitbar.hasClassName("folded")){this.effectWorking=!0;var current=this.options.getAdjust(this.paneA)+this.initBorderA;new Effect.Tween(null,current,size,{afterFinish:function(){this.effectWorking=!1}.bind(this)},function(p){this.paneA&&this.paneB&&this.moveSplitter(p)}.bind(this))}},startSplit:function(event){return this.splitbar.hasClassName("folded")?!1:(this.splitbar.addClassName(this.options.activeClass),this.paneA._posAdjust=this.options.getAdjust(this.paneA)+this.initBorderA-this.options.eventPointer(event),void(this.options.startDrag&&this.options.startDrag(this.getCurrentSize())))},doSplitMouse:function(event){return this.splitbar.hasClassName(this.options.activeClass)?void this.moveSplitter(this.paneA._posAdjust+this.options.eventPointer(event)):this.endSplit(event)},endSplit:function(event){this.splitbar.hasClassName(this.options.activeClass)&&(this.splitbar.removeClassName(this.options.activeClass),this.options.endDrag&&this.options.endDrag(this.getCurrentSize()),$(this.paneA).ajxpPaneObject&&$(this.paneA).ajxpPaneObject.resize(),$(this.paneB).ajxpPaneObject&&$(this.paneB).ajxpPaneObject.resize(),this.setUserPreference("size",this.getCurrentSize()))},moveSplitter:function(np,folding,foldingSize){var minSize=this.options.minSize,minPaneA=this.paneA._min,minPaneB=this.paneB._min;if(folding&&void 0!==this.options.foldingMinSize&&(minSize=minPaneA=minPaneB=this.options.foldingMinSize),!folding&&this.options.minA&&np<this.options.minA+10&&!this.options.noFolding){np=this.options.minA;var forceFolded=!0}np=Math.max(minPaneA+this.paneA._padAdjust,this.group._adjust-(this.paneB._max||9999),minSize,Math.min(np,this.paneA._max||9999,this.group._adjust-this.splitbar._adjust-Math.max(minPaneB+this.paneB._padAdjust,minSize)));this.options.set,this.options.adjust;np||(np=this.paneA._init),this.splitbar.setStyle(this.makeStyleObject(this.options.set,np+this.splitbar._reAdjust+"px"));var borderAdjA=0,borderAdjB=0;this.initBorderA&&(borderAdjA=this.initBorderA);var targetAdjustA=np-this.paneA._padAdjust-borderAdjA;this.paneA.setStyle(folding&&folding==this.paneA?this.makeStyleObject(this.options.set,targetAdjustA-foldingSize+"px"):this.makeStyleObject(this.options.adjust,targetAdjustA+"px")),this.paneB.setStyle(this.makeStyleObject(this.options.set,np+this.splitbar._adjust+"px")),this.initBorderB&&(borderAdjB=this.initBorderB);var bSide=this.group._adjust-this.splitbar._adjust-this.paneB._padAdjust-np-borderAdjB;bSide=Math.max(0,bSide),folding&&folding==this.paneB||this.paneB.setStyle(this.makeStyleObject(this.options.adjust,bSide+"px")),Prototype.Browser.IE||(this.paneA.fire("resize"),this.paneB.fire("resize")),this.options.onDrag&&this.options.onDrag(),$(this.paneA).ajxpPaneObject&&$(this.paneA).ajxpPaneObject.resize(),$(this.paneB).ajxpPaneObject&&$(this.paneB).ajxpPaneObject.resize(),forceFolded&&(this.prefoldValue||(this.prefoldValue=150),"A"==this.options.foldingButton?this.paneA.addClassName("folded"):this.paneB.addClassName("folded"),this.splitbar.addClassName("folded"),this.setUserPreference("folded",!0),this.refreshFoldingAction())},cssCache:function(jq,n,pf,m1,m2){var boxModel=!Prototype.Browser.IE||"CSS1Compat"==document.compatMode;jq[n]=boxModel?(parseInt(jq.getStyle(pf+m1))||0)+(parseInt(jq.getStyle(pf+m2))||0):0},optCache:function(jq,pane){jq._min=Math.max(0,this.options["min"+pane]||parseInt(jq.getStyle("min-"+this.options.adjust))||0),jq._max=Math.max(0,this.options["max"+pane]||parseInt(jq.getStyle("max-"+this.options.adjust))||0)},initCaches:function(){this.options.invisibleBar?(this.splitbar._adjust=0,this.splitbar._reAdjust=-Math.round(this.splitbar[this.options.offsetAdjust])/2):(this.splitbar._adjust=this.splitbar[this.options.offsetAdjust],this.splitbar._reAdjust=0),this.cssCache(this.group,"_borderAdjust","border",this.options.adjSide1,this.options.adjSide2),this.cssCache(this.group,"_borderFixed","border",this.options.fixSide1,this.options.fixSide2),this.cssCache(this.paneA,"_padAdjust","padding",this.options.adjSide1,this.options.adjSide2),this.cssCache(this.paneA,"_padFixed","padding",this.options.fixSide1,this.options.fixSide2),this.cssCache(this.paneB,"_padAdjust","padding",this.options.adjSide1,this.options.adjSide2),this.cssCache(this.paneB,"_padFixed","padding",this.options.fixSide1,this.options.fixSide2),this.optCache(this.paneA,"A"),this.optCache(this.paneB,"B")},getWidth:function(el){return el.offsetWidth},getHeight:function(el){if("undefined"!=typeof el.offsetHeight)return parseInt(el.offsetHeight);var h=el.getHeight();return!h&&el.parentNode&&(h=$(el.parentNode).getHeight(),Prototype.Browser.IE||(h-=parseInt(2*$(el.parentNode).paddingHeight))),h},makeStyleObject:function(propStringName,propValue){var sObject={};return sObject[propStringName]=propValue,sObject},getCurrentSize:function(){return this.options.getAdjust(this.paneA)},resize:function(){this.options.fit&&"height"==this.options.fit&&fitHeightToBottom(this.htmlElement,this.options.fitParent?$(this.options.fitParent):null),this.resizeGroup(null,null,!0),this.firstResizePassed||(this.userLoggedObs(),this.firstResizePassed=!0)},showElement:function(show){}});var CookieJar=Class.create();CookieJar.prototype={appendString:"__CJ_",initialize:function(options){if(this.options={expires:3600,path:"",domain:"",secure:""},Object.extend(this.options,options||{}),""!=this.options.expires){var date=new Date;date=new Date(date.getTime()+1e3*this.options.expires),this.options.expires="; expires="+date.toGMTString()}""!=this.options.path&&(this.options.path="; path="+escape(this.options.path)),""!=this.options.domain&&(this.options.domain="; domain="+escape(this.options.domain)),"secure"==this.options.secure?this.options.secure="; secure":this.options.secure=""},put:function(name,value){name=this.appendString+name;var cookie=this.options,type=typeof value;switch(type){case"undefined":case"function":case"unknown":return!1;case"boolean":case"string":case"number":value=String(value.toString())}var cookie_str=name+"="+escape(Object.toJSON(value));try{document.cookie=cookie_str+cookie.expires+cookie.path+cookie.domain+cookie.secure}catch(e){return!1}return!0},remove:function(name){name=this.appendString+name;var cookie=this.options;try{var date=new Date;date.setTime(date.getTime()-36e5);var expires="; expires="+date.toGMTString();document.cookie=name+"="+expires+cookie.path+cookie.domain+cookie.secure}catch(e){return!1}return!0},get:function(name){name=this.appendString+name;var cookies=document.cookie.match(name+"=(.*?)(;|$)");return cookies?unescape(cookies[1]).evalJSON():null},empty:function(){for(var keys=this.getKeys(),size=keys.size(),i=0;size>i;i++)this.remove(keys[i])},getPack:function(){for(var pack={},keys=this.getKeys(),size=keys.size(),i=0;size>i;i++)pack[keys[i]]=this.get(keys[i]);return pack},getKeys:function(){for(var match,keys=$A(),keyRe=/[^=; ]+(?=\=)/g,str=document.cookie,CJRe=new RegExp("^"+this.appendString);void 0!=(match=keyRe.exec(str));)CJRe.test(match[0].strip())&&keys.push(match[0].strip().gsub("^"+this.appendString,""));return keys}};var Protopass=Class.create({initialize:function(item,options){if(this.item=$(item),this.field_name=this.item.id,this.options={messages:["Unsafe password word!","Too short","Very weak","Weak","Medium","Strong","Very strong"],colors:["#f00","#999","#f00","#c06","#f60","#3c0","#2c0"],scores:[10,15,30,40],common:["password","123456","123","1234","mypass","pass","letmein","qwerty","monkey","asdfgh","zxcvbn","pass"],minchar:8,barContainer:this.item,barPosition:"after",labelWidth:39},window.MessageHash){var keys=[379,380,381,382,383,384,385];for(var key in keys)keys.hasOwnProperty(key)&&(this.options.messages[key]=window.MessageHash[keys[key]])}window.ajxpBootstrap&&parseInt(window.ajaxplorer.getPluginConfigs("core.auth").get("PASSWORD_MINLENGTH"))&&(this.options.minchar=parseInt(window.ajaxplorer.getPluginConfigs("core.auth").get("PASSWORD_MINLENGTH"))),Object.extend(this.options,options||{});var ins={},string='<div class="password-strength-info" style="float:left; padding-top: 2px; width:'+this.options.labelWidth+'%;text-align:right;" id="'+this.field_name+'_text"></div>';string+='<div style="float:left;width:'+(100-this.options.labelWidth-(Prototype.Browser.IE?7:0))+'%;"><div class="password-strength-bar" id="'+this.field_name+'_bar" style="'+(Prototype.Browser.IE?"":"margin-top:5px;")+'height:0px; width: 0px;"></div></div>',ins[this.options.barPosition]=string,this.options.barContainer.insert(ins),this.bar=$(this.field_name+"_bar"),this.feedback_text=$(this.field_name+"_text"),this.item.observe("keyup",function(){this.checkUserPasswordStrength()}.bind(this)),modal&&this.observeOnce("strength_change",function(){modal.refreshDialogAppearance()})},checkUserPasswordStrength:function(){var options=this.options,value=this.item.value,strength=this.getPasswordScore(value,options);this.strength=strength,-200==strength?this.displayPasswordStrengthFeedback(0,0):0>strength&&strength>-199?this.displayPasswordStrengthFeedback(1,10):strength<=options.scores[0]?this.displayPasswordStrengthFeedback(2,10):strength>options.scores[0]&&strength<=options.scores[1]?this.displayPasswordStrengthFeedback(3,25):strength>options.scores[1]&&strength<=options.scores[2]?this.displayPasswordStrengthFeedback(4,55):strength>options.scores[2]&&strength<=options.scores[3]?this.displayPasswordStrengthFeedback(5,80):this.displayPasswordStrengthFeedback(6,98),this.notify("strength_change")},displayPasswordStrengthFeedback:function(setting_index,percent_rate){this.feedback_text.innerHTML="<span style='color: "+this.options.colors[setting_index]+";'>"+this.options.messages[setting_index]+" &nbsp;&nbsp; </span>",this.bar.setStyle("height: "+(Prototype.Browser.IE?"5px":"8px;")+"; width:"+percent_rate+"%;background-color:"+this.options.colors[setting_index]),this.options.barContainer.show()},getPasswordScore:function(value,options){var strength=0;value.length<options.minchar?strength-=100:value.length>=options.minchar&&value.length<=options.minchar+2?strength+=6:value.length>=options.minchar+3&&value.length<=options.minchar+4?strength+=12:value.length>=options.minchar+5&&(strength+=18),value.match(/[a-z]/)&&(strength+=1),value.match(/[A-Z]/)&&(strength+=5),value.match(/\d+/)&&(strength+=5),value.match(/(.*[0-9].*[0-9].*[0-9])/)&&(strength+=7),value.match(/.[!,@,#,$,%,^,&,*,?,_,~]/)&&(strength+=5),value.match(/(.*[!,@,#,$,%,^,&,*,?,_,~].*[!,@,#,$,%,^,&,*,?,_,~])/)&&(strength+=7),value.match(/([a-z].*[A-Z])|([A-Z].*[a-z])/)&&(strength+=2),value.match(/([a-zA-Z])/)&&value.match(/([0-9])/)&&(strength+=3),value.match(/([a-zA-Z0-9].*[!,@,#,$,%,^,&,*,?,_,~])|([!,@,#,$,%,^,&,*,?,_,~].*[a-zA-Z0-9])/)&&(strength+=3);for(var i=0;i<options.common.length;i++)value.toLowerCase()==options.common[i]&&(strength=-200);return strength}});Class.create("Resizable",{initialize:function(elm){var defaults={onStart:null,onEnd:null,default_style:!0,class_name:"resizableHandle"};this.options=Object.extend(defaults,arguments[1]||{}),this.options.onStart&&(this.onStart=this.options.onStart),this.options.onEnd&&(this.onEnd=this.options.onEnd),this.c=elm,this.c.getStyle("position")||this.c.setStyle({position:"relative"}),this.resizer=new Element("div",{"class":this.options.class_name}),this.options.default_style&&this.resizer.writeAttribute({style:"width:10px; height:10px; position:absolute; background-color:grey;"}),this.resizer.toggle(),this.c.insert(this.resizer),this.setResizer(),this.start_count=0,this.resizer.observe("mousedown",function(ev){this.onStart&&this.start_count<1&&this.onStart(),this.c.observe("resizer:mousemove",function(ev){this.resizing(ev.memo)}.bind(this)),this.c.observe("resizer:mouseup",function(ev){this.start_count=0,this.onEnd&&this.onEnd(),this.c.stopObserving("resizer:mousemove"),this.c.stopObserving("resizer:mouseup")}.bind(this));var p=Event.pointer(ev);this.start_x=p.x,this.start_y=p.y,document.observe("mousemove",function(ev){this.c.fire("resizer:mousemove",ev)}.bind(this)),document.observe("mouseup",function(ev){this.c.fire("resizer:mouseup",ev)}.bind(this))}.bind(this)),this.resizer.ondragstart=function(){return!1},this.resizer.toggle()},setResizer:function(){var r_layout=this.resizer.getLayout(),c_layout=this.c.getLayout();Element.setStyle(this.resizer,{position:"absolute",left:c_layout.get("padding-box-width")-r_layout.get("padding-box-width")+"px",top:c_layout.get("padding-box-height")-r_layout.get("padding-box-width")+"px"})},resizing:function(ev){var p=Event.pointer(ev),xdiff=p.x-this.start_x,ydiff=p.y-this.start_y,c_layout=this.c.getLayout();this.c.setStyle({width:c_layout.get("width")+xdiff+"px"}),this.c.setStyle({height:c_layout.get("height")+ydiff+"px"}),this.start_x=p.x,this.start_y=p.y,this.setResizer()}});var currentLightBox,currentDraggable;Event.observe(window,"load",initializeLightbox,!1);var lightbox=Class.create();lightbox.prototype={yPos:0,xPos:0,initialize:function(id){this.content=id},activate:function(){Prototype.Browser.IE&&(this.getScroll(),this.setScroll(0,0)),this.displayLightbox("block")},getScroll:function(){self.pageYOffset?this.yPos=self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?this.yPos=document.documentElement.scrollTop:document.body&&(this.yPos=document.body.scrollTop)},setScroll:function(x,y){window.scrollTo(x,y)},displayLightbox:function(display){if($("overlay")||addLightboxMarkup(),"none"==display)$("overlay").fade({duration:.5,afterFinish:function(){this.originalStyle&&$("overlay").setStyle(this.originalStyle)}.bind(this)});else{if($("overlay").setAttribute("style",""),$("overlay").style.display=display,this.overlayStyle){this.originalStyle={};for(var key in this.overlayStyle)this.originalStyle[key]=$("overlay").getStyle(key);$("overlay").setStyle(this.overlayStyle)}this.overlayClass?$("overlay").className="overlay "+this.overlayClass:$("overlay").className="overlay"}null!=this.content&&($(this.content).style.display=display,currentDraggable=new Draggable(this.content,{handle:"dialogTitle",zindex:1050,starteffect:function(element){},endeffect:function(element){}}))},actions:function(){for(var lbActions=document.getElementsByClassName("lbAction"),i=0;i<lbActions.length;i++)Event.observe(lbActions[i],"click",this[lbActions[i].rel].bindAsEventListener(this),!1),lbActions[i].onclick=function(){return!1}},deactivate:function(){Prototype.Browser.IE&&this.setScroll(0,this.yPos),this.displayLightbox("none")}};var Builder={NODEMAP:{AREA:"map",CAPTION:"table",COL:"table",COLGROUP:"table",LEGEND:"fieldset",OPTGROUP:"select",OPTION:"select",PARAM:"object",TBODY:"table",TD:"table",TFOOT:"table",TH:"table",THEAD:"table",TR:"table"},node:function(elementName){elementName=elementName.toUpperCase();var parentTag=this.NODEMAP[elementName]||"div",parentElement=document.createElement(parentTag);try{parentElement.innerHTML="<"+elementName+"></"+elementName+">"}catch(e){}var element=parentElement.firstChild||null;if(element&&element.tagName.toUpperCase()!=elementName&&(element=element.getElementsByTagName(elementName)[0]),element||(element=document.createElement(elementName)),element){if(arguments[1])if(this._isStringOrNumber(arguments[1])||arguments[1]instanceof Array||arguments[1].tagName)this._children(element,arguments[1]);else{var attrs=this._attributes(arguments[1]);if(attrs.length){try{parentElement.innerHTML="<"+elementName+" "+attrs+"></"+elementName+">"}catch(e){}if(element=parentElement.firstChild||null,!element){element=document.createElement(elementName);for(attr in arguments[1])element["class"==attr?"className":attr]=arguments[1][attr]}element.tagName.toUpperCase()!=elementName&&(element=parentElement.getElementsByTagName(elementName)[0])}}return arguments[2]&&this._children(element,arguments[2]),element}},_text:function(text){return document.createTextNode(text)},ATTR_MAP:{className:"class",htmlFor:"for"},_attributes:function(attributes){var attrs=[];for(attribute in attributes)attrs.push((attribute in this.ATTR_MAP?this.ATTR_MAP[attribute]:attribute)+'="'+attributes[attribute].toString().escapeHTML().gsub(/"/,"&quot;")+'"');return attrs.join(" ")},_children:function(element,children){return children.tagName?void element.appendChild(children):void("object"==typeof children?children.flatten().each(function(e){"object"==typeof e?element.appendChild(e):Builder._isStringOrNumber(e)&&element.appendChild(Builder._text(e))}):Builder._isStringOrNumber(children)&&element.appendChild(Builder._text(children)))},_isStringOrNumber:function(param){return"string"==typeof param||"number"==typeof param},build:function(html){var element=this.node("div");return $(element).update(html.strip()),element.down()},dump:function(scope){"object"!=typeof scope&&"function"!=typeof scope&&(scope=window);var tags="A ABBR ACRONYM ADDRESS APPLET AREA B BASE BASEFONT BDO BIG BLOCKQUOTE BODY BR BUTTON CAPTION CENTER CITE CODE COL COLGROUP DD DEL DFN DIR DIV DL DT EM FIELDSET FONT FORM FRAME FRAMESET H1 H2 H3 H4 H5 H6 HEAD HR HTML I IFRAME IMG INPUT INS ISINDEX KBD LABEL LEGEND LI LINK MAP MENU META NOFRAMES NOSCRIPT OBJECT OL OPTGROUP OPTION P PARAM PRE Q S SAMP SCRIPT SELECT SMALL SPAN STRIKE STRONG STYLE SUB SUP TABLE TBODY TD TEXTAREA TFOOT TH THEAD TITLE TR TT U UL VAR".split(/\s+/);tags.each(function(tag){scope[tag]=function(){return Builder.node.apply(Builder,[tag].concat($A(arguments)))}})}};String.prototype.parseColor=function(){var color="#";if("rgb("==this.slice(0,4)){var cols=this.slice(4,this.length-1).split(","),i=0;do color+=parseInt(cols[i]).toColorPart();while(++i<3)}else if("#"==this.slice(0,1)){if(4==this.length)for(var i=1;4>i;i++)color+=(this.charAt(i)+this.charAt(i)).toLowerCase();7==this.length&&(color=this.toLowerCase())}return 7==color.length?color:arguments[0]||this},Element.collectTextNodes=function(element){return $A($(element).childNodes).collect(function(node){return 3==node.nodeType?node.nodeValue:node.hasChildNodes()?Element.collectTextNodes(node):""}).flatten().join("")},Element.collectTextNodesIgnoreClass=function(element,className){return $A($(element).childNodes).collect(function(node){return 3==node.nodeType?node.nodeValue:node.hasChildNodes()&&!Element.hasClassName(node,className)?Element.collectTextNodesIgnoreClass(node,className):""}).flatten().join("")},Element.setContentZoom=function(element,percent){return element=$(element),element.setStyle({fontSize:percent/100+"em"}),Prototype.Browser.WebKit&&window.scrollBy(0,0),element},Element.getInlineOpacity=function(element){return $(element).style.opacity||""},Element.forceRerendering=function(element){try{element=$(element);var n=document.createTextNode(" ");element.appendChild(n),element.removeChild(n)}catch(e){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(pos){return-Math.cos(pos*Math.PI)/2+.5},reverse:function(pos){return 1-pos},flicker:function(pos){var pos=-Math.cos(pos*Math.PI)/4+.75+Math.random()/4;return pos>1?1:pos},wobble:function(pos){return-Math.cos(pos*Math.PI*9*pos)/2+.5},pulse:function(pos,pulses){return pulses=pulses||5,0==(pos%(1/pulses)*pulses).round()?pos*pulses*2-(pos*pulses*2).floor():1-(pos*pulses*2-(pos*pulses*2).floor())},spring:function(pos){return 1-Math.cos(4.5*pos*Math.PI)*Math.exp(6*-pos)},none:function(pos){return 0},full:function(pos){return 1}},DefaultOptions:{duration:1,fps:100,sync:!1,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(element){var tagifyStyle="position:relative";Prototype.Browser.IE&&(tagifyStyle+=";zoom:1"),element=$(element),$A(element.childNodes).each(function(child){3==child.nodeType&&(child.nodeValue.toArray().each(function(character){element.insertBefore(new Element("span",{style:tagifyStyle}).update(" "==character?String.fromCharCode(160):character),child)}),Element.remove(child))})},multiple:function(element,effect){var elements;elements=("object"==typeof element||Object.isFunction(element))&&element.length?element:$(element).childNodes;var options=Object.extend({speed:.1,delay:0},arguments[2]||{}),masterDelay=options.delay;$A(elements).each(function(element,index){new effect(element,Object.extend(options,{delay:index*options.speed+masterDelay}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(element,effect){element=$(element),effect=(effect||"appear").toLowerCase();var options=Object.extend({queue:{position:"end",scope:element.id||"global",limit:1}},arguments[2]||{});Effect[element.visible()?Effect.PAIRS[effect][1]:Effect.PAIRS[effect][0]](element,options)}};if(Effect.DefaultOptions.transition=Effect.Transitions.sinoidal,Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[],this.interval=null},_each:function(iterator){this.effects._each(iterator)},add:function(effect){var timestamp=(new Date).getTime(),position=Object.isString(effect.options.queue)?effect.options.queue:effect.options.queue.position;switch(position){case"front":this.effects.findAll(function(e){return"idle"==e.state}).each(function(e){e.startOn+=effect.finishOn,e.finishOn+=effect.finishOn});break;case"with-last":timestamp=this.effects.pluck("startOn").max()||timestamp;break;case"end":timestamp=this.effects.pluck("finishOn").max()||timestamp}effect.startOn+=timestamp,effect.finishOn+=timestamp,(!effect.options.queue.limit||this.effects.length<effect.options.queue.limit)&&this.effects.push(effect),this.interval||(this.interval=setInterval(this.loop.bind(this),15))},remove:function(effect){this.effects=this.effects.reject(function(e){return e==effect}),0==this.effects.length&&(clearInterval(this.interval),this.interval=null)},loop:function(){for(var timePos=(new Date).getTime(),i=0,len=this.effects.length;len>i;i++)this.effects[i]&&this.effects[i].loop(timePos)}}),Effect.Queues={instances:$H(),get:function(queueName){return Object.isString(queueName)?this.instances.get(queueName)||this.instances.set(queueName,new Effect.ScopedQueue):queueName}},Effect.Queue=Effect.Queues.get("global"),Effect.Base=Class.create({position:null,start:function(options){function codeForEvent(options,eventName){return(options[eventName+"Internal"]?"this.options."+eventName+"Internal(this);":"")+(options[eventName]?"this.options."+eventName+"(this);":"")}options&&options.transition===!1&&(options.transition=Effect.Transitions.linear),this.options=Object.extend(Object.extend({},Effect.DefaultOptions),options||{}),this.currentFrame=0,this.state="idle",this.startOn=1e3*this.options.delay,this.finishOn=this.startOn+1e3*this.options.duration,this.fromToDelta=this.options.to-this.options.from,this.totalTime=this.finishOn-this.startOn,this.totalFrames=this.options.fps*this.options.duration,eval('this.render = function(pos){ if (this.state=="idle"){this.state="running";'+codeForEvent(this.options,"beforeSetup")+(this.setup?"this.setup();":"")+codeForEvent(this.options,"afterSetup")+'};if (this.state=="running"){pos=this.options.transition(pos)*'+this.fromToDelta+"+"+this.options.from+";this.position=pos;"+codeForEvent(this.options,"beforeUpdate")+(this.update?"this.update(pos);":"")+codeForEvent(this.options,"afterUpdate")+"}}"),this.event("beforeStart"),this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)},loop:function(timePos){if(timePos>=this.startOn){if(timePos>=this.finishOn)return this.render(1),this.cancel(),this.event("beforeFinish"),this.finish&&this.finish(),void this.event("afterFinish");var pos=(timePos-this.startOn)/this.totalTime,frame=(pos*this.totalFrames).round();frame>this.currentFrame&&(this.render(pos),this.currentFrame=frame)}},cancel:function(){this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this),this.state="finished"},event:function(eventName){this.options[eventName+"Internal"]&&this.options[eventName+"Internal"](this),this.options[eventName]&&this.options[eventName](this)},inspect:function(){var data=$H();for(property in this)Object.isFunction(this[property])||data.set(property,this[property]);return"#<Effect:"+data.inspect()+",options:"+$H(this.options).inspect()+">"}}),Effect.Parallel=Class.create(Effect.Base,{initialize:function(effects){this.effects=effects||[],this.start(arguments[1])},update:function(position){this.effects.invoke("render",position)},finish:function(position){this.effects.each(function(effect){effect.render(1),effect.cancel(),effect.event("beforeFinish"),effect.finish&&effect.finish(position),effect.event("afterFinish")})}}),Effect.Tween=Class.create(Effect.Base,{initialize:function(object,from,to){object=Object.isString(object)?$(object):object;var args=$A(arguments),method=args.last(),options=5==args.length?args[3]:null;this.method=Object.isFunction(method)?method.bind(object):Object.isFunction(object[method])?object[method].bind(object):function(value){object[method]=value},this.start(Object.extend({from:from,to:to},options||{}))},update:function(position){this.method(position)}}),Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction}),Effect.Opacity=Class.create(Effect.Base,{initialize:function(element){if(this.element=$(element),!this.element)throw Effect._elementDoesNotExistError;Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});var options=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});this.start(options)},update:function(position){this.element.setOpacity(position)}}),Effect.Move=Class.create(Effect.Base,{initialize:function(element){if(this.element=$(element),!this.element)throw Effect._elementDoesNotExistError;var options=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(options)},setup:function(){this.element.makePositioned(),this.originalLeft=parseFloat(this.element.getStyle("left")||"0"),this.originalTop=parseFloat(this.element.getStyle("top")||"0"),"absolute"==this.options.mode&&(this.options.x=this.options.x-this.originalLeft,this.options.y=this.options.y-this.originalTop)},update:function(position){this.element.setStyle({left:(this.options.x*position+this.originalLeft).round()+"px",top:(this.options.y*position+this.originalTop).round()+"px"})}}),Effect.MoveBy=function(element,toTop,toLeft){return new Effect.Move(element,Object.extend({x:toLeft,y:toTop},arguments[3]||{}))},Effect.Scale=Class.create(Effect.Base,{initialize:function(element,percent){if(this.element=$(element),!this.element)throw Effect._elementDoesNotExistError;var options=Object.extend({scaleX:!0,scaleY:!0,scaleContent:!0,scaleFromCenter:!1,scaleMode:"box",scaleFrom:100,scaleTo:percent},arguments[2]||{});this.start(options)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||!1,this.elementPositioning=this.element.getStyle("position"),this.originalStyle={},["top","left","width","height","fontSize"].each(function(k){this.originalStyle[k]=this.element.style[k]}.bind(this)),this.originalTop=this.element.offsetTop,this.originalLeft=this.element.offsetLeft;var fontSize=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(fontSizeType){fontSize.indexOf(fontSizeType)>0&&(this.fontSize=parseFloat(fontSize),this.fontSizeType=fontSizeType)}.bind(this)),this.factor=(this.options.scaleTo-this.options.scaleFrom)/100,this.dims=null,"box"==this.options.scaleMode&&(this.dims=[this.element.offsetHeight,this.element.offsetWidth]),/^content/.test(this.options.scaleMode)&&(this.dims=[this.element.scrollHeight,this.element.scrollWidth]),this.dims||(this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth])},update:function(position){var currentScale=this.options.scaleFrom/100+this.factor*position;this.options.scaleContent&&this.fontSize&&this.element.setStyle({fontSize:this.fontSize*currentScale+this.fontSizeType}),this.setDimensions(this.dims[0]*currentScale,this.dims[1]*currentScale)},finish:function(position){this.restoreAfterFinish&&this.element.setStyle(this.originalStyle)},setDimensions:function(height,width){var d={};if(this.options.scaleX&&(d.width=width.round()+"px"),this.options.scaleY&&(d.height=height.round()+"px"),this.options.scaleFromCenter){var topd=(height-this.dims[0])/2,leftd=(width-this.dims[1])/2;"absolute"==this.elementPositioning?(this.options.scaleY&&(d.top=this.originalTop-topd+"px"),this.options.scaleX&&(d.left=this.originalLeft-leftd+"px")):(this.options.scaleY&&(d.top=-topd+"px"),
this.options.scaleX&&(d.left=-leftd+"px"))}this.element.setStyle(d)}}),Effect.Highlight=Class.create(Effect.Base,{initialize:function(element){if(this.element=$(element),!this.element)throw Effect._elementDoesNotExistError;var options=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(options)},setup:function(){return"none"==this.element.getStyle("display")?void this.cancel():(this.oldStyle={},this.options.keepBackgroundImage||(this.oldStyle.backgroundImage=this.element.getStyle("background-image"),this.element.setStyle({backgroundImage:"none"})),this.options.endcolor||(this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")),this.options.restorecolor||(this.options.restorecolor=this.element.getStyle("background-color")),this._base=$R(0,2).map(function(i){return parseInt(this.options.startcolor.slice(2*i+1,2*i+3),16)}.bind(this)),void(this._delta=$R(0,2).map(function(i){return parseInt(this.options.endcolor.slice(2*i+1,2*i+3),16)-this._base[i]}.bind(this))))},update:function(position){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(m,v,i){return m+(this._base[i]+this._delta[i]*position).round().toColorPart()}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}}),Effect.ScrollTo=function(element){var options=arguments[1]||{},scrollOffsets=document.viewport.getScrollOffsets(),elementOffsets=$(element).cumulativeOffset(),max=(window.height||document.body.scrollHeight)-document.viewport.getHeight();return options.offset&&(elementOffsets[1]+=options.offset),new Effect.Tween(null,scrollOffsets.top,elementOffsets[1]>max?max:elementOffsets[1],options,function(p){scrollTo(scrollOffsets.left,p.round())})},Effect.Fade=function(element){element=$(element);var oldOpacity=element.getInlineOpacity(),options=Object.extend({from:element.getOpacity()||1,to:0,afterFinishInternal:function(effect){0==effect.options.to&&effect.element.hide().setStyle({opacity:oldOpacity})}},arguments[1]||{});return new Effect.Opacity(element,options)},Effect.Appear=function(element){element=$(element);var options=Object.extend({from:"none"==element.getStyle("display")?0:element.getOpacity()||0,to:1,afterFinishInternal:function(effect){effect.element.forceRerendering()},beforeSetup:function(effect){effect.element.setOpacity(effect.options.from).show()}},arguments[1]||{});return new Effect.Opacity(element,options)},Effect.Puff=function(element){element=$(element);var oldStyle={opacity:element.getInlineOpacity(),position:element.getStyle("position"),top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};return new Effect.Parallel([new Effect.Scale(element,200,{sync:!0,scaleFromCenter:!0,scaleContent:!0,restoreAfterFinish:!0}),new Effect.Opacity(element,{sync:!0,to:0})],Object.extend({duration:1,beforeSetupInternal:function(effect){Position.absolutize(effect.effects[0].element)},afterFinishInternal:function(effect){effect.effects[0].element.hide().setStyle(oldStyle)}},arguments[1]||{}))},Effect.BlindUp=function(element){return element=$(element),element.makeClipping(),new Effect.Scale(element,0,Object.extend({scaleContent:!1,scaleX:!1,restoreAfterFinish:!0,afterFinishInternal:function(effect){effect.element.hide().undoClipping()}},arguments[1]||{}))},Effect.BlindDown=function(element){element=$(element);var elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:0,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:!0,afterSetup:function(effect){effect.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(effect){effect.element.undoClipping()}},arguments[1]||{}))},Effect.SwitchOff=function(element){element=$(element);var oldOpacity=element.getInlineOpacity();return new Effect.Appear(element,Object.extend({duration:.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(effect){new Effect.Scale(effect.element,1,{duration:.3,scaleFromCenter:!0,scaleX:!1,scaleContent:!1,restoreAfterFinish:!0,beforeSetup:function(effect){effect.element.makePositioned().makeClipping()},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned().setStyle({opacity:oldOpacity})}})}},arguments[1]||{}))},Effect.DropOut=function(element){element=$(element);var oldStyle={top:element.getStyle("top"),left:element.getStyle("left"),opacity:element.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(element,{x:0,y:100,sync:!0}),new Effect.Opacity(element,{sync:!0,to:0})],Object.extend({duration:.5,beforeSetup:function(effect){effect.effects[0].element.makePositioned()},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoPositioned().setStyle(oldStyle)}},arguments[1]||{}))},Effect.Shake=function(element){element=$(element);var options=Object.extend({distance:20,duration:.5},arguments[1]||{}),distance=parseFloat(options.distance),split=parseFloat(options.duration)/10,oldStyle={top:element.getStyle("top"),left:element.getStyle("left")};return new Effect.Move(element,{x:distance,y:0,duration:split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:2*-distance,y:0,duration:2*split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:2*distance,y:0,duration:2*split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:2*-distance,y:0,duration:2*split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:2*distance,y:0,duration:2*split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance,y:0,duration:split,afterFinishInternal:function(effect){effect.element.undoPositioned().setStyle(oldStyle)}})}})}})}})}})}})},Effect.SlideDown=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle("bottom"),elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:!0,afterSetup:function(effect){effect.element.makePositioned(),effect.element.down().makePositioned(),window.opera&&effect.element.setStyle({top:""}),effect.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:effect.dims[0]-effect.element.clientHeight+"px"})},afterFinishInternal:function(effect){effect.element.undoClipping().undoPositioned(),effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom})}},arguments[1]||{}))},Effect.SlideUp=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle("bottom"),elementDimensions=element.getDimensions();return new Effect.Scale(element,window.opera?0:1,Object.extend({scaleContent:!1,scaleX:!1,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:!0,afterSetup:function(effect){effect.element.makePositioned(),effect.element.down().makePositioned(),window.opera&&effect.element.setStyle({top:""}),effect.element.makeClipping().show()},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:effect.dims[0]-effect.element.clientHeight+"px"})},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned(),effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom})}},arguments[1]||{}))},Effect.Squish=function(element){return new Effect.Scale(element,window.opera?1:0,{restoreAfterFinish:!0,beforeSetup:function(effect){effect.element.makeClipping()},afterFinishInternal:function(effect){effect.element.hide().undoClipping()}})},Effect.Grow=function(element){element=$(element);var initialMoveX,initialMoveY,moveX,moveY,options=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{}),oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()},dims=element.getDimensions();switch(options.direction){case"top-left":initialMoveX=initialMoveY=moveX=moveY=0;break;case"top-right":initialMoveX=dims.width,initialMoveY=moveY=0,moveX=-dims.width;break;case"bottom-left":initialMoveX=moveX=0,initialMoveY=dims.height,moveY=-dims.height;break;case"bottom-right":initialMoveX=dims.width,initialMoveY=dims.height,moveX=-dims.width,moveY=-dims.height;break;case"center":initialMoveX=dims.width/2,initialMoveY=dims.height/2,moveX=-dims.width/2,moveY=-dims.height/2}return new Effect.Move(element,{x:initialMoveX,y:initialMoveY,duration:.01,beforeSetup:function(effect){effect.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(effect){new Effect.Parallel([new Effect.Opacity(effect.element,{sync:!0,to:1,from:0,transition:options.opacityTransition}),new Effect.Move(effect.element,{x:moveX,y:moveY,sync:!0,transition:options.moveTransition}),new Effect.Scale(effect.element,100,{scaleMode:{originalHeight:dims.height,originalWidth:dims.width},sync:!0,scaleFrom:window.opera?1:0,transition:options.scaleTransition,restoreAfterFinish:!0})],Object.extend({beforeSetup:function(effect){effect.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(effect){effect.effects[0].element.undoClipping().undoPositioned().setStyle(oldStyle)}},options))}})},Effect.Shrink=function(element){element=$(element);var moveX,moveY,options=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{}),oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()},dims=element.getDimensions();switch(options.direction){case"top-left":moveX=moveY=0;break;case"top-right":moveX=dims.width,moveY=0;break;case"bottom-left":moveX=0,moveY=dims.height;break;case"bottom-right":moveX=dims.width,moveY=dims.height;break;case"center":moveX=dims.width/2,moveY=dims.height/2}return new Effect.Parallel([new Effect.Opacity(element,{sync:!0,to:0,from:1,transition:options.opacityTransition}),new Effect.Scale(element,window.opera?1:0,{sync:!0,transition:options.scaleTransition,restoreAfterFinish:!0}),new Effect.Move(element,{x:moveX,y:moveY,sync:!0,transition:options.moveTransition})],Object.extend({beforeStartInternal:function(effect){effect.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoClipping().undoPositioned().setStyle(oldStyle)}},options))},Effect.Pulsate=function(element){element=$(element);var options=arguments[1]||{},oldOpacity=element.getInlineOpacity(),transition=options.transition||Effect.Transitions.sinoidal,reverser=function(pos){return transition(1-Effect.Transitions.pulse(pos,options.pulses))};return reverser.bind(transition),new Effect.Opacity(element,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(effect){effect.element.setStyle({opacity:oldOpacity})}},options),{transition:reverser}))},Effect.Fold=function(element){element=$(element);var oldStyle={top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};return element.makeClipping(),new Effect.Scale(element,5,Object.extend({scaleContent:!1,scaleX:!1,afterFinishInternal:function(effect){new Effect.Scale(element,1,{scaleContent:!1,scaleY:!1,afterFinishInternal:function(effect){effect.element.hide().undoClipping().setStyle(oldStyle)}})}},arguments[1]||{}))},Effect.Morph=Class.create(Effect.Base,{initialize:function(element){if(this.element=$(element),!this.element)throw Effect._elementDoesNotExistError;var options=Object.extend({style:{}},arguments[1]||{});if(Object.isString(options.style))if(options.style.include(":"))this.style=options.style.parseStyle();else{this.element.addClassName(options.style),this.style=$H(this.element.getStyles()),this.element.removeClassName(options.style);var css=this.element.getStyles();this.style=this.style.reject(function(style){return style.value==css[style.key]}),options.afterFinishInternal=function(effect){effect.element.addClassName(effect.options.style),effect.transforms.each(function(transform){effect.element.style[transform.style]=""})}}else this.style=$H(options.style);this.start(options)},setup:function(){function parseColor(color){return(!color||["rgba(0, 0, 0, 0)","transparent"].include(color))&&(color="#ffffff"),color=color.parseColor(),$R(0,2).map(function(i){return parseInt(color.slice(2*i+1,2*i+3),16)})}this.transforms=this.style.map(function(pair){var property=pair[0],value=pair[1],unit=null;if("#zzzzzz"!=value.parseColor("#zzzzzz"))value=value.parseColor(),unit="color";else if("opacity"==property)value=parseFloat(value),Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});else if(Element.CSS_LENGTH.test(value)){var components=value.match(/^([\+\-]?[0-9\.]+)(.*)$/);value=parseFloat(components[1]),unit=3==components.length?components[2]:null}var originalValue=this.element.getStyle(property);return{style:property.camelize(),originalValue:"color"==unit?parseColor(originalValue):parseFloat(originalValue||0),targetValue:"color"==unit?parseColor(value):value,unit:unit}}.bind(this)).reject(function(transform){return transform.originalValue==transform.targetValue||"color"!=transform.unit&&(isNaN(transform.originalValue)||isNaN(transform.targetValue))})},update:function(position){for(var transform,style={},i=this.transforms.length;i--;)style[(transform=this.transforms[i]).style]="color"==transform.unit?"#"+Math.round(transform.originalValue[0]+(transform.targetValue[0]-transform.originalValue[0])*position).toColorPart()+Math.round(transform.originalValue[1]+(transform.targetValue[1]-transform.originalValue[1])*position).toColorPart()+Math.round(transform.originalValue[2]+(transform.targetValue[2]-transform.originalValue[2])*position).toColorPart():(transform.originalValue+(transform.targetValue-transform.originalValue)*position).toFixed(3)+(null===transform.unit?"":transform.unit);this.element.setStyle(style,!0)}}),Effect.Transform=Class.create({initialize:function(tracks){this.tracks=[],this.options=arguments[1]||{},this.addTracks(tracks)},addTracks:function(tracks){return tracks.each(function(track){track=$H(track);var data=track.values().first();this.tracks.push($H({ids:track.keys().first(),effect:Effect.Morph,options:{style:data}}))}.bind(this)),this},play:function(){return new Effect.Parallel(this.tracks.map(function(track){var ids=track.get("ids"),effect=track.get("effect"),options=track.get("options"),elements=[$(ids)||$$(ids)].flatten();return elements.map(function(e){return new effect(e,Object.extend({sync:!0},options))})}).flatten(),this.options)}}),Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex"),Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/,String.__parseStyleElement=document.createElement("div"),String.prototype.parseStyle=function(){var style,styleRules=$H();return Prototype.Browser.WebKit?style=new Element("div",{style:this}).style:(String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>',style=String.__parseStyleElement.childNodes[0].style),Element.CSS_PROPERTIES.each(function(property){style[property]&&styleRules.set(property,style[property])}),Prototype.Browser.IE&&this.include("opacity")&&styleRules.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1]),styleRules},document.defaultView&&document.defaultView.getComputedStyle?Element.getStyles=function(element){var css=document.defaultView.getComputedStyle($(element),null);return Element.CSS_PROPERTIES.inject({},function(styles,property){return styles[property]=css[property],styles})}:Element.getStyles=function(element){element=$(element);var styles,css=element.currentStyle;return styles=Element.CSS_PROPERTIES.inject({},function(hash,property){return hash.set(property,css[property]),hash}),styles.opacity||styles.set("opacity",element.getOpacity()),styles},Effect.Methods={morph:function(element,style){return element=$(element),new Effect.Morph(element,Object.extend({style:style},arguments[2]||{})),element},visualEffect:function(element,effect,options){element=$(element);var s=effect.dasherize().camelize(),klass=s.charAt(0).toUpperCase()+s.substring(1);return new Effect[klass](element,options),element},highlight:function(element,options){return element=$(element),new Effect.Highlight(element,options),element}},$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(effect){Effect.Methods[effect]=function(element,options){return element=$(element),Effect[effect.charAt(0).toUpperCase()+effect.substring(1)](element,options),element}}),$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(f){Effect.Methods[f]=Element[f]}),Element.addMethods(Effect.Methods),Object.isUndefined(Effect))throw"dragdrop.js requires including script.aculo.us' effects.js library";var Droppables={drops:[],remove:function(element){this.drops=this.drops.reject(function(d){return d.element==$(element)})},add:function(element){element=$(element);var options=Object.extend({greedy:!0,hoverclass:null,tree:!1},arguments[1]||{});if(options.containment){options._containers=[];var containment=options.containment;Object.isArray(containment)?containment.each(function(c){options._containers.push($(c))}):options._containers.push($(containment))}options.accept&&(options.accept=[options.accept].flatten()),Element.makePositioned(element),options.element=element,this.drops.push(options)},findDeepestChild:function(drops){for(var deepest=drops[0],i=1;i<drops.length;++i)Element.isParent(drops[i].element,deepest.element)&&(deepest=drops[i]);return deepest},isContained:function(element,drop){var containmentNode;return containmentNode=drop.tree?element.treeNode:element.parentNode,drop._containers.detect(function(c){return containmentNode==c})},isAffected:function(point,element,drop){return drop.element&&drop.element!=element&&(!drop._containers||this.isContained(element,drop))&&(!drop.accept||Element.classNames(element).detect(function(v){return drop.accept.include(v)}))&&Position.within(drop.element,point[0],point[1])},deactivate:function(drop){drop.hoverclass&&Element.removeClassName(drop.element,drop.hoverclass),drop.onOut&&drop.onOut(drop.element),this.last_active=null},activate:function(drop){drop.hoverclass&&Element.addClassName(drop.element,drop.hoverclass),this.last_active=drop},show:function(point,element){if(this.drops.length){var drop,affected=[];$A(this.drops).each(function(drop){Droppables.isAffected(point,element,drop)&&affected.push(drop)}),affected.length>0&&(drop=Droppables.findDeepestChild(affected)),this.last_active&&this.last_active!=drop&&this.deactivate(this.last_active),drop&&(Position.within(drop.element,point[0],point[1]),drop.onHover&&drop.onHover(element,drop.element,Position.overlap(drop.overlap,drop.element)),drop!=this.last_active&&Droppables.activate(drop))}},fire:function(event,element){return this.last_active?(Position.prepare(),Position.includeScrollOffsets=!0,this.isAffected([Event.pointerX(event),Event.pointerY(event)],element,this.last_active)&&this.last_active.onDrop?(this.last_active.onDrop(element,this.last_active.element,event),!0):void 0):void 0},reset:function(){this.last_active&&this.deactivate(this.last_active)}},Draggables={drags:[],observers:[],register:function(draggable){0==this.drags.length&&(this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.updateDrag.bindAsEventListener(this),this.eventKeypress=this.keyPress.bindAsEventListener(this),Event.observe(document,"mouseup",this.eventMouseUp),Event.observe(document,"mousemove",this.eventMouseMove),Event.observe(document,"keypress",this.eventKeypress)),this.drags.push(draggable)},unregister:function(draggable){this.drags=this.drags.reject(function(d){return d==draggable}),0==this.drags.length&&(Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),Event.stopObserving(document,"keypress",this.eventKeypress))},activate:function(draggable){draggable.options.delay?this._timeout=setTimeout(function(){Draggables._timeout=null,window.focus(),Draggables.activeDraggable=draggable}.bind(this),draggable.options.delay):(window.focus(),this.activeDraggable=draggable)},deactivate:function(){this.activeDraggable=null},updateDrag:function(event){if(this.activeDraggable){var pointer=[Event.pointerX(event),Event.pointerY(event)];this._lastPointer&&this._lastPointer.inspect()==pointer.inspect()||(this._lastPointer=pointer,this.activeDraggable.updateDrag(event,pointer))}},endDrag:function(event){this._timeout&&(clearTimeout(this._timeout),this._timeout=null),this.activeDraggable&&(this._lastPointer=null,this.activeDraggable.endDrag(event),this.activeDraggable=null)},keyPress:function(event){this.activeDraggable&&this.activeDraggable.keyPress(event)},addObserver:function(observer){this.observers.push(observer),this._cacheObserverCallbacks()},removeObserver:function(element){this.observers=this.observers.reject(function(o){return o.element==element}),this._cacheObserverCallbacks()},notify:function(eventName,draggable,event){this[eventName+"Count"]>0&&this.observers.each(function(o){o[eventName]&&o[eventName](eventName,draggable,event)}),draggable.options[eventName]&&draggable.options[eventName](draggable,event)},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(eventName){Draggables[eventName+"Count"]=Draggables.observers.select(function(o){return o[eventName]}).length})}},Draggable=Class.create({initialize:function(element){var defaults={handle:!1,reverteffect:function(element,top_offset,left_offset){var dur=.02*Math.sqrt(Math.abs(2^top_offset)+Math.abs(2^left_offset));new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:dur,queue:{scope:"_draggable",position:"end"}})},endeffect:function(element){var toOpacity=Object.isNumber(element._opacity)?element._opacity:1;new Effect.Opacity(element,{duration:.2,from:.7,to:toOpacity,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[element]=!1}})},zindex:1e3,revert:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,snap:!1,delay:0};(!arguments[1]||Object.isUndefined(arguments[1].endeffect))&&Object.extend(defaults,{starteffect:function(element){element._opacity=Element.getOpacity(element),Draggable._dragging[element]=!0,new Effect.Opacity(element,{duration:.2,from:element._opacity,to:.7})}});var options=Object.extend(defaults,arguments[1]||{});this.element=$(element),options.handle&&Object.isString(options.handle)&&(this.handle=this.element.down("."+options.handle,0)),this.handle||(this.handle=$(options.handle)),this.handle||(this.handle=this.element),!options.scroll||options.scroll.scrollTo||options.scroll.outerHTML||(options.scroll=$(options.scroll),this._isScrollChild=Element.childOf(this.element,options.scroll)),Element.makePositioned(this.element),this.options=options,this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown),Draggables.unregister(this)},currentDelta:function(){return[parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")]},initDrag:function(event){if((Object.isUndefined(Draggable._dragging[this.element])||!Draggable._dragging[this.element])&&Event.isLeftClick(event)){var tag_name,src=Event.element(event);if((tag_name=src.tagName.toUpperCase())&&("INPUT"==tag_name||"SELECT"==tag_name||"OPTION"==tag_name||"BUTTON"==tag_name||"TEXTAREA"==tag_name))return;var pointer=[Event.pointerX(event),Event.pointerY(event)],pos=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(i){return pointer[i]-pos[i]}),Draggables.activate(this),Event.stop(event)}},startDrag:function(event){if(this.dragging=!0,this.delta||(this.delta=this.currentDelta()),this.options.zindex&&(this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0),this.element.style.zIndex=this.options.zindex),this.options.ghosting&&(this._clone=this.element.cloneNode(!0),this.element._originallyAbsolute="absolute"==this.element.getStyle("position"),this.element._originallyAbsolute||Position.absolutize(this.element),this.element.parentNode.insertBefore(this._clone,this.element)),this.options.scroll)if(this.options.scroll==window){var where=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=where.left,this.originalScrollTop=where.top}else this.originalScrollLeft=this.options.scroll.scrollLeft,this.originalScrollTop=this.options.scroll.scrollTop;Draggables.notify("onStart",this,event),this.options.starteffect&&this.options.starteffect(this.element)},updateDrag:function(event,pointer){if(this.dragging||this.startDrag(event),this.options.quiet||(Position.prepare(),Position.includeScrollOffsets=!0,Droppables.show(pointer,this.element)),Draggables.notify("onDrag",this,event),this.draw(pointer),this.options.change&&this.options.change(this),this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){var scrollObject=this._getWindowScroll(this.options.scroll);scrollObject&&(p=[scrollObject.left,scrollObject.top,scrollObject.left+scrollObject.width,scrollObject.top+scrollObject.height])}else p=Position.page(this.options.scroll),p[0]+=this.options.scroll.scrollLeft+Position.deltaX,p[1]+=this.options.scroll.scrollTop+Position.deltaY,p[2]=p[0]+this.options.scroll.offsetWidth,p[3]=p[1]+this.options.scroll.offsetHeight;var speed=[0,0];pointer[0]<p[0]+this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)),pointer[1]<p[1]+this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)),pointer[0]>p[2]-this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)),pointer[1]>p[3]-this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)),this.startScrolling(speed)}Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event)},finishDrag:function(event,success){if(this.dragging=!1,this.options.quiet){Position.prepare(),Position.includeScrollOffsets=!0;var pointer=[Event.pointerX(event),Event.pointerY(event)];Droppables.show(pointer,this.element)}this.options.ghosting&&(this.element._originallyAbsolute||Position.relativize(this.element),delete this.element._originallyAbsolute,Element.remove(this._clone),this._clone=null);var dropped=!1;success&&(dropped=Droppables.fire(event,this.element),dropped||(dropped=!1)),dropped&&this.options.onDropped&&this.options.onDropped(this.element),Draggables.notify("onEnd",this,event);var revert=this.options.revert;revert&&Object.isFunction(revert)&&(revert=revert(this.element));var d=this.currentDelta();revert&&this.options.reverteffect?(0==dropped||"failure"!=revert)&&this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0]):this.delta=d,this.options.zindex&&(this.element.style.zIndex=this.originalZ),this.options.endeffect&&this.options.endeffect(this.element),Draggables.deactivate(this),Droppables.reset()},keyPress:function(event){event.keyCode==Event.KEY_ESC&&(this.finishDrag(event,!1),Event.stop(event))},endDrag:function(event){this.dragging&&(this.stopScrolling(),this.finishDrag(event,!0),Event.stop(event))},draw:function(point){var pos=Position.cumulativeOffset(this.element);if(this.options.ghosting){var r=Position.realOffset(this.element);pos[0]+=r[0]-Position.deltaX,pos[1]+=r[1]-Position.deltaY}var d=this.currentDelta();pos[0]-=d[0],pos[1]-=d[1],this.options.scroll&&this.options.scroll!=window&&this._isScrollChild&&(pos[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft,pos[1]-=this.options.scroll.scrollTop-this.originalScrollTop);var p=[0,1].map(function(i){return point[i]-pos[i]-this.offset[i]}.bind(this));this.options.snap&&(p=Object.isFunction(this.options.snap)?this.options.snap(p[0],p[1],this):p.map(Object.isArray(this.options.snap)?function(v,i){return(v/this.options.snap[i]).round()*this.options.snap[i]}.bind(this):function(v){return(v/this.options.snap).round()*this.options.snap}.bind(this)));var style=this.element.style;this.options.constraint&&"horizontal"!=this.options.constraint||(style.left=p[0]+"px"),this.options.constraint&&"vertical"!=this.options.constraint||(style.top=p[1]+"px"),"hidden"==style.visibility&&(style.visibility="")},stopScrolling:function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null,Draggables._lastScrollPointer=null)},startScrolling:function(speed){(speed[0]||speed[1])&&(this.scrollSpeed=[speed[0]*this.options.scrollSpeed,speed[1]*this.options.scrollSpeed],this.lastScrolled=new Date,this.scrollInterval=setInterval(this.scroll.bind(this),10))},scroll:function(){var current=new Date,delta=current-this.lastScrolled;if(this.lastScrolled=current,this.options.scroll==window){var scrollObject=this._getWindowScroll(this.options.scroll);if(scrollObject&&(this.scrollSpeed[0]||this.scrollSpeed[1])){var d=delta/1e3;this.options.scroll.scrollTo(scrollObject.left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}else this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1e3,this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1e3;Position.prepare(),Position.includeScrollOffsets=!0,Droppables.show(Draggables._lastPointer,this.element),Draggables.notify("onDrag",this),this._isScrollChild&&(Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer),Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1e3,Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1e3,Draggables._lastScrollPointer[0]<0&&(Draggables._lastScrollPointer[0]=0),Draggables._lastScrollPointer[1]<0&&(Draggables._lastScrollPointer[1]=0),this.draw(Draggables._lastScrollPointer)),this.options.change&&this.options.change(this)},_getWindowScroll:function(w){var T,L,W,H;return w.document.documentElement&&documentElement.scrollTop?(T=w.document.documentElement.scrollTop,L=w.document.documentElement.scrollLeft):w.document.body&&(T=w.document.body.scrollTop,L=w.document.body.scrollLeft),w.innerWidth?(W=w.innerWidth,H=w.innerHeight):w.document.documentElement&&documentElement.clientWidth?(W=w.document.documentElement.clientWidth,H=w.document.documentElement.clientHeight):(W=w.document.body.offsetWidth,H=w.document.body.offsetHeight),{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(element,observer){this.element=$(element),this.observer=observer,this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark(),this.lastValue!=Sortable.serialize(this.element)&&this.observer(this.element)}}),Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,
sortables:{},_findRootElement:function(element){for(;"BODY"!=element.tagName.toUpperCase();){if(element.id&&Sortable.sortables[element.id])return element;element=element.parentNode}},options:function(element){return(element=Sortable._findRootElement($(element)))?Sortable.sortables[element.id]:void 0},destroy:function(element){var s=Sortable.options(element);s&&(Draggables.removeObserver(s.element),s.droppables.each(function(d){Droppables.remove(d)}),s.draggables.invoke("destroy"),delete Sortable.sortables[s.element.id])},create:function(element){element=$(element);var options=Object.extend({element:element,tag:"li",dropOnEmpty:!1,tree:!1,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:element,handle:!1,only:!1,delay:0,hoverclass:null,ghosting:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:!1,handles:!1,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(element);var options_for_draggable={revert:!0,quiet:options.quiet,scroll:options.scroll,scrollSpeed:options.scrollSpeed,scrollSensitivity:options.scrollSensitivity,delay:options.delay,ghosting:options.ghosting,constraint:options.constraint,handle:options.handle};options.starteffect&&(options_for_draggable.starteffect=options.starteffect),options.reverteffect?options_for_draggable.reverteffect=options.reverteffect:options.ghosting&&(options_for_draggable.reverteffect=function(element){element.style.top=0,element.style.left=0}),options.endeffect&&(options_for_draggable.endeffect=options.endeffect),options.zindex&&(options_for_draggable.zindex=options.zindex);var options_for_droppable={overlap:options.overlap,containment:options.containment,tree:options.tree,hoverclass:options.hoverclass,onHover:Sortable.onHover},options_for_tree={onHover:Sortable.onEmptyHover,overlap:options.overlap,containment:options.containment,hoverclass:options.hoverclass};Element.cleanWhitespace(element),options.draggables=[],options.droppables=[],(options.dropOnEmpty||options.tree)&&(Droppables.add(element,options_for_tree),options.droppables.push(element)),(options.elements||this.findElements(element,options)||[]).each(function(e,i){var handle=options.handles?$(options.handles[i]):options.handle?$(e).select("."+options.handle)[0]:e;options.draggables.push(new Draggable(e,Object.extend(options_for_draggable,{handle:handle}))),Droppables.add(e,options_for_droppable),options.tree&&(e.treeNode=element),options.droppables.push(e)}),options.tree&&(Sortable.findTreeElements(element,options)||[]).each(function(e){Droppables.add(e,options_for_tree),e.treeNode=element,options.droppables.push(e)}),this.sortables[element.id]=options,Draggables.addObserver(new SortableObserver(element,options.onUpdate))},findElements:function(element,options){return Element.findChildren(element,options.only,options.tree?!0:!1,options.tag)},findTreeElements:function(element,options){return Element.findChildren(element,options.only,options.tree?!0:!1,options.treeTag)},onHover:function(element,dropon,overlap){if(!(Element.isParent(dropon,element)||overlap>.33&&.66>overlap&&Sortable.options(dropon).tree))if(overlap>.5){if(Sortable.mark(dropon,"before"),dropon.previousSibling!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden",dropon.parentNode.insertBefore(element,dropon),dropon.parentNode!=oldParentNode&&Sortable.options(oldParentNode).onChange(element),Sortable.options(dropon.parentNode).onChange(element)}}else{Sortable.mark(dropon,"after");var nextElement=dropon.nextSibling||null;if(nextElement!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden",dropon.parentNode.insertBefore(element,nextElement),dropon.parentNode!=oldParentNode&&Sortable.options(oldParentNode).onChange(element),Sortable.options(dropon.parentNode).onChange(element)}}},onEmptyHover:function(element,dropon,overlap){var oldParentNode=element.parentNode,droponOptions=Sortable.options(dropon);if(!Element.isParent(dropon,element)){var index,children=Sortable.findElements(dropon,{tag:droponOptions.tag,only:droponOptions.only}),child=null;if(children){var offset=Element.offsetSize(dropon,droponOptions.overlap)*(1-overlap);for(index=0;index<children.length;index+=1){if(!(offset-Element.offsetSize(children[index],droponOptions.overlap)>=0)){if(offset-Element.offsetSize(children[index],droponOptions.overlap)/2>=0){child=index+1<children.length?children[index+1]:null;break}child=children[index];break}offset-=Element.offsetSize(children[index],droponOptions.overlap)}}dropon.insertBefore(element,child),Sortable.options(oldParentNode).onChange(element),droponOptions.onChange(element)}},unmark:function(){Sortable._marker&&Sortable._marker.hide()},mark:function(dropon,position){var sortable=Sortable.options(dropon.parentNode);if(!sortable||sortable.ghosting){Sortable._marker||(Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"}),document.getElementsByTagName("body").item(0).appendChild(Sortable._marker));var offsets=Position.cumulativeOffset(dropon);Sortable._marker.setStyle({left:offsets[0]+"px",top:offsets[1]+"px"}),"after"==position&&Sortable._marker.setStyle("horizontal"==sortable.overlap?{left:offsets[0]+dropon.clientWidth+"px"}:{top:offsets[1]+dropon.clientHeight+"px"}),Sortable._marker.show()}},_tree:function(element,options,parent){for(var children=Sortable.findElements(element,options)||[],i=0;i<children.length;++i){var match=children[i].id.match(options.format);if(match){var child={id:encodeURIComponent(match?match[1]:null),element:element,parent:parent,children:[],position:parent.children.length,container:$(children[i]).down(options.treeTag)};child.container&&this._tree(child.container,options,child),parent.children.push(child)}}return parent},tree:function(element){element=$(element);var sortableOptions=this.options(element),options=Object.extend({tag:sortableOptions.tag,treeTag:sortableOptions.treeTag,only:sortableOptions.only,name:element.id,format:sortableOptions.format},arguments[1]||{}),root={id:null,parent:null,children:[],container:element,position:0};return Sortable._tree(element,options,root)},_constructIndex:function(node){var index="";do node.id&&(index="["+node.position+"]"+index);while(null!=(node=node.parent));return index},sequence:function(element){element=$(element);var options=Object.extend(this.options(element),arguments[1]||{});return $(this.findElements(element,options)||[]).map(function(item){return item.id.match(options.format)?item.id.match(options.format)[1]:""})},setSequence:function(element,new_sequence){element=$(element);var options=Object.extend(this.options(element),arguments[2]||{}),nodeMap={};this.findElements(element,options).each(function(n){n.id.match(options.format)&&(nodeMap[n.id.match(options.format)[1]]=[n,n.parentNode]),n.parentNode.removeChild(n)}),new_sequence.each(function(ident){var n=nodeMap[ident];n&&(n[1].appendChild(n[0]),delete nodeMap[ident])})},serialize:function(element){element=$(element);var options=Object.extend(Sortable.options(element),arguments[1]||{}),name=encodeURIComponent(arguments[1]&&arguments[1].name?arguments[1].name:element.id);return options.tree?Sortable.tree(element,arguments[1]).children.map(function(item){return[name+Sortable._constructIndex(item)+"[id]="+encodeURIComponent(item.id)].concat(item.children.map(arguments.callee))}).flatten().join("&"):Sortable.sequence(element,arguments[1]).map(function(item){return name+"[]="+encodeURIComponent(item)}).join("&")}};if(Element.isParent=function(child,element){return child.parentNode&&child!=element?child.parentNode==element?!0:Element.isParent(child.parentNode,element):!1},Element.findChildren=function(element,only,recursive,tagName){if(!element.hasChildNodes())return null;tagName=tagName.toUpperCase(),only&&(only=[only].flatten());var elements=[];return $A(element.childNodes).each(function(e){if(!e.tagName||e.tagName.toUpperCase()!=tagName||only&&!Element.classNames(e).detect(function(v){return only.include(v)})||elements.push(e),recursive){var grandchildren=Element.findChildren(e,only,recursive,tagName);grandchildren&&elements.push(grandchildren)}}),elements.length>0?elements.flatten():[]},Element.offsetSize=function(element,type){return element["offset"+("vertical"==type||"height"==type?"Height":"Width")]},"undefined"==typeof Effect)throw"controls.js requires including script.aculo.us' effects.js library";var Autocompleter={};if(Autocompleter.Base=Class.create({baseInitialize:function(element,update,options){element=$(element),this.element=element,this.update=$(update),this.hasFocus=!1,this.changed=!1,this.active=!1,this.index=0,this.entryCount=0,this.oldElementValue=this.element.value,this.setOptions?this.setOptions(options):this.options=options||{},this.options.paramName=this.options.paramName||this.element.name,this.options.tokens=this.options.tokens||[],this.options.frequency=this.options.frequency||.4,this.options.minChars=this.options.minChars||1,this.options.onShow=this.options.onShow||function(element,update){update.style.position&&"absolute"!=update.style.position||(update.style.position="absolute",Position.clone(element,update,{setHeight:!1,offsetTop:element.offsetHeight})),Effect.Appear(update,{duration:.15})},this.options.onHide=this.options.onHide||function(element,update){new Effect.Fade(update,{duration:.15})},"string"==typeof this.options.tokens&&(this.options.tokens=new Array(this.options.tokens)),this.options.tokens.include("\n")||this.options.tokens.push("\n"),this.observer=null,this.element.setAttribute("autocomplete","off"),Element.hide(this.update),Event.observe(this.element,"blur",this.onBlur.bindAsEventListener(this)),Event.observe(this.element,"keypress",this.onKeyPress.bindAsEventListener(this))},show:function(){"none"==Element.getStyle(this.update,"display")&&this.options.onShow(this.element,this.update),!this.iefix&&Prototype.Browser.IE&&"absolute"==Element.getStyle(this.update,"position")&&(new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" src="javascript:false;" frameborder="0" scrolling="no"></iframe>'),this.iefix=$(this.update.id+"_iefix")),this.iefix&&setTimeout(this.fixIEOverlapping.bind(this),50)},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:!this.update.style.height}),this.iefix.style.zIndex=3e3,this.update.style.zIndex=3001,Element.show(this.iefix)},hide:function(){this.stopIndicator(),"none"!=Element.getStyle(this.update,"display")&&this.options.onHide(this.element,this.update),this.iefix&&Element.hide(this.iefix)},startIndicator:function(){this.options.indicator&&Element.show(this.options.indicator)},stopIndicator:function(){this.options.indicator&&Element.hide(this.options.indicator)},onKeyPress:function(event){if(this.active)switch(event.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry(),Event.stop(event);case Event.KEY_ESC:return this.hide(),this.active=!1,void Event.stop(event);case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:return this.markPrevious(),this.render(),void(Prototype.Browser.WebKit&&Event.stop(event));case Event.KEY_DOWN:return this.markNext(),this.render(),void(Prototype.Browser.WebKit&&Event.stop(event))}else if(event.keyCode==Event.KEY_TAB||event.keyCode==Event.KEY_RETURN||Prototype.Browser.WebKit>0&&0==event.keyCode)return;this.changed=!0,this.hasFocus=!0,this.observer&&clearTimeout(this.observer),this.observer=setTimeout(this.onObserverEvent.bind(this),1e3*this.options.frequency)},activate:function(){this.changed=!1,this.hasFocus=!0,this.getUpdatedChoices()},onHover:function(event){var element=Event.findElement(event,"LI");this.index!=element.autocompleteIndex&&(this.index=element.autocompleteIndex,this.render()),Event.stop(event)},onClick:function(event){var element=Event.findElement(event,"LI");element&&(this.index=element.autocompleteIndex,this.selectEntry(),this.hide())},onBlur:function(event){this.hasFocus=!1},onMouseup:function(event){this.hasFocus||(this.hideTimeout=setTimeout(function(){this.hasFocus||this.hide()}.bind(this),250),this.hasFocus=!1,this.active=!1)},render:function(){if(this.entryCount>0){for(var i=0;i<this.entryCount;i++)this.index==i?Element.addClassName(this.getEntry(i),"selected"):Element.removeClassName(this.getEntry(i),"selected");this.hasFocus&&(this.show(),this.active=!0)}else this.active=!1,this.hide()},markPrevious:function(){this.index>0?this.index--:this.index=this.entryCount-1,this.getEntry(this.index).scrollIntoView(!0)},markNext:function(){this.index<this.entryCount-1?this.index++:this.index=0,this.getEntry(this.index).scrollIntoView(!1)},getEntry:function(index){return this.update.firstChild.childNodes[index]},getCurrentEntry:function(){return this.getEntry(this.index)},selectEntry:function(){this.active=!1,this.updateElement(this.getCurrentEntry())},updateElement:function(selectedElement){if(this.options.updateElement)return void this.options.updateElement(selectedElement);var value="";if(this.options.select){var nodes=$(selectedElement).select("."+this.options.select)||[];nodes.length>0&&(value=Element.collectTextNodes(nodes[0],this.options.select))}else value=Element.collectTextNodesIgnoreClass(selectedElement,"informal");var bounds=this.getTokenBounds();if(-1!=bounds[0]){var newValue=this.element.value.substr(0,bounds[0]),whitespace=this.element.value.substr(bounds[0]).match(/^\s+/);whitespace&&(newValue+=whitespace[0]),this.element.value=newValue+value+this.element.value.substr(bounds[1])}else this.element.value=value;this.oldElementValue=this.element.value,this.element.focus(),this.options.afterUpdateElement&&this.options.afterUpdateElement(this.element,selectedElement)},updateChoices:function(choices){if(!this.changed&&this.hasFocus){if(this.update.innerHTML=choices,Element.cleanWhitespace(this.update),Element.cleanWhitespace(this.update.down()),this.update.firstChild&&this.update.down().childNodes){this.entryCount=this.update.down().childNodes.length;for(var i=0;i<this.entryCount;i++){var entry=this.getEntry(i);entry.autocompleteIndex=i,this.addObservers(entry)}}else this.entryCount=0;this.stopIndicator(),this.index=0,1==this.entryCount&&this.options.autoSelect?(this.selectEntry(),this.hide()):this.render()}},addObservers:function(element){Event.observe(element,"mouseover",this.onHover.bindAsEventListener(this)),Event.observe(element,"click",this.onClick.bindAsEventListener(this)),Event.observe($(document),"mouseup",this.onMouseup.bindAsEventListener(this))},onObserverEvent:function(){this.changed=!1,this.tokenBounds=null,this.getToken().length>=this.options.minChars?this.getUpdatedChoices():(this.active=!1,this.hide()),this.oldElementValue=this.element.value},getToken:function(){var bounds=this.getTokenBounds();return this.element.value.substring(bounds[0],bounds[1]).strip()},getTokenBounds:function(){if(null!=this.tokenBounds)return this.tokenBounds;var value=this.element.value;if(value.strip().empty())return[-1,0];for(var tp,diff=arguments.callee.getFirstDifferencePos(value,this.oldElementValue),offset=diff==this.oldElementValue.length?1:0,prevTokenPos=-1,nextTokenPos=value.length,index=0,l=this.options.tokens.length;l>index;++index)tp=value.lastIndexOf(this.options.tokens[index],diff+offset-1),tp>prevTokenPos&&(prevTokenPos=tp),tp=value.indexOf(this.options.tokens[index],diff+offset),-1!=tp&&nextTokenPos>tp&&(nextTokenPos=tp);return this.tokenBounds=[prevTokenPos+1,nextTokenPos]}}),Autocompleter.Base.prototype.getTokenBounds.getFirstDifferencePos=function(newS,oldS){for(var boundary=Math.min(newS.length,oldS.length),index=0;boundary>index;++index)if(newS[index]!=oldS[index])return index;return boundary},Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(element,update,url,options){this.baseInitialize(element,update,options),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=url},getUpdatedChoices:function(){this.startIndicator();var entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry,this.options.defaultParams&&(this.options.parameters+="&"+this.options.defaultParams),new Ajax.Request(this.url,this.options)},onComplete:function(request){this.updateChoices(request.responseText)}}),Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(element,update,array,options){this.baseInitialize(element,update,options),this.options.array=array},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},setOptions:function(options){this.options=Object.extend({choices:10,partialSearch:!0,partialChars:2,ignoreCase:!0,fullSearch:!1,selector:function(instance){for(var ret=[],partial=[],entry=instance.getToken(),i=0;i<instance.options.array.length&&ret.length<instance.options.choices;i++)for(var elem=instance.options.array[i],foundPos=instance.options.ignoreCase?elem.toLowerCase().indexOf(entry.toLowerCase()):elem.indexOf(entry);-1!=foundPos;){if(0==foundPos&&elem.length!=entry.length){ret.push("<li><strong>"+elem.substr(0,entry.length)+"</strong>"+elem.substr(entry.length)+"</li>");break}if(entry.length>=instance.options.partialChars&&instance.options.partialSearch&&-1!=foundPos&&(instance.options.fullSearch||/\s/.test(elem.substr(foundPos-1,1)))){partial.push("<li>"+elem.substr(0,foundPos)+"<strong>"+elem.substr(foundPos,entry.length)+"</strong>"+elem.substr(foundPos+entry.length)+"</li>");break}foundPos=instance.options.ignoreCase?elem.toLowerCase().indexOf(entry.toLowerCase(),foundPos+1):elem.indexOf(entry,foundPos+1)}return partial.length&&(ret=ret.concat(partial.slice(0,instance.options.choices-ret.length))),"<ul>"+ret.join("")+"</ul>"}},options||{})}}),Field.scrollFreeActivate=function(field){setTimeout(function(){Field.activate(field)},1)},Ajax.InPlaceEditor=Class.create({initialize:function(element,url,options){this.url=url,this.element=element=$(element),this.prepareOptions(),this._controls={},arguments.callee.dealWithDeprecatedOptions(options),Object.extend(this.options,options||{}),!this.options.formId&&this.element.id&&(this.options.formId=this.element.id+"-inplaceeditor",$(this.options.formId)&&(this.options.formId="")),this.options.externalControl&&(this.options.externalControl=$(this.options.externalControl)),this.options.externalControl||(this.options.externalControlOnly=!1),this._originalBackground=this.element.getStyle("background-color")||"transparent",this.element.title=this.options.clickToEditText,this._boundCancelHandler=this.handleFormCancellation.bind(this),this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this),this._boundFailureHandler=this.handleAJAXFailure.bind(this),this._boundSubmitHandler=this.handleFormSubmission.bind(this),this._boundWrapperHandler=this.wrapUp.bind(this),this.registerListeners()},checkForEscapeOrReturn:function(e){!this._editing||e.ctrlKey||e.altKey||e.shiftKey||(Event.KEY_ESC==e.keyCode?this.handleFormCancellation(e):Event.KEY_RETURN==e.keyCode&&this.handleFormSubmission(e))},createControl:function(mode,handler,extraClasses){var control=this.options[mode+"Control"],text=this.options[mode+"Text"];if("button"==control){var btn=document.createElement("input");btn.type="submit",btn.value=text,btn.className="editor_"+mode+"_button","cancel"==mode&&(btn.onclick=this._boundCancelHandler),this._form.appendChild(btn),this._controls[mode]=btn}else if("link"==control){var link=document.createElement("a");link.href="#",link.appendChild(document.createTextNode(text)),link.onclick="cancel"==mode?this._boundCancelHandler:this._boundSubmitHandler,link.className="editor_"+mode+"_link",extraClasses&&(link.className+=" "+extraClasses),this._form.appendChild(link),this._controls[mode]=link}},createEditField:function(){var fld,text=this.options.loadTextURL?this.options.loadingText:this.getText();if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){fld=document.createElement("input"),fld.type="text";var size=this.options.size||this.options.cols||0;size>0&&(fld.size=size)}else fld=document.createElement("textarea"),fld.rows=1>=this.options.rows?this.options.autoRows:this.options.rows,fld.cols=this.options.cols||40;fld.name=this.options.paramName,fld.value=text,fld.className="editor_field",this.options.submitOnBlur&&(fld.onblur=this._boundSubmitHandler),this._controls.editor=fld,this.options.loadTextURL&&this.loadExternalText(),this._form.appendChild(this._controls.editor)},createForm:function(){function addText(mode,condition){var text=ipe.options["text"+mode+"Controls"];text&&condition!==!1&&ipe._form.appendChild(document.createTextNode(text))}var ipe=this;this._form=$(document.createElement("form")),this._form.id=this.options.formId,this._form.addClassName(this.options.formClassName),this._form.onsubmit=this._boundSubmitHandler,this.createEditField(),"textarea"==this._controls.editor.tagName.toLowerCase()&&this._form.appendChild(document.createElement("br")),this.options.onFormCustomization&&this.options.onFormCustomization(this,this._form),addText("Before",this.options.okControl||this.options.cancelControl),this.createControl("ok",this._boundSubmitHandler),addText("Between",this.options.okControl&&this.options.cancelControl),this.createControl("cancel",this._boundCancelHandler,"editor_cancel"),addText("After",this.options.okControl||this.options.cancelControl)},destroy:function(){this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML),this.leaveEditMode(),this.unregisterListeners()},enterEditMode:function(e){this._saving||this._editing||(this._editing=!0,this.triggerCallback("onEnterEditMode"),this.options.externalControl&&this.options.externalControl.hide(),this.element.hide(),this.createForm(),this.element.parentNode.insertBefore(this._form,this.element),this.options.loadTextURL||this.postProcessEditField(),e&&Event.stop(e))},enterHover:function(e){this.options.hoverClassName&&this.element.addClassName(this.options.hoverClassName),this._saving||this.triggerCallback("onEnterHover")},getText:function(){return this.element.innerHTML},handleAJAXFailure:function(transport){this.triggerCallback("onFailure",transport),this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML,this._oldInnerHTML=null)},handleFormCancellation:function(e){this.wrapUp(),e&&Event.stop(e)},handleFormSubmission:function(e){var form=this._form,value=$F(this._controls.editor);this.prepareSubmission();var params=this.options.callback(form,value)||"";if(Object.isString(params)&&(params=params.toQueryParams()),params.editorId=this.element.id,this.options.htmlResponse){var options=Object.extend({evalScripts:!0},this.options.ajaxOptions);Object.extend(options,{parameters:params,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),new Ajax.Updater({success:this.element},this.url,options)}else{var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:params,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),new Ajax.Request(this.url,options)}e&&Event.stop(e)},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName),this.removeForm(),this.leaveHover(),this.element.style.backgroundColor=this._originalBackground,this.element.show(),this.options.externalControl&&this.options.externalControl.show(),this._saving=!1,this._editing=!1,this._oldInnerHTML=null,this.triggerCallback("onLeaveEditMode")},leaveHover:function(e){this.options.hoverClassName&&this.element.removeClassName(this.options.hoverClassName),this._saving||this.triggerCallback("onLeaveHover")},loadExternalText:function(){this._form.addClassName(this.options.loadingClassName),this._controls.editor.disabled=!0;var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){this._form.removeClassName(this.options.loadingClassName);var text=transport.responseText;this.options.stripLoadedTextTags&&(text=text.stripTags()),this._controls.editor.value=text,this._controls.editor.disabled=!1,this.postProcessEditField()}.bind(this),onFailure:this._boundFailureHandler}),new Ajax.Request(this.options.loadTextURL,options)},postProcessEditField:function(){var fpc=this.options.fieldPostCreation;fpc&&$(this._controls.editor)["focus"==fpc?"focus":"activate"]()},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions),Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks),[this._extraDefaultOptions].flatten().compact().each(function(defs){Object.extend(this.options,defs)}.bind(this))},prepareSubmission:function(){this._saving=!0,this.removeForm(),this.leaveHover(),this.showSaving()},registerListeners:function(){this._listeners={};var listener;$H(Ajax.InPlaceEditor.Listeners).each(function(pair){listener=this[pair.value].bind(this),this._listeners[pair.key]=listener,this.options.externalControlOnly||this.element.observe(pair.key,listener),this.options.externalControl&&this.options.externalControl.observe(pair.key,listener)}.bind(this))},removeForm:function(){this._form&&(this._form.remove(),this._form=null,this._controls={})},showSaving:function(){this._oldInnerHTML=this.element.innerHTML,this.element.innerHTML=this.options.savingText,this.element.addClassName(this.options.savingClassName),this.element.style.backgroundColor=this._originalBackground,this.element.show()},triggerCallback:function(cbName,arg){"function"==typeof this.options[cbName]&&this.options[cbName](this,arg)},unregisterListeners:function(){$H(this._listeners).each(function(pair){this.options.externalControlOnly||this.element.stopObserving(pair.key,pair.value),this.options.externalControl&&this.options.externalControl.stopObserving(pair.key,pair.value)}.bind(this))},wrapUp:function(transport){this.leaveEditMode(),this._boundComplete(transport,this.element)}}),Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy}),Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,element,url,options){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions,$super(element,url,options)},createEditField:function(){var list=document.createElement("select");list.name=this.options.paramName,list.size=1,this._controls.editor=list,this._collection=this.options.collection||[],this.options.loadCollectionURL?this.loadCollection():this.checkForExternalText(),this._form.appendChild(this._controls.editor)},loadCollection:function(){this._form.addClassName(this.options.loadingClassName),this.showLoadingText(this.options.loadingCollectionText);var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){var js=transport.responseText.strip();if(!/^\[.*\]$/.test(js))throw"Server returned an invalid collection representation.";this._collection=eval(js),this.checkForExternalText()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadCollectionURL,options)},showLoadingText:function(text){this._controls.editor.disabled=!0;var tempOption=this._controls.editor.firstChild;tempOption||(tempOption=document.createElement("option"),tempOption.value="",this._controls.editor.appendChild(tempOption),tempOption.selected=!0),tempOption.update((text||"").stripScripts().stripTags())},checkForExternalText:function(){this._text=this.getText(),this.options.loadTextURL?this.loadExternalText():this.buildOptionList()},loadExternalText:function(){this.showLoadingText(this.options.loadingText);var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){this._text=transport.responseText.strip(),this.buildOptionList()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadTextURL,options)},buildOptionList:function(){this._form.removeClassName(this.options.loadingClassName),this._collection=this._collection.map(function(entry){return 2===entry.length?entry:[entry,entry].flatten()});var marker="value"in this.options?this.options.value:this._text,textFound=this._collection.any(function(entry){return entry[0]==marker}.bind(this));this._controls.editor.update("");var option;this._collection.each(function(entry,index){option=document.createElement("option"),option.value=entry[0],option.selected=textFound?entry[0]==marker:0==index,option.appendChild(document.createTextNode(entry[1])),this._controls.editor.appendChild(option)}.bind(this)),this._controls.editor.disabled=!1,Field.scrollFreeActivate(this._controls.editor)}}),Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(options){function fallback(name,expr){name in options||void 0===expr||(options[name]=expr)}options&&(fallback("cancelControl",options.cancelLink?"link":options.cancelButton?"button":options.cancelLink==options.cancelButton==0?!1:void 0),fallback("okControl",options.okLink?"link":options.okButton?"button":options.okLink==options.okButton==0?!1:void 0),fallback("highlightColor",options.highlightcolor),fallback("highlightEndColor",options.highlightendcolor))},Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:"link",cancelText:"cancel",clickToEditText:"Click to edit",externalControl:null,externalControlOnly:!1,fieldPostCreation:"activate",formClassName:"inplaceeditor-form",formId:null,highlightColor:"#ffff99",highlightEndColor:"#ffffff",hoverClassName:"",htmlResponse:!0,loadingClassName:"inplaceeditor-loading",loadingText:"Loading...",okControl:"button",okText:"ok",paramName:"value",rows:1,savingClassName:"inplaceeditor-saving",savingText:"Saving...",size:0,stripLoadedTextTags:!1,submitOnBlur:!1,textAfterControls:"",textBeforeControls:"",textBetweenControls:""},DefaultCallbacks:{callback:function(form){return Form.serialize(form)},onComplete:function(transport,element){new Effect.Highlight(element,{startcolor:this.options.highlightColor,keepBackgroundImage:!0})},onEnterEditMode:null,onEnterHover:function(ipe){ipe.element.style.backgroundColor=ipe.options.highlightColor,ipe._effect&&ipe._effect.cancel()},onFailure:function(transport,ipe){alert("Error communication with the server: "+transport.responseText.stripTags())},onFormCustomization:null,onLeaveEditMode:null,onLeaveHover:function(ipe){ipe._effect=new Effect.Highlight(ipe.element,{startcolor:ipe.options.highlightColor,endcolor:ipe.options.highlightEndColor,restorecolor:ipe._originalBackground,keepBackgroundImage:!0})}},Listeners:{click:"enterEditMode",keydown:"checkForEscapeOrReturn",mouseover:"enterHover",mouseout:"leaveHover"}}),Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:"Loading options..."},Form.Element.DelayedObserver=Class.create({initialize:function(element,delay,callback){this.delay=delay||.5,this.element=$(element),this.callback=callback,this.timer=null,this.lastValue=$F(this.element),Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this))},delayedListener:function(event){this.lastValue!=$F(this.element)&&(this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.onTimerEvent.bind(this),1e3*this.delay),this.lastValue=$F(this.element))},onTimerEvent:function(){this.timer=null,this.callback(this.element,$F(this.element))}}),!Control)var Control={};if(Control.Slider=Class.create({initialize:function(handle,track,options){var slider=this;Object.isArray(handle)?this.handles=handle.collect(function(e){return $(e)}):this.handles=[$(handle)],this.track=$(track),this.options=options||{},
this.axis=this.options.axis||"horizontal",this.increment=this.options.increment||1,this.step=parseInt(this.options.step||"1"),this.range=this.options.range||$R(0,1),this.value=0,this.values=this.handles.map(function(){return 0}),this.spans=this.options.spans?this.options.spans.map(function(s){return $(s)}):!1,this.options.startSpan=$(this.options.startSpan||null),this.options.endSpan=$(this.options.endSpan||null),this.restricted=this.options.restricted||!1,this.maximum=this.options.maximum||this.range.end,this.minimum=this.options.minimum||this.range.start,this.alignX=parseInt(this.options.alignX||"0"),this.alignY=parseInt(this.options.alignY||"0"),this.trackLength=this.maximumOffset()-this.minimumOffset(),this.handleLength=this.isVertical()?0!=this.handles[0].offsetHeight?this.handles[0].offsetHeight:this.handles[0].style.height.replace(/px$/,""):0!=this.handles[0].offsetWidth?this.handles[0].offsetWidth:this.handles[0].style.width.replace(/px$/,""),this.active=!1,this.dragging=!1,this.disabled=!1,this.options.disabled&&this.setDisabled(),this.allowedValues=this.options.values?this.options.values.sortBy(Prototype.K):!1,this.allowedValues&&(this.minimum=this.allowedValues.min(),this.maximum=this.allowedValues.max()),this.eventMouseDown=this.startDrag.bindAsEventListener(this),this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.update.bindAsEventListener(this),this.handles.each(function(h,i){i=slider.handles.length-1-i,slider.setValue(parseFloat((Object.isArray(slider.options.sliderValue)?slider.options.sliderValue[i]:slider.options.sliderValue)||slider.range.start),i),h.makePositioned().observe("mousedown",slider.eventMouseDown)}),this.track.observe("mousedown",this.eventMouseDown),document.observe("mouseup",this.eventMouseUp),document.observe("mousemove",this.eventMouseMove),this.initialized=!0},dispose:function(){var slider=this;Event.stopObserving(this.track,"mousedown",this.eventMouseDown),Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),this.handles.each(function(h){Event.stopObserving(h,"mousedown",slider.eventMouseDown)})},setDisabled:function(){this.disabled=!0},setEnabled:function(){this.disabled=!1},getNearestValue:function(value){if(this.allowedValues){if(value>=this.allowedValues.max())return this.allowedValues.max();if(value<=this.allowedValues.min())return this.allowedValues.min();var offset=Math.abs(this.allowedValues[0]-value),newValue=this.allowedValues[0];return this.allowedValues.each(function(v){var currentOffset=Math.abs(v-value);offset>=currentOffset&&(newValue=v,offset=currentOffset)}),newValue}return value>this.range.end?this.range.end:value<this.range.start?this.range.start:value},setValue:function(sliderValue,handleIdx){this.active||(this.activeHandleIdx=handleIdx||0,this.activeHandle=this.handles[this.activeHandleIdx],this.updateStyles()),handleIdx=handleIdx||this.activeHandleIdx||0,this.initialized&&this.restricted&&(handleIdx>0&&sliderValue<this.values[handleIdx-1]&&(sliderValue=this.values[handleIdx-1]),handleIdx<this.handles.length-1&&sliderValue>this.values[handleIdx+1]&&(sliderValue=this.values[handleIdx+1])),sliderValue=this.getNearestValue(sliderValue),this.values[handleIdx]=sliderValue,this.value=this.values[0];try{this.handles[handleIdx].style[this.isVertical()?"top":"left"]=this.translateToPx(sliderValue)}catch(e){}this.drawSpans(),this.dragging&&this.event||this.updateFinished()},setValueBy:function(delta,handleIdx){this.setValue(this.values[handleIdx||this.activeHandleIdx||0]+delta,handleIdx||this.activeHandleIdx||0)},translateToPx:function(value){return Math.round((this.trackLength-this.handleLength)/(this.range.end-this.range.start)*(value-this.range.start))+"px"},translateToValue:function(offset){return offset/(this.trackLength-this.handleLength)*(this.range.end-this.range.start)+this.range.start},getRange:function(range){var v=this.values.sortBy(Prototype.K);return range=range||0,$R(v[range],v[range+1])},minimumOffset:function(){return this.isVertical()?this.alignY:this.alignX},maximumOffset:function(){return this.isVertical()?(0!=this.track.offsetHeight?this.track.offsetHeight:this.track.style.height.replace(/px$/,""))-this.alignY:(0!=this.track.offsetWidth?this.track.offsetWidth:this.track.style.width.replace(/px$/,""))-this.alignX},isVertical:function(){return"vertical"==this.axis},drawSpans:function(){var slider=this;this.spans&&$R(0,this.spans.length-1).each(function(r){slider.setSpan(slider.spans[r],slider.getRange(r))}),this.options.startSpan&&this.setSpan(this.options.startSpan,$R(0,this.values.length>1?this.getRange(0).min():this.value)),this.options.endSpan&&this.setSpan(this.options.endSpan,$R(this.values.length>1?this.getRange(this.spans.length-1).max():this.value,this.maximum))},setSpan:function(span,range){this.isVertical()?(span.style.top=this.translateToPx(range.start),span.style.height=this.translateToPx(range.end-range.start+this.range.start)):(span.style.left=this.translateToPx(range.start),span.style.width=this.translateToPx(range.end-range.start+this.range.start))},updateStyles:function(){this.handles.each(function(h){Element.removeClassName(h,"selected")}),Element.addClassName(this.activeHandle,"selected")},startDrag:function(event){if(Event.isLeftClick(event)){if(!this.disabled){this.active=!0;var handle=Event.element(event),pointer=[Event.pointerX(event),Event.pointerY(event)],track=handle;if(track==this.track){var offsets=Position.cumulativeOffset(this.track);this.event=event,this.setValue(this.translateToValue((this.isVertical()?pointer[1]-offsets[1]:pointer[0]-offsets[0])-this.handleLength/2));var offsets=Position.cumulativeOffset(this.activeHandle);this.offsetX=pointer[0]-offsets[0],this.offsetY=pointer[1]-offsets[1]}else{for(;-1==this.handles.indexOf(handle)&&handle.parentNode;)handle=handle.parentNode;if(-1!=this.handles.indexOf(handle)){this.activeHandle=handle,this.activeHandleIdx=this.handles.indexOf(this.activeHandle),this.updateStyles();var offsets=Position.cumulativeOffset(this.activeHandle);this.offsetX=pointer[0]-offsets[0],this.offsetY=pointer[1]-offsets[1]}}}Event.stop(event)}},update:function(event){this.active&&(this.dragging||(this.dragging=!0),this.draw(event),Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event))},draw:function(event){var pointer=[Event.pointerX(event),Event.pointerY(event)],offsets=Position.cumulativeOffset(this.track);pointer[0]-=this.offsetX+offsets[0],pointer[1]-=this.offsetY+offsets[1],this.event=event,this.setValue(this.translateToValue(this.isVertical()?pointer[1]:pointer[0])),this.initialized&&this.options.onSlide&&this.options.onSlide(this.values.length>1?this.values:this.value,this)},endDrag:function(event){this.active&&this.dragging&&(this.finishDrag(event,!0),Event.stop(event)),this.active=!1,this.dragging=!1},finishDrag:function(event,success){this.active=!1,this.dragging=!1,this.updateFinished()},updateFinished:function(){this.initialized&&this.options.onChange&&this.options.onChange(this.values.length>1?this.values:this.value,this),this.event=null}}),Effect.CSS_SUPPORTED=Modernizr.csstransitions&&Modernizr.cssanimations,Effect.CSS_ANIMATE=function(effectName,element,options){var className,originalMethod,endStyle={};switch(options||(options={}),["webkitAnimationEnd","mozAnimationEnd","oAnimationEnd","animationEnd","transitionend","animationend","oanimationend","mozanimationend"].map(function(event){element.stopObserving(event)}),effectName){case"RowFade":className="quick bounceOutLeft",originalMethod="Fade";break;case"RowAppear":className="quick fadeInLeft",originalMethod="Appear";break;case"ErrorShake":className="shake",originalMethod="Shake";break;case"MessageAppear":element.removeClassName("fadeOutDownBig"),className="fadeInUpBig",endStyle={opacity:1},originalMethod="Appear",element.setOpacity(0),element.show();break;case"MessageFade":className="long fadeOutDownBig",endStyle={opacity:0},originalMethod="Appear",options.afterFinish||(options.afterFinish=function(){element.hide()});break;case"MenuAppear":className="super-quick fadeIn",endStyle={opacity:1},originalMethod="Appear"}Effect.CSS_SUPPORTED?(["webkitAnimationEnd","mozAnimationEnd","oAnimationEnd","animationEnd","transitionend","animationend","oanimationend","mozanimationend"].map(function(event){element.observeOnce(event,function(){("animated "+className).split(" ").map(function(cName){element.removeClassName(cName)}),endStyle&&element.setStyle(endStyle),options&&options.afterFinish&&options.afterFinish()})}),element.addClassName("animated "+className)):new Effect[originalMethod](element,options)},Effect.RowFade=function(element,options){Effect.CSS_ANIMATE("RowFade",element,options)},Effect.RowAppear=function(element,options){Effect.CSS_ANIMATE("RowAppear",element,options)},Effect.MessageFade=function(element,options){Effect.CSS_ANIMATE("MessageFade",element,options)},Effect.MessageAppear=function(element,options){Effect.CSS_ANIMATE("MessageAppear",element,options)},Effect.MenuAppear=function(element,options){Effect.CSS_ANIMATE("MenuAppear",element,options)},Effect.ErrorShake=function(element,options){Effect.CSS_ANIMATE("ErrorShake",element,options)},"undefined"==typeof Prototype)throw"Control.ScrollBar requires Prototype to be loaded.";if("undefined"==typeof Control.Slider)throw"Control.ScrollBar requires Control.Slider to be loaded.";if("undefined"==typeof Object.Event)throw"Control.ScrollBar requires Object.Event to be loaded.";Control.ScrollBar=Class.create({initialize:function(container,track,options){Control.ScrollBar.instances.push(this),this.enabled=!1,this.notificationTimeout=!1,this.container=$(container),this.container.scrollerInstance=this,this.boundMouseWheelEvent=this.onMouseWheel.bindAsEventListener(this),this.boundResizeObserver=this.onWindowResize.bind(this),this.track=$(track),this.handle=this.track.firstDescendant(),this.options=Object.extend({active_class_name:"scrolling",apply_active_class_name_to:this.container,notification_timeout_length:125,handle_minimum_length:25,scroll_to_smoothing:.01,scroll_to_steps:15,scroll_to_precision:100,proportional:!0,custom_event:null,custom_event_handler:null,scroll_axis:"vertical",fixed_scroll_distance:100,slider_options:{}},options||{}),this.slider=new Control.Slider(this.handle,this.track,Object.extend({axis:this.options.scroll_axis,onSlide:this.onChange.bind(this),onChange:this.onChange.bind(this)},this.options.slider_options)),this.recalculateLayout(),this.options.custom_event&&(Object.isFunction(this.options.custom_event_handler)?this.container.observe(this.options.custom_event,this.options.custom_event_handler):this.container.observe(this.options.custom_event,this.boundResizeObserver)),this.handle.observe("mousedown",function(){this.auto_sliding_executer&&this.auto_sliding_executer.stop()}.bind(this)),attachMobileScroll(container,"vertical")},destroy:function(){this.options.active_class_name&&$(this.options.apply_active_class_name_to).removeClassName(this.options.active_class_name),this.options.custom_event&&this.container.stopObserving(this.options.custom_event),this.container.scrollerInstance=null},scrollLength:function(){return"vertical"==this.options.scroll_axis?this.container.scrollHeight:this.container.scrollWidth},offsetLength:function(){return"vertical"==this.options.scroll_axis?this.container.offsetHeight:this.container.offsetWidth},enable:function(){this.enabled=!0,this.container.observe("mouse:wheel",this.boundMouseWheelEvent),this.slider.setEnabled(),this.track.show(),this.options.active_class_name&&$(this.options.apply_active_class_name_to).addClassName(this.options.active_class_name),this.notify("enabled")},disable:function(){this.enabled=!1,this.container.stopObserving("mouse:wheel",this.boundMouseWheelEvent),this.slider.setDisabled(),this.track.hide(),this.options.active_class_name&&$(this.options.apply_active_class_name_to).removeClassName(this.options.active_class_name),this.notify("disabled"),this.reset()},reset:function(){this.slider.setValue(0)},recalculateLayout:function(parentHeight){if(parentHeight&&!Modernizr.flexbox&&this.track.setStyle({height:parentHeight+"px"}),this.scrollLength()<=this.offsetLength())this.disable();else{if(this.enable(),this.slider.trackLength=this.slider.maximumOffset()-this.slider.minimumOffset(),this.options.proportional&&(this.slider.handleLength=Math.max(this.offsetLength()*(this.offsetLength()/this.scrollLength()),this.options.handle_minimum_length),"vertical"==this.options.scroll_axis?this.handle.style.height=this.slider.handleLength+"px":this.handle.style.width=this.slider.handleLength+"px"),"vertical"==this.options.scroll_axis&&parseInt(this.handle.style.height)>this.offsetLength()||parseInt(this.handle.style.width)>this.offsetLength())return void this.disable();this.scrollBy(0)}},onWindowResize:function(){this.recalculateLayout(),this.scrollBy(0)},onMouseWheel:function(event){return this.auto_sliding_executer&&this.auto_sliding_executer.stop(),this.slider.setValueBy(this.options.fixed_scroll_distance>0?-(this.options.fixed_scroll_distance*event.memo.delta/(this.scrollLength()-this.slider.trackLength)):-(event.memo.delta/8)),event.stop(),!1},onChange:function(value){var scroll_pos=Math.round(value/this.slider.maximum*(this.scrollLength()-this.offsetLength()));if("vertical"==this.options.scroll_axis)try{this.container.scrollTop=scroll_pos}catch(e){}else this.container.scrollLeft=scroll_pos;this.notificationTimeout&&window.clearTimeout(this.notificationTimeout),this.notificationTimeout=window.setTimeout(function(){this.notify("change",value)}.bind(this),this.options.notification_timeout_length)},getCurrentMaximumDelta:function(){return this.slider.maximum*(this.scrollLength()-this.offsetLength())},getContainerOffset:function(element){for(var offset=element.positionedOffset();element.getOffsetParent()!=this.container;)element=element.getOffsetParent(),offset[0]+=element.positionedOffset()[0],offset[1]+=element.positionedOffset()[1],offset.top+=element.positionedOffset().top,offset.left+=element.positionedOffset().left;return offset},getDeltaToElement:function(element){return"vertical"==this.options.scroll_axis?this.slider.maximum*(this.getContainerOffset(element).top+element.getHeight()/2-this.container.getHeight()/2):this.slider.maximum*(this.getContainerOffset(element).left+element.getWidth()/2-this.container.getWidth()/2)},scrollTo:function(y,animate){var precision=this.options.scroll_to_precision,current_maximum_delta=this.getCurrentMaximumDelta();if("auto"==precision&&(precision=Math.pow(10,Math.ceil(Math.log(current_maximum_delta)/Math.log(10)))),"top"==y?y=0:"bottom"==y?y=current_maximum_delta:"number"!=typeof y&&(y=this.getDeltaToElement($(y))),this.enabled){y=Math.max(0,Math.min(y,current_maximum_delta)),this.auto_sliding_executer&&this.auto_sliding_executer.stop();var target_value=y/current_maximum_delta,original_slider_value=this.slider.value,delta=(target_value-original_slider_value)*current_maximum_delta;animate?this.auto_sliding_executer=new PeriodicalExecuter(function(){Math.round(this.slider.value*precision)/precision<Math.round(target_value*precision)/precision||Math.round(this.slider.value*precision)/precision>Math.round(target_value*precision)/precision?this.scrollBy(delta/this.options.scroll_to_steps):(this.auto_sliding_executer.stop(),this.auto_sliding_executer=null,"function"==typeof animate&&animate())}.bind(this),this.options.scroll_to_smoothing):this.scrollBy(delta)}else"function"==typeof animate&&animate()},scrollBy:function(y){this.enabled&&this.slider.setValueBy(y/(0==this.getCurrentMaximumDelta()?1:this.getCurrentMaximumDelta()))}}),Object.extend(Control.ScrollBar,{instances:[],findByElementId:function(id){return Control.ScrollBar.instances.find(function(instance){return instance.container.id&&instance.container.id==id})}}),Object.Event.extend(Control.ScrollBar),Class.create("Carousel",Abstract,{initialize:function(scroller,slides,controls,options){if(this.scrolling=!1,this.scroller=$(scroller),this.slides=slides,this.controls=controls,this.options=Object.extend({duration:1,auto:!1,frequency:3,visibleSlides:1,controlClassName:"carousel-control",jumperClassName:"carousel-jumper",disabledClassName:"carousel-disabled",selectedClassName:"carousel-selected",circular:!1,wheel:!0,effect:"scroll",transition:"sinoidal"},options||{}),"fade"==this.options.effect&&(this.options.circular=!0),this.slides.each(function(slide,index){slide._index=index}),this.controls&&this.controls.invoke("observe","click",this.click.bind(this)),this.options.wheel&&this.scroller.observe("mousewheel",this.wheel.bindAsEventListener(this)).observe("DOMMouseScroll",this.wheel.bindAsEventListener(this)),this.options.auto&&this.start(),this.options.initial){var initialIndex=this.slides.indexOf($(this.options.initial));initialIndex>this.options.visibleSlides-1&&this.options.visibleSlides>1&&initialIndex>this.slides.length-(this.options.visibleSlides+1)&&(initialIndex=this.slides.length-this.options.visibleSlides),this.moveTo(this.slides[initialIndex])}},refreshSlides:function(slides){if(this.slides=slides,this.slides.each(function(slide,index){slide._index=index}),this.current)var newCurrent=this.slides.find(function(el){return el.id==this.current.id}.bind(this));newCurrent?this.moveTo(newCurrent):this.first()},click:function(event){this.stop();var element=event.findElement("a");element.hasClassName(this.options.disabledClassName)||(element.hasClassName(this.options.controlClassName)?eval("this."+element.rel+"()"):element.hasClassName(this.options.jumperClassName)&&(this.moveTo(element.rel),this.options.selectedClassName&&(this.controls.invoke("removeClassName",this.options.selectedClassName),element.addClassName(this.options.selectedClassName)))),this.deactivateControls(),event.stop()},moveTo:function(element){if(this.options.beforeMove&&"function"==typeof this.options.beforeMove&&this.options.beforeMove(),this.previous=this.current?this.current:this.slides[0],this.current=$(element),!this.current)return!1;var scrollerOffset=this.scroller.cumulativeOffset(),elementOffset=this.current.cumulativeOffset(),previousNode=this.current.previous();switch(previousNode&&previousNode.hasClassName("separator")&&(elementOffset=previousNode.cumulativeOffset()),this.scrolling&&this.scrolling.cancel(),this.options.effect){case"fade":this.scrolling=new Effect.Opacity(this.scroller,{from:1,to:0,duration:this.options.duration,afterFinish:function(){this.scroller.scrollLeft=elementOffset[0]-scrollerOffset[0],this.scroller.scrollTop=elementOffset[1]-scrollerOffset[1],new Effect.Opacity(this.scroller,{from:0,to:1,duration:this.options.duration,afterFinish:function(){this.controls&&this.activateControls(),this.options.afterMove&&"function"==typeof this.options.afterMove&&this.options.afterMove()}.bind(this)})}.bind(this)});break;case"scroll":default:var transition;switch(this.options.transition){case"spring":transition=Effect.Transitions.spring;break;case"sinoidal":default:transition=Effect.Transitions.sinoidal}this.scrolling=new Effect.SmoothScroll(this.scroller,{duration:this.options.duration,x:elementOffset[0]-scrollerOffset[0],y:elementOffset[1]-scrollerOffset[1],transition:transition,afterFinish:function(){this.controls&&this.activateControls(),this.options.afterMove&&"function"==typeof this.options.afterMove&&this.options.afterMove(),this.scrolling=!1}.bind(this)})}return!1},prev:function(){var prevIndex;if(this.current){var currentIndex=this.current._index;prevIndex=0==currentIndex?this.options.circular?this.slides.length-1:0:currentIndex-1}else prevIndex=this.options.circular?this.slides.length-1:0;prevIndex==this.slides.length-1&&this.options.circular&&"fade"!=this.options.effect&&(this.scroller.scrollLeft=(this.slides.length-1)*this.slides.first().getWidth(),this.scroller.scrollTop=(this.slides.length-1)*this.slides.first().getHeight(),prevIndex=this.slides.length-2),this.moveTo(this.slides[prevIndex])},next:function(){var nextIndex;if(this.current){var currentIndex=this.current._index;nextIndex=this.slides.length-1==currentIndex?this.options.circular?0:currentIndex:currentIndex+1}else nextIndex=1;0==nextIndex&&this.options.circular&&"fade"!=this.options.effect&&(this.scroller.scrollLeft=0,this.scroller.scrollTop=0,nextIndex=1),nextIndex>this.slides.length-(this.options.visibleSlides+1)&&(nextIndex=this.slides.length-this.options.visibleSlides),this.slides[nextIndex]&&this.slides[nextIndex].visible()||nextIndex++,this.moveTo(this.slides[nextIndex])},first:function(){this.moveTo(this.slides[0])},last:function(){this.moveTo(this.slides[this.slides.length-1])},toggle:function(){this.previous&&this.moveTo(this.slides[this.previous._index])},stop:function(){this.timer&&clearTimeout(this.timer)},start:function(){this.periodicallyUpdate()},pause:function(){this.stop(),this.activateControls()},resume:function(event){if(event){var related=event.relatedTarget||event.toElement;related&&(this.slides.include(related)||this.slides.any(function(slide){return related.descendantOf(slide)}))||this.start()}else this.start()},periodicallyUpdate:function(){null!=this.timer&&(clearTimeout(this.timer),this.next()),this.timer=setTimeout(this.periodicallyUpdate.bind(this),1e3*this.options.frequency)},wheel:function(event){event.cancelBubble=!0,event.stop();var delta=0;return event||(event=window.event),event.wheelDelta?delta=event.wheelDelta/120:event.detail&&(delta=-event.detail/3),this.scrolling||(this.deactivateControls(),delta>0?this.prev():this.next()),Math.round(delta)},deactivateControls:function(){this.controls.invoke("addClassName",this.options.disabledClassName)},activateControls:function(){this.controls.invoke("removeClassName",this.options.disabledClassName)}}),Effect.SmoothScroll=Class.create(),Object.extend(Object.extend(Effect.SmoothScroll.prototype,Effect.Base.prototype),{initialize:function(element){this.element=$(element);var options=Object.extend({x:0,y:0,mode:"absolute"},arguments[1]||{});this.start(options)},setup:function(){this.options.continuous&&!this.element._ext&&(this.element.cleanWhitespace(),this.element._ext=!0,this.element.appendChild(this.element.firstChild)),this.originalLeft=this.element.scrollLeft,this.originalTop=this.element.scrollTop,"absolute"==this.options.mode&&(this.options.x-=this.originalLeft,this.options.y-=this.originalTop)},update:function(position){this.element.scrollLeft=this.options.x*position+this.originalLeft,this.element.scrollTop=this.options.y*position+this.originalTop}}),Class.create("accordion",{showAccordion:null,currentAccordion:null,duration:null,effects:[],animating:!1,initialize:function(container,options){if(!$(container))throw container+" doesn't exist!";this.container=$(container),this.options=Object.extend({resizeSpeed:8,classNames:{toggle:"accordion_toggle",toggleActive:"accordion_toggle_active",content:"accordion_content"},defaultSize:{height:null,width:null},direction:"vertical",onEvent:"click"},options||{}),this.duration=.15*(11-this.options.resizeSpeed);var accordions=this.container.select("div."+this.options.classNames.toggle);accordions.each(function(accordion){Event.observe(accordion,this.options.onEvent,this.activate.bind(this,accordion),!1),"click"==this.options.onEvent&&(accordion.onclick=function(){return!1});var options;options=$H("horizontal"==this.options.direction?{width:"0px"}:{height:"0px"}),options=options.merge({display:"none"}),this.currentAccordion=$(accordion.next(0)).setStyle(options._object)}.bind(this))},openAll:function(){this.container.select("div."+this.options.classNames.toggle).each(function(accordion){accordion.stopObserving("click"),accordion.stopObserving("focus")}),this.container.select("div."+this.options.classNames.content).each(function(accordion){accordion.setStyle({display:"block",height:"auto"})})},activate:function(accordion){this.animating||(this.effects=[],this.currentAccordion=$(accordion.next(0)),this.currentAccordion.setStyle({display:"block"}),this.currentAccordion.previous(0).addClassName(this.options.classNames.toggleActive),"horizontal"==this.options.direction?this.scaling=$H({scaleX:!0,scaleY:!1}):this.scaling=$H({scaleX:!1,scaleY:!0}),this.currentAccordion==this.showAccordion?this.deactivate():this._handleAccordion())},deactivate:function(){var options=$H({duration:this.duration,scaleContent:!1,transition:Effect.Transitions.sinoidal,queue:{position:"end",scope:"accordionAnimation"},scaleMode:{originalHeight:this.options.defaultSize.height?this.options.defaultSize.height:this.currentAccordion.scrollHeight,originalWidth:this.options.defaultSize.width?this.options.defaultSize.width:this.currentAccordion.scrollWidth},afterFinish:function(){this.showAccordion.setStyle({height:"auto",display:"none"}),this.showAccordion.previous(0).removeClassName(this.options.classNames.toggleActive),this.showAccordion=null,this.animating=!1,this.notify("animation-finished")}.bind(this)});options=options.merge(this.scaling),new Effect.Scale(this.showAccordion,0,options._object)},_handleAccordion:function(){var options=$H({sync:!0,scaleFrom:0,scaleContent:!1,transition:Effect.Transitions.sinoidal,scaleMode:{originalHeight:this.options.defaultSize.height?this.options.defaultSize.height:this.currentAccordion.scrollHeight,originalWidth:this.options.defaultSize.width?this.options.defaultSize.width:this.currentAccordion.scrollWidth}});options=options.merge(this.scaling),this.effects.push(new Effect.Scale(this.currentAccordion,100,options._object)),this.showAccordion&&(options=$H({sync:!0,scaleContent:!1,transition:Effect.Transitions.sinoidal}),options=options.merge(this.scaling),this.effects.push(new Effect.Scale(this.showAccordion,0,options._object))),new Effect.Parallel(this.effects,{duration:this.duration,queue:{position:"end",scope:"accordionAnimation"},beforeStart:function(){this.animating=!0,this.notify("animation-started")}.bind(this),afterFinish:function(){this.showAccordion&&(this.showAccordion.setStyle({display:"none"}),this.showAccordion.previous(0).removeClassName(this.options.classNames.toggleActive)),$(this.currentAccordion).setStyle({height:"auto"}),this.showAccordion=this.currentAccordion,this.animating=!1,this.notify("animation-finished")}.bind(this)})}});var webFXTreeConfig={rootIcon:"/images/foldericon.png",openRootIcon:"/images/openfoldericon.png",folderIcon:"/images/foldericon.png",openFolderIcon:"/images/openfoldericon.png",fileIcon:"/images/foldericon.png",iIcon:"/images/I.png",lIcon:"/images/L.png",lMinusIcon:"/images/Lminus.png",lPlusIcon:"/images/Lplus.png",lMinusIconActive:"/images/Lminus-active.png",lPlusIconActive:"/images/Lplus-active.png",tIcon:"/images/T.png",tMinusIcon:"/images/Tminus.png",tPlusIcon:"/images/Tplus.png",tMinusIconActive:"/images/Tminus-active.png",tPlusIconActive:"/images/Tplus-active.png",blankIcon:"/images/blank.png",defaultText:"Tree Item",defaultAction:function(e){},defaultBehavior:"classic",zipRegexp:new RegExp(/\.zip$/),usePersistence:!1};Event.observe(document,"ajaxplorer:boot_loaded",function(){var resourcesFolder=window.ajxpResourcesFolder;webFXTreeConfig.rootIcon=resourcesFolder+"/images/foldericon.png",webFXTreeConfig.openRootIcon=resourcesFolder+"/images/openfoldericon.png",webFXTreeConfig.folderIcon=resourcesFolder+"/images/foldericon.png",webFXTreeConfig.openFolderIcon=resourcesFolder+"/images/openfoldericon.png",webFXTreeConfig.fileIcon=resourcesFolder+"/images/foldericon.png",webFXTreeConfig.iIcon=resourcesFolder+"/images/I.png",webFXTreeConfig.lIcon=resourcesFolder+"/images/L.png",webFXTreeConfig.lMinusIcon=resourcesFolder+"/images/Lminus.png",webFXTreeConfig.lPlusIcon=resourcesFolder+"/images/Lplus.png",webFXTreeConfig.lMinusIconActive=resourcesFolder+"/images/Lminus-active.png",webFXTreeConfig.lPlusIconActive=resourcesFolder+"/images/Lplus-active.png",webFXTreeConfig.tIcon=resourcesFolder+"/images/T.png",webFXTreeConfig.tMinusIcon=resourcesFolder+"/images/Tminus.png",webFXTreeConfig.tPlusIcon=resourcesFolder+"/images/Tplus.png",webFXTreeConfig.tMinusIconActive=resourcesFolder+"/images/Tminus-active.png",webFXTreeConfig.tPlusIconActive=resourcesFolder+"/images/Tplus-active.png",webFXTreeConfig.blankIcon=resourcesFolder+"/images/blank.png"});var webFXTreeHandler={idCounter:0,idPrefix:"webfx-tree-object-",all:{},behavior:null,selected:null,contextMenu:null,onSelect:null,getId:function(){return this.idPrefix+this.idCounter++},toggle:function(oItem){this.all[oItem.id.replace("-plus","")].toggle()},select:function(oItem){this.all[oItem.id].select()},hasFocus:!1,focus:function(oItem){this.all[oItem.id.replace("-anchor","")]&&this.all[oItem.id.replace("-anchor","")].focus()},blur:function(oItem){this.all[oItem.id.replace("-anchor","")]&&this.all[oItem.id.replace("-anchor","")].blur()},setFocus:function(bFocus){this.hasFocus=bFocus},keydown:function(oItem,e){return this.all[oItem.id].keydown(e.keyCode)},linkKeyPress:function(oItem,e){return this.hasFocus&&9!=e.keyCode?!0:!1},cookies:new WebFXCookie,insertHTMLBeforeEnd:function(oElement,sHTML){if(oElement){if(oElement&&oElement.insertAdjacentHTML)return void oElement.insertAdjacentHTML("BeforeEnd",sHTML);var df,r=oElement.ownerDocument.createRange();r.selectNodeContents(oElement),r.collapse(!1),df=r.createContextualFragment(sHTML),oElement.appendChild(df)}}};WebFXCookie.prototype.setCookie=function(key,value){document.cookie=key+"="+escape(value)},WebFXCookie.prototype.getCookie=function(key){if(this.cookies){var start=this.cookies.indexOf(" "+key+"=");if(-1==start)return null;var end=this.cookies.indexOf(";",start);-1==end&&(end=this.cookies.length),end-=start;var cookie=this.cookies.substr(start,end);return unescape(cookie.substr(cookie.indexOf("=")+1,cookie.length-cookie.indexOf("=")+1))}return null},WebFXTreeAbstractNode.prototype.add=function(node,bNoIdent){node.parentNode=this;node.parentNode.url;node.parentNode.inZip?node.inZip=!0:webFXTreeConfig.zipRegexp.test(node.text)!==!1&&(node.inZip=!0),!node.action&&node.parentNode.action&&(node.action=node.parentNode.action),this.childNodes[this.childNodes.length]=node;var root=this;for(this.childNodes.length>=2&&(this.childNodes[this.childNodes.length-2]._last=!1);root.parentNode;)root=root.parentNode;if(root.rendered){this.childNodes.length>=2&&($(this.childNodes[this.childNodes.length-2].id+"-plus").src=this.childNodes[this.childNodes.length-2].folder?this.childNodes[this.childNodes.length-2].open?webFXTreeConfig.tMinusIcon:webFXTreeConfig.tPlusIcon:webFXTreeConfig.tIcon,this.childNodes[this.childNodes.length-2].plusIcon=webFXTreeConfig.tPlusIcon,this.childNodes[this.childNodes.length-2].minusIcon=webFXTreeConfig.tMinusIcon,this.childNodes[this.childNodes.length-2]._last=!1),this._last=!0;for(var foo=this;foo.parentNode;){for(var i=0;i<foo.parentNode.childNodes.length&&foo.id!=foo.parentNode.childNodes[i].id;i++);i==foo.parentNode.childNodes.length-1?foo.parentNode._last=!0:foo.parentNode._last=!1,foo=foo.parentNode}$(this.id+"-cont").insert(node.toString()),$(node.id).ajxpNode=node.ajxpNode,node.inZip||window.setTimeout(function(){$(node.id)&&AjxpDroppables.add(node.id,node.ajxpNode)},200),webFXTreeHandler.contextMenu&&(Event.observe(node.id+"","contextmenu",function(event){this.select(),this.action(),Event.stop(event)}.bind(node)),webFXTreeHandler.contextMenu.addElements("#"+node.id)),Event.observe(node.id,"click",function(event){this.select(),this.action(),Event.stop(event)}.bind(node)),Event.observe(node.id,"dblclick",function(event){this.toggle(),Event.stop(event)}.bind(node)),Event.observe(node.id+"-plus","click",function(event){this.toggle(),Event.stop(event)}.bind(node)),this.folder||this.openIcon||(this.icon=webFXTreeConfig.folderIcon,this.openIcon=webFXTreeConfig.openFolderIcon),this.folder||(this.folder=!0,this.collapse(!0)),bNoIdent||this.indent(),this.ajxpNode&&this.ajxpNode.fake&&(this.parentNode&&this.parentNode.expand(),this.expand()),(Prototype.Browser.IE||Prototype.Browser.Opera)&&window.setTimeout(function(){var sum=0;$(node.id)&&$(node.id).childElements().each(function(el){
sum+=el.getWidth()}),sum&&$(node.id).setStyle({width:Math.max(sum+50,$(node.id).parentNode.getWidth())+"px"})},100)}return WebFXTreeBufferTreeChange(),node},WebFXTreeAbstractNode.prototype.updateLabel=function(label){$(this.id+"-label")&&$(this.id+"-label").update(label)},WebFXTreeAbstractNode.prototype.setLabelIcon=function(icon){if($(this.id+"-label")){var label=$(this.id+"-label"),bgOverlayImage="url('"+icon+"')",bgOverlayPosition="4px 1px";if(this.overlayClasses){var d=label.down("div.overlay_icon_div");d?d.update(""):(d=new Element("div",{className:"overlay_icon_div"}),label.insert(d)),this.overlayClasses.each(function(c){d.insert(new Element("span",{className:c+" overlay-class-span"}))})}else if(this.overlayIcon){switch(this.overlayIcon.length){case 1:bgOverlayPosition="14px 11px, 4px 1px",bgOverlayImage='url("'+this.overlayIcon[0]+'"), ';break;case 2:bgOverlayPosition="2px 11px, 14px 11px, 4px 1px",bgOverlayImage='url("'+this.overlayIcon[0]+'"), url("'+this.overlayIcon[1]+'"), ';break;case 3:bgOverlayPosition="14px 2px, 2px 11px, 14px 11px, 4px 1px",bgOverlayImage='url("'+this.overlayIcon[0]+'"), url("'+this.overlayIcon[1]+'"), url("'+this.overlayIcon[2]+'"), ';break;case 4:default:bgOverlayPosition="2px 2px, 14px 2px, 2px 11px, 14px 11px, 4px 1px",bgOverlayImage='url("'+this.overlayIcon[0]+'"), url("'+this.overlayIcon[1]+'"), url("'+this.overlayIcon[2]+'"), url("'+this.overlayIcon[3]+'"), '}bgOverlayImage+=" url('"+icon+"')"}label.setStyle({backgroundImage:bgOverlayImage,backgroundPosition:bgOverlayPosition})}},WebFXTreeAbstractNode.prototype.toggle=function(){this.folder&&(this.open?this.collapse():this.expand())},WebFXTreeAbstractNode.prototype.select=function(){if($(this.id+"-anchor"))try{if($(this.id+"-anchor").focus(),webFXTreeHandler.focus(this),!this.scrollContainer){for(var root=this;root.parentNode;)root=root.parentNode;this.rootOffset=$(root.id).offsetTop,this.scrollContainer=$(root.id).parentNode}if(this.scrollContainer.scrollerInstance){this.scrollContainer.scrollerInstance.scrollTo(this.scrollContainer.scrollTop);var oEl=$(this.id),elHeight=$(oEl).getHeight(),scrollOffset=oEl.offsetTop-this.rootOffset,parentHeight=this.scrollContainer.getHeight(),parentScrollTop=this.scrollContainer.scrollTop,sTop=-1;scrollOffset+elHeight>parentHeight+parentScrollTop?sTop=scrollOffset-parentHeight+elHeight:parentScrollTop>scrollOffset&&(sTop=scrollOffset-elHeight),-1!=sTop&&this.scrollContainer.scrollerInstance.scrollTo(sTop)}}catch(e){window.console&&console.log(e)}},WebFXTreeAbstractNode.prototype.deSelect=function(){$(this.id+"-anchor")&&($(this.id+"-anchor").className=""),webFXTreeHandler.selected=null,$(this.id)&&($(this.id).className="webfx-tree-item")},WebFXTreeAbstractNode.prototype.focus=function(){webFXTreeHandler.selected&&webFXTreeHandler.selected!=this&&webFXTreeHandler.selected.deSelect(),webFXTreeHandler.selected=this,this.openIcon&&"classic"!=webFXTreeHandler.behavior&&this.setLabelIcon(this.openIcon);try{$(this.id+"-anchor")&&$(this.id+"-anchor").focus()}catch(e){}$(this.id).className="webfx-tree-item selected-webfx-tree-item",webFXTreeHandler.onSelect&&webFXTreeHandler.onSelect(this)},WebFXTreeAbstractNode.prototype.blur=function(){$(this.id)&&(this.openIcon&&"classic"!=webFXTreeHandler.behavior&&this.setLabelIcon(this.icon),webFXTreeHandler.selected==this?$(this.id).className="webfx-tree-item selected-webfx-tree-item-inactive":$(this.id).className="webfx-tree-item",Prototype.Browser.IE&&$(this.id+"-anchor")&&$(this.id+"-anchor").blur())},WebFXTreeAbstractNode.prototype.doExpand=function(){"classic"==webFXTreeHandler.behavior&&this.setLabelIcon(this.openIcon),this.childNodes.length&&$(this.id+"-cont")&&($(this.id+"-cont").style.display="block"),this.open=!0,webFXTreeConfig.usePersistence&&webFXTreeHandler.cookies.setCookie(this.id.substr(18,this.id.length-18),"1"),WebFXTreeBufferTreeChange()},WebFXTreeAbstractNode.prototype.doCollapse=function(){"classic"==webFXTreeHandler.behavior&&this.setLabelIcon(this.icon),this.childNodes.length&&($(this.id+"-cont").style.display="none"),this.open=!1,webFXTreeConfig.usePersistence&&webFXTreeHandler.cookies.setCookie(this.id.substr(18,this.id.length-18),"0"),WebFXTreeBufferTreeChange()},WebFXTreeAbstractNode.prototype.expandAll=function(){this.expandChildren(),this.folder&&!this.open&&this.expand()},WebFXTreeAbstractNode.prototype.expandChildren=function(){for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].expandAll()},WebFXTreeAbstractNode.prototype.collapseAll=function(){this.collapseChildren(),this.folder&&this.open&&this.collapse(!0)},WebFXTreeAbstractNode.prototype.collapseChildren=function(){for(var i=0;i<this.childNodes.length;i++)this.childNodes[i].collapseAll()},WebFXTreeAbstractNode.prototype.indent=function(lvl,del,last,level,nodesLeft){null==lvl&&(lvl=-2);for(var state=0,i=this.childNodes.length-1;i>=0;i--)if(state=this.childNodes[i].indent(lvl+1,del,last,level))return;if(del&&level>=this._level&&$(this.id+"-plus"))return this.folder?($(this.id+"-plus").src=this.open?webFXTreeConfig.lMinusIcon:webFXTreeConfig.lPlusIcon,this.plusIcon=webFXTreeConfig.lPlusIcon,this.minusIcon=webFXTreeConfig.lMinusIcon):nodesLeft&&($(this.id+"-plus").src=webFXTreeConfig.lIcon),1;var foo=$(this.id+"-indent-"+lvl);return foo&&(foo._last||del&&last?foo.src=webFXTreeConfig.blankIcon:foo.src=webFXTreeConfig.iIcon),0},WebFXTree.prototype=new WebFXTreeAbstractNode,WebFXTree.prototype.setBehavior=function(sBehavior){webFXTreeHandler.behavior=sBehavior},WebFXTree.prototype.getBehavior=function(sBehavior){return webFXTreeHandler.behavior},WebFXTree.prototype.getSelected=function(){return webFXTreeHandler.selected?webFXTreeHandler.selected:null},WebFXTree.prototype.remove=function(){},WebFXTree.prototype.expand=function(){this.doExpand()},WebFXTree.prototype.collapse=function(b){if(!b)try{this.focus()}catch(e){}this.doCollapse()},WebFXTree.prototype.getFirst=function(){return null},WebFXTree.prototype.getLast=function(){return null},WebFXTree.prototype.getNextSibling=function(){return null},WebFXTree.prototype.getPreviousSibling=function(){return null},WebFXTree.prototype.keydown=function(key){if(!webFXTreeHandler.hasFocus)return!0;if(9==key)return!1;if(39==key)return this.open?this.childNodes.length&&this.childNodes[0].select():this.expand(),!1;if(37==key)return this.collapse(),!1;if(40==key&&this.open&&this.childNodes.length){this.childNodes[0].select();var toExec=this.childNodes[0];return WebFXtimer&&clearTimeout(WebFXtimer),WebFXtimer=window.setTimeout(toExec.action.bind(toExec),1e3),!1}return!0},WebFXTree.prototype.toString=function(){for(var str='<div id="'+this.id+'" ondblclick="webFXTreeHandler.toggle(this);" class="webfx-tree-item" onkeydown="return webFXTreeHandler.keydown(this, event)"><a href="/" id="'+this.id+'-anchor" onkeydown="return webFXTreeHandler.linkKeyPress(this, event);"  onfocus="webFXTreeHandler.focus(this);" onblur="webFXTreeHandler.blur(this);"'+(this.target?' target="'+this.target+'"':"")+'><span id="'+this.id+'-label" style="background-image:url(\''+("classic"==webFXTreeHandler.behavior&&this.open?this.openIcon:this.icon)+"');\">"+this.text+'</span></a></div><div id="'+this.id+'-cont" class="webfx-tree-container first_container" style="display: '+(this.open?"block":"none")+';">',sb=[],i=0;i<this.childNodes.length;i++)sb[i]=this.childNodes[i].toString(i,this.childNodes.length);return this.rendered=!0,str+sb.join("")+"</div>"},WebFXTreeItem.prototype=new WebFXTreeAbstractNode,WebFXTreeItem.prototype.updateIcon=function(icon,openIcon){openIcon?this.openIcon=openIcon:this.openIcon=icon,this.icon=icon,this.setLabelIcon(this.open&&"classic"!=webFXTreeHandler.behavior?this.openIcon:icon)},WebFXTreeItem.prototype.remove=function(){if($(this.id+"-plus")){var parentNode=($(this.id+"-plus").src,this.parentNode),prevSibling=this.getPreviousSibling(!0),nextSibling=this.getNextSibling(!0),last=(this.parentNode.folder,nextSibling&&nextSibling.parentNode&&nextSibling.parentNode.id==parentNode.id?!1:!0);this._remove(),Droppables.remove($(this.id)),webFXTreeHandler.contextMenu&&webFXTreeHandler.contextMenu.removeElements("#"+this.id),0==parentNode.childNodes.length&&($(parentNode.id+"-cont").style.display="none",parentNode.doCollapse(),parentNode.folder=!1,parentNode.open=!1),(!nextSibling||last)&&parentNode.indent(null,!0,last,this._level,parentNode.childNodes.length),prevSibling!=parentNode||parentNode.childNodes.length||(prevSibling.folder=!1,prevSibling.open=!1,$(prevSibling.id+"-plus")&&($(prevSibling.id+"-plus").src=this.zeroIcon,prevSibling.setLabelIcon(webFXTreeHandler.all[prevSibling.id].icon?webFXTreeHandler.all[prevSibling.id].icon:webFXTreeConfig.fileIcon))),$(prevSibling.id+"-plus")&&parentNode==prevSibling.parentNode&&($(prevSibling.id+"-plus").src=this.zeroIcon)}},WebFXTreeItem.prototype._remove=function(){for(var i=this.childNodes.length-1;i>=0;i--)this.childNodes[i]._remove();for(var i=0;i<this.parentNode.childNodes.length;i++)if(this==this.parentNode.childNodes[i]){for(var j=i;j<this.parentNode.childNodes.length;j++)this.parentNode.childNodes[j]=this.parentNode.childNodes[j+1];this.parentNode.childNodes.length-=1,i+1==this.parentNode.childNodes.length&&(this.parentNode._last=!0);break}delete webFXTreeHandler.all[this.id];var tmp=$(this.id);tmp&&tmp.parentNode.removeChild(tmp),tmp=$(this.id+"-cont"),tmp&&tmp.parentNode.removeChild(tmp)},WebFXTreeItem.prototype.expand=function(){this.doExpand(),$(this.id+"-plus")&&($(this.id+"-plus").src=this.minusIcon)},WebFXTreeItem.prototype.collapse=function(b){if(!b)try{this.focus()}catch(e){}this.doCollapse(),$(this.id+"-plus")&&($(this.id+"-plus").src=this.plusIcon)},WebFXTreeItem.prototype.getFirst=function(){return this.childNodes[0]},WebFXTreeItem.prototype.getLast=function(){return this.childNodes[this.childNodes.length-1].open?this.childNodes[this.childNodes.length-1].getLast():this.childNodes[this.childNodes.length-1]},WebFXTreeItem.prototype.getNextSibling=function(){for(var i=0;i<this.parentNode.childNodes.length&&this!=this.parentNode.childNodes[i];i++);return++i==this.parentNode.childNodes.length?this.parentNode.getNextSibling():this.parentNode.childNodes[i]},WebFXTreeItem.prototype.getPreviousSibling=function(b){for(var i=0;i<this.parentNode.childNodes.length&&this!=this.parentNode.childNodes[i];i++);return 0==i?this.parentNode:this.parentNode.childNodes[--i].open||b&&this.parentNode.childNodes[i].folder?this.parentNode.childNodes[i].getLast():this.parentNode.childNodes[i]},WebFXTreeItem.prototype.getCurrentPlusIcon=function(){return this.folder?this.open?this.parentNode._last?"lMinusIcon":"tMinusIcon":this.parentNode._last?"lPlusIcon":"tPlusIcon":this.parentNode._last?"lIcon":"tIcon"};var WebFXtimer;WebFXTreeItem.prototype.keydown=function(key){if(!webFXTreeHandler.hasFocus)return!0;if(9==key)return!1;if(39==key&&this.folder)return this.open?this.getFirst().select():this.expand(),!1;if(37==key)return this.open?this.collapse():this.parentNode.select(),!1;if(40==key){if(this.open){this.getFirst().select();var toExec=this.getFirst();WebFXtimer&&clearTimeout(WebFXtimer),WebFXtimer=window.setTimeout(toExec.action.bind(toExec),1e3)}else{var sib=this.getNextSibling();sib&&(sib.select(),WebFXtimer&&clearTimeout(WebFXtimer),WebFXtimer=window.setTimeout(sib.action.bind(sib),1e3))}return!1}if(38==key){var sib=this.getPreviousSibling();return sib.select(),WebFXtimer&&clearTimeout(WebFXtimer),WebFXtimer=window.setTimeout(sib.action.bind(sib),1e3),!1}return!0},WebFXTreeItem.prototype.toString=function(nItem,nItemCount){var foo=this.parentNode,indent="";nItem+1==nItemCount&&(this.parentNode._last=!0);for(var i=0;foo.parentNode;)foo=foo.parentNode,indent='<img id="'+this.id+"-indent-"+i+'" src="'+(foo._last?webFXTreeConfig.blankIcon:webFXTreeConfig.iIcon)+'" width="19" height="25">'+indent,i++;this._level=i,this.childNodes.length?this.folder=1:this.open=!1,this.folder||"classic"!=webFXTreeHandler.behavior?(this.icon||(this.icon=webFXTreeConfig.folderIcon),this.openIcon||(this.openIcon=webFXTreeConfig.openFolderIcon)):this.icon||(this.icon=webFXTreeConfig.fileIcon);var bgOverlayImage="",bgOverlayPosition="4px 1px",d="";if(this.overlayClasses)d='<div class="overlay_icon_div">',this.overlayClasses.each(function(c){d+='<span class="overlay-class-span '+c+'"></span>'}),d+="</div>";else if(this.overlayIcon)switch(this.overlayIcon.length){case 1:bgOverlayPosition="14px 11px, 4px 1px",bgOverlayImage="url('"+this.overlayIcon[0]+"'), ";break;case 2:bgOverlayPosition="2px 11px, 14px 11px, 4px 1px",bgOverlayImage="url('"+this.overlayIcon[0]+"'), url('"+this.overlayIcon[1]+"'), ";break;case 3:bgOverlayPosition="14px 2px, 2px 11px, 14px 11px, 4px 1px",bgOverlayImage="url('"+this.overlayIcon[0]+"'), url('"+this.overlayIcon[1]+"'), url('"+this.overlayIcon[2]+"'), ";break;case 4:default:bgOverlayPosition="2px 2px, 14px 2px, 2px 11px, 14px 11px, 4px 1px",bgOverlayImage="url('"+this.overlayIcon[0]+"'), url('"+this.overlayIcon[1]+"'), url('"+this.overlayIcon[2]+"'), url('"+this.overlayIcon[3]+"'), "}for(var label=this.text.replace(/</g,"&lt;").replace(/>/g,"&gt;")+d,str='<div id="'+this.id+'" class="webfx-tree-item" onkeydown="return webFXTreeHandler.keydown(this, event)" data-node-icon="'+getBaseName(this.open?this.openIcon:this.icon)+'">'+indent+'<img  width="19" height="25" id="'+this.id+'-plus" src="'+(this.folder?this.open?this.parentNode._last?webFXTreeConfig.lMinusIcon:webFXTreeConfig.tMinusIcon:this.parentNode._last?webFXTreeConfig.lPlusIcon:webFXTreeConfig.tPlusIcon:this.parentNode._last?webFXTreeConfig.lIcon:webFXTreeConfig.tIcon)+'"><a href="'+this.url+'" id="'+this.id+'-anchor" onkeydown="return webFXTreeHandler.linkKeyPress(this, event);" onfocus="webFXTreeHandler.focus(this);" onblur="webFXTreeHandler.blur(this);"'+(this.target?' target="'+this.target+'"':"")+'><span id="'+this.id+'-label" style="background-position:'+bgOverlayPosition+";background-image:"+bgOverlayImage+"url('"+("classic"==webFXTreeHandler.behavior&&this.open?this.openIcon:this.icon)+"');\">"+label+'</span></a></div><div id="'+this.id+'-cont" class="webfx-tree-container" style="display: '+(this.open?"block":"none")+';">',sb=[],i=0;i<this.childNodes.length;i++)sb[i]=this.childNodes[i].toString(i,this.childNodes.length);return this.zeroIcon=this.parentNode._last?webFXTreeConfig.lIcon:webFXTreeConfig.tIcon,this.plusIcon=this.parentNode._last?webFXTreeConfig.lPlusIcon:webFXTreeConfig.tPlusIcon,this.minusIcon=this.parentNode._last?webFXTreeConfig.lMinusIcon:webFXTreeConfig.tMinusIcon,str+sb.join("")+"</div>"},webFXTreeConfig.loadingText="Loading...",AJXPTree.prototype=new WebFXTree,AJXPTree.prototype._webfxtree_expand=WebFXTree.prototype.expand,AJXPTree.prototype.expand=function(){this.ajxpNode.fake||this.ajxpNode.load(),this._webfxtree_expand()},AJXPTree.prototype.destroy=function(){this.ajxpNode&&this.ajxpNode.stopObserving()},AJXPTree.prototype.setAjxpRootNode=function(rootNode){if(this.ajxpNode)var oldNode=this.ajxpNode;this.ajxpNode=rootNode;var clear=function(){for(this.open=!1;this.childNodes.length>0;)this.childNodes[this.childNodes.length-1].remove();this.loaded=!1};this.ajxpNode.observe("force_clear",clear.bind(this)),this.ajxpNode.observe("node_replaced",clear.bind(this)),this.attachListeners(this,rootNode),oldNode&&oldNode.notify("node_replaced")},AJXPTree.prototype.attachListeners=function(jsNode,ajxpNode){ajxpNode.observe("child_added",function(childPath){if(ajxpNode.getMetadata().get("paginationData")){var pData=ajxpNode.getMetadata().get("paginationData");if(!this.paginated&&(this.paginated=!0,"0"!=pData.get("dirsCount"))){var message=pData.get("overflowMessage");MessageHash[message]&&(message=MessageHash[message]),this.updateLabel(this.text+" ("+message+")")}}else this.paginated&&(this.paginated=!1,this.updateLabel(this.text));var child=ajxpNode.findChildByPath(childPath);if(child){var jsChild=_ajxpNodeToTree(child,this);jsChild&&this.attachListeners(jsChild,child)}}.bind(jsNode)),ajxpNode.observe("node_replaced",function(newNode){if(jsNode.updateIcon){var ic=resolveImageSource(ajxpNode.getIcon(),"/images/mimes/ICON_SIZE",16),oic=ic;ajxpNode.getMetadata().get("openicon")&&(oic=resolveImageSource(ajxpNode.getMetadata().get("openicon"),"/images/mimes/ICON_SIZE",16)),(jsNode.icon!=ic||jsNode.openIcon!=oic)&&jsNode.updateIcon(ic,oic),jsNode.overlayIcon=splitOverlayIcons(ajxpNode),jsNode.overlayClasses=splitOverlayClasses(ajxpNode)}jsNode.updateLabel&&jsNode.text!=ajxpNode.getLabel()&&jsNode.updateLabel(ajxpNode.getLabel())}.bind(jsNode));var remover=function(e){jsNode.remove(),window.setTimeout(function(){ajxpNode.stopObserving("node_removed",remover)},200)};ajxpNode.observe("node_removed",remover),ajxpNode.observe("loading",function(){}.bind(jsNode)),ajxpNode.observe("loaded",function(){this._loadingItem.remove(),this.childNodes.length&&this._webfxtree_expand()}.bind(jsNode))},AJXPTreeItem.prototype=new WebFXTreeItem,AJXPTreeItem.prototype._webfxtree_expand=WebFXTreeItem.prototype.expand,AJXPTreeItem.prototype.expand=function(){this.ajxpNode.load(),this._webfxtree_expand()},AJXPTreeItem.prototype.attachListeners=AJXPTree.prototype.attachListeners,function(){var eventMatchers={HTMLEvents:/^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,MouseEvents:/^(?:click|mouse(?:down|up|over|move|out))$/},defaultOptions={pointerX:0,pointerY:0,button:0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,bubbles:!0,cancelable:!0};Event.simulate=function(element,eventName){var oEvent,options=Object.extend(defaultOptions,arguments[2]||{}),eventType=null;element=$(element);for(var name in eventMatchers)if(eventMatchers[name].test(eventName)){eventType=name;break}if(!eventType)throw new SyntaxError("Only HTMLEvents and MouseEvents interfaces are supported");return document.createEvent?(oEvent=document.createEvent(eventType),"HTMLEvents"==eventType?oEvent.initEvent(eventName,options.bubbles,options.cancelable):oEvent.initMouseEvent(eventName,options.bubbles,options.cancelable,document.defaultView,options.button,options.pointerX,options.pointerY,options.pointerX,options.pointerY,options.ctrlKey,options.altKey,options.shiftKey,options.metaKey,options.button,element),element.dispatchEvent(oEvent)):(options.clientX=options.pointerX,options.clientY=options.pointerY,oEvent=Object.extend(document.createEventObject(),options),element.fireEvent("on"+eventName,oEvent)),element},Element.addMethods({simulate:Event.simulate})}(),function(){var AbstractChosen,SelectParser,_ref,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};SelectParser=function(){function SelectParser(){this.options_index=0,this.parsed=[]}return SelectParser.prototype.add_node=function(child){return"OPTGROUP"===child.nodeName.toUpperCase()?this.add_group(child):this.add_option(child)},SelectParser.prototype.add_group=function(group){var group_position,option,_i,_len,_ref,_results;for(group_position=this.parsed.length,this.parsed.push({array_index:group_position,group:!0,label:this.escapeExpression(group.label),children:0,disabled:group.disabled}),_ref=group.childNodes,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)option=_ref[_i],_results.push(this.add_option(option,group_position,group.disabled));return _results},SelectParser.prototype.add_option=function(option,group_position,group_disabled){return"OPTION"===option.nodeName.toUpperCase()?(""!==option.text?(null!=group_position&&(this.parsed[group_position].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:option.value,text:option.text,html:option.innerHTML,selected:option.selected,disabled:group_disabled===!0?group_disabled:option.disabled,group_array_index:group_position,classes:option.className,style:option.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1):void 0},SelectParser.prototype.escapeExpression=function(text){var map,unsafe_chars;return null==text||text===!1?"":/[\&\<\>\"\'\`]/.test(text)?(map={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},unsafe_chars=/&(?!\w+;)|[\<\>\"\'\`]/g,text.replace(unsafe_chars,function(chr){return map[chr]||"&amp;"})):text},SelectParser}(),SelectParser.select_to_array=function(select){var child,parser,_i,_len,_ref;for(parser=new SelectParser,_ref=select.childNodes,_i=0,_len=_ref.length;_len>_i;_i++)child=_ref[_i],parser.add_node(child);return parser.parsed},AbstractChosen=function(){function AbstractChosen(form_field,options){this.form_field=form_field,this.options=null!=options?options:{},AbstractChosen.browser_is_supported()&&(this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers())}return AbstractChosen.prototype.set_default_values=function(){var _this=this;return this.click_test_action=function(evt){return _this.test_active_click(evt)},this.activate_action=function(evt){return _this.activate_field(evt)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.allow_single_deselect=null!=this.options.allow_single_deselect&&null!=this.form_field.options[0]&&""===this.form_field.options[0].text?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=null!=this.options.enable_split_word_search?this.options.enable_split_word_search:!0,this.group_search=null!=this.options.group_search?this.options.group_search:!0,this.search_contains=this.options.search_contains||!1,this.single_backstroke_delete=null!=this.options.single_backstroke_delete?this.options.single_backstroke_delete:!0,this.max_selected_options=this.options.max_selected_options||1/0,this.inherit_select_classes=this.options.inherit_select_classes||!1,this.display_selected_options=null!=this.options.display_selected_options?this.options.display_selected_options:!0,this.display_disabled_options=null!=this.options.display_disabled_options?this.options.display_disabled_options:!0},AbstractChosen.prototype.set_default_text=function(){return this.form_field.getAttribute("data-placeholder")?this.default_text=this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.default_text=this.options.placeholder_text_multiple||this.options.placeholder_text||AbstractChosen.default_multiple_text:this.default_text=this.options.placeholder_text_single||this.options.placeholder_text||AbstractChosen.default_single_text,this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||AbstractChosen.default_no_result_text},AbstractChosen.prototype.mouse_enter=function(){return this.mouse_on_container=!0},AbstractChosen.prototype.mouse_leave=function(){return this.mouse_on_container=!1},AbstractChosen.prototype.input_focus=function(evt){var _this=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return _this.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},AbstractChosen.prototype.input_blur=function(evt){var _this=this;return this.mouse_on_container?void 0:(this.active_field=!1,setTimeout(function(){return _this.blur_test()},100))},AbstractChosen.prototype.results_option_build=function(options){var content,data,_i,_len,_ref;for(content="",_ref=this.results_data,_i=0,_len=_ref.length;_len>_i;_i++)data=_ref[_i],content+=data.group?this.result_add_group(data):this.result_add_option(data),(null!=options?options.first:void 0)&&(data.selected&&this.is_multiple?this.choice_build(data):data.selected&&!this.is_multiple&&this.single_set_selected_text(data.text));return content},AbstractChosen.prototype.result_add_option=function(option){var classes,option_el;return option.search_match&&this.include_option_in_results(option)?(classes=[],option.disabled||option.selected&&this.is_multiple||classes.push("active-result"),!option.disabled||option.selected&&this.is_multiple||classes.push("disabled-result"),option.selected&&classes.push("result-selected"),null!=option.group_array_index&&classes.push("group-option"),""!==option.classes&&classes.push(option.classes),option_el=document.createElement("li"),option_el.className=classes.join(" "),option_el.style.cssText=option.style,option_el.setAttribute("data-option-array-index",option.array_index),option_el.innerHTML=option.search_text,this.outerHTML(option_el)):""},AbstractChosen.prototype.result_add_group=function(group){var group_el;return(group.search_match||group.group_match)&&group.active_options>0?(group_el=document.createElement("li"),group_el.className="group-result",group_el.innerHTML=group.search_text,this.outerHTML(group_el)):""},AbstractChosen.prototype.results_update_field=function(){return this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.results_build(),this.results_showing?this.winnow_results():void 0},AbstractChosen.prototype.reset_single_select_options=function(){var result,_i,_len,_ref,_results;for(_ref=this.results_data,_results=[],_i=0,_len=_ref.length;_len>_i;_i++)result=_ref[_i],_results.push(result.selected?result.selected=!1:void 0);return _results},AbstractChosen.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},AbstractChosen.prototype.results_search=function(evt){return this.results_showing?this.winnow_results():this.results_show()},AbstractChosen.prototype.winnow_results=function(){var escapedSearchText,option,regex,results,results_group,searchText,startpos,text,zregex,_i,_len,_ref;for(this.no_results_clear(),results=0,searchText=this.get_search_text(),escapedSearchText=searchText.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),zregex=new RegExp(escapedSearchText,"i"),regex=this.get_search_regex(escapedSearchText),_ref=this.results_data,_i=0,_len=_ref.length;_len>_i;_i++)option=_ref[_i],option.search_match=!1,results_group=null,this.include_option_in_results(option)&&(option.group&&(option.group_match=!1,option.active_options=0),null!=option.group_array_index&&this.results_data[option.group_array_index]&&(results_group=this.results_data[option.group_array_index],0===results_group.active_options&&results_group.search_match&&(results+=1),results_group.active_options+=1),(!option.group||this.group_search)&&(option.search_text=option.group?option.label:option.text,option.search_match=this.search_string_match(option.search_text,regex),option.search_match&&!option.group&&(results+=1),option.search_match?(searchText.length&&(startpos=option.search_text.search(zregex),text=option.search_text.substr(0,startpos+searchText.length)+"</em>"+option.search_text.substr(startpos+searchText.length),option.search_text=text.substr(0,startpos)+"<em>"+text.substr(startpos)),null!=results_group&&(results_group.group_match=!0)):null!=option.group_array_index&&this.results_data[option.group_array_index].search_match&&(option.search_match=!0)));return this.result_clear_highlight(),1>results&&searchText.length?(this.update_results_content(""),this.no_results(searchText)):(this.update_results_content(this.results_option_build()),this.winnow_results_set_highlight())},AbstractChosen.prototype.get_search_regex=function(escaped_search_string){var regex_anchor;return regex_anchor=this.search_contains?"":"^",new RegExp(regex_anchor+escaped_search_string,"i")},AbstractChosen.prototype.search_string_match=function(search_string,regex){var part,parts,_i,_len;if(regex.test(search_string))return!0;if(this.enable_split_word_search&&(search_string.indexOf(" ")>=0||0===search_string.indexOf("["))&&(parts=search_string.replace(/\[|\]/g,"").split(" "),parts.length))for(_i=0,_len=parts.length;_len>_i;_i++)if(part=parts[_i],regex.test(part))return!0},AbstractChosen.prototype.choices_count=function(){var option,_i,_len,_ref;if(null!=this.selected_option_count)return this.selected_option_count;for(this.selected_option_count=0,_ref=this.form_field.options,_i=0,_len=_ref.length;_len>_i;_i++)option=_ref[_i],option.selected&&(this.selected_option_count+=1);return this.selected_option_count},AbstractChosen.prototype.choices_click=function(evt){return evt.preventDefault(),this.results_showing||this.is_disabled?void 0:this.results_show()},AbstractChosen.prototype.keyup_checker=function(evt){var stroke,_ref;switch(stroke=null!=(_ref=evt.which)?_ref:evt.keyCode,this.search_field_scale(),stroke){case 8:if(this.is_multiple&&this.backstroke_length<1&&this.choices_count()>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:if(evt.preventDefault(),this.results_showing)return this.result_select(evt);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},AbstractChosen.prototype.clipboard_event_checker=function(evt){var _this=this;return setTimeout(function(){return _this.results_search()},50)},AbstractChosen.prototype.container_width=function(){return null!=this.options.width?this.options.width:""+this.form_field.offsetWidth+"px"},AbstractChosen.prototype.include_option_in_results=function(option){return this.is_multiple&&!this.display_selected_options&&option.selected?!1:!this.display_disabled_options&&option.disabled?!1:option.empty?!1:!0},AbstractChosen.prototype.search_results_touchstart=function(evt){return this.touch_started=!0,this.search_results_mouseover(evt)},AbstractChosen.prototype.search_results_touchmove=function(evt){return this.touch_started=!1,this.search_results_mouseout(evt)},AbstractChosen.prototype.search_results_touchend=function(evt){return this.touch_started?this.search_results_mouseup(evt):void 0},AbstractChosen.prototype.outerHTML=function(element){var tmp;return element.outerHTML?element.outerHTML:(tmp=document.createElement("div"),tmp.appendChild(element),tmp.innerHTML)},AbstractChosen.browser_is_supported=function(){return"Microsoft Internet Explorer"===window.navigator.appName?document.documentMode>=8:/iP(od|hone)/i.test(window.navigator.userAgent)?!1:/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)?!1:!0},AbstractChosen.default_multiple_text="Select Some Options",AbstractChosen.default_single_text="Select an Option",AbstractChosen.default_no_result_text="No results match",AbstractChosen}(),this.Chosen=function(_super){function Chosen(){return _ref=Chosen.__super__.constructor.apply(this,arguments)}return __extends(Chosen,_super),Chosen.prototype.setup=function(){return this.current_selectedIndex=this.form_field.selectedIndex,this.is_rtl=this.form_field.hasClassName("chosen-rtl")},Chosen.prototype.set_default_values=function(){return Chosen.__super__.set_default_values.call(this),this.single_temp=new Template('<a class="chosen-single chosen-default" tabindex="-1"><span>#{default}</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /></div><ul class="chosen-results"></ul></div>'),this.multi_temp=new Template('<ul class="chosen-choices"><li class="search-field"><input type="text" value="#{default}" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chosen-drop"><ul class="chosen-results"></ul></div>'),this.no_results_temp=new Template('<li class="no-results">'+this.results_none_found+' "<span>#{terms}</span>"</li>')},Chosen.prototype.set_up_html=function(){var container_classes,container_props;return container_classes=["chosen-container"],container_classes.push("chosen-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&container_classes.push(this.form_field.className),
this.is_rtl&&container_classes.push("chosen-rtl"),container_props={"class":container_classes.join(" "),style:"width: "+this.container_width()+";",title:this.form_field.title},this.form_field.id.length&&(container_props.id=this.form_field.id.replace(/[^\w]/g,"_")+"_chosen"),this.container=new Element("div",container_props).update(this.is_multiple?this.multi_temp.evaluate({"default":this.default_text}):this.single_temp.evaluate({"default":this.default_text})),this.form_field.hide().insert({after:this.container}),this.dropdown=this.container.down("div.chosen-drop"),this.search_field=this.container.down("input"),this.search_results=this.container.down("ul.chosen-results"),this.search_field_scale(),this.search_no_results=this.container.down("li.no-results"),this.is_multiple?(this.search_choices=this.container.down("ul.chosen-choices"),this.search_container=this.container.down("li.search-field")):(this.search_container=this.container.down("div.chosen-search"),this.selected_item=this.container.down(".chosen-single")),this.results_build(),this.set_tab_index(),this.set_label_behavior(),this.form_field.fire("chosen:ready",{chosen:this})},Chosen.prototype.register_observers=function(){var _this=this;return this.container.observe("touchstart",function(evt){return _this.container_mousedown(evt)}),this.container.observe("touchend",function(evt){return _this.container_mouseup(evt)}),this.container.observe("mousedown",function(evt){return _this.container_mousedown(evt)}),this.container.observe("mouseup",function(evt){return _this.container_mouseup(evt)}),this.container.observe("mouseenter",function(evt){return _this.mouse_enter(evt)}),this.container.observe("mouseleave",function(evt){return _this.mouse_leave(evt)}),this.search_results.observe("mouseup",function(evt){return _this.search_results_mouseup(evt)}),this.search_results.observe("mouseover",function(evt){return _this.search_results_mouseover(evt)}),this.search_results.observe("mouseout",function(evt){return _this.search_results_mouseout(evt)}),this.search_results.observe("mousewheel",function(evt){return _this.search_results_mousewheel(evt)}),this.search_results.observe("DOMMouseScroll",function(evt){return _this.search_results_mousewheel(evt)}),this.search_results.observe("touchstart",function(evt){return _this.search_results_touchstart(evt)}),this.search_results.observe("touchmove",function(evt){return _this.search_results_touchmove(evt)}),this.search_results.observe("touchend",function(evt){return _this.search_results_touchend(evt)}),this.form_field.observe("chosen:updated",function(evt){return _this.results_update_field(evt)}),this.form_field.observe("chosen:activate",function(evt){return _this.activate_field(evt)}),this.form_field.observe("chosen:open",function(evt){return _this.container_mousedown(evt)}),this.form_field.observe("chosen:close",function(evt){return _this.input_blur(evt)}),this.search_field.observe("blur",function(evt){return _this.input_blur(evt)}),this.search_field.observe("keyup",function(evt){return _this.keyup_checker(evt)}),this.search_field.observe("keydown",function(evt){return _this.keydown_checker(evt)}),this.search_field.observe("focus",function(evt){return _this.input_focus(evt)}),this.search_field.observe("cut",function(evt){return _this.clipboard_event_checker(evt)}),this.search_field.observe("paste",function(evt){return _this.clipboard_event_checker(evt)}),this.is_multiple?this.search_choices.observe("click",function(evt){return _this.choices_click(evt)}):this.container.observe("click",function(evt){return evt.preventDefault()})},Chosen.prototype.destroy=function(){return this.container.ownerDocument.stopObserving("click",this.click_test_action),this.form_field.stopObserving(),this.container.stopObserving(),this.search_results.stopObserving(),this.search_field.stopObserving(),null!=this.form_field_label&&this.form_field_label.stopObserving(),this.is_multiple?(this.search_choices.stopObserving(),this.container.select(".search-choice-close").each(function(choice){return choice.stopObserving()})):this.selected_item.stopObserving(),this.search_field.tabIndex&&(this.form_field.tabIndex=this.search_field.tabIndex),this.container.remove(),this.form_field.show()},Chosen.prototype.search_field_disabled=function(){return this.is_disabled=this.form_field.disabled,this.is_disabled?(this.container.addClassName("chosen-disabled"),this.search_field.disabled=!0,this.is_multiple||this.selected_item.stopObserving("focus",this.activate_action),this.close_field()):(this.container.removeClassName("chosen-disabled"),this.search_field.disabled=!1,this.is_multiple?void 0:this.selected_item.observe("focus",this.activate_action))},Chosen.prototype.container_mousedown=function(evt){return this.is_disabled||(evt&&"mousedown"===evt.type&&!this.results_showing&&evt.stop(),null!=evt&&evt.target.hasClassName("search-choice-close"))?void 0:(this.active_field?this.is_multiple||!evt||evt.target!==this.selected_item&&!evt.target.up("a.chosen-single")||this.results_toggle():(this.is_multiple&&this.search_field.clear(),this.container.ownerDocument.observe("click",this.click_test_action),this.results_show()),this.activate_field())},Chosen.prototype.container_mouseup=function(evt){return"ABBR"!==evt.target.nodeName||this.is_disabled?void 0:this.results_reset(evt)},Chosen.prototype.search_results_mousewheel=function(evt){var delta;return delta=evt.deltaY||-evt.wheelDelta||evt.detail,null!=delta?(evt.preventDefault(),"DOMMouseScroll"===evt.type&&(delta=40*delta),this.search_results.scrollTop=delta+this.search_results.scrollTop):void 0},Chosen.prototype.blur_test=function(evt){return!this.active_field&&this.container.hasClassName("chosen-container-active")?this.close_field():void 0},Chosen.prototype.close_field=function(){return this.container.ownerDocument.stopObserving("click",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClassName("chosen-container-active"),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},Chosen.prototype.activate_field=function(){return this.container.addClassName("chosen-container-active"),this.active_field=!0,this.search_field.value=this.search_field.value,this.search_field.focus()},Chosen.prototype.test_active_click=function(evt){return evt.target.up(".chosen-container")===this.container?this.active_field=!0:this.close_field()},Chosen.prototype.results_build=function(){return this.parsing=!0,this.selected_option_count=null,this.results_data=SelectParser.select_to_array(this.form_field),this.is_multiple?this.search_choices.select("li.search-choice").invoke("remove"):this.is_multiple||(this.single_set_selected_text(),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?(this.search_field.readOnly=!0,this.container.addClassName("chosen-container-single-nosearch")):(this.search_field.readOnly=!1,this.container.removeClassName("chosen-container-single-nosearch"))),this.update_results_content(this.results_option_build({first:!0})),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.parsing=!1},Chosen.prototype.result_do_highlight=function(el){var high_bottom,high_top,maxHeight,visible_bottom,visible_top;return this.result_clear_highlight(),this.result_highlight=el,this.result_highlight.addClassName("highlighted"),maxHeight=parseInt(this.search_results.getStyle("maxHeight"),10),visible_top=this.search_results.scrollTop,visible_bottom=maxHeight+visible_top,high_top=this.result_highlight.positionedOffset().top,high_bottom=high_top+this.result_highlight.getHeight(),high_bottom>=visible_bottom?this.search_results.scrollTop=high_bottom-maxHeight>0?high_bottom-maxHeight:0:visible_top>high_top?this.search_results.scrollTop=high_top:void 0},Chosen.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClassName("highlighted"),this.result_highlight=null},Chosen.prototype.results_show=function(){return this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field.fire("chosen:maxselected",{chosen:this}),!1):(this.container.addClassName("chosen-with-drop"),this.results_showing=!0,this.search_field.focus(),this.search_field.value=this.search_field.value,this.winnow_results(),this.form_field.fire("chosen:showing_dropdown",{chosen:this}))},Chosen.prototype.update_results_content=function(content){return this.search_results.update(content)},Chosen.prototype.results_hide=function(){return this.results_showing&&(this.result_clear_highlight(),this.container.removeClassName("chosen-with-drop"),this.form_field.fire("chosen:hiding_dropdown",{chosen:this})),this.results_showing=!1},Chosen.prototype.set_tab_index=function(el){var ti;return this.form_field.tabIndex?(ti=this.form_field.tabIndex,this.form_field.tabIndex=-1,this.search_field.tabIndex=ti):void 0},Chosen.prototype.set_label_behavior=function(){var _this=this;return this.form_field_label=this.form_field.up("label"),null==this.form_field_label&&(this.form_field_label=$$("label[for='"+this.form_field.id+"']").first()),null!=this.form_field_label?this.form_field_label.observe("click",function(evt){return _this.is_multiple?_this.container_mousedown(evt):_this.activate_field()}):void 0},Chosen.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices_count()<1&&!this.active_field?(this.search_field.value=this.default_text,this.search_field.addClassName("default")):(this.search_field.value="",this.search_field.removeClassName("default"))},Chosen.prototype.search_results_mouseup=function(evt){var target;return target=evt.target.hasClassName("active-result")?evt.target:evt.target.up(".active-result"),target?(this.result_highlight=target,this.result_select(evt),this.search_field.focus()):void 0},Chosen.prototype.search_results_mouseover=function(evt){var target;return target=evt.target.hasClassName("active-result")?evt.target:evt.target.up(".active-result"),target?this.result_do_highlight(target):void 0},Chosen.prototype.search_results_mouseout=function(evt){return evt.target.hasClassName("active-result")||evt.target.up(".active-result")?this.result_clear_highlight():void 0},Chosen.prototype.choice_build=function(item){var choice,close_link,_this=this;return choice=new Element("li",{"class":"search-choice"}).update("<span>"+item.html+"</span>"),item.disabled?choice.addClassName("search-choice-disabled"):(close_link=new Element("a",{href:"#","class":"search-choice-close",rel:item.array_index}),close_link.observe("click",function(evt){return _this.choice_destroy_link_click(evt)}),choice.insert(close_link)),this.search_container.insert({before:choice})},Chosen.prototype.choice_destroy_link_click=function(evt){return evt.preventDefault(),evt.stopPropagation(),this.is_disabled?void 0:this.choice_destroy(evt.target)},Chosen.prototype.choice_destroy=function(link){return this.result_deselect(link.readAttribute("rel"))?(this.show_search_field_default(),this.is_multiple&&this.choices_count()>0&&this.search_field.value.length<1&&this.results_hide(),link.up("li").remove(),this.search_field_scale()):void 0},Chosen.prototype.results_reset=function(){return this.reset_single_select_options(),this.form_field.options[0].selected=!0,this.single_set_selected_text(),this.show_search_field_default(),this.results_reset_cleanup(),"function"==typeof Event.simulate&&this.form_field.simulate("change"),this.active_field?this.results_hide():void 0},Chosen.prototype.results_reset_cleanup=function(){var deselect_trigger;return this.current_selectedIndex=this.form_field.selectedIndex,deselect_trigger=this.selected_item.down("abbr"),deselect_trigger?deselect_trigger.remove():void 0},Chosen.prototype.result_select=function(evt){var high,item;return this.result_highlight?(high=this.result_highlight,this.result_clear_highlight(),this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field.fire("chosen:maxselected",{chosen:this}),!1):(this.is_multiple?high.removeClassName("active-result"):this.reset_single_select_options(),high.addClassName("result-selected"),item=this.results_data[high.getAttribute("data-option-array-index")],item.selected=!0,this.form_field.options[item.options_index].selected=!0,this.selected_option_count=null,this.is_multiple?this.choice_build(item):this.single_set_selected_text(item.text),(evt.metaKey||evt.ctrlKey)&&this.is_multiple||this.results_hide(),this.search_field.value="","function"!=typeof Event.simulate||!this.is_multiple&&this.form_field.selectedIndex===this.current_selectedIndex||this.form_field.simulate("change"),this.current_selectedIndex=this.form_field.selectedIndex,this.search_field_scale())):void 0},Chosen.prototype.single_set_selected_text=function(text){return null==text&&(text=this.default_text),text===this.default_text?this.selected_item.addClassName("chosen-default"):(this.single_deselect_control_build(),this.selected_item.removeClassName("chosen-default")),this.selected_item.down("span").update(text)},Chosen.prototype.result_deselect=function(pos){var result_data;return result_data=this.results_data[pos],this.form_field.options[result_data.options_index].disabled?!1:(result_data.selected=!1,this.form_field.options[result_data.options_index].selected=!1,this.selected_option_count=null,this.result_clear_highlight(),this.results_showing&&this.winnow_results(),"function"==typeof Event.simulate&&this.form_field.simulate("change"),this.search_field_scale(),!0)},Chosen.prototype.single_deselect_control_build=function(){return this.allow_single_deselect?(this.selected_item.down("abbr")||this.selected_item.down("span").insert({after:'<abbr class="search-choice-close"></abbr>'}),this.selected_item.addClassName("chosen-single-with-deselect")):void 0},Chosen.prototype.get_search_text=function(){return this.search_field.value===this.default_text?"":this.search_field.value.strip().escapeHTML()},Chosen.prototype.winnow_results_set_highlight=function(){var do_high;return this.is_multiple||(do_high=this.search_results.down(".result-selected.active-result")),null==do_high&&(do_high=this.search_results.down(".active-result")),null!=do_high?this.result_do_highlight(do_high):void 0},Chosen.prototype.no_results=function(terms){return this.search_results.insert(this.no_results_temp.evaluate({terms:terms})),this.form_field.fire("chosen:no_results",{chosen:this})},Chosen.prototype.no_results_clear=function(){var nr,_results;for(nr=null,_results=[];nr=this.search_results.down(".no-results");)_results.push(nr.remove());return _results},Chosen.prototype.keydown_arrow=function(){var next_sib;return this.results_showing&&this.result_highlight?(next_sib=this.result_highlight.next(".active-result"))?this.result_do_highlight(next_sib):void 0:this.results_show()},Chosen.prototype.keyup_arrow=function(){var actives,prevs,sibs;return this.results_showing||this.is_multiple?this.result_highlight?(sibs=this.result_highlight.previousSiblings(),actives=this.search_results.select("li.active-result"),prevs=sibs.intersect(actives),prevs.length?this.result_do_highlight(prevs.first()):(this.choices_count()>0&&this.results_hide(),this.result_clear_highlight())):void 0:this.results_show()},Chosen.prototype.keydown_backstroke=function(){var next_available_destroy;return this.pending_backstroke?(this.choice_destroy(this.pending_backstroke.down("a")),this.clear_backstroke()):(next_available_destroy=this.search_container.siblings().last(),next_available_destroy&&next_available_destroy.hasClassName("search-choice")&&!next_available_destroy.hasClassName("search-choice-disabled")?(this.pending_backstroke=next_available_destroy,this.pending_backstroke&&this.pending_backstroke.addClassName("search-choice-focus"),this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClassName("search-choice-focus")):void 0)},Chosen.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClassName("search-choice-focus"),this.pending_backstroke=null},Chosen.prototype.keydown_checker=function(evt){var stroke,_ref1;switch(stroke=null!=(_ref1=evt.which)?_ref1:evt.keyCode,this.search_field_scale(),8!==stroke&&this.pending_backstroke&&this.clear_backstroke(),stroke){case 8:this.backstroke_length=this.search_field.value.length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(evt),this.mouse_on_container=!1;break;case 13:this.results_showing&&evt.preventDefault();break;case 32:this.disable_search&&evt.preventDefault();break;case 38:evt.preventDefault(),this.keyup_arrow();break;case 40:evt.preventDefault(),this.keydown_arrow()}},Chosen.prototype.search_field_scale=function(){var div,f_width,h,style,style_block,styles,w,_i,_len;if(this.is_multiple){for(h=0,w=0,style_block="position:absolute; left: -1000px; top: -1000px; display:none;",styles=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"],_i=0,_len=styles.length;_len>_i;_i++)style=styles[_i],style_block+=style+":"+this.search_field.getStyle(style)+";";return div=new Element("div",{style:style_block}).update(this.search_field.value.escapeHTML()),document.body.appendChild(div),w=Element.measure(div,"width")+25,div.remove(),f_width=this.container.getWidth(),w>f_width-10&&(w=f_width-10),this.search_field.setStyle({width:w+"px"})}},Chosen}(AbstractChosen)}.call(this);var timerClearObserver={onEnd:function(){window.WebFXtimer&&clearTimeout(window.WebFXtimer)}};document.observe("ajaxplorer:loaded",function(){Draggables.addObserver(timerClearObserver),Draggables.addObserver({onDrag:function(eventName,element,event){element.updateCtrlKey&&element.updateCtrlKey(event)}})}),window.AllAjxpDraggables=$A([]),window.AllAjxpDroppables=$A([]),Event.observe(window,"unload",function(){Draggables.removeObserver(timerClearObserver),window.AllAjxpDraggables.each(function(el){try{el.destroy()}catch(z){}}),window.AllAjxpDroppables.each(function(el){try{Droppables.remove(el)}catch(z){}})}),Class.create("AjxpDraggable",Draggable,{initialize:function($super,element,options,component,componentType){element=$(element),element.addClassName("ajxp_draggable"),options.zindex||(options.zindex=900),$super(element,options),this.options.reverteffect=function(element,top_offset,left_offset){new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:0,queue:{scope:"_draggable",position:"end"}})},this.options.delay=Prototype.Browser.IE?350:200,this.component=component,window.AllAjxpDraggables.push(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown),this.element.removeClassName("ajxp_draggable"),this.element=null,Draggables.unregister(this)},initDrag:function(event){if((Object.isUndefined(Draggable._dragging[this.element])||!Draggable._dragging[this.element])&&Event.isLeftClick(event)){var tag_name,src=Event.element(event);if((tag_name=src.tagName.toUpperCase())&&("INPUT"==tag_name||"SELECT"==tag_name||"OPTION"==tag_name||"BUTTON"==tag_name||"TEXTAREA"==tag_name))return;var pointer=[Event.pointerX(event),Event.pointerY(event)],pos=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(i){return Math.min(15,pointer[i]-pos[i])}),Draggables.activate(this),Event.stop(event)}},startDrag:function(event){if(this.delta||(this.delta=this.currentDelta()),this.dragging=!0,this._draggingMultiple=!1,this.options.zindex&&(this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0),this.element.setStyle({zIndex:this.options.zindex})),this.options.ghosting){var selection=ajaxplorer.getUserSelection();if(this.component.findSelectableParent)if(selection.isEmpty())this.component.findSelectableParent(this.element,!0);else{var selItems=this.component.getSelectedItems(),item=this.component.findSelectableParent(this.element,!1);$A(selItems).include(item)||(this.component.setSelectedNodes([]),this.component.findSelectableParent(this.element,!0))}var nodes=selection.getSelectedNodes();this._draggingMultiple=!0,this._clone=new Element("div"),$(this._clone).addClassName("ajxp_draggable"),$(this._clone).addClassName("multiple_selection_draggable"),this._clone.setAttribute("user_selection","true"),$(ajxpBootstrap.parameters.get("MAIN_ELEMENT")).insert(this._clone),this.original=this.element,this.element=this._clone;for(var max=Math.min(nodes.length,5),maxWidth=0,i=0;max>i;i++){var text=nodes[i].getLabel()+(max-1>i?",<br>":"");maxWidth=Math.max(maxWidth,testStringWidth(text)),this._clone.insert(text)}max<nodes.length&&this._clone.insert(",<br> "+(nodes.length-max)+" "+MessageHash[334]+"..."),this.element.setStyle({height:"auto",width:maxWidth+"px"}),Position.absolutize(this._clone);var zIndex=1e4;this.element.getStyle("zIndex")&&(zIndex=this.element.getStyle("zIndex")+100),this.element.setStyle({zIndex:zIndex})}if(this.options.scroll)if(this.options.scroll==window){var where=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=where.left,this.originalScrollTop=where.top}else this.originalScrollLeft=this.options.scroll.scrollLeft,this.originalScrollTop=this.options.scroll.scrollTop;Draggables.notify("onStart",this,event),this.options.starteffect&&this.options.starteffect(this.element),this.dndAction=pydio.getController().getDefaultAction("dragndrop"),this.ctrlDndAction=pydio.getController().getDefaultAction("ctrldragndrop")},updateDrag:function(event,pointer){if(this.dragging||this.startDrag(event),this.options.quiet||(Position.prepare(),Position.includeScrollOffsets=!0,Droppables.show(pointer,this.element)),Draggables.notify("onDrag",this,event),this.draw(pointer),this.options.change&&this.options.change(this),this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){var obj=this._getWindowScroll(this.options.scroll);obj&&(p=[obj.left,obj.top,obj.left+obj.width,obj.top+obj.height])}else p=Position.page(this.options.scroll),p[0]+=Position.deltaX,p[1]+=Position.deltaY,p[2]=p[0]+this.options.scroll.offsetWidth,p[3]=p[1]+this.options.scroll.offsetHeight;var speed=[0,0];pointer[0]<p[0]+this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)),pointer[1]<p[1]+this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)),pointer[0]>p[2]-this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)),pointer[1]>p[3]-this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)),this.startScrolling(speed)}Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event)},draw:function(point){var pos=Position.cumulativeOffset(this.element);if(this.options.ghosting){var r=Position.realOffset(this.element);pos[0]+=r[0]-Position.deltaX,pos[1]+=r[1]-Position.deltaY}var d=this.currentDelta();pos[0]-=d[0],pos[1]-=d[1],this.options.scroll&&this.options.scroll!=window&&this._isScrollChild&&(pos[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft,pos[1]-=this.options.scroll.scrollTop-this.originalScrollTop),this.options.containerScroll&&this.options.containerScroll!=window&&(pos[0]+=this.options.containerScroll.scrollLeft,pos[1]+=this.options.containerScroll.scrollTop);var p=[0,1].map(function(i){return point[i]-pos[i]-this.offset[i]}.bind(this));this.options.snap&&(p=Object.isFunction(this.options.snap)?this.options.snap(p[0],p[1],this):p.map(Object.isArray(this.options.snap)?function(v,i){return(v/this.options.snap[i]).round()*this.options.snap[i]}.bind(this):function(v){return(v/this.options.snap).round()*this.options.snap}.bind(this)));var style=this.element.style;this.options.constraint&&"horizontal"!=this.options.constraint||(style.left=p[0]+"px"),this.options.constraint&&"vertical"!=this.options.constraint||(style.top=p[1]+"px"),"hidden"==style.visibility&&(style.visibility="")},finishDrag:function(event,success){if(this.dragging=!1,this.options.quiet){Position.prepare();var pointer=[Event.pointerX(event),Event.pointerY(event)];Droppables.show(pointer,this.element)}var dropped=!1;success&&(dropped=Droppables.fire(event,this.element),dropped||(dropped=!1)),dropped&&this.options.onDropped&&this.options.onDropped(this.element),Draggables.notify("onEnd",this,event);var revert=this.options.revert;revert&&"function"==typeof revert&&(revert=revert(this.element));var d=this.currentDelta();if(revert&&this.options.reverteffect?(0==dropped||"failure"!=revert)&&(this._draggingMultiple||this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0])):this.delta=d,this.options.zindex&&this.element.setStyle({zIndex:this.originalZ}),this.options.endeffect&&this.options.endeffect(this.element),this._draggingMultiple){var selectDiv=this.element;this.element=this.original,Element.remove(selectDiv)}Draggables.deactivate(this),Droppables.reset()},scroll:function(){var current=new Date,delta=current-this.lastScrolled;if(this.lastScrolled=current,this.options.scroll==window){var obj=this._getWindowScroll(this.options.scroll);if(obj&&(this.scrollSpeed[0]||this.scrollSpeed[1])){var d=delta/1e3;this.options.scroll.scrollTo(obj.left+d*this.scrollSpeed[0],obj.top+d*this.scrollSpeed[1])}}else if(this.options.scroll.scrollerInstance){var pos=this.options.scroll.scrollTop+this.scrollSpeed[1]*delta/1e3;this.options.scroll.scrollerInstance.scrollTo(pos)}else this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1e3,this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1e3;Position.prepare(),Position.includeScrollOffsets=!0,Droppables.show(Draggables._lastPointer,this.element),Draggables.notify("onDrag",this),this._isScrollChild&&(Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer),Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1e3,Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1e3,Draggables._lastScrollPointer[0]<0&&(Draggables._lastScrollPointer[0]=0),Draggables._lastScrollPointer[1]<0&&(Draggables._lastScrollPointer[1]=0),this.draw(Draggables._lastScrollPointer)),this.options.change&&this.options.change(this)},updateCtrlKey:function(event){if(event){var ctrl=event.ctrlKey;this.ctrlDndAction&&(ctrl||this.dndAction.deny)?this.addCopyClass():this.removeCopyClass()}},addCopyClass:function(){$(this.element).addClassName("selection_ctrl_key")},removeCopyClass:function(){$(this.element).removeClassName("selection_ctrl_key")}});var AjxpDroppables={options:{hoverclass:"droppableZone",accept:"ajxp_draggable",onDrop:function(draggable,droppable,event){if((draggable.ajxpNode||draggable.getAttribute("user_selection"))&&droppable.ajxpNode){var srcName,targetName=droppable.ajxpNode.getPath();draggable.ajxpNode&&(srcName=draggable.ajxpNode.getPath()),window.WebFXtimer&&clearTimeout(window.WebFXtimer);var nodeId=null;droppable.id&&webFXTreeHandler.all[droppable.id]&&(nodeId=droppable.id);var copy=draggable.hasClassName("selection_ctrl_key");droppable.applyDragMove?(!srcName&&draggable.getAttribute("user_selection")&&(srcName="ajxp-user-selection"),droppable.applyDragMove(srcName,targetName,nodeId,copy)):pydio.getController().applyDragMove(srcName,targetName,nodeId,copy)}},onHover:function(draggable,droppable,event){if(window.WebFXtimer&&clearTimeout(window.WebFXtimer),droppable.id&&webFXTreeHandler.all[droppable.id]){var container=droppable.up("div.show_first_level");container&&(container.removeClassName("show_first_level"),container.addClassName("reset_show_first_level")),window.WebFXtimer=window.setTimeout(function(){var node=webFXTreeHandler.all[droppable.id];node&&node.folder&&!node.open&&node.expand()},500)}},onOut:function(droppable){window.WebFXtimer&&clearTimeout(window.WebFXtimer);var container=droppable.up("div.reset_show_first_level");container&&container.addClassName("show_first_level")}},add:function(element,ajxpNode){ajxpNode&&ajxpNode.hasMetadataInBranch("ajxp_readonly","true")||(Droppables.add(element,this.options),element=$(element),AllAjxpDroppables.push(element),AjxpDroppables.dragOverHook&&element.select("*").each(function(e){e.observe("dragover",AjxpDroppables.dragOverHook),e.observe("drop",AjxpDroppables.dropHook),e.observe("dragenter",AjxpDroppables.dragEnterHook),e.observe("dragleave",AjxpDroppables.dragLeaveHook)}))}};Class.create("AjxpSortable",SortableTable,{initialize:function($super,oTable,oSortTypes,oTHead){$super(oTable,oSortTypes,oTHead),this.addSortType("NumberK",this.replace8a8),this.addSortType("NumberKo",this.replace8oa8),this.addSortType("MyDate",null,!1,this.sortTimes),this.addSortType("CellSorterValue",null,!1,this.cellSorterValue),this.addSortType("StringDirFile",this.toUpperCase,!1,this.splitDirsAndFiles.bind(this),this.splitDirsAndFilesNodes.bind(this))},setPaginationBehaviour:function(loaderFunc,columnsDefs,crtOrderName,crtOrderDir){this.paginationLoaderFunc=loaderFunc,this.columnsDefs=columnsDefs;for(var found=-1,i=0;i<columnsDefs.length;i++)if(columnsDefs[i].attributeName==crtOrderName){found=i;break}this.sortColumn=found,this.descending="desc"==crtOrderDir,this.updateHeaderArrows()},headerOnclick:function(e){var el=Event.findElement(e,"div.header_cell"),cellColumn=el.cellIndex;if(this.paginationLoaderFunc){var params=$H({});this.sortColumn!=cellColumn?this.descending=this.defaultDescending:this.descending=!this.descending;var column=this.columnsDefs[cellColumn];params.set("order_column",column.attributeName||cellColumn),params.set("order_direction",this.descending?"desc":"asc"),this.paginationLoaderFunc(params)}else this.sort(cellColumn)},replace8a8:function(str){str=str.toUpperCase();var num,splitstr="____",ar=str.replace(/(([0-9]*\.)?[0-9]+([eE][-+]?[0-9]+)?)(.*)/,"$1"+splitstr+"$4").split(splitstr);if(num=Number(ar[0]).valueOf(),ar[1]){var ml=ar[1].replace(/\s*([KMGB])\s*/,"$1");"K"==ml?num*=1024:"M"==ml?num*=1048576:"G"==ml?num*=1073741824:"T"==ml&&(num*=1099511627776)}return num},replace8oa8:function(str){if(str=str.toUpperCase(),"-"==str)return 0;var splitstr="____",ar=str.replace(/(([0-9]*\.)?[0-9]+([eE][-+]?[0-9]+)?)(.*)/,"$1"+splitstr+"$4").split(splitstr),num=Number(ar[0]).valueOf();if(ar[1]){var ml=ar[1].replace(/\s*(KO|MO|GO|T|KB|MB|GB)\s*/,"$1");"KO"==ml||"KB"==ml?num*=1024:"MO"==ml||"MB"==ml?num*=1048576:"GO"==ml||"GB"==ml?num*=1073741824:"T"==ml&&(num*=1099511627776)}return num},replaceDate:function(s){var parts1=s.split(" "),parts=parts1[0].split("/"),d=new Date(0);d.setFullYear(parts[2]),d.setDate(parts[0]),d.setMonth(parts[1]-1);var hours=parts1[1].split(":");return d.setHours(hours[0]),d.setMinutes(hours[1]),d.getTime()},splitDirsAndFiles:function(oRow,nColumn){var s,c=oRow.cells[nColumn],cT=c.textContent||c.innerText;return s="undefined"!=typeof cT?cT:this.getInnerText(c)," "==s[0]&&(s=s.substr(1,s.length-1)),oRow.ajxpNode.isLeaf()||(s="000"+s),s.toUpperCase()},splitDirsAndFilesNodes:function(oNode,attName){var s;return"ajxp_label"==attName&&(attName="text"),s=oNode.getMetadata().get(attName)," "==s[0]&&(s=s.substr(1,s.length-1)),oNode.isLeaf()||(s="000"+s),s.toUpperCase()},cellSorterValue:function(oRow,nColumn,attName){if(attName&&(oRow.getAttribute("data-"+attName+"-sorter_value")||oRow.down("[data-"+attName+"-sorter_value]")))return oRow.down("[data-"+attName+"-sorter_value]")?parseInt(oRow.down("[data-"+attName+"-sorter_value]").getAttribute("data-"+attName+"-sorter_value")):oRow.getAttribute("data-"+attName+"-sorter_value");var tds=oRow.select("td");return tds[nColumn]&&tds[nColumn].getAttribute("data-sorter_value")?parseInt(tds[nColumn].getAttribute("data-sorter_value")):0},sortTimes:function(oRow,nColumn){return oRow.ajxpNode&&oRow.ajxpNode.getMetadata().get("ajxp_modiftime")?parseInt(oRow.ajxpNode.getMetadata().get("ajxp_modiftime")):0}}),Class.create("AjxpTabulator",AjxpPane,{tabulatorData:null,tabsConfigs:null,_eventPath:null,initialize:function($super,htmlElement,tabulatorOptions){if($super(htmlElement,tabulatorOptions),this.tabulatorData=$A(tabulatorOptions.tabInfos),tabulatorOptions.registerAsEditorOpener&&pydio.UI.registerEditorOpener(this),tabulatorOptions.events){var events=$H();$H(tabulatorOptions.events).each(function(pair){var callback=new Function(pair.value).bind(this);
document.observe(pair.key,callback),events.set(pair.key,callback)}.bind(this)),this.options.events=events}tabulatorOptions.saveState&&(this.tabsConfigs=$H());var div=new Element("div",{className:"tabulatorContainer panelHeader"});$(this.htmlElement).insert({top:div});var shortener=this.shortenLabel;if(this.tabulatorData.each(function(tabInfo){var tab=this._renderTab(tabInfo);div.insert(tab),this.selectedTabInfo=tabInfo;var paneObject=this.getAndSetAjxpObject(tabInfo);!tabInfo.label&&paneObject&&(paneObject.getDomNode().observe("editor:updateTitle",function(event){tabInfo.headerElement.down(".tab_label").update(shortener(event.memo))}),paneObject.getDomNode().observe("editor:updateIconClass",function(event){tabInfo.headerElement.down("span").replace(new Element("span",{className:event.memo}))})),$(tabInfo.element)&&$(tabInfo.element).observe("widget:updateTitle",function(event){tabInfo.headerElement.down(".tab_label").update(shortener(event.memo))}),this.options.saveState&&paneObject.getDomNode().observe("widget:updateState",this.saveState.bind(this))}.bind(this)),this.options.headerToolbarOptions){var tbD=new Element("div",{id:"display_toolbar"});div.insert({top:tbD}),this.tb=new ActionsToolbar(tbD,this.options.headerToolbarOptions)}tabulatorOptions.defaultTabId&&this.switchTabulator(tabulatorOptions.defaultTabId),document.observe("ajaxplorer:component_config_changed",function(event){event.memo.className=="AjxpTabulator::"+htmlElement.id&&this.parseComponentConfig(event.memo.classConfig.get("all"))}.bind(this)),this.options.saveState&&(document.observe("ajaxplorer:user_logged",this.loadState.bind(this)),this.loadState())},_renderTab:function(tabInfo){var td;if(tabInfo.ajxpClass&&tabInfo.ajxpOptions){td=new Element("span",{className:"toggleHeader"});var klass=Class.getByName(tabInfo.ajxpClass);return new klass(td,tabInfo.ajxpOptions),tabInfo.headerElement=td,tabInfo.closeable&&(td.insert(new Element("span",{className:"icon-remove tab_close_button"})),td.down(".tab_close_button").observe("click",function(){this.closeTab(tabInfo.id)}.bind(this))),td}var label="";tabInfo.label&&(label=MessageHash[tabInfo.label]||tabInfo.label);var title=MessageHash[tabInfo.title]||label.stripTags(),options={className:"toggleHeader toggleInactive"};this.options.tabsTips||(options.title=title),td=new Element("span",options);var short=this.shortenLabel(label);if(this.options.tabsTips||short!=label){var horizontal=this.htmlElement.hasClassName("left_tabulator");modal.simpleTooltip(td,horizontal?'<div class="simple_tooltip_title">'+label+"</div>"+title:title,this.options.tabsTips,horizontal?"left_arrow_tip":"down_arrow_tip","element")}return tabInfo.icon&&td.insert('<img width="16" height="16" align="absmiddle" src="'+resolveImageSource(tabInfo.icon,"/images/actions/ICON_SIZE",16)+'">'),tabInfo.iconClass&&td.insert(new Element("span",{className:tabInfo.iconClass})),td.insert('<span class="tab_label" ajxp_message_id="'+tabInfo.label+'">'+short+"</span>"),td.observe("click",function(){this.switchTabulator(tabInfo.id)}.bind(this)),tabInfo.closeable&&(td.insert(new Element("span",{className:"icon-remove tab_close_button"})),td.down(".tab_close_button").observe("click",function(){this.closeTab(tabInfo.id)}.bind(this))),tabInfo.headerElement=td,disableTextSelection(td),td},shortenLabel:function(label){if(label&&void 0!==label.innerHTML){if(label.down(".filenameSpan")){var cont=label.down(".filenameSpan").innerHTML;cont.length>25&&(cont=cont.substr(0,7)+"[...]"+cont.substr(-13),label.down(".filenameSpan").update(cont))}return label}return label.stripTags()!=label?label:label&&label.length?label.length>25?label.substr(0,7)+"[...]"+label.substr(-13):label:""},openEditorForNode:function(ajxpNode,editorData){if(this.options.uniqueTab){var editorId="unique-editor",existing=this.tabulatorData.detect(function(internalInfo){return internalInfo.id==editorId});return existing&&existing.ajxpObject&&this.closeTab(editorId,!0),void this.addTab({id:editorId,label:editorData.text,iconClass:editorData.icon_class,closeable:!0},{type:"editor",editorData:editorData,node:ajxpNode})}this.addTab({id:editorData.id+":/"+ajxpNode.getPath(),label:editorData.text,iconClass:editorData.icon_class,closeable:!0},{type:"editor",editorData:editorData,node:ajxpNode})},parseComponentConfig:function(domNode){var contentNodes=XMLUtils.XPathSelectNodes(domNode,"additional_tab"),detectedClasses=$H();contentNodes.each(function(n){var cdataContent=n.firstChild.nodeValue;cdataContent&&(detectedClasses=detectedClasses.merge(pydio.UI.findAjxpClassesInText(cdataContent)))}),ResourcesManager.loadClassesAndApply(detectedClasses.keys(),function(){contentNodes.each(function(addNode){var cdataContent=addNode.firstChild.nodeValue,anchor=this.htmlElement;if(cdataContent&&anchor){if(!anchor.down("#"+addNode.getAttribute("id"))){anchor.insert(cdataContent);var compReg=$A();pydio.UI.buildGUI(anchor.down("#"+addNode.getAttribute("id")),compReg),compReg.length&&pydio.UI.initAjxpWidgets(compReg)}this.addTab(addNode.getAttribute("tabInfo").evalJSON(),addNode.getAttribute("paneInfo").evalJSON())}}.bind(this))}.bind(this))},addTab:function(tabInfo,paneInfo,skipStateSave){if(paneInfo.nodePath&&!paneInfo.node)return void ajaxplorer.getContextHolder().loadPathInfoAsync(paneInfo.nodePath,function(n){n.__className&&n.getPath&&(paneInfo.node=n,this.addTab(tabInfo,paneInfo,skipStateSave))}.bind(this));if(this.options.saveState){var confPaneInfo=Object.clone(paneInfo);this.tabsConfigs.set(tabInfo.id,{TAB:Object.clone(tabInfo),PANE:confPaneInfo})}var existing=this.tabulatorData.detect(function(internalInfo){return internalInfo.id==tabInfo.id});if(existing)return void(existing.dontFocus||this.switchTabulator(existing.id));if(void 0==tabInfo.position||this.tabulatorData.size()<tabInfo.position)$(this.htmlElement).down(".tabulatorContainer").insert(this._renderTab(tabInfo));else{var index=Math.max(tabInfo.position-1,0);$(this.htmlElement).down(".tabulatorContainer").down("span.toggleHeader",index).insert({before:this._renderTab(tabInfo)})}if(!tabInfo.element){var randomId="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=16*Math.random()|0,v="x"==c?r:3&r|8;return v.toString(16)});tabInfo.element="dynamic-panel-"+randomId}$(this.htmlElement).insert(new Element("div",{id:tabInfo.element})),fitHeightToBottom($(this.htmlElement).down("#"+tabInfo.element),null,this.options.fitMarginBottom);var shortener=this.shortenLabel;if("editor"==paneInfo.type&&paneInfo.node&&paneInfo.node.getPath){var editorData;if(paneInfo.editorID)editorData=pydio.Registry.findEditorById(paneInfo.editorID);else if(paneInfo.editorData)editorData=paneInfo.editorData;else{var selectedMime=getAjxpMimeType(paneInfo.node),editors=pydio.Registry.findEditorsForMime(selectedMime);editors.length&&editors[0].openable&&(editorData=editors[0])}if(editorData&&paneInfo.node){pydio.Registry.loadEditorResources(editorData.resourcesManager);var oForm=$("all_forms").down("#"+editorData.formId).cloneNode(!0);$(tabInfo.element).insert(oForm);var editorOptions={closable:!1,context:this,editorData:editorData},editor=eval("new "+editorData.editorClass+"(oForm, editorOptions)");editor.getDomNode().observe("editor:updateTitle",function(event){tabInfo.headerElement.down(".tab_label").update(shortener(event.memo))}),editor.getDomNode().observe("editor:updateIconClass",function(event){tabInfo.headerElement.down("span").replace(new Element("span",{className:event.memo}))}),editor.open(paneInfo.node),tabInfo.ajxpObject=editor,tabInfo.ajxpNode=paneInfo.node,editor.resize(),confPaneInfo&&(confPaneInfo.editorData&&(confPaneInfo.editorID=confPaneInfo.editorData.id,delete confPaneInfo.editorData),confPaneInfo.node&&(confPaneInfo.nodePath=confPaneInfo.node.getPath(),delete confPaneInfo.node))}}else if("widget"==paneInfo.type&&(paneInfo.widgetClassName&&(paneInfo.widgetClass=Class.getByName(paneInfo.widgetClassName)),paneInfo.widgetClass&&paneInfo.widgetOptions)){var widgetInstance=new paneInfo.widgetClass($(tabInfo.element),paneInfo.widgetOptions);$(tabInfo.element).observe("widget:updateTitle",function(event){tabInfo.headerElement.down(".tab_label").update(shortener(event.memo))}),confPaneInfo&&(confPaneInfo.widgetClassName=widgetInstance.__className,widgetInstance.getDomNode().observe("widget:updateState",this.saveState.bind(this)))}if(this.tabulatorData.push(tabInfo),tabInfo.dontFocus){var ajxpObject=this.getAndSetAjxpObject(tabInfo);ajxpObject.showElement(!1)}else this.switchTabulator(tabInfo.id),window.setTimeout(this.resize.bind(this),750);this.resize(),skipStateSave||this.saveState(),this.htmlElement&&this.htmlElement.writeAttribute("data-ajxpTabsCount",this.tabulatorData.size())},closeTab:function(tabId,skipSaveState){var ti,previousTab;this.tabulatorData.each(function(tabInfo){if(tabInfo.id==tabId){if(!tabInfo.closeable)throw $break;var ajxpObject=this.getAndSetAjxpObject(tabInfo);if(ajxpObject){if(ajxpObject.validateClose){var test=ajxpObject.validateClose();if(!test)throw $break}ajxpObject.showElement(!1),ajxpObject.destroy()}var pane=$(this.htmlElement).down("#"+tabInfo.element);throw pane&&pane.remove(),tabInfo.headerElement.stopObserving("click"),tabInfo.headerElement.remove(),ti=tabInfo,$break}previousTab=tabInfo}.bind(this)),ti&&(this.tabulatorData=this.tabulatorData.without(ti),this.options.saveState&&this.tabsConfigs.unset(tabId),previousTab?this.switchTabulator(previousTab.id):this.tabulatorData.length&&this.switchTabulator(this.tabulatorData.first().id),this.resize(),skipSaveState||this.saveState(),this.htmlElement&&this.htmlElement.writeAttribute("data-ajxpTabsCount",this.tabulatorData.size()))},switchTabulator:function(tabId){if(!this.crtTabId||this.crtTabId!=tabId||this.options.uniqueTab){var toShow,toShowElement;if(this.tabulatorData.each(function(tabInfo){var ajxpObject=this.getAndSetAjxpObject(tabInfo);tabInfo.headerElement.removeClassName("toggleInactiveBeforeActive"),tabInfo.id==tabId?(tabInfo.headerElement.removeClassName("toggleInactive"),tabInfo.headerElement.down("img")&&tabInfo.headerElement.down("img").show(),ajxpObject&&(toShow=ajxpObject,toShowElement=tabInfo.element),this.selectedTabInfo=tabInfo,tabInfo.headerElement.previous(".toggleHeader")&&tabInfo.headerElement.previous(".toggleHeader").addClassName("toggleInactiveBeforeActive")):(tabInfo.headerElement.addClassName("toggleInactive"),tabInfo.headerElement.down("img")&&tabInfo.headerElement.down("img").hide(),ajxpObject&&(ajxpObject.showElement(!1),$(tabInfo.element)&&$(tabInfo.element).hide()))}.bind(this)),toShow){if(!$(toShowElement)||$(toShowElement).visible()&&0!=parseInt($(toShowElement).getStyle("height"))||($(toShowElement)&&$(toShowElement).show(),fitHeightToBottom($(toShowElement),null,this.options.fitMarginBottom),toShow.showElement(!0)),this.htmlElement&&this.htmlElement.up('div[ajxpClass="Splitter"]')&&this.htmlElement.up('div[ajxpClass="Splitter"]').ajxpPaneObject){var splitter=this.htmlElement.up('div[ajxpClass="Splitter"]').ajxpPaneObject;splitter.splitbar.hasClassName("folded")&&(Element.descendantOf(this.htmlElement,splitter.paneA)||this.htmlElement==splitter.paneA)&&splitter.unfold()}toShow.resize()}this.options.headerToolbarOptions&&pydio.getController().fireSelectionChange(),this.htmlElement&&this.htmlElement.writeAttribute("data-ajxpTabsCount",this.tabulatorData.size()),this.resize(),this.crtTabId=tabId,this.notify("switch",tabId)}},switchToFirstIfPathDiffers:function(event){var cNode=event.memo;this._eventPath&&cNode.getPath()!=this._eventPath&&this.switchTabulator(this.tabulatorData.first().id),this._eventPath=cNode.getPath()},resize:function(size,loop){if(this.selectedTabInfo&&this.htmlElement){if(this.options.fit&&"height"==this.options.fit&&fitHeightToBottom(this.htmlElement,this.options.fitParent),this.htmlElement.hasClassName("horizontal_tabulator")){var tabContainer=this.htmlElement.down("div.tabulatorContainer");fitHeightToBottom(tabContainer,null,this.options.fitMarginBottom);var pWidth=this.htmlElement.getWidth()-tabContainer.getWidth();this.htmlElement.select("> div:not(.tabulatorContainer)").invoke("setStyle",{width:pWidth+"px"})}var ajxpObject=this.getAndSetAjxpObject(this.selectedTabInfo);if(ajxpObject&&!ajxpObject.fullScreenMode){var nodeElement=$(this.htmlElement).down("#"+this.selectedTabInfo.element);fitHeightToBottom(nodeElement,this.htmlElement,this.options.fitMarginBottom),ajxpObject.resize(nodeElement?nodeElement.getHeight():this.htmlElement.getHeight());var left=0,total=0,cont=this.htmlElement.down("div.tabulatorContainer"),innerWidth=parseInt(this.htmlElement.getWidth())-parseInt(cont.getStyle("paddingLeft"))-parseInt(cont.getStyle("paddingRight"));if(this.options.headerToolbarOptions){var dBar=this.htmlElement.down("div#display_toolbar");innerWidth-=parseInt(dBar.getWidth())+parseInt(dBar.getStyle("paddingRight"))+parseInt(dBar.getStyle("paddingLeft"))}if(cont.removeClassName("icons_only"),this.htmlElement.removeClassName("tabulator-vertical"),this.tabulatorData.each(function(tabInfo){var header=tabInfo.headerElement;header.setStyle({width:"auto"});var hWidth=parseInt(header.getWidth());tabInfo==this.selectedTabInfo&&(left=innerWidth-hWidth),total+=hWidth}.bind(this)),total>=innerWidth){var part=parseInt(left/(this.tabulatorData.length-1))-1;14>part&&cont.addClassName("icons_only"),30>innerWidth&&this.htmlElement.addClassName("tabulator-vertical"),this.tabulatorData.each(function(tabInfo){var header=tabInfo.headerElement;if(tabInfo!=this.selectedTabInfo)try{header.setStyle({width:part-(parseInt(header.getStyle("paddingRight"))+parseInt(header.getStyle("paddingLeft"))+parseInt(header.getStyle("borderRightWidth"))+parseInt(header.getStyle("borderLeftWidth")))+"px"})}catch(e){}}.bind(this))}}document.fire("ajaxplorer:resize-AjxpTabulator-"+this.htmlElement.id,this.htmlElement.getDimensions()),this.options.refireResize&&!loop&&window.setTimeout(function(){this.resize(size,!0)}.bind(this),1e3*this.options.refireResize)}},showElement:function($super,show){this.htmlElement&&(this.tabulatorData.each(function(tabInfo){var ajxpObject=this.getAndSetAjxpObject(tabInfo);ajxpObject.showElement(show)}.bind(this)),show?(this.htmlElement.show(),this.resize()):this.htmlElement.hide())},getDomNode:function(){return this.htmlElement},destroy:function(){this.tabulatorData.each(function(tabInfo){var ajxpObject=this.getAndSetAjxpObject(tabInfo);tabInfo.headerElement.stopObserving("click"),Class.objectImplements(ajxpObject,"IFocusable")&&pydio.UI.unregisterFocusable(ajxpObject),Class.objectImplements(ajxpObject,"IActionProvider")&&ajxpObject.getActions()&&ajxpObject.getActions().each(function(act){pydio.getController().deleteFromGuiActions(act.key)}.bind(this)),ajxpObject.destroy()}.bind(this)),this.tb&&this.tb.destroy(),this.options.registerAsEditorOpener&&pydio.UI.registerEditorOpener(this),this.options.events&&this.options.events.each(function(pair){document.stopObserving(pair.key,pair.value)}),this.htmlElement.update("");try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}this.htmlElement=null},getAndSetAjxpObject:function(tabInfo){var ajxpObject=tabInfo.ajxpObject||null,nodeElement=$(tabInfo.element);return!nodeElement||!nodeElement.ajxpPaneObject||ajxpObject&&ajxpObject==nodeElement.ajxpPaneObject||(ajxpObject=tabInfo.ajxpObject=nodeElement.ajxpPaneObject),ajxpObject},getAjxpObjectByTabId:function(tabId){var theInfo=this.tabulatorData.detect(function(tabInfo){return tabInfo.id==tabId?tabInfo:void 0});return theInfo?this.getAndSetAjxpObject(theInfo):null},__stateLoaded:!1,saveState:function(){this.options.saveState&&this.__stateLoaded&&ajaxplorer.user&&(this.tabulatorData.each(function(tabInfo){var object=this.getAndSetAjxpObject(tabInfo);object.getStateData&&(this.tabsConfigs.get(tabInfo.id)||this.tabsConfigs.set(tabInfo.id,{}),this.tabsConfigs.get(tabInfo.id).DATA=object.getStateData())}.bind(this)),this.tabsConfigs.each(function(pair){var confPaneInfo=pair.value.PANE;confPaneInfo&&(confPaneInfo.editorData&&(confPaneInfo.editorID=confPaneInfo.editorData.id,delete confPaneInfo.editorData),confPaneInfo.node&&(confPaneInfo.nodePath=confPaneInfo.node.getPath(),delete confPaneInfo.node))}),this.setUserPreference("tabs_state",this.tabsConfigs))},loadState:function(){if(this.clearState(),ajaxplorer&&ajaxplorer.user){var pref=this.getUserPreference("tabs_state");if(pref){var index=1;$H(pref).each(function(pair){if(pair.value.TAB&&pair.value.PANE)pair.value.TAB.dontFocus=!0,window.setTimeout(function(){if($(this.htmlElement)&&(this.addTab(Object.clone(pair.value.TAB),Object.clone(pair.value.PANE),!0),pair.value.DATA)){var object=this.getAjxpObjectByTabId(pair.key);object&&object.loadStateData&&object.loadStateData(pair.value.DATA)}}.bind(this),2e3*index),index++;else if(pair.value.DATA){var object=this.getAjxpObjectByTabId(pair.key);object&&object.loadStateData&&object.loadStateData(pair.value.DATA)}}.bind(this))}this.__stateLoaded=!0}},clearState:function(){this.tabulatorData.each(function(tabInfo){try{var ajxpObject=this.getAndSetAjxpObject(tabInfo);ajxpObject.clearStateData&&ajxpObject.clearStateData(),this.closeTab(tabInfo.id,!0)}catch(e){}}.bind(this))}}),Class.create("VisibilityToggler",AjxpPane,{initialize:function($super,htmlElement,options){$super(htmlElement,options);var togId=options.widget_id,detectionId=options.detection_id?options.detection_id:options.widget_id,updaterScroller=function(){try{htmlElement.up("[ajxpClass]").ajxpPaneObject.scrollbar&&htmlElement.up("[ajxpClass]").ajxpPaneObject.scrollbar.recalculateLayout()}catch(e){}};updaterScroller(),window.setTimeout(updaterScroller,1500),htmlElement.observe("click",function(){if($(togId)&&$(detectionId)){if($(togId).ajxpPaneObject)$(togId).ajxpPaneObject.showElement(!$(detectionId).visible());else{var show=!$(detectionId).visible();show?$(togId).show():$(togId).hide()}htmlElement.removeClassName("simple-toggler-show").removeClassName("simple-toggler-hide"),htmlElement.addClassName($(detectionId).visible()?"simple-toggler-hide":"simple-toggler-show"),htmlElement.update($(detectionId).visible()?MessageHash[514]:MessageHash[513]),updaterScroller(),window.setTimeout(updaterScroller,1500)}}),this.parentElement=htmlElement.up(),Droppables.add(this.parentElement,{hoverclass:"",accept:"ajxp_draggable",onHover:function(draggable,droppable,event){if($(togId)&&$(detectionId)&&!$(detectionId).visible()){if($(togId).ajxpPaneObject)$(togId).ajxpPaneObject.showElement(!$(detectionId).visible());else{var show=!$(detectionId).visible();show?$(togId).show():$(togId).hide()}htmlElement.removeClassName("simple-toggler-show").removeClassName("simple-toggler-hide"),htmlElement.addClassName($(detectionId).visible()?"simple-toggler-hide":"simple-toggler-show"),htmlElement.update($(detectionId).visible()?MessageHash[514]:MessageHash[513]),updaterScroller(),window.setTimeout(updaterScroller,1500)}}.bind(this)})},destroy:function($super){Droppables.remove(this.parentElement),$super()}}),Class.create("AjxpSimpleTabs",AjxpPane,{panes:null,tabRow:null,fitHeight:!0,initialize:function($super,htmlElement,tabulatorOptions){$super(htmlElement,tabulatorOptions),tabulatorOptions&&tabulatorOptions.autoHeight&&(this.fitHeight=!1),htmlElement.down("div.tabpanes")||htmlElement.insert(new Element("div",{className:"tabpanes"})),this.panes=htmlElement.down("div.tabpanes"),this.fitHeight&&fitHeightToBottom(this.panes,this.htmlElement),htmlElement.down("ul.tabrow")?(this.tabRow=htmlElement.down("ul.tabrow"),htmlElement.down("ul.tabrow").select("li").each(function(tab){var paneId=tab.getAttribute("data-PaneID");htmlElement.down("#"+paneId)?this.addTab(tab,htmlElement.down("#"+paneId)):this.addTab(tab)}.bind(this)),window.setTimeout(function(){if(this.options.saveState){var test=this.loadState();if(void 0!==test)return void this.selectTabByIndex(test)}this.selectTabByIndex(0)}.bind(this),100)):(htmlElement.insert(new Element("ul",{className:"tabrow"})),this.tabRow=htmlElement.down("ul.tabrow"))},addTab:function(tab,pane){tab instanceof String&&(tab=new Element("li",{className:""}).update(tab),this.tabRow.insert(tab)),pane||(pane=new Element("div")),pane.addClassName("tabPane"),tab.tabPANE=pane,this.panes.insert(pane),this.fitHeight&&fitHeightToBottom(pane,this.panes),pane.setStyle({overflowY:"auto"}),attachMobileScroll(pane,"vertical"),tab.setSelected=function(){this.panes.childElements("div.tabPane").invoke("hide"),tab.tabPANE.show(),this.tabRow.select("li").invoke("removeClassName","selected"),tab.addClassName("selected"),this.fitHeight&&pane.setStyle({height:parseInt(this.panes.getHeight())+"px"}),tab.tabPANE.resizeOnShow&&tab.tabPANE.resizeOnShow(tab,tab.tabPANE)}.bind(this),tab.observe("click",function(){if(tab.setSelected(),this.options.saveState){var index=this.tabRow.select("li").indexOf(tab);this.saveState(index)}}.bind(this)),tab.setSelected()},selectTabByIndex:function(index){try{this.tabRow.select("li")[index].setSelected(),this.notify("switch"),this.options.saveState&&this.saveState(index)}catch(e){}},saveState:function(index){this.setUserPreference("tabs_state","selected_"+index)},loadState:function(){var pref=this.getUserPreference("tabs_state");return pref&&pref.startsWith("selected_")?parseInt(pref.replace("selected_","")):void 0},resize:function(){this.fitHeight&&fitHeightToBottom(this.panes,this.htmlElement);var tRW=this.tabRow.getWidth(),padding=0,lis=this.tabRow.select("li"),currentSum=0;if(lis.each(function(t){t.setStyle({width:"auto",maxWidth:"none"}),currentSum+=t.getWidth()}),currentSum>tRW){lis.size()&&(padding=parseInt(lis.first().getStyle("paddingLeft"))+parseInt(this.tabRow.down("li").getStyle("paddingRight")));var maxWidth=Math.round(tRW/lis.size())-padding-2}this.tabRow.select("li").each(function(tab){maxWidth&&tab.setStyle({maxWidth:maxWidth+"px"}),tab.tabPANE&&(this.fitHeight&&fitHeightToBottom(tab.tabPANE,this.panes),tab.hasClassName("selected")&&tab.tabPANE.resizeOnShow&&tab.tabPANE.resizeOnShow(tab,tab.tabPANE))}.bind(this))},getDomNode:function(){return this.htmlElement},destroy:function(){this.htmlElement=null}}),Class.create("RepositorySelect",{__implements:"IAjxpWidget",_defaultString:"No Repository",_defaultIcon:"network-wired.png",options:{},initialize:function(oElement,options){this.element=oElement,this.element.ajxpPaneObject=this,this.show=!0,options&&(this.options=options),this.createGui(),this.observer=function(e){this.refreshRepositoriesMenu(e.memo.list,e.memo.active)}.bind(this),document.observe("ajaxplorer:repository_list_refreshed",this.observer)},getDomNode:function(){return this.element},destroy:function(){try{pydio.UI.removeInstanceFromCache(this.element.id)}catch(e){}this.element=null,document.stopObserving("ajaxplorer:repository_list_refreshed",this.observer),this.repoMenu&&this.repoMenu.destroy()},createGui:function(){return MessageHash&&(this._defaultString=MessageHash[391]),this.options.simpleLabel?void this.element.insert(this.options.simpleLabel):(this.icon=new Element("img",{id:"repo_icon",src:resolveImageSource(this._defaultIcon,"/images/actions/ICON_SIZE",16),width:16,height:16,align:"absmiddle"}),this.label=new Element("input",{type:"text",name:"repo_path",value:this._defaultString,id:"repo_path"}),this.currentRepositoryLabel=new Element("div",{id:"repository_form"}),this.currentRepositoryLabel.insert(this.icon),this.currentRepositoryLabel.insert(this.label),this.element.insert(this.currentRepositoryLabel),this.button=simpleButton("repository_goto","inlineBarButton",200,200,ajxpResourcesFolder+"/images/arrow_down.png",16,"inline_hover",null,!0),this.button.setStyle({marginRight:"7px"}),this.button.select("img")[0].setStyle({height:"6px",width:"10px",marginLeft:"1px",marginRight:"1px",marginTop:"8px"}),void this.element.insert(this.button))},refreshRepositoriesMenu:function(repositoryList,repositoryId){var button;button=this.options.simpleLabel?this.element:this.button,repositoryList=ProtoCompat.map2hash(repositoryList),button.addClassName("disabled");var actions=$A([]),lastActions=$A([]),sharedActions=$A([]);repositoryList&&repositoryList.size()?repositoryList.each(function(pair){var repoObject=pair.value,key=pair.key,selected=key==repositoryId;if(!repoObject.getAccessType().startsWith("ajxp_")){var label=repoObject.getHtmlBadge()+'<span class="menu_label">'+repoObject.getLabel()+"</span>",alt=repoObject.getLabel();repoObject.getDescription()?(label+='<span class="menu_description">'+repoObject.getDescription()+"</span>",alt+="-"+repoObject.getDescription()):alt+=repoObject.getOwner()?" ("+MessageHash[413]+" "+repoObject.getOwner()+")":"";var actionData={name:label,alt:alt,image:repoObject.getIcon(),icon_class:"icon-hdd",overlay:repoObject.getOverlay(),className:"edit",disabled:selected,callback:function(e){this.onRepoSelect(""+key)}.bind(this)};repoObject.userEditable&&(actionData.moreActions=this.getContextActions(key)),"ajxp_shared"==repoObject.getAccessType()?lastActions.push(actionData):repoObject.getOwner()?sharedActions.push(actionData):actions.push(actionData),key==repositoryId&&(this.label&&this.label.setValue(repoObject.getLabel()),this.icon&&(this.icon.src=repoObject.getIcon()))}}.bind(this)):(this.label&&this.label.setValue(this._defaultString),this.icon&&(this.icon.src=resolveImageSource(this._defaultIcon,"/images/actions/ICON_SIZE",16)));var fonc=function(a,b){var x=a.name.toLowerCase(),y=b.name.toLowerCase();return y>x?-1:x>y?1:0};if(actions.sort(fonc),sharedActions.length&&(sharedActions.sort(fonc),actions.push({separator:!0,menuTitle:MessageHash[469]}),actions=actions.concat(sharedActions)),lastActions.length&&(lastActions.sort(fonc),actions.push({separator:!0,menuTitle:"Other Actions"}),actions=actions.concat(lastActions)),!actions.length)return void(this.repoMenu&&(this.repoMenu.options.menuItems=actions,this.repoMenu.refreshList()));var menuActionsLoader=function(){var menuItems=$A();pydio.getController().getActionsForAjxpWidget("RepositorySelect",this.element.id).each(function(otherAction){menuItems.push({name:otherAction.getKeyedText(),alt:otherAction.options.title,action_id:otherAction.options.name,icon_class:otherAction.options.icon_class,className:"edit",image:resolveImageSource(otherAction.options.src,"/images/actions/ICON_SIZE",16),callback:function(e){this.apply()}.bind(otherAction)})}),menuItems.length&&(actions.push({separator:!0}),actions=actions.concat(menuItems)),this.repoMenu.options.menuItems=actions,this.repoMenu.refreshList()}.bind(this);this.repoMenu?(this.repoMenu.options.menuItems=actions,this.repoMenu.refreshList()):(this.repoMenu=new Proto.Menu({className:"menu rootDirChooser menuDetails workspacesMenu",mouseClick:this.options.menuEvent?this.options.menuEvent:"left",anchor:button,position:this.options.menuPosition?this.options.menuPosition:"bottom",createAnchor:!1,anchorContainer:$("dir_chooser"),anchorSrc:ajxpResourcesFolder+"/images/arrow_down.png",anchorTitle:MessageHash[200],topOffset:void 0!==this.options.menuOffsetTop?this.options.menuOffsetTop:2,leftOffset:void 0!==this.options.menuOffsetLeft?this.options.menuOffsetLeft:-127,menuTitle:MessageHash[468],menuItems:actions,menuMaxHeight:this.options.menuMaxHeight,menuFitHeight:this.options.menuFitHeight,fade:!0,beforeShow:menuActionsLoader,zIndex:1500}),this.notify("createMenu")),actions.length&&button.removeClassName("disabled")},onRepoSelect:function(key){ajaxplorer.triggerRepositoryChange(key)},resize:function(){if(this.currentRepositoryLabel){var parent=this.element.getOffsetParent();this.showElement(parent.getWidth()<3.5*this.currentRepositoryLabel.getWidth()?!1:!0)}},getContextActions:function(repositoryId){var removeAction={name:MessageHash[423],alt:MessageHash[423],image:ajxpResourcesFolder+"/images/actions/16/delete_bookmark.png",icon_class:"icon-remove",disabled:!1,className:"edit",callback:function(e){if(window.confirm(MessageHash[424])){var conn=new Connexion;conn.setParameters({get_action:"user_delete_repository",repository_id:repositoryId}),conn.onComplete=function(transport){pydio.getController().parseXmlMessage(transport.responseXML)},conn.sendAsync()}}.bind(this)};return new Array(removeAction)},showElement:function(show){this.show=show,show?(this.currentRepositoryLabel.show(),this.repoMenu&&(this.repoMenu.options.leftOffset=-127)):(this.currentRepositoryLabel.hide(),this.repoMenu&&(this.repoMenu.options.leftOffset=0)),this.repoMenu||this.observeOnce("createMenu",function(){this.showElement(this.show)}.bind(this))},getActualWidth:function(){return this.options.simpleLabel?this.element.getWidth():this.currentRepositoryLabel.visible()?this.element.getWidth():this.button.getWidth()+10}}),Class.create("RepositorySimpleLabel",AjxpPane,{_defaultString:"",_defaultIcon:"network-wired.png",options:{},initialize:function($super,oElement,options){if(options=Object.extend({displayLabelLegend:!0,displayWorkspaceDescription:!1},options),$super(oElement,options),this.options.displayLabelLegend&&this.htmlElement.update('<div class="repository_legend">Workspace</div>'),this.htmlElement.insert('<div class="repository_title"></div>'),this.options.displayWorkspaceDescription&&this.htmlElement.insert('<div class="repository_description"></div>'),options.link){var linkTitle;options.linkTitle&&(linkTitle=MessageHash[options.linkTitle]?MessageHash[options.linkTitle]:options.linkTitle,this.htmlElement.down("div.repository_title").writeAttribute("title",linkTitle)),this.htmlElement.down("div.repository_title").observe("click",function(){options.linkTarget&&"new"==options.linkTarget?window.open(options.link):document.location.href=options.link}),this.htmlElement.down("div.repository_title").addClassName("linked")}this.observer=function(e){this.htmlElement.down("div.repository_title").update(this._defaultString),this.options.displayWorkspaceDescription&&this.htmlElement.down("div.repository_description").update("");var repositoryList=ProtoCompat.map2hash(e.memo.list),repositoryId=e.memo.active;if(repositoryList&&repositoryList.size()){var repoObject=repositoryList.get(repositoryId);repoObject&&(this.htmlElement.down("div.repository_title").update(repoObject.getLabel()),this.options.displayWorkspaceDescription&&this.htmlElement.down("div.repository_description").update(repoObject.getDescription()))}var upDiv=this.htmlElement.up('[ajxpClass="AjxpPane"]');upDiv&&upDiv.ajxpPaneObject.resize()}.bind(this),document.observe("ajaxplorer:repository_list_refreshed",this.observer)},destroy:function(){document.stopObserving("ajaxplorer:repository_list_refreshed",this.observer)}}),Class.create("Breadcrumb",AjxpPane,{__implements:["IAjxpWidget"],currentPath:"",initialize:function($super,oElement,options){$super(oElement,options),this.element=oElement,this.element.ajxpPaneObject=this,this.options=options||{},this.element.update("Files"),this.observerFunc=function(event){if(this.element){var newNode=event.memo,parts=$H();if(Object.isString(newNode)){newNode=new AjxpNode(newNode);var newPath=newNode.getPath(),crtPath="";$A(newPath.split("/")).each(function(element){element&&(crtPath+="/"+element,parts.set(crtPath,element))}),getBaseName(newPath)!=newNode.getLabel()&&parts.set(newPath,newNode.getLabel())}else{var parent=newNode.getParent();for(parts.set(newNode.getPath(),newNode.getLabel());null!=parent;){var lastChild=parent;parts.set(parent.getPath(),parent.getLabel()),parent=parent.getParent()}parts.size()>1&&!this.options.always_show_root&&parts.unset(lastChild.getPath());var keys=parts.keys().reverse(),tmpParts=$H();keys.each(function(k){tmpParts.set(k,parts.get(k))}),parts=tmpParts}var chevron="<span class='icon-chevron-right'></span>",clickPath="";this.options.hide_home_icon||(clickPath="<span class='icon-home ajxp-goto' data-goTo='/' title='"+MessageHash[459]+"'></span>",this.options.use_ul&&(clickPath="<li>"+clickPath+"</li>"));var pos=0,length=parts.keys().length;parts.each(function(pair){var refresh="";if(this.options.use_ul){pos==length-1&&(refresh='<i class="icon-refresh ajxp-goto-refresh" title="'+MessageHash[149]+'"></i>');var first=0==pos?" first-bread":"";
clickPath+="<li><span class='ajxp-goto "+first+"' data-goTo='"+pair.key+"'><em>"+pair.value+"</em></span></li>",refresh&&(clickPath+="<li><i class='ajxp-goto' data-goTo='"+pair.key+"'>"+refresh+"</i></li>")}else pos==length-1&&(refresh='<span class="icon-refresh ajxp-goto-refresh" title="'+MessageHash[149]+'"></span>'),clickPath+=(pair.value!=pos!=0&&this.options.hide_home_icon?"":chevron)+"<span class='ajxp-goto' data-goTo='"+pair.key+"'>"+pair.value+refresh+"</span>";pos++}.bind(this)),this.options.use_ul?(this.element.update("<div class='inner_bread'><ul>"+clickPath+"</ul></div>"),this.resizeUls()):this.element.update("<div class='inner_bread'>"+clickPath+"</div>"),this.element.select("span.ajxp-goto").invoke("observe","click",function(event){"use strict";var target=Event.findElement(event,"span[data-goTo]").getAttribute("data-goTo");event.target.setAttribute("title","Go to "+target),event.target.hasClassName("ajxp-goto-refresh")||event.target.down("span.ajxp-goto-refresh")?window.ajaxplorer.fireContextRefresh():window.ajaxplorer.goTo(target)}),this.element.select("i.ajxp-goto").invoke("observe","click",function(event){window.ajaxplorer.fireContextRefresh()})}}.bind(this),document.observe("ajaxplorer:context_changed",this.observerFunc)},resize:function($super){this.element&&($super(),this.options.use_ul&&this.resizeUls(),document.fire("ajaxplorer:resize-Breadcrumb-"+this.element.id,this.element.getDimensions()))},resizeUls:function(){var available=parseInt(this.element.getWidth()),lastOverlaps=function(){var last=this.element.down("li:last");return(last&&last.positionedOffset().left+last.getWidth())>available}.bind(this),i=0,spans=this.element.select("li > span");for(spans.invoke("removeClassName","reduced");lastOverlaps()&&i<spans.length-2;)i++,spans[i].addClassName("reduced");lastOverlaps()&&spans.length&&spans[0].addClassName("reduced")},getDomNode:function(){return this.element},destroy:function($super){document.stopObserving("ajaxplorer:context_changed",this.observerFunc),$super()},showElement:function(show){}}),Class.create("LocationBar",{__implements:["IAjxpWidget","IFocusable"],_defaultGotoIcon:"media-playback-start.png",_reloadGotoIcon:"reload.png",_modified:!1,_beforeModified:"",initialize:function(oElement,options){this.element=oElement,this.element.ajxpPaneObject=this,this.realPath="/",this.options=options||{},this.createGui(),document.observe("ajaxplorer:user_logged",this.resize.bind(this))},createGui:function(){this.parentButton=simpleButton("goto_parent","inlineBarButtonRight",24,24,"goto_parent.png",16,"inline_hover",function(){pydio.getController().fireAction("up_dir")}),this.element.insert(this.parentButton);var locDiv=new Element("div",{id:"location_form"});this.initCurrentPath(),this.element.insert(locDiv),locDiv.insert(this.currentPath);this.currentPath.getDimensions();this.currentPath.hide(),this.label=new Element("div",{className:"location_bar_label"}).update("/test"),this.label.setStyle({marginTop:1,fontSize:"11px",height:Prototype.Browser.IE?"18px":"15px",fontFamily:"Trebuchet MS,sans-serif,Nimbus Sans L",zIndex:1e4,backgroundColor:"white",whiteSpace:"nowrap",overflow:"hidden"}),locDiv.insert(this.label),this.label.observe("click",function(){this.label.hide(),this.currentPath.show(),this.currentPath.focus()}.bind(this)),this.gotoButton=simpleButton("location_goto","inlineBarButton",104,104,this._reloadGotoIcon,16,"inline_hover",this.submitPath.bind(this)),this.element.insert(this.gotoButton),this.options.searchButton&&(this.searchButton=simpleButton("search_panel_button","inlineBarButtonLeft",87,184,this.options.searchIcon,16,"inline_hover",function(){var folded=window[this.options.searchButton].toggleFolding();folded||$(this.options.searchFocus).focus()}.bind(this),!1,!0),this.element.insert(this.searchButton)),this.bmButton=simpleButton("bookmarks_goto","inlineBarButtonLeft",145,145,"bookmark.png",16,"inline_hover",null,!1,!0),this.element.insert(this.bmButton),this.initBookmarksBar()},initCurrentPath:function(){this.currentPath=new Element("input",{id:"current_path",type:"text",value:"/"});var autoCompOptions={afterUpdateElement:function(element,li){this.currentPath.value!=this.realPath&&(this.setModified(!0),this.submitPath())}.bind(this)};this.autoComp=new AjxpAutocompleter(this.currentPath,"autocomplete_choices",null,autoCompOptions),this.currentPath.observe("keydown",function(event){if(9==event.keyCode)return!1;if(this._modified||this._beforeModified==this.currentPath.getValue()||this.setModified(!0),13==event.keyCode){if(this.autoComp.active)return;this.submitPath(),Event.stop(event)}}.bind(this)),this.currentPath.observe("focus",function(e){return pydio.UI.disableShortcuts(),this.hasFocus=!0,this.currentPath.select(),!1}.bind(this)),this.currentPath.observe("blur",function(e){this.currentPath.hide(),this.label.show(),currentLightBox||(pydio.UI.enableShortcuts(),this.hasFocus=!1)}.bind(this)),document.observe("ajaxplorer:context_changed",function(event){window.setTimeout(function(){this.updateLocationBar(event.memo)}.bind(this),0)}.bind(this))},initBookmarksBar:function(){this.bookmarkBar=new BookmarksBar(this.bmButton)},submitPath:function(){if(this._modified){var url=this.currentPath.value.stripScripts();if(""==url)return!1;var node=new AjxpNode(url,!1),parts=url.split("##");if(2==parts.length){var data=new Hash;data.set("new_page",parts[1]),url=parts[0],node=new AjxpNode(url),node.getMetadata().set("paginationData",data)}this.pathExists(url)?pydio.getController().fireDefaultAction("dir",node):(modal.displayMessage("ERROR","Cannot find : "+url),this.currentPath.setValue(this._beforeModified))}else pydio.getController().fireAction("refresh");return!1},pathExists:function(dirName){var connexion=new Connexion;connexion.addParameter("get_action","stat"),connexion.addParameter("file",dirName);var result=!1;return connexion.onComplete=function(transport){transport.responseJSON&&transport.responseJSON.mode&&(result=!0)}.bind(this),connexion.sendSync(),result},updateLocationBar:function(newNode){Object.isString(newNode)&&(newNode=new AjxpNode(newNode));var newPath=newNode.getPath();newNode.getMetadata().get("paginationData")&&(newPath+="##"+newNode.getMetadata().get("paginationData").get("current")),this.realPath=newPath,this.currentLabel=this.realPath,getBaseName(newPath)!=newNode.getLabel()&&(this.currentLabel=getRepName(newPath)+"/"+newNode.getLabel()),this.label.update(this.currentLabel),this.currentPath.value=this.realPath,this.setModified(!1)},setModified:function(bool){this._modified=bool,this.gotoButton.setSrc(resolveImageSource(bool?this._defaultGotoIcon:this._reloadGotoIcon,"/images/actions/ICON_SIZE",16)),this._beforeModified=this.currentPath.getValue()},resize:function(){if(this.options.flexTo){var parentWidth=$(this.options.flexTo).getWidth(),siblingWidth=0;this.element.siblings().each(function(s){siblingWidth+=s.ajxpPaneObject&&s.ajxpPaneObject.getActualWidth?s.ajxpPaneObject.getActualWidth():s.getWidth()});var buttonsWidth=20;this.element.select("div.inlineBarButton,div.inlineBarButtonLeft,div.inlineBarButtonRight").each(function(el){buttonsWidth+=el.getWidth()});var newWidth=Math.min(parentWidth-siblingWidth-buttonsWidth,320);5>newWidth?this.element.hide():(this.element.show(),this.currentPath.setStyle({width:newWidth+"px"}),this.label.setStyle({width:newWidth+"px"}))}},getDomNode:function(){return this.element},destroy:function(){this.element=null},showElement:function(show){},setFocusBehaviour:function(){},focus:function(){this.label.hide(),this.currentPath.show(),this.currentPath.focus(),this.hasFocus=!0},blur:function(){this.currentPath.blur(),this.currentPath.hide(),this.label.show(),this.hasFocus=!1}}),Class.create("UserWidget",{__implements:["IAjxpWidget"],options:{},initialize:function(element,options){this.element=element,this.element.ajxpPaneObject=this,options&&(this.options=options),this.mObs1=function(){this.element.select("div").invoke("addClassName","user_widget_hover")}.bind(this),this.mObs2=function(){var divs=this.element.select("div");divs.length&&(divs[0].hasClassName("inline_hover_light")||this.element.select("div").invoke("removeClassName","user_widget_hover"))}.bind(this),this.uLoggedObs=this.updateGui.bind(this),this.actLoaded=this.updateActions.bind(this),this.element.observe("mouseover",this.mObs1),this.element.observe("mouseout",this.mObs2),document.observe("ajaxplorer:user_logged",this.uLoggedObs),document.observe("ajaxplorer:actions_loaded",this.actLoaded),Prototype.Browser.IE&&document.observe("ajaxplorer:actions_refreshed",this.actLoaded)},updateGui:function(){var logging_string="",oUser=ajaxplorer.user;if(null!=oUser)if("guest"!=oUser.id){var displayName=oUser.id;oUser.getPreference("USER_DISPLAY_NAME")&&(displayName=oUser.getPreference("USER_DISPLAY_NAME"));var label="<i>"+displayName+' </i> <span class="icon-caret-down ajxp_icon_arrow"></span>',img="",imgSrc="",conn=new Connexion;oUser.getPreference("avatar")?imgSrc=conn._baseUrl+"&get_action=get_binary_param&binary_id="+oUser.getPreference("avatar")+"&user_id="+oUser.id:ajaxplorer.getPluginConfigs("ajxp_plugin[@id='action.avatar']").get("AVATAR_PROVIDER")&&(conn.addParameter("get_action","get_avatar_url"),conn.addParameter("userid",oUser.id),conn.onComplete=function(transport){imgSrc=transport.responseText},conn.sendSync()),""!=imgSrc&&(img='<img src="'+imgSrc+'" alt="avatar" class="user_widget_mini">',label="<i>"+img+displayName+"</i>"),logging_string='<div class="user_widget_label '+(img?"withImage":"")+'"><span class="icon-reorder"></span> '+label+' </div><div class="inlineBarButtonLeft" style="-moz-border-radius: 0 5px 5px 0;border-radius: 0 5px 5px 0;border-left-style:none; border-width:1px;"><img width="16" height="16" style="height: 6px; width: 10px; margin-top: 9px; margin-left: 3px; margin-right: 3px;" ajxp_message_title="189" title="'+MessageHash[189]+'" src="'+ajxpResourcesFolder+'/images/arrow_down.png"></div>',this.element.removeClassName("disabled"),oUser.lock||null==oUser.getPreference("lang")||""==oUser.getPreference("lang")||oUser.getPreference("lang")==ajaxplorer.currentLanguage||ajaxplorer.loadI18NMessages(oUser.getPreference("lang"))}else logging_string='<div style="padding:3px 0 3px 7px;"><ajxp:message ajxp_message_id="143">'+MessageHash[143]+"</ajxp:message></div>",this.element.addClassName("disabled");else logging_string='<div style="padding:3px 0 3px 7px;"><ajxp:message ajxp_message_id="142">'+MessageHash[144]+"</ajxp:message></div>",this.element.addClassName("disabled");this.element.update(logging_string)},updateActions:function(){var menuItems=$A(),actions=pydio.getController().getActionsForAjxpWidget("UserWidget",this.element.id),groups={};actions.each(function(action){var bGroup;try{bGroup=action.context.actionBarGroup}catch(e){}bGroup||(bGroup="default"),groups[bGroup]||(groups[bGroup]=$A()),groups[bGroup].push({name:action.getKeyedText(),action_id:action.options.name,alt:action.options.title,image:resolveImageSource(action.options.src,"/images/actions/ICON_SIZE",16),icon_class:action.options.icon_class,callback:function(e){this.apply()}.bind(action)})});for(var key in groups)groups.hasOwnProperty(key)&&(menuItems=menuItems.concat(groups[key],{separator:!0}));menuItems.pop(),this.menu?(this.menu.options.menuItems=menuItems,this.menu.refreshList()):(this.menu=new Proto.Menu({className:"menu rootDirChooser menuDetails",mouseClick:this.options.menuEvent?this.options.menuEvent:"left",position:"bottom right",anchor:this.element,createAnchor:!1,topOffset:this.options.menuOffsetTop?this.options.menuOffsetTop:2,leftOffset:this.options.menuOffsetLeft?this.options.menuOffsetLeft:-3,menuItems:menuItems,menuTitle:MessageHash[511].replace("%s",ajaxplorer.getPluginConfigs("ajaxplorer").get("APPLICATION_TITLE")),detailedItems:!0,fade:!0,zIndex:1500,beforeShow:function(e){this.element.select("div").invoke("addClassName","inline_hover_light"),this.element.select("div").invoke("addClassName","user_widget_hover")}.bind(this),beforeHide:function(e){this.element.select("div").invoke("removeClassName","inline_hover_light"),this.element.select("div").invoke("removeClassName","user_widget_hover")}.bind(this),beforeSelect:function(e){this.element.select("div").invoke("removeClassName","inline_hover_light"),this.element.select("div").invoke("removeClassName","user_widget_hover")}.bind(this)}),this.notify("createMenu"))},resize:function(){},showElement:function(show){this.element.select(".user_widget_label").invoke(show?"show":"hide")},getDomNode:function(){return this.element},destroy:function(){this.element.stopObserving("mouseover",this.mObs1),this.element.stopObserving("mouseout",this.mObs2),document.stopObserving("ajaxplorer:user_logged",this.uLoggedObs),document.stopObserving("ajaxplorer:actions_loaded",this.actLoaded),Prototype.Browser.IE&&document.stopObserving("ajaxplorer:actions_refreshed",this.actLoaded),this.menu&&this.menu.destroy(),this.element=null}}),Class.create("LogoWidget",AjxpPane,{_imageParameter:null,_imagePlugin:null,initialize:function($super,element,options){$super(element,options);var paramLocation=options.imageParameter||"gui.ajax/CUSTOM_TOP_LOGO",parts=paramLocation.split("/");this._imagePlugin=parts[0],this._imageParameter=parts[1];var configs=ajaxplorer.getPluginConfigs(this._imagePlugin);if(this.updateConfig(configs),options.link){var linkTitle;options.linkTitle&&(linkTitle=MessageHash[options.linkTitle]?MessageHash[options.linkTitle]:options.linkTitle);var observeElement,clickObs=function(){options.link.startsWith("triggerRepositoryChange:")?ajaxplorer.triggerRepositoryChange(options.link.replace("triggerRepositoryChange:","")):options.linkTarget&&"new"==options.linkTarget?window.open(options.link):document.location.href=options.link};if(this.image)observeElement=this.image;else if(this.titleDiv)observeElement=this.titleDiv;else{var clickable=new Element("div",{title:linkTitle});clickable.setStyle({cursor:"pointer",height:element.getHeight()+"px",position:"absolute",top:0,left:0,width:"180px"}),element.insert({top:clickable}),observeElement=clickable}linkTitle&&observeElement.writeAttribute("title",linkTitle),observeElement.observe("click",clickObs),observeElement.addClassName("linked")}},updateConfig:function(configs){configs.get("CUSTOM_TOP_TITLE")?(this.titleDiv?this.titleDiv.update(configs.get("CUSTOM_TOP_TITLE")):(this.titleDiv=new Element("div",{className:"custom_top_title"}).update(configs.get("CUSTOM_TOP_TITLE")),this.htmlElement.insert(this.titleDiv)),configs.get(this._imageParameter)&&"ajxp-remove-original"!=configs.get(this._imageParameter)||(this.image&&(this.image.parentNode&&this.image.remove(),this.image=null),this.resizeImage(configs,!0))):this.titleDiv&&(this.titleDiv.remove(),this.titleDiv=null);var defaultImage=pydio.Registry.getDefaultImageFromParameters(this._imagePlugin,this._imageParameter);if((configs.get(this._imageParameter)||defaultImage)&&"ajxp-remove-original"!=configs.get(this._imageParameter)){var parameter="binary_id";configs.get(this._imageParameter+"_ISTMP")&&(parameter="tmp_file");var url;configs.get(this._imageParameter)?(url=window.ajxpServerAccessPath+"&get_action=get_global_binary_param&"+parameter+"="+configs.get(this._imageParameter),0===configs.get(this._imageParameter).indexOf("plugins/")&&(url=configs.get(this._imageParameter))):(url=defaultImage,this.imageIsDefault=!0,$A([this._imageParameter+"_H",this._imageParameter+"_W",this._imageParameter+"_L",this._imageParameter+"_T"]).each(function(param){var v=XPathGetSingleNodeText(ajaxplorer.getXmlRegistry(),"plugins/*[@id='gui.ajax']/server_settings/global_param[@name='"+param+"']/@default");v||(v=0),configs.set(param,parseInt(v))})),this.image?this.image.src!=url&&(this.image.src=url,this.image.onload=function(){this.resizeImage(configs,!1)}.bind(this)):(this.image=new Image,this.image.addClassName("custom_logo_image"),this.image.src=url,this.image.onload=function(){this.resizeImage(configs,!0)}.bind(this))}else"ajxp-remove-original"==configs.get(this._imageParameter)&&this.image&&(this.image.parentNode&&this.image.remove(),this.image=null,this.htmlElement.setAttribute("style",""))},resizeImage:function(configs,insert){var imgH,imgW;if(this.image){var w=this.image.width,h=this.image.height;configs.get(this._imageParameter+"_H")?(imgH=parseInt(configs.get(this._imageParameter+"_H"))||h,imgW=parseInt(imgH*w/h)):configs.get(this._imageParameter+"_W")&&(imgW=parseInt(configs.get(this._imageParameter+"_W")),imgH=parseInt(imgW*h/w)),imgW||(imgW=w,imgH=h);var imgTop=parseInt(configs.get(this._imageParameter+"_T"))||0,imgLeft=parseInt(configs.get(this._imageParameter+"_L"))||0;this.image.setStyle({position:"absolute",height:imgH+"px",width:"auto",top:imgTop+"px",left:imgLeft+"px"}),this.image.writeAttribute("width",""),this.image.writeAttribute("height","")}else imgW=-3,imgH=0;if(this.htmlElement.setStyle({paddingTop:"orbit"==ajxpBootstrap.parameters.get("theme")?0:"9px"}),this.htmlElement.getHeight()&&imgH>parseInt(this.htmlElement.getHeight())){var elPadding=parseInt(this.htmlElement.getStyle("paddingTop"))+(imgH-parseInt(this.htmlElement.getHeight()));"orbit"==ajxpBootstrap.parameters.get("theme")&&(elPadding+=9),this.htmlElement.setStyle({paddingTop:elPadding+"px"})}var htHeight=parseInt(this.htmlElement.getHeight()),has_by=!1;configs.get("SKIP_BY_LOGO")||this.imageIsDefault?this.htmlElement.setStyle({backgroundImage:"none"}):(this.htmlElement.setStyle({backgroundImage:"url("+window.ajxpResourcesFolder+"/images/white_by.png)",backgroundSize:"66px",backgroundPosition:imgW+16+"px "+(htHeight-18)+"px"}),has_by=!0),this.titleDiv&&this.titleDiv.setStyle({position:"absolute",left:imgW+16+"px",top:htHeight-(has_by?42:39)+"px",fontSize:"19px"}),this.htmlElement.down("img.custom_logo_image")||this.htmlElement.insert(this.image),this.htmlElement.down("div.linked")&&this.htmlElement.down("div.linked").setStyle({height:htHeight+"px"})}}),Class.create("AjxpAutocompleter",Autocompleter.Base,{initialize:function(element,update,url,options){Object.isString(update)&&!$(update)&&document.getElementsByTagName("body")[0].appendChild(new Element("div",{id:update,className:"autocomplete",style:"position:absolute; display:none;"})),this.baseInitialize(element,update,options),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=ajxpServerAccessPath+"&get_action=ls&options=dz",this.options.paramName="dir",this.options.minChars=1},getUpdatedChoices:function(){this.startIndicator();var value=this.getToken(),entry=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(value.substring(0,value.lastIndexOf("/")+1));this.options.parameters=this.options.callback?this.options.callback(this.element,entry):entry,this.options.defaultParams&&(this.options.parameters+="&"+this.options.defaultParams),new Ajax.Request(this.url,this.options)},onComplete:function(request){var oXmlDoc=request.responseXML,token=this.getToken(),dirs=$A();if(null==oXmlDoc||null==oXmlDoc.documentElement)return void this.updateChoices("");for(var root=oXmlDoc.documentElement,cs=root.childNodes,l=cs.length,i=0;l>i;i++)if("tree"==cs[i].tagName){var text=getBaseName(cs[i].getAttribute("filename")),hasCharAfterSlash=token.lastIndexOf("/")<token.length-1;if(hasCharAfterSlash){var afterSlash=token.substring(token.lastIndexOf("/")+1,token.length);0==text.indexOf(afterSlash)&&(dirs[dirs.length]=text)}else dirs[dirs.length]=text}if(!dirs.length)return void this.updateChoices("");var responseText="<ul>";dirs.each(function(dir){var value=token.substring(0,token.lastIndexOf("/")+1);responseText+="<li>"+value+dir+"</li>"}),responseText+="</ul>",this.updateChoices(responseText)}}),Class.create("AjxpUsersCompleter",Ajax.Autocompleter,{createUserEntry:function(isGroup,isTemporary,entryId,entryLabel,skipObservers){var spanLabel=new Element("span",{className:"user_entry_label"}).update(entryLabel),li=new Element("div",{className:"user_entry"}).update(spanLabel);return isGroup?li.addClassName("group_entry"):isTemporary&&li.addClassName("user_entry_temp"),li.writeAttribute("data-entry_id",entryId),li.insert({bottom:'<span style="display: none;" class="delete_user_entry icon-remove-sign">&nbsp;</span>'}),skipObservers||(li.observe("mouseover",function(event){li.down("span.delete_user_entry").show()}),li.observe("mouseout",function(event){li.down("span.delete_user_entry").hide()}),li.down("span.delete_user_entry").observe("click",function(){Effect.RowFade(li,{duration:.3,afterFinish:li.remove.bind(li)})}),li.appendToList=function(htmlObject){htmlObject.insert({bottom:li}),Effect.RowAppear(li,{duration:.3})}),li},initialize:function(textElement,listElement,update,options){var entryTplGenerator=this.createUserEntry.bind(this);if(!options.indicator,options.minChars||(options.minChars=3),options.tmpUsersPrefix)var pref=options.tmpUsersPrefix;if(options.updateUserEntryAfterCreate)var entryTplUpdater=options.updateUserEntryAfterCreate;if(options.createUserPanel)var createUserPanel=options.createUserPanel.panel,createUserPass=options.createUserPanel.pass,createUserConfirmPass=options.createUserPanel.confirmPass;else var createActionPanel=new Element("div",{id:"create_sub_user"}).update('<div class="dialogContentMainTitle">'+MessageHash[484]+"</div>");if(listElement&&pydio.getController().actions.get("user_team_create")){var butt=new Element("span",{className:"icon-save user_team_save","data-simpleTooltipTitle":MessageHash[509]});listElement.insert({after:butt}),modal.simpleTooltip(butt,"","top center","down_arrow_tip","element"),butt.observe("click",function(){var label=window.prompt(MessageHash[510]);if(label){var params=$H({"user_ids[]":[],team_label:label,get_action:"user_team_create"});listElement.select("div.user_entry").each(function(el){params.get("user_ids[]").push(el.readAttribute("data-entry_id"))});var c=new Connexion;c.setParameters(params),c.sendAsync()}})}options=Object.extend({paramName:"value",tokens:[",","\n"],frequency:.7,tmpUsersPrefix:"",updateUserEntryAfterCreate:null,createUserPanel:null,usersOnly:!1,existingOnly:!1,afterUpdateElement:function(element,selectedLi){if(listElement){var label=(Math.random(),selectedLi.getAttribute("data-label")),entryId=selectedLi.getAttribute("data-entry_id");selectedLi.getAttribute("data-temporary")&&pref&&!label.startsWith(pref)&&(label=pref+label);var li=entryTplGenerator(selectedLi.getAttribute("data-group")?!0:!1,selectedLi.getAttribute("data-temporary")?!0:!1,selectedLi.getAttribute("data-group")?selectedLi.getAttribute("data-group"):entryId?entryId:label,label);if(entryTplUpdater&&entryTplUpdater(li),selectedLi.getAttribute("data-temporary")&&null!=createUserPanel)element.readOnly=!0,createUserPass.setValue(""),createUserConfirmPass.setValue(""),element.setValue(MessageHash[449].replace("%s",label)),createUserPanel.select("div.dialogButtons>input").invoke("addClassName","dialogButtons"),createUserPanel.select("div.dialogButtons>input").invoke("stopObserving","click"),createUserPanel.select("div.dialogButtons>input").invoke("observe","click",function(event){Event.stop(event);var close=!1;"ok"==event.target.name?!createUserPass.value||createUserPass.value.length<parseInt(window.ajaxplorer.getPluginConfigs("core.auth").get("PASSWORD_MINLENGTH"))?alert(MessageHash[378]):createUserPass.getValue()==createUserConfirmPass.getValue()&&(li.NEW_USER_PASSWORD=createUserPass.getValue(),li.appendToList(listElement),close=!0):event.target.name.startsWith("can")&&(close=!0),close&&(element.setValue(""),element.readOnly=!1,Effect.BlindUp("create_shared_user",{duration:.4}),createUserPanel.select("div.dialogButtons>input").invoke("removeClassName","dialogButtons"))}),Effect.BlindDown(createUserPanel,{duration:.6,transition:Effect.Transitions.spring,afterFinish:function(){createUserPass.focus()}});else if(selectedLi.getAttribute("data-temporary")&&createActionPanel){element.readOnly=!0,createActionPanel.update("");for(var params=$A(ajaxplorer.getPluginConfigs("conf").get("NEWUSERS_EDIT_PARAMETERS").split(",")),i=0;i<params.length;i++)params[i]="user/preferences/pref[@exposed]|//param[@name='"+params[i]+"']";var f=new FormManager,def1=$A();def1.push($H({description:MessageHash[533],editable:!1,expose:"true",label:MessageHash[522],name:"new_user_id",scope:"user",type:"string",mandatory:"true"}),$H({description:MessageHash[534],editable:"true",expose:"true",label:MessageHash[523],name:"new_password",scope:"user",type:"password-create",mandatory:"true"}),$H({description:MessageHash[536],editable:"true",expose:"true",label:MessageHash[535],name:"send_email",scope:"user",type:"boolean","default":"",mandatory:!0}));var definitions=f.parseParameters(ajaxplorer.getXmlRegistry(),params.join("|"));definitions.each(function(el){def1.push(el)});var defaultValues=$H();defaultValues.set("lang",ajaxplorer.currentLanguage),defaultValues.set("new_user_id",label),defaultValues.set("new_password",""),f.createParametersInputs(createActionPanel,def1,!0,defaultValues,!1,!0);var parent=listElement.up("div.dialogContent")||listElement.up("div");modal.showSimpleModal(parent,createActionPanel,function(){var params=$H(),f=new FormManager,missing=f.serializeParametersInputs(createActionPanel,params,"NEW_");if(missing)return!1;var conn=new Connexion;params.set("get_action","user_create_user"),conn.setParameters(params),conn.setMethod("POST");var success=!1;return conn.onComplete=function(transport){if("SUCCESS"==transport.responseText){var id=createActionPanel.down('[name="new_user_id"]').getValue(),label=id;createActionPanel.down('[name="USER_DISPLAY_NAME"]')&&(label=createActionPanel.down('[name="USER_DISPLAY_NAME"]').getValue(),label||(label=id)),element.setValue("");var li=entryTplGenerator(!1,!1,id,label);entryTplUpdater&&entryTplUpdater(li),li.appendToList(listElement),success=!0}else pydio.getController().parseXmlMessage(transport.responseXML),success=!1},conn.sendSync(),success&&(element.readOnly=!1),success},function(){return element.setValue(""),element.readOnly=!1,!0})}else element.setValue(""),li.appendToList(listElement)}}},options),this.baseInitialize(textElement,update,options),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=this.options.url||window.ajxpServerAccessPath+"&get_action=user_list_authorized_users",this.options.usersOnly&&(this.url+="&users_only=true"),this.options.existingOnly&&(this.url+="&existing_only=true"),listElement&&(this.options.onComplete=function(transport){var tmpElement=new Element("div");tmpElement.update(transport.responseText),listElement.select("div.user_entry").each(function(li){var found=tmpElement.down('[data-label="'+li.getAttribute("data-entry_id")+'"]');found&&found.remove()}),this.updateChoices(tmpElement.innerHTML)}.bind(this)),Prototype.Browser.IE&&$(document.body).insert(update),textElement.observe("click",function(){this.activate()}.bind(this))}}),Class.create("TreeSelector",{initialize:function(oElement,options){this.htmlElement=oElement,this.options=Object.extend({filterSelectorId:'select[id="external_repository"]',targetField:'input[name="dest"]',targetNode:'input[name="dest_node"]',treeContainer:".treeCopyContainer",nodeFilter:function(ajxpNode){return!ajxpNode.isLeaf()}},options||{})},load:function(rootNode){webFXTreeHandler&&webFXTreeHandler.selected&&(this.__initialWebFXSelection=webFXTreeHandler.selected),this.filterSelector=this.htmlElement.select(this.options.filterSelectorId)[0];var target=this.targetField=this.htmlElement.select(this.options.targetField)[0],targetNode=this.targetNode=this.htmlElement.select(this.options.targetNode)[0];this.treeContainer=this.htmlElement.select(this.options.treeContainer)[0],this.filterSelector.hide(),this._nodeActionCallback=function(e){target.value=this.ajxpNode.getPath(),targetNode.value=this.ajxpNode.getPath(),this.select()},rootNode||(rootNode=new AjxpNode("/",!1,MessageHash[373],"folder.png")),this.treeCopy=new AJXPTree(rootNode,this._nodeActionCallback,this.options.nodeFilter),this.treeContainer.update(this.treeCopy.toString()),$(this.treeCopy.id).observe("click",function(e){this.action(),Event.stop(e)}.bind(this.treeCopy)),this.treeCopy.focus(),this.treeCopy.setAjxpRootNode(rootNode)},unload:function(){this.__initialWebFXSelection&&this.__initialWebFXSelection.select(),this.treeCopy.remove()},getSelectedNode:function(){return this.targetNode.getValue()},getSelectedLabel:function(){return this.target.getValue()},setFilterShow:function(bool){bool?this.filterSelector.show():this.filterSelector.hide()},getFilterActive:function(refValue){return this.filterSelector.visible()?!(refValue&&this.filterSelector.getValue()==refValue):!1},appendFilterValue:function(key,value,position){var obj,newOption=new Element("option",{value:key}).update(value);obj="top"==position?{top:newOption}:newOption,this.filterSelector.insert(obj)},setFilterSelectedIndex:function(index){this.filterSelector.selectedIndex=index},setFilterChangeCallback:function(func){this.filterSelector.observe("change",func.bind(this))},resetAjxpRootNode:function(ajxpNode){this.treeCopy.ajxpNode.clear(),this.treeCopy.setAjxpRootNode(ajxpNode),this.treeCopy.ajxpNode.load()}}),Class.create("SliderInput",{initialize:function(inputElement,options){this.input=$(inputElement),this.options=Object.extend({format:"",axis:"vertical",onChange:Prototype.emptyFunction,onSlide:Prototype.emptyFunction,topOffset:2,leftOffset:3,range:$R(0,1),alignY:6,anchorActiveClass:"slider-anchor-active"},options||{});var original=this.options.onSlide;this.options.onSlide=function(value){this.input.value=value,original(value),this.delay()}.bind(this),this.options.sliderValue&&(this.input.value=this.options.sliderValue),this.buildGui()},buildGui:function(){this.holder=new Element("div",{className:"slider-pane"}),this.trackerTop=new Element("div",{className:"slider-tracker-top",style:"width:10px;height:2px;font-size:1px;"}).update(""),this.tracker=new Element("div",{className:"slider-tracker",style:"width:10px;height:90px;"}),this.cursor=new Element("div",{className:"slider-handle"}),this.holder.insert(this.trackerTop),this.holder.insert(this.tracker),this.tracker.insert(this.cursor),this.holder.hide(),$(document.body).insert(this.holder),this.slider=new Control.Slider(this.cursor,this.tracker,this.options),this.showObserver=this.show.bind(this),this.input.getAttribute("type")&&"image"==this.input.getAttribute("type")||"input"!=this.input.nodeName?this.input.observe("click",this.showObserver):this.input.observe("focus",this.showObserver),this.docObserver=function(event){var element=Event.findElement(event);!element.descendantOf||element.descendantOf(this.holder)||element.descendantOf(this.input)||element==this.holder||element==this.input||this.hide()}.bind(this),document.observe("click",this.docObserver)},destroy:function(){try{this.input.stopObserving("click",this.showObserver),this.input.stopObserving("focus",this.showObserver),document.stopObserving("click",this.docObserver),this.holder.remove()}catch(e){}},setValue:function(value){var original=this.slider.options.onChange;this.slider.options.onChange=Prototype.emptyFunction,this.slider&&this.slider.setValue(value),this.input&&(this.input.value=value),this.slider.options.onChange=original},show:function(anchor){var pos=this.computeAnchorPosition(this.input);anchor&&!anchor.target&&(pos=this.computeAnchorPosition(anchor)),this.holder.setStyle(pos),this.slider.setValue(parseFloat(this.input.value)),this.holder.show(),this.input.addClassName(this.options.anchorActiveClass),anchor&&!anchor.target&&anchor.addClassName(this.options.anchorActiveClass),this.delay()},hide:function(){this.holder.hide(),this.timer&&window.clearTimeout(this.timer);try{this.input.blur()}catch(e){}this.input.removeClassName(this.options.anchorActiveClass)},delay:function(){this.timer&&window.clearTimeout(this.timer)},computeAnchorPosition:function(anchor){var anchorPosition=Position.cumulativeOffset($(anchor)),anchorScroll=anchor.cumulativeScrollOffset(),topPos=anchorPosition[1]+anchor.getHeight()+this.options.topOffset-anchorScroll[1],leftPos=anchorPosition[0]+this.options.leftOffset-anchorScroll[0];
return{top:topPos+"px",left:leftPos+"px"}}}),Class.create("ActionsToolbar",AjxpPane,{__implements:"IAjxpWidget",initialize:function($super,oElement,options){$super(oElement,options),this.element=oElement,this.element.ajxpPaneObject=this,this.options=Object.extend({buttonRenderer:"this",skipBubbling:!0,toolbarsList:$A(["default","put","get","change","user","remote"]),groupOtherToolbars:$A([]),skipCarousel:!0,manager:null,dataModelElementId:null},options||{});var renderer=this.options.buttonRenderer;"this"==renderer?this.options.buttonRenderer=this:this.options.buttonRenderer=new renderer,this.toolbars=$H(),this.options.skipCarousel||this.initCarousel(),this.options.styles&&(this.buildActionBarStylingMenu(),this.style=this.options.defaultStyle,this.styleObserver=function(){this.getUserPreference("action_bar_style")?this.style=this.getUserPreference("action_bar_style"):this.style=this.options.defaultStyle,this.switchStyle(!1,!0)}.bind(this),document.observe("ajaxplorer:user_logged",this.styleObserver)),attachMobileScroll(oElement.id,"horizontal"),this.actionsLoadedObserver=this.actionsLoaded.bind(this),this.refreshToolbarObserver=this.refreshToolbarsSeparator.bind(this),this.componentConfigHandler=function(event){"ActionsToolbar"==event.memo.className&&this.parseComponentConfig(event.memo.classConfig.get("all"))}.bind(this),this.options.manager?(this.options.manager.observe("actions_loaded",this.actionsLoadedObserver),this.options.manager.observe("actions_refreshed",this.refreshToolbarObserver)):this.options.dataModelElementId?(this.options.manager=new Controller(pydio,this.options.dataModelElementId),this.options.manager.observe("actions_loaded",this.actionsLoadedObserver),this.options.manager.observe("actions_refreshed",this.refreshToolbarObserver),this.actionsLoaded(null)):(document.observe("ajaxplorer:actions_loaded",this.actionsLoadedObserver),document.observe("ajaxplorer:actions_refreshed",this.refreshToolbarObserver)),document.observe("ajaxplorer:component_config_changed",this.componentConfigHandler)},getDomNode:function(){return this.element},destroy:function($super){this.emptyToolbars(),this.options.manager?(this.options.manager.stopObserving("actions_loaded",this.actionsLoadedObserver),this.options.manager.stopObserving("actions_refreshed",this.refreshToolbarObserver),this.options.manager.destroy()):(document.stopObserving("ajaxplorer:actions_loaded",this.actionsLoadedObserver),document.stopObserving("ajaxplorer:actions_refreshed",this.refreshToolbarObserver)),document.stopObserving("ajaxplorer:component_config_changed",this.componentConfigHandler),this.styleObserver&&document.stopObserving("ajaxplorer:user_logged",this.styleObserver),$super()},parseComponentConfig:function(domNode){var config=XPathSelectSingleNode(domNode,'property[@name="style"]');if(config){var value=config.getAttribute("value");this.options.styles&&this.options.styles[value]&&(this.style=value,this.switchStyle())}},actionsLoaded:function(event){event&&event.memo?this.actions=ProtoCompat.map2hash(event.memo):this.options.manager&&(this.actions=ProtoCompat.map2hash(this.options.manager.actions)),this.emptyToolbars(),this.actions&&this.initToolbars()},initToolbars:function(){if(this.registeredButtons=$A(),this.actions.each(function(pair){var action=pair.value,actionName=pair.key;action.context.actionBar&&$A(action.context.actionBarGroup.split(",")).each(function(barGroup){null==this.toolbars.get(barGroup)&&this.toolbars.set(barGroup,[]),this.toolbars.get(barGroup).push(actionName)}.bind(this))}.bind(this)),this.options.groupOtherToolbars.length){var submenuItems=[];this.options.groupOtherToolbars.each(function(otherToolbar){var otherActions=this.toolbars.get(otherToolbar);otherActions&&(otherActions.each(function(act){submenuItems.push({actionId:act})}),otherToolbar!=this.options.groupOtherToolbars.last()&&submenuItems.push({separator:!0}))}.bind(this));var moreAction=new Action({name:"group_more_action",src:"view_icon.png",icon_class:"icon-none",text:MessageHash[456],title:MessageHash[456],hasAccessKey:!1,subMenu:!0,callback:function(){}},{selection:!1,dir:!0,actionBar:!0,actionBarGroup:"get",contextMenu:!1,infoPanel:!1},{},{},{dynamicItems:submenuItems});pydio.getController().registerAction(moreAction),this.actions.set("group_more_action",moreAction);try{this.toolbars.get($A(this.options.toolbarsList).last()).push("group_more_action")}catch(e){}}var crtCount=0,toolbarsList=this.options.toolbarsList;toolbarsList.each(function(toolbar){var tBar=this.initToolbar(toolbar);if(tBar&&tBar.actionsCount){if(crtCount<toolbarsList.size()-1){var separator=new Element("div");separator.addClassName("separator"),tBar.insert({top:separator})}this.element.insert(tBar),crtCount++}}.bind(this)),this.element.select("a").each(disableTextSelection)},refreshToolbarsSeparator:function(){this.toolbars.each(function(pair){var toolbar=this.element.select('[id="'+pair.key+'_toolbar"]')[0];if(toolbar){var sep=toolbar.select("div.separator")[0];if(sep){var hasVisibleActions=!1;toolbar.select("a").each(function(action){action.visible()&&(hasVisibleActions=!0)}),hasVisibleActions?sep.show():sep.hide()}}}.bind(this)),this.options.skipCarousel||this.refreshSlides()},initToolbar:function(toolbar){if(!this.toolbars.get(toolbar))return"";var toolEl=this.element.down("#"+toolbar+"_toolbar");return toolEl||(toolEl=new Element("div",{id:toolbar+"_toolbar",className:"toolbarGroup"})),toolEl.actionsCount=0,this.toolbars.get(toolbar).each(function(actionName){var action=this.actions.get(actionName);if(action){var button=this.renderToolbarAction(action);toolEl.insert(button),toolEl.actionsCount++}}.bind(this)),toolEl},emptyToolbars:function(){this.registeredButtons&&this.registeredButtons.each(function(button){if(button.ACTION&&button.OBSERVERS){button.OBSERVERS.each(function(pair){button.ACTION.stopObserving(pair.key,pair.value)});try{button.remove()}catch(e){}}}),this.element.subMenus&&this.element.subMenus.invoke("destroy"),this.element.select("div").each(function(divElement){divElement.remove()}.bind(this)),this.toolbars=new Hash},initCarousel:function(){this.outer=this.element;var origHeight=this.outer.getHeight()-1;this.prev=new Element("a",{className:"carousel-control",rel:"prev",style:"height:"+origHeight+"px;"}).update(new Element("img",{src:ajxpResourcesFolder+"/images/arrow_left.png"})),this.next=new Element("a",{className:"carousel-control",rel:"next",style:"float:right;height:"+origHeight+"px;"}).update(new Element("img",{src:ajxpResourcesFolder+"/images/arrow_right.png"})),this.inner=new Element("div",{id:"buttons_inner",style:"width:1000px;"}),this.outer.insert({before:this.prev}),this.outer.insert({before:this.next}),this.outer.insert(this.inner),Prototype.Browser.IE&&this.outer.setStyle({cssFloat:"left"}),this.element=this.inner,this.carousel=new Carousel(this.outer,[],$A([this.prev,this.next]),{duration:.1})},refreshSlides:function(){var allSlides=$A();this.inner.select("a").each(function(a){a.visible()&&allSlides.push(a)}),this.carousel.refreshSlides(allSlides),this.resize()},renderToolbarAction:function(action){var button=new Element("a",{href:action.options.name,id:action.options.name+"_button"}).observe("click",function(e){Event.stop(e),this.options.subMenu||this.apply()}.bind(action)),icSize=this.options.defaultIconSize?this.options.defaultIconSize:22;this.options.stylesImgSizes&&this.style&&this.options.stylesImgSizes[this.style]&&(icSize=this.options.stylesImgSizes[this.style]);var img;if(action.options.icon_class&&window.ajaxplorer.currentThemeUsesIconFonts)img=new Element("span",{className:action.options.icon_class+" ajxp_icon_span",title:action.options.title});else{var imgPath=resolveImageSource(action.options.src,action.__DEFAULT_ICON_PATH,icSize);img=new Element("img",{id:action.options.name+"_button_icon",className:"actionbar_button_icon",src:imgPath,width:icSize,height:icSize,border:0,alt:action.options.title,title:action.options.title,"data-action-src":action.options.src})}var titleSpan=new Element("span",{id:action.options.name+"_button_label",className:"actionbar_button_label"});if(button.insert(img).insert(titleSpan.update(action.getKeyedText())),action.options.subMenu)if(this.buildActionBarSubMenu(button,action),window.ajaxplorer.currentThemeUsesIconFonts)button.insert(new Element("span",{className:"icon-caret-down ajxp_icon_arrow"}));else{button.setStyle({position:"relative"});var arrowDiv=new Element("div",{className:"actionbar_arrow_div"});arrowDiv.insert(new Element("img",{src:ajxpResourcesFolder+"/images/arrow_down.png",height:6,width:10,border:0})),arrowDiv.imgRef=img,button.insert(arrowDiv)}else this.options.skipBubbling||(button.observe("mouseover",function(){this.buttonStateHover(button,action)}.bind(this)),button.observe("mouseout",function(){this.buttonStateOut(button,action)}.bind(this)));return this.options.skipBubbling||img.setStyle("width:18px;height:18px;margin-top:8px;"),button.hideButton=function(){this.hide(),this.removeClassName("action_visible"),this.addClassName("action_hidden")}.bind(button),button.showButton=function(){this.show(),this.removeClassName("action_hidden"),this.addClassName("action_visible")}.bind(button),button.hideButton(),this.attachListeners(button,action),this.registeredButtons||(this.registeredButtons=$A()),this.registeredButtons.push(button),button},attachListeners:function(button,action){if(this.options.attachToNode){action.fireContextChange(ajaxplorer.usersEnabled,ajaxplorer.user,this.options.attachToNode.getParent());var fakeDm=new PydioDataModel;return fakeDm.setSelectedNodes([this.options.attachToNode]),action.fireSelectionChange(fakeDm),action.deny?button.hideButton():button.showButton(),void(button.ACTION=action)}button.OBSERVERS=$H(),button.OBSERVERS.set("hide",function(){button.hideButton()}.bind(this)),button.OBSERVERS.set("show",function(){button.showButton()}.bind(this)),button.OBSERVERS.each(function(pair){action.observe(pair.key,pair.value)}),button.ACTION=action,action.observe("hide",function(){button.hideButton()}.bind(this)),action.observe("show",function(){button.showButton()}.bind(this)),action.observe("disable",function(){button.addClassName("disabled")}.bind(this)),action.observe("enable",function(){button.removeClassName("disabled")}.bind(this)),action.observe("update_label",function(newLabel){button.down("span.actionbar_button_label").update(newLabel)}.bind(this)),action.observe("update_title",function(newTitle){button.title=newTitle}.bind(this)),action.observe("update_icon",function(data){var previousIconClass=data.previous_class,iconClass=data.new_class,iconSrc=data.new_src;window.ajaxplorer.currentThemeUsesIconFonts?iconClass&&button.down("span.ajxp_icon_span")&&(button.down("span.ajxp_icon_span").removeClassName(previousIconClass),button.down("span.ajxp_icon_span").addClassName(iconClass)):button.down("img.actionbar_button_icon")&&(button.down("img.actionbar_button_icon").src=resolveImageSource(iconSrc,action.__DEFAULT_ICON_PATH,22))}.bind(this)),action.observe("submenu_active",function(submenuItem){if(submenuItem.src&&action.options.subMenuUpdateImage){var images=button.select('img[id="'+action.options.name+'_button_icon"]');if(images.length){var icSize=22;this.options.stylesImgSizes&&this.style&&this.options.stylesImgSizes[this.style]&&(icSize=this.options.stylesImgSizes[this.style]),images[0].src=resolveImageSource(submenuItem.src,action.__DEFAULT_ICON_PATH,icSize),action.options.src=submenuItem.src}}}.bind(this)),action.observe("remove",function(){button.stopObserving(),button.parentNode&&button.remove()})},buildActionBarSubMenu:function(button,action){var subMenu=new Proto.Menu({mouseClick:"over",anchor:button,className:"menu desktop toolbarmenu"+(this.options.submenuClassName?" "+this.options.submenuClassName:""),topOffset:this.options.submenuOffsetTop?this.options.submenuOffsetTop:0,leftOffset:this.options.submenuOffsetLeft?this.options.submenuOffsetLeft:0,parent:this.element,menuItems:action.subMenuItems.staticOptions||[],menuTitle:action.options.text,fade:!0,zIndex:2e3,position:this.options.submenuPosition?this.options.submenuPosition:"bottom"});subMenu.options.beforeShow=function(){button.addClassName("menuAnchorSelected"),this.options.skipBubbling||this.buttonStateHover(button,action),action.subMenuItems.dynamicBuilder&&action.subMenuItems.dynamicBuilder(subMenu)}.bind(this),subMenu.options.beforeHide=function(){button.removeClassName("menuAnchorSelected"),this.options.skipBubbling||this.buttonStateOut(button,action)}.bind(this),this.element.subMenus||(this.element.subMenus=$A([])),this.element.subMenus.push(subMenu)},buildActionBarStylingMenu:function(){this.stylingMenu=new Proto.Menu({mouseClick:"right",selector:$(this.element.parentNode),anchor:"mouse",className:"menu desktop textual",topOffset:0,leftOffset:0,parent:this.element,menuItems:[],beforeShow:function(){this.stylingMenu.options.menuItems=this.listStyleMenuItems()}.bind(this),fade:!0,zIndex:2e3})},listStyleMenuItems:function(){var items=[],oThis=this;for(var k in this.options.styles)items.push({name:this.options.styles[k],alt:k,image:resolveImageSource(k==this.style?"button_ok.png":"transp.png",Action.prototype.__DEFAULT_ICON_PATH,16),isDefault:k==this.style,callback:function(){oThis.switchStyle(this)}});return items},switchStyle:function(command,start){var style=this.style;command&&("img"==command.nodeName.toLowerCase()&&(command=command.up("a")),style=command.getAttribute("title"),this.style=style);for(var parent=this.element.up("div[@ajxpClass]");void 0!=parent.up("div[@ajxpClass]");)parent=parent.up("div[@ajxpClass]");var actBar=this.element.up("div.action_bar"),applyResize=function(){for(var k in this.options.styles)k!=style&&this.element.parentNode.removeClassName(k);this.element.parentNode.addClassName(style),this.options.stylesImgSizes&&this.options.stylesImgSizes[style]&&this.element.select("img.actionbar_button_icon").each(function(img){img.src=resolveImageSource(img.getAttribute("data-action-src"),Action.prototype.__DEFAULT_ICON_PATH,this.options.stylesImgSizes[style])}.bind(this)),parent.ajxpPaneObject&&parent.ajxpPaneObject.resize(),start||this.setUserPreference("action_bar_style",style)}.bind(this);this.options.stylesBarSizes&&this.options.stylesBarSizes[style]?new Effect.Morph(actBar,{style:"height:"+this.options.stylesBarSizes[style]+"px",duration:.5,afterFinish:applyResize,afterUpdate:function(){actBar.select("div.separator").invoke("setStyle",{height:actBar.getHeight()-1+"px"}),parent.ajxpPaneObject&&parent.ajxpPaneObject.resize()}}):applyResize()},buttonStateHover:function(button,action){button.hasClassName("disabled")||(button.hideTimeout&&clearTimeout(button.hideTimeout),new Effect.Morph(button.select('img[id="'+action.options.name+'_button_icon"]')[0],{style:"width:22px; height:22px;margin-top:3px;",duration:.08,transition:Effect.Transitions.sinoidal,afterFinish:function(){this.updateTitleSpan(button.select("span")[0],"big")}.bind(this)}))},buttonStateOut:function(button,action){button.hasClassName("disabled")||(button.hideTimeout=setTimeout(function(){new Effect.Morph(button.select('img[id="'+action.options.name+'_button_icon"]')[0],{style:"width:18px; height:18px;margin-top:8px;",duration:.2,transition:Effect.Transitions.sinoidal,afterFinish:function(){this.updateTitleSpan(button.select("span")[0],"small")}.bind(this)})}.bind(this),10))},updateTitleSpan:function(span,state){if(!span.orig_width&&"big"==state){var origWidth=span.getWidth();span.setStyle({display:"block",width:origWidth,overflow:"visible",padding:0}),span.orig_width=origWidth}span.setStyle({fontSize:"big"==state?"11px":"9px"})},resize:function($super){if($super(),!this.options.skipCarousel){var innerSize=0,parentWidth=$(this.outer).parentNode.getWidth();Prototype.Browser.IE&&(parentWidth=$(this.outer).getOffsetParent().getWidth()-4);var visibles=[],buttons=this.inner.select("a");if(buttons.each(function(a){a.visible()&&visibles.push(a)}),visibles.length){var last=visibles[visibles.length-1];innerSize=last.cumulativeOffset()[0]+last.getWidth()}if(innerSize>parentWidth){var h=parseInt(this.element.up("div.action_bar").getHeight())-1,m=parseInt((h-10)/2);h-=m,this.prev.setStyle({height:h+"px",paddingTop:m+"px"}),this.next.setStyle({height:h+"px",paddingTop:m+"px"}),this.prev.show(),this.next.show(),this.outer.setStyle({width:parentWidth-this.prev.getWidth()-this.next.getWidth()+"px"})}else this.prev.hide(),this.next.hide(),this.carousel.first(),this.outer.setStyle({width:parentWidth+"px"})}},showElement:function(show){}}),Class.create("BackgroundManagerPane",{initialize:function(actionManager){actionManager||(actionManager=pydio.getController()),this.bgManager=actionManager.getBackgroundTasksManager(),this.bgManager&&(this.insertPanel(),this.bgManager.observe("update_message",this.updatePanelMessage.bind(this)),this.bgManager.observe("update_message_error",this.updatePanelError.bind(this)),this.bgManager.observe("tasks_finished",this.hidePanel.bind(this)))},insertPanel:function(){this.panel=new Element("div").addClassName("backgroundPanel"),Prototype.Browser.IE&&this.panel.setStyle({width:"35%"}),this.panel.hide(),document.body.insert(this.panel)},updatePanelMessage:function(message){var imgString='<img src="'+ajxpResourcesFolder+'/images/loadingImage.gif" width="16" align="absmiddle">';this.panel.update(imgString+" "+message),Effect.Appear(this.panel)},updatePanelError:function(errorMessage){this.panel.update(errorMessage),this.panel.insert(this.makeCloseLink())},hidePanel:function(){Effect.SwitchOff(this.panel)},makeCloseLink:function(){return new Element("a",{href:"#"}).update("Close").observe("click",function(e){Event.stop(e),this.hidePanel()}.bind(this))}}),Class.create("HeaderResizer",{initialize:function(element,options){this.element=element,this.options=Object.extend({initSizes:null,initSizesType:"percent",cellSelector:"div.header_cell",handleSelector:"div.resizer",body:$("tBody"),bodyRowSelector:"tr",bodyCellSelector:"td",bodyIsMaster:!1,filterPanel:null,handleWidth:3,headerData:null,useCSS3:!1,scrollerWidth:18},options||{}),this.filterCells=[],this.options.filterPanel&&this.options.filterPanel.addClassName("header_resizer"),this.options.headerData&&this.generateHeader(),this.options.useCSS3=this.detectCSS3(),this.mainSize=this.element.getWidth(),this.cells=this.element.select(this.options.cellSelector),this.cells.each(function(el){disableTextSelection(el)}),this.options.filterPanel&&(this.filterCells=this.options.filterPanel.select(this.options.cellSelector)),this.element.select(this.options.handleSelector).each(function(el){this.initDraggable(el)}.bind(this));var sizes;sizes=this.options.initSizes?"percent"==this.options.initSizesType?this.computePercentSizes(this.options.initSizes,100):this.options.initSizes:this.computeEqualSizes(),this.resizeHeaders(sizes),this.observe("drag_resize",function(e){this.refreshBody()}.bind(this))},generateHeader:function(){var data=this.options.headerData;this.element.addClassName("header_resizer");var initSizes,index=0;data.each(function(el){if(this.element.insert('<div class="header_cell"><div class="header_label">'+el.label+"</div></div>"),el!=data.last()&&this.element.insert('<div class="resizer">&nbsp;</div>'),el.size&&(initSizes||(initSizes=$A()),initSizes[index]=el.size),this.options.filterPanel){var input=new Element("input",{type:"text",name:el.metaName}),cell=new Element("div",{className:"header_cell"});cell.insert(input),this.options.filterPanel.insert(cell),input.observe("focus",function(){pydio.UI.disableAllKeyBindings()}.bind(this)),input.observe("blur",function(){pydio.UI.enableAllKeyBindings()}.bind(this)),input.observe("input",function(){input.filterTimer&&window.clearTimeout(input.filterTimer),input.filterTimer=window.setTimeout(function(){this.notify("filter_update",{metaName:el.metaName,metaValue:input.getValue()})}.bind(this),200)}.bind(this))}index++}.bind(this)),initSizes&&initSizes.length&&(this.options.initSizes=initSizes)},computeEqualSizes:function(){for(var ratio=1/this.cells.length,sizes=$A(),computeWidth=this.getInnerWidth()-(this.cells.length-1)*this.options.handleWidth,uniqueSize=Math.floor(computeWidth*ratio),i=0;i<this.cells.length;i++)sizes[i]=uniqueSize;return this.log("Compute equal size on "+this.getInnerWidth()+" result:"+sizes.join(",")),sizes},computePercentSizes:function(previousSizes,previousInner){var sizes=$A(),innerWidth=this.getInnerWidth();return previousSizes.each(function(s){sizes.push(Math.round(s*innerWidth/previousInner))}),sizes},getCurrentSizes:function(percent){if(!percent)return this.currentSizes;for(var innerWidth=this.getInnerWidth(),percentSizes=$A(),i=0;i<this.currentSizes.length;i++)percentSizes[i]=Math.floor(this.currentSizes[i]/innerWidth*100);return percentSizes},resize:function(size){this.mainSize=size,this.element.setStyle({width:this.mainSize+"px"}),this.checkBodyScroll(),this.resizeHeaders(),this.log("Resize:"+size),this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout(this.refreshBody.bind(this),50)},resizeHeaders:function(sizes,loop){var innerWidth=this.getInnerWidth();if(innerWidth&&(!sizes&&this.currentInner&&(sizes=this.computePercentSizes(this.currentSizes,this.currentInner)),sizes||(sizes=this.computeEqualSizes()),sizes)){this.log("Inner Width:"+innerWidth+"/"+this.element.offsetWidth);for(var total=0,i=0;i<this.cells.length;i++)sizes[i]||(sizes[i]=Math.floor((innerWidth-(this.verticalScrollerMargin||0)-total)/(this.cells.length-i))),total+=sizes[i]+this.options.handleWidth,i<this.cells.length-1&&innerWidth>total?(this.cells[i].setStyle({width:sizes[i]-(Prototype.Browser.IE?1:0)+"px"}),this.filterCells[i]&&this.filterCells[i].setStyle({width:sizes[i]-(Prototype.Browser.IE?1:0)+"px"})):(total-=sizes[i]+this.options.handleWidth,sizes[i]=Math.floor((innerWidth-(this.verticalScrollerMargin||0)-total)/(this.cells.length-i)),this.cells[i].setStyle({width:sizes[i]+"px"}),this.filterCells[i]&&this.filterCells[i].setStyle({width:sizes[i]+"px"}),Position.cumulativeOffset(this.cells[i])[1]>Position.cumulativeOffset(this.element)[1]+10&&(sizes[i]=innerWidth-total-1-(this.verticalScrollerMargin||0),this.cells[i].setStyle({width:sizes[i]+"px"}),this.filterCells[i]&&this.filterCells[i].setStyle({width:sizes[i]+"px"})),total+=sizes[i]+this.options.handleWidth,i==this.cells.length-1&&total<innerWidth-(this.verticalScrollerMargin||0)&&(sizes[i]=innerWidth-(this.verticalScrollerMargin||0)-total,this.cells[i].setStyle({width:sizes[i]+"px"}),this.filterCells[i]&&this.filterCells[i].setStyle({width:sizes[i]+"px"})));this.currentSizes=sizes,this.log(this.currentSizes.join(",")),this.currentInner=innerWidth,this.notify("headers_resize")}},initDraggable:function(handle){new Draggable(handle,{constraint:"horizontal",snap:function(x,y,draggable){function constrain(n,lower,upper){return n>upper?upper:lower>n?lower:n}var newPosition=Element.cumulativeOffset(draggable.element).left,delta=newPosition-draggable.originalLeft;return(0>x&&-delta>draggable._initLeftCell-10||0>delta&&-delta>draggable._initLeftCell)&&(x=0),x>0&&delta>draggable._initRightCell-10&&(x=0),[constrain(x,-draggable._initLeftCell,draggable._initRightCell),y]},onDrag:function(draggable){for(var newPosition=Element.cumulativeOffset(draggable.element).left,delta=newPosition-draggable.originalLeft,newSizes=$A(),i=0;i<this.cells.length;i++)this.cells[i]==draggable.previous?newSizes[i]=draggable._initLeftCell+delta:newSizes[i]=this.currentSizes[i]-(i==this.cells.length-1?delta:0);this.log(newSizes),draggable.element.setStyle({left:0}),this.resizeHeaders(newSizes),draggable._ghost&&(draggable._ghost.getOffsetParent()&&(newPosition-=draggable._ghost.getOffsetParent().cumulativeOffset()[0]+2),draggable._ghost.setStyle({left:newPosition-(Prototype.Browser.IE?0:this.options.body.scrollLeft)+"px"}))}.bind(this),onStart:function(draggable){draggable.element.addClassName("dragging"),draggable.originalLeft=Element.cumulativeOffset(draggable.element).left,draggable.previous=draggable.element.previous(),draggable.next=draggable.element.next(),draggable._initLeftCell=draggable.previous.getWidth(),draggable._initRightCell=draggable.next.getWidth(),draggable._ghost=this.createResizeGhost(),draggable._ghost&&draggable._ghost.setStyle({left:draggable.originalLeft+"px"})}.bind(this),onEnd:function(draggable){draggable.element.setStyle({left:0}),draggable.element.removeClassName("dragging"),draggable._ghost&&draggable._ghost.remove();for(var i=0;i<this.cells.length;i++)this.cells[i]==draggable.previous&&(this.currentSizes[i]=draggable.previous.getWidth()),this.cells[i]==draggable.next&&(this.currentSizes[i]=draggable.next.getWidth());this.notify("drag_resize")}.bind(this)})},createResizeGhost:function(){if(!this.options.body)return null;var ghost=new Element("div",{className:"resizeGhost"});this.options.body.insert({before:ghost});var h=this.getInnerHeight(this.options.body)-(this.options.body.scrollWidth>this.options.body.getWidth()?16:0);return ghost.setStyle({height:h+"px",left:0}),ghost},refreshBody:function(){var newSizes=this.getCurrentSizes();if(newSizes){var useCSS3=this.options.useCSS3,sheet=this.createStyleSheet();if(Prototype.Browser.IE)return this.options.body.select(this.options.bodyRowSelector).each(function(row){for(var cells=row.select(this.options.bodyCellSelector),i=0;i<cells.length;i++)newSizes[i]&&this.setGridCellWidth(cells[i],newSizes[i])}.bind(this)),void this.checkBodyScroll();for(var i=0;i<newSizes.length;i++){var selector;selector=useCSS3?"#"+this.options.body.id+" td:nth-child("+(i+1)+")":"#"+this.options.body.id+" td.resizer_"+i;var rule="width:"+(newSizes[i]+(Prototype.Browser.IE?10:0))+"px !important;";this.addStyleRule(sheet,selector,rule),selector=useCSS3?"#"+this.options.body.id+" td:nth-child("+(i+1)+") .text_label":"#"+this.options.body.id+" td.resizer_"+i+" .text_label",rule="width:"+(newSizes[i]-(Prototype.Browser.IE?0:(this.options.headerData[i]?this.options.headerData[i].leftPadding:0)+2))+"px !important;",this.addStyleRule(sheet,selector,rule)}this.checkBodyScroll()}},addStyleRule:function(sheet,selector,rule){Prototype.Browser.IE?sheet.addRule(selector,rule):sheet.insertRule(selector+"{"+rule+"}",sheet.cssRules.length)},createStyleSheet:function(){var sheet;if(Prototype.Browser.IE)return null;var cssTag=$("resizer_css-"+this.options.body.id);return cssTag&&cssTag.remove(),cssTag=new Element("style",{type:"text/css",id:"resizer_css-"+this.options.body.id}),$$("head")[0].insert(cssTag),sheet=cssTag.sheet},removeStyleSheet:function(){if(!Prototype.Browser.IE){var cssTag=$("resizer_css-"+this.options.body.id);cssTag&&cssTag.remove()}},detectCSS3:function(){if(Prototype.Browser.IE)return!1;if(void 0!=window.ajxp_resizer_csstest)return window.ajxp_resizer_csstest;var sheet=this.createStyleSheet(),detected=!1;try{this.addStyleRule(sheet,this.options.cellSelector+":nth-child(1)","color:rgb(0, 0, 15);");var test=this.element.down(this.options.cellSelector);test&&"rgb(0, 0, 15)"==test.getStyle("color")&&(detected=!0),this.removeStyleSheet()}catch(e){}return window.ajxp_resizer_csstest=detected,detected},setGridCellWidth:function(cell,width,labelPadding){var label=cell.down(".text_label");if(!label)return void(width&&cell.setStyle({width:width+"px"}));var computedWidth;computedWidth=width?parseInt(width):cell.getWidth()-3;var labelPaddLeft=parseInt(label.getStyle("paddingLeft"))||0,siblingWidth=1+labelPaddLeft+(labelPadding||0);label.siblings().each(function(sib){siblingWidth+=sib.getWidth()}),label.setStyle({width:computedWidth-siblingWidth+"px"}),width&&cell.setStyle({width:computedWidth+"px"})},checkBodyScroll:function(){var body=this.options.body;body.scrollHeight>body.getHeight()?this.verticalScrollerMargin=this.options.scrollerWidth:body.scrollHeight<=body.getHeight()&&(this.verticalScrollerMargin=0),this.options.bodyIsMaster&&(body.scrollWidth>body.getWidth()?(this.scroller?this.scroller.setStyle({width:this.mainSize+"px"}):(this.element._origWidth=this.element.getWidth(),this.scroller=new Element("div",{style:"overflow:hidden;"}),this.scroller.setStyle({width:this.element._origWidth+"px"}),$(this.element.parentNode).insert({top:this.scroller}),this.scroller.insert(this.element),this.scroller.observer=function(){this.log(body.scrollWidth),this.scroller.scrollLeft=body.scrollLeft}.bind(this),body.observe("scroll",this.scroller.observer)),this.element.setStyle({width:body.scrollWidth+"px"}),this.verticalScrollerMargin=0,this.resizeHeaders()):body.scrollWidth<=body.getWidth()&&this.scroller&&(this.element.setStyle({width:this.element._origWidth+"px"}),$(this.scroller.parentNode)&&$(this.scroller.parentNode).insert({top:this.element}),body.stopObserving("scroll",this.scroller.observer),$(this.scroller.parentNode)&&this.scroller.remove(),this.scroller=null,this.resizeHeaders()))},getInnerWidth:function(){var leftWidth=parseInt(this.element.getStyle("borderLeftWidth"))||0,rightWidth=parseInt(this.element.getStyle("borderRightWidth"))||0;return this.element.getWidth()-leftWidth-rightWidth},getInnerHeight:function(element){return element.getHeight()-(parseInt(element.getStyle("borderTopWidth"))||0)-(parseInt(element.getStyle("borderBottomWidth"))||0)},log:function(message){}}),Class.create("PreviewFactory",{sequencialLoading:!0,imagesHash:$H(),_crtImageIndex:0,_thumbSize:64,initialize:function(options){this.imagesHash=$H()},clear:function(){this.imagesHash=$H()},generateBasePreview:function(ajxpNode){return AbstractEditor.prototype.getPreview(ajxpNode)},setThumbSize:function(tSize){this._thumbSize=tSize},enrichBasePreview:function(ajxpNode,mainObject){var editors=pydio.Registry.findEditorsForMime(ajxpNode.isLeaf()?ajxpNode.getAjxpMime():"mime_folder",!0);if(editors&&editors.length){this._crtImageIndex++;var imgIndex=this._crtImageIndex;mainObject.IMAGE_ELEMENT.writeAttribute("data-is_loaded","false"),mainObject.IMAGE_ELEMENT.writeAttribute("id","ajxp_image_"+imgIndex);var crtIndex=this._crtImageIndex;pydio.Registry.loadEditorResources(editors[0].resourcesManager);var editorClass=Class.getByName(editors[0].editorClass);if(editorClass){var oImageToLoad={index:"ajxp_image_"+crtIndex,ajxpNode:ajxpNode,editorClass:editorClass,mainObject:mainObject};this.sequencialLoading?this.imagesHash.set(oImageToLoad.index,oImageToLoad):this.loadImage(oImageToLoad)}}},loadNextImage:function(){if(this.imagesHash&&this.imagesHash.size()){if(this.loading)return;var oImageToLoad=this.imagesHash.unset(this.imagesHash.keys()[0]);oImageToLoad.PFacLoader=new Image,oImageToLoad.PFacLoader.onerror=this.loadNextImage.bind(this);var loader=function(){var img=oImageToLoad.mainObject.IMAGE_ELEMENT||$(oImageToLoad.index);if(null!=img&&null!=oImageToLoad.PFacLoader){var newImg=oImageToLoad.editorClass.prototype.getPreview(oImageToLoad.ajxpNode);newImg.setAttribute("data-is_loaded","true"),img.parentNode&&img.parentNode.replaceChild(newImg,img),oImageToLoad.mainObject.IMAGE_ELEMENT=newImg,this.resizeThumbnail(newImg),oImageToLoad.PFacLoader=null,this.loadNextImage()}}.bind(this);oImageToLoad.PFacLoader.src=oImageToLoad.editorClass.prototype.getThumbnailSource(oImageToLoad.ajxpNode),oImageToLoad.PFacLoader.readyState&&"complete"==oImageToLoad.PFacLoader.readyState?loader():oImageToLoad.PFacLoader.onload=loader}},loadImage:function(oImageToLoad){var imageLoader=new Image;imageLoader.editorClass=oImageToLoad.editorClass,imageLoader.src=imageLoader.editorClass.prototype.getThumbnailSource(oImageToLoad.ajxpNode);var loader=function(){var img=oImageToLoad.mainObject.IMAGE_ELEMENT||$(oImageToLoad.index);if(null!=img&&null!=imageLoader){var newImg=imageLoader.editorClass.prototype.getPreview(oImageToLoad.ajxpNode);newImg.setAttribute("data-is_loaded","true"),img.parentNode.replaceChild(newImg,img),oImageToLoad.mainObject.IMAGE_ELEMENT=newImg,this.resizeThumbnail(newImg),imageLoader=null}}.bind(this);imageLoader.readyState&&"complete"==imageLoader.readyState?loader():imageLoader.onload=loader},resizeThumbnail:function(element){var tW,tH,mT,mB,thumbSize=this._thumbSize,defaultMargin=5;
element.resizePreviewElement&&"true"==element.getAttribute("data-is_loaded")?element.resizePreviewElement({width:thumbSize,height:thumbSize,margin:defaultMargin}):(thumbSize>=64?(tW=tH=64,mT=parseInt((thumbSize-64)/2)+defaultMargin,mB=thumbSize+2*defaultMargin-tH-mT-1):(tW=tH=thumbSize,mT=mB=defaultMargin),element.setStyle({width:tW+"px",height:tH+"px",marginTop:mT+"px",marginBottom:mB+"px"}))},renderSimpleLink:function(ajxpNodeOrPath,label){var p;p="string"==typeof ajxpNodeOrPath?ajxpNodeOrPath:ajxpNodeOrPath.getPath();var link=new Element("span",{className:"simple_goto_link","data-ajaxplorerGoto":p}).update(label?label:p);return link.observe("click",function(e){this.goTo(p)}.bind(ajaxplorer)),link},renderUserLink:function(userId){}}),Class.create("FilesList",SelectableElements,{__implements:["IAjxpWidget","IFocusable","IContextMenuable","IActionProvider"],__allObservers:null,__currentInstanceIndex:1,_dataModel:null,_doubleClickListener:null,_previewFactory:null,_detailThumbSize:28,_inlineToolbarOptions:null,_instanciatedToolbars:null,getUserPreference:AjxpPane.prototype.getUserPreference,setUserPreference:AjxpPane.prototype.setUserPreference,initialize:function($super,oElement,initDefaultDispOrOptions){$super(null,!0),$(oElement).ajxpPaneObject=this,this.htmlElement=$(oElement),this._previewFactory=new PreviewFactory,this._previewFactory.sequencialLoading=!0,this.__allObservers=$A(),this._parsingCache=new $H,this._filters=$H(),"string"==typeof initDefaultDispOrOptions?(this.options={},this._displayMode=initDefaultDispOrOptions):(this.options=initDefaultDispOrOptions,this.options.displayMode?this._displayMode=this.options.displayMode:this._displayMode="detail",this.options.dataModel&&(this._dataModel=this.options.dataModel),this.options.doubleClickListener&&(this._doubleClickListener=this.options.doubleClickListener),this.options.detailThumbSize&&(this._detailThumbSize=this.options.detailThumbSize),this.options.inlineToolbarOptions&&(this._inlineToolbarOptions=this.options.inlineToolbarOptions,this._instanciatedToolbars=$A())),this.options.fit&&"content"==this.options.fit&&(this.options.replaceScroller=!1),FilesList.staticIndex?FilesList.staticIndex++:FilesList.staticIndex=1,this.__currentInstanceIndex=FilesList.staticIndex;var userLoggedObserver=function(){if(ajaxplorer&&ajaxplorer.user&&this.htmlElement){var disp=this.getUserPreference("display");!disp||"thumb"!=disp&&"list"!=disp&&"detail"!=disp||disp!=this._displayMode&&this.switchDisplayMode(disp),this._thumbSize=parseInt(this.getUserPreference("thumb_size")),this.slider&&(this.slider.setValue(this._thumbSize),this.resizeThumbnails())}}.bind(this);this._registerObserver(document,"ajaxplorer:user_logged",userLoggedObserver);var loadObserver=this.contextObserver.bind(this),childAddedObserver=this.childAddedToContext.bind(this),loadingObs=this.setOnLoad.bind(this),loadEndObs=this.removeOnLoad.bind(this),contextChangedObserver=function(event){var newContext=event.memo,previous=this.crtContext;if(previous&&(previous.stopObserving("loaded",loadEndObs),previous.stopObserving("loading",loadingObs),previous.stopObserving("child_added",childAddedObserver)),this.crtContext=newContext,this.crtContext.isLoaded())this.contextObserver(event);else{var oThis=this;this.crtContext.observeOnce("loaded",function(){oThis.crtContext=this,loadObserver()})}this.crtContext.observe("loaded",loadEndObs),this.crtContext.observe("loading",loadingObs),this.crtContext.observe("child_added",childAddedObserver)}.bind(this),componentConfigObserver=function(event){if(this.htmlElement&&"FilesList"==event.memo.className){var refresh=this.parseComponentConfig(event.memo.classConfig.get("all"));refresh&&this.initGUI()}}.bind(this),selectionChangedObserver=function(event){if(null!=event.memo._selectionSource&&event.memo._selectionSource!=this){var dm=this._dataModel?this._dataModel:ajaxplorer.getContextHolder(),origFC=this._fireChange;this._fireChange=!1,this.setSelectedNodes(dm.getSelectedNodes()),this._fireChange=origFC}}.bind(this);this._dataModel?(this._registerObserver(this._dataModel,"context_changed",contextChangedObserver,!0),this._registerObserver(this._dataModel,"context_loading",loadingObs,!0),this._registerObserver(this._dataModel,"component_config_changed",componentConfigObserver,!0),this._registerObserver(this._dataModel,"selection_changed",selectionChangedObserver,!0)):(this._registerObserver(document,"ajaxplorer:context_changed",contextChangedObserver,!1),this._registerObserver(document,"ajaxplorer:context_loading",loadingObs,!1),this._registerObserver(document,"ajaxplorer:component_config_changed",componentConfigObserver,!1),this._registerObserver(document,"ajaxplorer:selection_changed",selectionChangedObserver,!1));var userDisplay=this.getUserPreference("display");userDisplay&&(this._displayMode=userDisplay),this._thumbSize=64,this._crtImageIndex=0,this.options.fixedThumbSize&&(this._fixedThumbSize=this.options.fixedThumbSize),this._pendingFile=null,this.allDraggables=$A(),this.allDroppables=$A(),this.gridStyle="file",this.paginationData=null,this.even=!0,this.hiddenColumns=$A([]),this.options.columnsDef?(this.columnsDef=this.options.columnsDef,this.defaultSortTypes=this.options.defaultSortTypes,this.options.columnsTemplate&&(this.columnsTemplate=this.options.columnsTemplate)):(this.columnsDef=$A([]),this.columnsDef.push({messageId:1,attributeName:"ajxp_label"}),this.columnsDef.push({messageId:2,attributeName:"filesize"}),this.columnsDef.push({messageId:3,attributeName:"mimestring"}),this.columnsDef.push({messageId:4,attributeName:"ajxp_modiftime"}),this.defaultSortTypes=["StringDirFile","NumberKo","String","MyDate"]),this._oSortTypes=this.defaultSortTypes,this.initGUI();var keydownObserver=this.keydown.bind(this),repoSwitchObserver=this.setOnLoad.bind(this);this._registerObserver(document,"keydown",keydownObserver),this._dataModel?document.fire("ajaxplorer:datamodel-loaded-"+this.htmlElement.id):this._registerObserver(document,"ajaxplorer:trigger_repository_switch",repoSwitchObserver),this.options.messageBoxReference&&ajaxplorer&&pydio.UI.registerAsMessageBoxReference(this.htmlElement)},getDataModel:function(){return this._dataModel},_registerObserver:function(object,eventName,handler,objectEvent){objectEvent?object.observe(eventName,handler):Event.observe(object,eventName,handler),this.__allObservers.push({object:object,event:eventName,handler:handler,objectEvent:objectEvent})},_clearObservers:function(){this.__allObservers.each(function(el){el.objectEvent?el.object.stopObserving(el.event,el.handler):Event.stopObserving(el.object,el.event,el.handler)}),this.observer&&this.stopObserving("resize",this.observer),this.scrollSizeObserver&&this.stopObserving("resize",this.scrollSizeObserver)},getDomNode:function(){return this.htmlElement},destroy:function($super){this.empty(!0),$super(),this._clearObservers();try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}this.boundSizeEvents&&this.boundSizeEvents.each(function(pair){document.stopObserving(pair.key,pair.value)}),this.resizeEvents&&this.resizeEvents.each(function(pair){document.stopObserving(pair.key,pair.value)}),Class.objectImplements(this,"IFocusable")&&pydio.UI.unregisterFocusable(this),Class.objectImplements(this,"IActionProvider")&&this.getActions().each(function(act){pydio.getController().deleteFromGuiActions(act.key)}.bind(this)),this.slider&&this.slider.destroy(),this.headerMenu&&this.headerMenu.destroy(),this.htmlElement=null},getVisibleColumns:function(){var visible=$A([]);return this.columnsDef.each(function(el){this.hiddenColumns.include(el.attributeName)||visible.push(el)}.bind(this)),visible},getVisibleSortTypes:function(){for(var visible=$A([]),i=0;i<this.columnsDef.length;i++)this.hiddenColumns.include(this.columnsDef[i].attributeName)||visible.push(this.columnsDef[i].sortType);return visible},setColumnVisible:function(attName,visible){var change=!1;visible&&this.hiddenColumns.include(attName)&&(this.hiddenColumns=this.hiddenColumns.without(attName),change=!0),visible||this.hiddenColumns.include(attName)||(this.hiddenColumns.push(attName),change=!0),change&&(this.setUserPreference("columns_visibility",this.hiddenColumns),this.initGUI(),this.empty(!0),this.fill(this.crtContext))},contextObserver:function(e){if(this.crtContext&&this.htmlElement){var base=getBaseName(this.crtContext.getLabel());if(!base)try{base=ajaxplorer.user.repositories.get(ajaxplorer.repositoryId).getLabel()}catch(e){}this.options.muteUpdateTitleEvent||this.htmlElement.fire("editor:updateTitle",base),this.empty(),this.fill(this.crtContext),this.removeOnLoad()}},extractComponentConfig:function(){return{gridStyle:{value:this.gridStyle},_displayMode:{value:this._displayMode},columnsTemplate:{value:this.columnsTemplate},columnsDef:{value:this.columnsDef?this.columnsDef.clone():this.columnsDef},oSortTypes:{value:this._oSortTypes?this._oSortTypes.clone():this._oSortTypes},_thumbSize:{value:this._thumbSize},_fixedThumbSize:{value:this._fixedThumbSize}}},applyComponentConfig:function(config){for(var key in config)config.hasOwnProperty(key)&&(this[key]=config[key].value)},parseComponentConfig:function(domNode){domNode.getAttribute("local")&&!this.restoreConfig&&(this.restoreConfig=this.extractComponentConfig());var refreshGUI=!1;this.columnsTemplate=!1;var columnsNode=XPathSelectSingleNode(domNode,"columns");if(columnsNode){if(columnsNode.getAttribute("switchGridMode")&&(this.gridStyle=columnsNode.getAttribute("switchGridMode"),refreshGUI=!0),columnsNode.getAttribute("switchDisplayMode")){var dispMode=columnsNode.getAttribute("switchDisplayMode");this._fullview=!1,"full"==dispMode&&(this._fullview=!0,dispMode="list"),dispMode!=this._displayMode&&(this.switchDisplayMode(dispMode),refreshGUI=!0)}columnsNode.getAttribute("template_name")&&(this.columnsTemplate=columnsNode.getAttribute("template_name"));var newCols,sortTypes,columns=XPathSelectNodes(columnsNode,"column"),addColumns=XPathSelectNodes(columnsNode,"additional_column");columns.length?(newCols=$A([]),sortTypes=$A([]),columns.concat(addColumns)):(newCols=this.columnsDef,sortTypes=this._oSortTypes,columns=addColumns),columns.each(function(col){var obj={};$A(col.attributes).each(function(att){obj[att.nodeName]=att.value,"sortType"==att.nodeName?sortTypes.push(att.value):"defaultVisibilty"==att.nodeName&&"hidden"==att.value&&this.hiddenColumns.push(col.getAttribute("attributeName"))}.bind(this)),newCols.push(obj)}.bind(this)),newCols.size()&&(this.columnsDef=newCols,this._oSortTypes=sortTypes,"list"==this._displayMode&&(refreshGUI=!0))}var properties=XPathSelectNodes(domNode,"property");if(properties.length)for(var i=0;i<properties.length;i++){var property=properties[i];if("thumbSize"==property.getAttribute("name"))this._thumbSize=parseInt(property.getAttribute("value")),refreshGUI=!0;else if("fixedThumbSize"==property.getAttribute("name"))this._fixedThumbSize=parseInt(property.getAttribute("value")),refreshGUI=!0;else if("displayMode"==property.getAttribute("name")){var displayMode=property.getAttribute("value"),userPrefDisp=this.getUserPreference("display");userPrefDisp||(this._displayMode=displayMode,refreshGUI=!0)}}return refreshGUI},getActions:function(){var oThis=this,oThisId=this.htmlElement.id,options1={name:oThisId+"-multi_display",src:"view_icon.png",icon_class:"icon-th-large",text_id:150,title_id:151,text:MessageHash[150],title:MessageHash[151],hasAccessKey:!1,subMenu:!0,subMenuUpdateImage:!0,callback:function(){if(window.actionArguments){var command;command=Object.isString(window.actionArguments[0])?window.actionArguments[0]:window.actionArguments[0].command,oThis.switchDisplayMode(command)}},listeners:{init:function(){window.setTimeout(function(){var displayMode=oThis.getDisplayMode(),item=this.subMenuItems.staticItems.detect(function(item){return item.command==displayMode});this.notify("submenu_active",item)}.bind(window.listenerContext),500)}}},context1={selection:!1,dir:!0,actionBar:!0,actionBarGroup:oThisId+"-actions",contextMenu:!1,infoPanel:!1},subMenuItems1={staticItems:[{text:226,title:227,src:"view_text.png",icon_class:"icon-table",command:"list",hasAccessKey:!0,accessKey:"list_access_key"},{text:460,title:461,src:"view_list_details.png",icon_class:"icon-th-list",command:"detail",hasAccessKey:!0,accessKey:"detail_access_key"},{text:228,title:229,src:"view_icon.png",icon_class:"icon-th",command:"thumb",hasAccessKey:!0,accessKey:"thumbs_access_key"}]},multiAction=new Action(options1,context1,{},{},subMenuItems1),options2={name:oThisId+"-thumb_size",src:"view_icon.png",icon_class:"icon-resize-full",text_id:452,title_id:453,text:MessageHash[452],title:MessageHash[453],hasAccessKey:!1,subMenu:!1,subMenuUpdateImage:!1,callback:function(){oThis.slider.show($(oThisId+"-thumb_size_button"))},listeners:{init:function(){var actBar=window.pydio.getController();oThis.observe("switch-display-mode",function(e){"thumb"!=oThis._displayMode?actBar.getActionByName(oThisId+"-thumb_size").disable():actBar.getActionByName(oThisId+"-thumb_size").enable()}),window.setTimeout(function(){actBar.getActionByName(oThisId+"-thumb_size")&&("thumb"!=oThis._displayMode?actBar.getActionByName(oThisId+"-thumb_size").disable():actBar.getActionByName(oThisId+"-thumb_size").enable())}.bind(window.listenerContext),800)}}},context2={selection:!1,dir:!0,actionBar:!0,actionBarGroup:oThisId+"-actions",contextMenu:!1,infoPanel:!1},thumbsizeAction=new Action(options2,context2,{},{}),options3={name:oThisId+"-thumbs_sortby",src:"view_icon.png",icon_class:"icon-sort",text_id:450,title_id:451,text:MessageHash[450],title:MessageHash[451],hasAccessKey:!1,subMenu:!0,subMenuUpdateImage:!1,callback:function(){},listeners:{init:function(){var actBar=window.pydio.getController();oThis.observe("switch-display-mode",function(e){"list"==oThis._displayMode?actBar.getActionByName(oThisId+"-thumbs_sortby").disable():actBar.getActionByName(oThisId+"-thumbs_sortby").enable()}),window.setTimeout(function(){var act=actBar.getActionByName(oThisId+"-thumbs_sortby");act&&("list"==oThis._displayMode?actBar.getActionByName(oThisId+"-thumbs_sortby").disable():actBar.getActionByName(oThisId+"-thumbs_sortby").enable())}.bind(window.listenerContext),800)}}},context3={selection:!1,dir:!0,actionBar:!0,actionBarGroup:oThisId+"-actions",contextMenu:!1,infoPanel:!1},submenuItems3={dynamicBuilder:function(protoMenu){"use strict";var items=$A([]),index=0;oThis.columnsDef.each(function(column){var isSorted=this._sortableTable.sortColumn==index;items.push({name:column.messageId?MessageHash[column.messageId]:column.messageString,alt:column.messageId?MessageHash[column.messageId]:column.messageString,image:resolveImageSource((isSorted?"column-visible":"transp")+".png","/images/actions/ICON_SIZE",16),icon_class:isSorted?"icon-caret-"+(this._sortableTable.descending?"down":"up"):"",isDefault:!1,callback:function(e){var clickIndex=this.columnsDef.indexOf(column),sorted=this._sortableTable.sortColumn==clickIndex;sorted&&(this._sortableTable.descending=!this._sortableTable.descending),this._sortableTable.sort(clickIndex,this._sortableTable.descending)}.bind(this)}),index++,protoMenu.options.menuItems=items,protoMenu.refreshList()}.bind(oThis))}},thumbSortAction=new Action(options3,context3,{},{},submenuItems3),butts=$H();return butts.set(oThisId+"-thumb_size",thumbsizeAction),butts.set(oThisId+"-thumb_sort",thumbSortAction),butts.set(oThisId+"-multi_display",multiAction),butts},initGUI:function(){this.observer&&this.stopObserving("resize",this.observer),this.scrollSizeObserver&&this.stopObserving("resize",this.scrollSizeObserver),this.slider&&this.slider.destroy(),$A(["list","thumb","detail"]).each(function(f){this._displayMode==f?this.htmlElement.addClassName("fl-displayMode-"+f):this.htmlElement.removeClassName("fl-displayMode-"+f)}.bind(this));var scrollElement,buffer;if("list"==this._displayMode){this.hiddenColumns=$A();var testPref=this.getUserPreference("columns_visibility");testPref&&(this.hiddenColumns=$A(testPref));var userPref,visibleColumns=this.getVisibleColumns();if(this.getUserPreference("columns_size")){var data=new Hash(this.getUserPreference("columns_size"));this.columnsTemplate&&data.get(this.columnsTemplate)?userPref=new Hash(data.get(this.columnsTemplate)):data.get(ajaxplorer.user.getActiveRepository())&&(userPref=new Hash(data.get(ajaxplorer.user.getActiveRepository())))}for(var headerData=$A(),i=0;i<visibleColumns.length;i++){var column=visibleColumns[i],userWidth=0;column.defaultWidth&&(userWidth=column.defaultWidth.replace("%","")),("grid"!=this.gridStyle||this.columnsTemplate)&&userPref&&userPref.get(i)&&i<visibleColumns.length-1&&(userWidth=userPref.get(i)),column.fixedWidth&&(userWidth=column.fixedWidth);var label=column.messageId?MessageHash[column.messageId]:column.messageString,leftPadding=this.options.cellPaddingCorrection||0;"ajxp_label"==column.attributeName&&(leftPadding=24),headerData.push({label:label,size:userWidth,leftPadding:leftPadding,metaName:column.attributeName})}buffer='<div id="selectable_div_header-'+this.__currentInstanceIndex+'" class="sort-table"></div>',buffer+='<div id="selectable_div_header_filter-'+this.__currentInstanceIndex+'" class="sort-table-filter"></div>',buffer=buffer+'<div id="table_rows_container-'+this.__currentInstanceIndex+'" class="table_rows_container"><table id="selectable_div-'+this.__currentInstanceIndex+'" class="selectable_div sort-table" width="100%" cellspacing="0"><tbody></tbody></table></div>',this.htmlElement.update(buffer);var contentContainer=this.htmlElement.down("div.table_rows_container");contentContainer.setStyle("grid"!=this.gridStyle?{overflowX:"hidden",overflowY:this.options.replaceScroller?"hidden":"auto",paddingBottom:"16px"}:{overflow:"auto",paddingBottom:"0"}),this.options.horizontalScroll?attachMobileScroll(this.htmlElement,"horizontal"):attachMobileScroll(contentContainer,"vertical"),scrollElement=contentContainer;var oElement=this.htmlElement.down(".selectable_div");this.paginationData&&parseInt(this.paginationData.get("total"))>1?(this.htmlElement.addClassName("paginated"),contentContainer.insert({before:this.createPaginator()})):this.htmlElement.removeClassName("paginated"),void 0==this.options.selectable||this.options.selectable===!0?this.initSelectableItems(oElement,!0,contentContainer,!0):this.initNonSelectableItems(oElement),this._headerResizer=new HeaderResizer(this.htmlElement.down("div.sort-table"),{headerData:headerData,body:contentContainer,filterPanel:this.htmlElement.down("div.sort-table-filter"),initSizesType:"percent",bodyIsMaster:"grid"==this.gridStyle,scrollerWidth:this.options.replaceScroller?0:18,handleWidth:this.options.replaceScroller?1:3}),this._headerResizer.observe("drag_resize",function(){this.prefSaver&&window.clearTimeout(this.prefSaver),this.prefSaver=window.setTimeout(function(){if(ajaxplorer.user&&("grid"!=this.gridStyle||this.columnsTemplate)){var sizes=this._headerResizer.getCurrentSizes("percent"),data=this.getUserPreference("columns_size");data=data?new Hash(data):new Hash,sizes.type="percent";var id=this.columnsTemplate?this.columnsTemplate:ajaxplorer.user.getActiveRepository();data.set(id,sizes),this.setUserPreference("columns_size",data)}}.bind(this),2e3)}.bind(this)),this._headerResizer.observe("filter_update",function(event){event.metaValue?this.addMetadataFilter(event.metaName,event.metaValue+"*"):this.removeMetadataFilter(event.metaName)}.bind(this)),this._sortableTable=new AjxpSortable(oElement,this.getVisibleSortTypes(),this.htmlElement.down("div.sort-table")),this.options.groupByData&&this._sortableTable.setGroupByData(this.options.groupByData),this._sortableTable.onsort=function(){this.redistributeBackgrounds();var ctxt=this.getCurrentContextNode();ctxt.getMetadata().set("filesList.sortColumn",""+this._sortableTable.sortColumn),ctxt.getMetadata().set("filesList.descending",this._sortableTable.descending)}.bind(this),this.paginationData&&this.paginationData.get("remote_order")&&parseInt(this.paginationData.get("total"))>1&&this._sortableTable.setPaginationBehaviour(function(params){this.getCurrentContextNode().getMetadata().set("remote_order",params);var oThis=this;this.crtContext.observeOnce("loaded",function(){oThis.crtContext=this,oThis.fill(oThis.crtContext)}),this.getCurrentContextNode().reload()}.bind(this),this.getVisibleColumns(),this.paginationData.get("currentOrderCol")||-1,this.paginationData.get("currentOrderDir")),this.observer=function(e){if(this.options.fit&&"height"==this.options.fit&&fitHeightToBottom(contentContainer,this.htmlElement),Prototype.Browser.IE)this._headerResizer.resize(contentContainer.getWidth());else{var width=this.htmlElement.getWidth();width-=parseInt(this.htmlElement.getStyle("borderLeftWidth"))+parseInt(this.htmlElement.getStyle("borderRightWidth")),this._headerResizer.resize(width)}}.bind(this),this.observe("resize",this.observer),this.options.noContextualMenu||(this.headerMenu&&(this.headerMenu.destroy(),delete this.headerMenu),this.headerMenu=new Proto.Menu({selector:"#selectable_div_header-"+this.__currentInstanceIndex,className:"menu desktop",menuItems:[],fade:!0,zIndex:2e3,beforeShow:function(){var items=$A([]);this.columnsDef.each(function(column){var isVisible=!this.hiddenColumns.include(column.attributeName);items.push({name:column.messageId?MessageHash[column.messageId]:column.messageString,alt:column.messageId?MessageHash[column.messageId]:column.messageString,image:resolveImageSource((isVisible?"column-visible":"transp")+".png","/images/actions/ICON_SIZE",16),isDefault:!1,callback:function(e){this.setColumnVisible(column.attributeName,!isVisible)}.bind(this)})}.bind(this)),this.headerMenu.options.menuItems=items,this.headerMenu.refreshList()}.bind(this)}))}else("thumb"==this._displayMode||"detail"==this._displayMode)&&(this.headerMenu&&(this.headerMenu.destroy(),delete this.headerMenu),buffer='<div class="panelHeader"><div style="float:right;padding-right:5px;font-size:1px;height:16px;"><input type="image" height="16" width="16" src="'+ajxpResourcesFolder+'/images/actions/16/zoom-in.png" id="slider-input-1" style="border:0px;width:16px;height:16px;margin-top:0px;padding:0px;" value="64"/></div>'+MessageHash[126]+"</div>",buffer+='<div id="selectable_div-'+this.__currentInstanceIndex+'" class="selectable_div'+("detail"==this._displayMode?" detailed":"")+'" style="overflow:auto;">',this.htmlElement.update(buffer),this.options.horizontalScroll?attachMobileScroll(this.htmlElement,"horizontal"):attachMobileScroll(this.htmlElement.down(".selectable_div"),"vertical"),this.paginationData&&parseInt(this.paginationData.get("total"))>1?(this.htmlElement.addClassName("paginated"),this.htmlElement.down(".selectable_div").insert({before:this.createPaginator()})):this.htmlElement.removeClassName("paginated"),scrollElement=this.htmlElement.down(".selectable_div"),this.options.horizontalScroll&&(scrollElement.setStyle({width:"100000px"}),this.htmlElement.setStyle({overflowX:"auto"})),this.observer=function(e){this.options.fit&&"height"==this.options.fit&&fitHeightToBottom.defer(scrollElement,this.htmlElement)}.bind(this),this.observe("resize",this.observer),this.getUserPreference("thumb_size")&&(this._thumbSize=parseInt(this.getUserPreference("thumb_size"))),this._fixedThumbSize&&(this._thumbSize=parseInt(this._fixedThumbSize)),this._sortableTable=new AjxpSortable(scrollElement,null,null),this._sortableTable.setMetaSortType(this.columnsDef),this.options.groupByData&&this._sortableTable.setGroupByData(this.options.groupByData),this._sortableTable.onsort=function(){var ctxt=this.getCurrentContextNode();ctxt.getMetadata().set("filesList.sortColumn",""+this._sortableTable.sortColumn),ctxt.getMetadata().set("filesList.descending",this._sortableTable.descending)}.bind(this),this.options.noContextualMenu||(this.headerMenu&&(this.headerMenu.destroy(),delete this.headerMenu),this.headerMenu=new Proto.Menu({selector:"#content_pane div.panelHeader",className:"menu desktop",menuItems:[],fade:!0,zIndex:2e3,beforeShow:function(){var items=$A([]),index=0;this.columnsDef.each(function(column){var isSorted=this._sortableTable.sortColumn==index;items.push({name:column.messageId?MessageHash[column.messageId]:column.messageString,alt:column.messageId?MessageHash[column.messageId]:column.messageString,image:resolveImageSource((isSorted?"column-visible":"transp")+".png","/images/actions/ICON_SIZE",16),isDefault:!1,callback:function(e){var clickIndex=this.columnsDef.indexOf(column),sorted=this._sortableTable.sortColumn==clickIndex;sorted&&(this._sortableTable.descending=!this._sortableTable.descending),this._sortableTable.sort(clickIndex,this._sortableTable.descending)}.bind(this)}),index++}.bind(this)),this.headerMenu.options.menuItems=items,this.headerMenu.refreshList()}.bind(this)})),"thumb"==this._displayMode&&(this.slider&&this.slider.destroy(),this.slider=new SliderInput($("slider-input-1"),{range:$R(30,250),sliderValue:this._thumbSize,leftOffset:0,onSlide:function(value){this._thumbSize=value,this.resizeThumbnails()}.bind(this),onChange:function(value){this.options.replaceScroller&&this.notify("resize"),ajaxplorer&&ajaxplorer.user&&this.setUserPreference("thumb_size",this._thumbSize)}.bind(this)})),void 0==this.options.selectable||this.options.selectable===!0?this.initSelectableItems(scrollElement,!0,scrollElement,!0):this.initNonSelectableItems(scrollElement));this.options.replaceScroller&&(this.scroller=new Element("div",{id:"filelist_scroller"+this.__currentInstanceIndex,className:"scroller_track",style:"right:0px"}),this.scroller.insert('<div id="filelist_scrollbar_handle'+this.__currentInstanceIndex+'" class="scroller_handle"></div>'),scrollElement.insert({before:this.scroller}),scrollElement.setStyle("grid"==this.gridStyle?{overflowY:"hidden",overflowX:"auto",paddingBottom:"16px"}:{overflow:"hidden",paddingBottom:"0"}),this.scrollbar=new Control.ScrollBar(scrollElement,this.scroller),this.scrollSizeObserver&&this.stopObserving("resize",this.scrollSizeObserver),this.stopObserving("resize",this.observer),this.scrollSizeObserver=function(){window.setTimeout(function(){if(this.htmlElement&&this.scrollbar){if("list"==this._displayMode&&contentContainer)if(this.options.fit&&"height"==this.options.fit&&fitHeightToBottom(contentContainer,this.htmlElement),Prototype.Browser.IE)this._headerResizer.resize(contentContainer.getWidth());else{var width=this.htmlElement.getWidth();width-=parseInt(this.htmlElement.getStyle("borderLeftWidth"))+parseInt(this.htmlElement.getStyle("borderRightWidth")),this._headerResizer.resize(width)}else this.options.fit&&"height"==this.options.fit&&fitHeightToBottom(scrollElement,this.htmlElement);this.scrollbar.recalculateLayout(parseInt(scrollElement.getHeight()))}}.bind(this),.01)}.bind(this),this.observe("resize",this.scrollSizeObserver)),this.notify("resize")},createPaginator:function(){var current=parseInt(this.paginationData.get("current")),total=parseInt(this.paginationData.get("total")),div=new Element("div").addClassName("paginator"),currentInput=new Element("input",{value:current,className:"paginatorInput"});return div.update(MessageHash[331]),div.insert(currentInput),div.insert("/"+total),current>1&&(div.insert({top:this.createPaginatorLink(current-1,"<b>&lt;</b>","Previous")}),current>2&&div.insert({top:this.createPaginatorLink(1,"<b>&lt;&lt;</b>","First")})),total>1&&total>current&&(div.insert({bottom:this.createPaginatorLink(current+1,"<b>&gt;</b>","Next")}),total-1>current&&div.insert({bottom:this.createPaginatorLink(total,"<b>&gt;&gt;</b>","Last")})),currentInput.observe("focus",function(){pydio.UI.disableAllKeyBindings()}.bind(this)),currentInput.observe("blur",function(){pydio.UI.enableAllKeyBindings()}.bind(this)),currentInput.observe("keydown",function(event){if(event.keyCode==Event.KEY_RETURN){Event.stop(event),currentInput.blur();var new_page=parseInt(currentInput.getValue());if(new_page==current)return;if(1>new_page||new_page>total)return ajaxplorer.displayMessage("ERROR",MessageHash[335]+" "+total),void currentInput.setValue(current);var node=this.getCurrentContextNode();node.getMetadata().get("paginationData").set("new_page",new_page),this._dataModel?this._dataModel.requireContextChange(node):ajaxplorer.updateContextData(node)}}.bind(this)),div},createPaginatorLink:function(page,text,title){var node=this.getCurrentContextNode();return new Element("a",{href:"#",style:"font-size:12px;padding:0 7px;",title:title}).update(text).observe("click",function(e){node.getMetadata().get("paginationData").set("new_page",page),this._dataModel?this._dataModel.requireContextChange(node):ajaxplorer.updateContextData(node),Event.stop(e)}.bind(this))},setColumnsDef:function(aColumns){this.columnsDef=aColumns,"list"==this._displayMode&&this.initGUI()},getColumnsDef:function(){return this.columnsDef},setContextualMenu:function(protoMenu){this.protoMenu=protoMenu},getCurrentContextNode:function(){return this._dataModel?this._dataModel.getContextNode():ajaxplorer.getContextNode()},resize:function(){if(this.options.fit&&"height"==this.options.fit){var marginBottom=0;if(this.options.fitMarginBottom){var expr=this.options.fitMarginBottom;try{marginBottom=parseInt(eval(expr))}catch(e){}}fitHeightToBottom(this.htmlElement,this.options.fitParent?$(this.options.fitParent):null,expr)}else this.options.fit&&"content"==this.options.fit&&this.options.horizontalScroll&&this.htmlElement.setStyle({height:this._thumbSize+60+"px"});this.htmlElement.down(".table_rows_container")&&Prototype.Browser.IE&&"file"==this.gridStyle&&this.htmlElement.down(".table_rows_container").setStyle({width:"100%"}),"thumb"==this._displayMode&&this.resizeThumbnails(null,!0),this.notify("resize"),document.fire("ajaxplorer:resize-FilesList-"+this.htmlElement.id,this.htmlElement.getDimensions())},setFocusBehaviour:function(){var clickObserver=function(){pydio&&pydio.UI.focusOn(this)}.bind(this);this._registerObserver(this.htmlElement,"click",clickObserver)},showElement:function(show){show?(pydio&&(this._dataModel||pydio.updateContextData(null,this.getSelectedNodes(),this),pydio.UI.focusOn(this)),this.htmlElement.setStyle({display:"block"})):(this.blur(),!this._dataModel&&ajaxplorer&&pydio.updateContextData(null,[],this),this.htmlElement.setStyle({display:"none"}))},switchDisplayMode:function(mode){if(this.options.fixedDisplayMode){if(this.options.fixedDisplayMode==this._displayMode)return this._displayMode;mode=this.options.fixedDisplayMode}return this.removeCurrentLines(!0),mode?this._displayMode=mode:this._displayMode="thumb"==this._displayMode?"list":"thumb",this.notify("switch-display-mode"),this.initGUI(),this.empty(!0),this.fill(this.getCurrentContextNode()),this.fireChange(),this.setUserPreference("display",this._displayMode),document.fire("ajaxplorer:switchDisplayMode-FilesList-"+this.htmlElement.id),this._displayMode},getDisplayMode:function(){return this._displayMode},initRowsBuffered:function(){this.iRBTimer&&(window.clearTimeout(this.iRBTimer),this.iRBTimer=null),this.iRBTimer=window.setTimeout(function(){this.initRows(),this.iRBTimer=null}.bind(this),200)},initRows:function(){if(this.notify("rows:willInitialize"),"thumb"==this._displayMode||"detail"==this._displayMode){var adjusted=this.resizeThumbnails();this.protoMenu&&(this.protoMenu.addElements("#selectable_div-"+this.__currentInstanceIndex),this.protoMenu.addElements("#selectable_div-"+this.__currentInstanceIndex+" > .ajxpNodeProvider")),window.setTimeout(function(){this._previewFactory.setThumbSize(adjusted?adjusted:"detail"==this._displayMode?this._detailThumbSize:this._thumbSize),this._previewFactory.loadNextImage()}.bind(this),10)}else this.protoMenu&&(this.protoMenu.addElements("#table_rows_container-"+this.__currentInstanceIndex),this.protoMenu.addElements("#table_rows_container-"+this.__currentInstanceIndex+" > .ajxpNodeProvider")),this._headerResizer&&this._headerResizer.resize(this.htmlElement.getWidth()-2);this.notify("resize"),this.notify("rows:didInitialize")},reload:function(additionnalParameters){this.getCurrentContextNode()&&(this.empty(),
this.fill(this.getCurrentContextNode()))},softReload:function(){this.setSelectedNodes([]),this.removeCurrentLines(!0),this.fill(this.getCurrentContextNode(),!0)},empty:function(skipFireChange){this._previewFactory.clear(),this.protoMenu&&this.protoMenu.removeElements("thumb"==this._displayMode||"detail"==this._displayMode?"#selectable_div-"+this.__currentInstanceIndex+", #selectable_div-"+this.__currentInstanceIndex+" > .ajxpNodeProvider":"#table_rows_container-"+this.__currentInstanceIndex+", #table_rows_container-"+this.__currentInstanceIndex+" > .ajxpNodeProvider");for(var i=0;i<AllAjxpDroppables.length;i++){var el=AllAjxpDroppables[i];this.isItem(el)&&(Droppables.remove(AllAjxpDroppables[i]),delete AllAjxpDroppables[i])}for(i=0;i<window.AllAjxpDraggables.length;i++)if(window.AllAjxpDraggables[i]&&window.AllAjxpDraggables[i].element&&this.isItem(window.AllAjxpDraggables[i].element)){if(window.AllAjxpDraggables[i].element.IMAGE_ELEMENT)try{window.AllAjxpDraggables[i].element.IMAGE_ELEMENT.destroyElement&&window.AllAjxpDraggables[i].element.IMAGE_ELEMENT.destroyElement(),window.AllAjxpDraggables[i].element.IMAGE_ELEMENT=null,delete window.AllAjxpDraggables[i].element.IMAGE_ELEMENT}catch(e){}Element.remove(window.AllAjxpDraggables[i].element)}window.AllAjxpDraggables=$A([]);var items=this.getSelectedItems(),setItemSelected=this.setItemSelected.bind(this);for(i=0;i<items.length;i++)setItemSelected(items[i],!1);this.removeCurrentLines(skipFireChange)},makeItemRefreshObserver:function(ajxpNode,item,renderer){return function(){if(!this.loading&&(item.ajxpNode&&(item.REMOVE_OBS&&item.ajxpNode.stopObserving("node_removed",item.REMOVE_OBS),item.REPLACE_OBS&&item.ajxpNode.stopObserving("node_replaced",item.REPLACE_OBS)),item.parentNode)){var newItem=renderer(ajxpNode,item);item.insert({before:newItem}),item.remove(),newItem.ajxpNode=ajxpNode,newItem.addClassName("ajxpNodeProvider"),ajxpNode.isLeaf()&&newItem.addClassName("ajxpNodeLeaf"),this.initRows(),item.ajxpNode=null,item=void 0,newItem.REPLACE_OBS=this.makeItemRefreshObserver(ajxpNode,newItem,renderer),newItem.REMOVE_OBS=this.makeItemRemovedObserver(ajxpNode,newItem),ajxpNode.observe("node_replaced",newItem.REPLACE_OBS),ajxpNode.observe("node_removed",newItem.REMOVE_OBS);var dm=this._dataModel?this._dataModel:ajaxplorer.getContextHolder();if(dm.getSelectedNodes()&&dm.getSelectedNodes().length&&dm.getSelectionSource()==this){var selectedNodes=dm.getSelectedNodes();this._selectedItems=[];for(var f=0;f<selectedNodes.length;f++)Object.isString(selectedNodes[f])?this.selectFile(selectedNodes[f],!0):this.selectFile(selectedNodes[f].getPath(),!0);dm.getSelectionSource()==this&&(this.hasFocus=!0)}}}.bind(this)},makeItemRemovedObserver:function(ajxpNode,item){return function(){try{if(this.loading)return;this.setItemSelected(item,!1),item.ajxpNode&&(item.REMOVE_OBS&&item.ajxpNode.stopObserving("node_removed",item.REMOVE_OBS),item.REPLACE_OBS&&item.ajxpNode.stopObserving("node_replaced",item.REPLACE_OBS),item.parentNode||(item=this.htmlElement.down('[id="'+item.ajxpNode.getPath()+'"]'))),item.ajxpNode=null,Prototype.Browser.IE&&Prototype.Version.startsWith("1.6")?window.setTimeout(function(){item.remove(),item=void 0,this.initRowsBuffered()}.bind(this),10):new Effect.RowFade(item,{afterFinish:function(){try{item.remove()}catch(e){window.console&&console.log(e)}item=void 0,this.initRowsBuffered()}.bind(this),duration:.2})}catch(e){}}.bind(this)},childAddedToContext:function(childPath){if(!this.loading){var renderer=this.getRenderer(),child=this.crtContext.findChildByPath(childPath);if(child&&!this._rejectNodeByFilters(child)){var newItem;if(newItem=renderer(child),newItem.ajxpNode=child,newItem.addClassName("ajxpNodeProvider"),child.isLeaf()&&newItem.addClassName("ajxpNodeLeaf"),newItem.REPLACE_OBS=this.makeItemRefreshObserver(child,newItem,renderer),newItem.REMOVE_OBS=this.makeItemRemovedObserver(child,newItem),child.observe("node_replaced",newItem.REPLACE_OBS),child.observe("node_removed",newItem.REMOVE_OBS),this._sortableTable){var sortColumn=this.crtContext.getMetadata().get("filesList.sortColumn");this.crtContext.getMetadata().get("filesList.descending");if(void 0!=sortColumn&&this.columnsDef[sortColumn]||(sortColumn=0),void 0!=sortColumn){sortColumn=parseInt(sortColumn);var sortFunction=this._sortableTable.getSortFunction(this._sortableTable.getSortType(sortColumn),sortColumn),sortCache=this._sortableTable.getCache(this._sortableTable.getSortType(sortColumn),sortColumn);sortCache.sort(sortFunction);for(var i=0;i<sortCache.length;i++)if(sortCache[i].element==newItem){if(0==i)$(newItem.parentNode).insert({top:newItem});else{if(sortCache[i-1].element.ajxpNode.getPath()==newItem.ajxpNode.getPath()){$(newItem.parentNode).remove(newItem);break}sortCache[i-1].element.insert({after:newItem})}break}this._sortableTable.destroyCache(sortCache)}}this.initRows()}}},getRenderer:function(){return"thumb"==this._displayMode?this.ajxpNodeToDiv.bind(this):"detail"==this._displayMode?this.ajxpNodeToLargeDiv.bind(this):"list"==this._displayMode?this.ajxpNodeToTableRow.bind(this):void 0},fill:function(contextNode,forceNoRefreshGui){var refreshGUI=!1;this.gridStyle="file",this.even=!1,this._oSortTypes=this.defaultSortTypes;var hasPagination=this.paginationData?!0:!1;contextNode.getMetadata().get("paginationData")?(this.paginationData=contextNode.getMetadata().get("paginationData"),refreshGUI=!0):(this.paginationData=null,hasPagination&&(refreshGUI=!0));var clientConfigs=contextNode.getMetadata().get("client_configs");if(clientConfigs){var componentData=XPathSelectSingleNode(clientConfigs,"component_config");componentData&&componentData.getAttribute("className")&&"FilesList"==componentData.getAttribute("className")&&(refreshGUI=this.parseComponentConfig(componentData))}else this.restoreConfig&&(this.applyComponentConfig(this.restoreConfig),this.restoreConfig=null,refreshGUI=!0);refreshGUI&&!forceNoRefreshGui&&this.initGUI(),this.clearParsingCache();for(var children=ProtoCompat.map2values(contextNode.getChildren()),renderer=this.getRenderer(),i=0;i<children.length;i++){var child=children[i];if(!this._rejectNodeByFilters(child)){var newItem;newItem=renderer(child),newItem.ajxpNode=child,newItem.addClassName("ajxpNodeProvider"),child.isLeaf()&&newItem.addClassName("ajxpNodeLeaf"),newItem.REPLACE_OBS=this.makeItemRefreshObserver(child,newItem,renderer),newItem.REMOVE_OBS=this.makeItemRemovedObserver(child,newItem),child.observe("node_replaced",newItem.REPLACE_OBS),child.observe("node_removed",newItem.REMOVE_OBS)}}if(this.initRows(),this.paginationData&&this.paginationData.get("remote_order")||(this._sortableTable.sortColumn=-1,this._sortableTable.updateHeaderArrows()),this.options.fixedSortColumn&&this.options.fixedSortDirection){var col=this.columnsDef.detect(function(c){return c.attributeName==this.options.fixedSortColumn}.bind(this));if(col){var index=this.columnsDef.indexOf(col);this._sortableTable.sort(index,"desc"==this.options.fixedSortDirection),this._sortableTable.updateHeaderArrows()}}else if(contextNode.getMetadata().get("filesList.sortColumn")&&this.columnsDef[contextNode.getMetadata().get("filesList.sortColumn")]){var sortColumn=parseInt(contextNode.getMetadata().get("filesList.sortColumn")),descending=contextNode.getMetadata().get("filesList.descending");this._sortableTable.sort(sortColumn,descending),this._sortableTable.updateHeaderArrows()}var dm=this._dataModel?this._dataModel:ajaxplorer.getContextHolder();if(dm.getSelectedNodes()&&dm.getSelectedNodes().length&&dm.getSelectionSource()==this){for(var selectedNodes=dm.getSelectedNodes(),f=0;f<selectedNodes.length;f++)Object.isString(selectedNodes[f])?this.selectFile(selectedNodes[f],!0):this.selectFile(selectedNodes[f].getPath(),!0);dm.getSelectionSource()==this&&(this.hasFocus=!0)}this.hasFocus&&window.setTimeout(function(){pydio.UI.focusOn(this)}.bind(this),200)},toggleFilterPane:function(){this.htmlElement.toggleClassName("fl-showFilterPane"),this.htmlElement.hasClassName("fl-showFilterPane")||this.clearMetadataFilters(),window.setTimeout(function(){this.resize()}.bind(this),0)},addMetadataFilter:function(metaName,metaValue){metaValue?this._filters.set(metaName,metaValue):this._filters.unset(metaName),this.softReload()},removeMetadataFilter:function(metaName){this._filters.unset(metaName),this.softReload()},clearMetadataFilters:function(){this._filters=$H(),this.softReload()},_rejectNodeByFilters:function(ajxpNode){var reject=!1;return this._filters.each(function(pair){if(this._filterNodeByMetadata(ajxpNode,pair.key,pair.value))throw reject=!0,$break}.bind(this)),reject},_filterNodeByMetadata:function(ajxpNode,metaName,metaValue){var currentMeta=ajxpNode.getMetadata().get(metaName);currentMeta||(currentMeta=""),metaValue=metaValue.toLowerCase(),currentMeta=currentMeta.toLocaleLowerCase();var reject=!1,correspond=!1;return metaValue.startsWith("!")&&(reject=!0,metaValue=metaValue.replace("!","")),correspond=metaValue.endsWith("*")?-1!==currentMeta.indexOf(metaValue.replace("*","")):currentMeta==metaValue,reject?correspond:!correspond},switchCurrentLabelToEdition:function(callback){var span,posSpan,sel=this.getSelectedItems(),item=sel[0],offset={top:0,left:0},scrollTop=0,addStyle={fontSize:"12px"};"list"==this._displayMode?(span=item.select("span.text_label")[0],posSpan=item.select("span.list_selectable_span")[0],offset.top=-3,offset.left=25,scrollTop=this.htmlElement.down("div.table_rows_container").scrollTop):"thumb"==this._displayMode?(span=item.select("div.thumbLabel")[0],posSpan=span,offset.top=-2,offset.left=3,scrollTop=this.htmlElement.down(".selectable_div").scrollTop):"detail"==this._displayMode&&(span=item.select("div.thumbLabel")[0],posSpan=span,offset.top=0,offset.left=0,scrollTop=this.htmlElement.down(".selectable_div").scrollTop,addStyle={fontSize:"20px",paddingLeft:"2px",color:"rgb(111, 121, 131)"});var pos=posSpan.cumulativeOffset();span.innerHTML;item.ajxpNode||(item.ajxpNode=$(item.id).ajxpNode);var edit=new Element("input",{value:item.ajxpNode.getLabel("text"),id:"editbox"}).setStyle({zIndex:5e3,position:"absolute",marginLeft:"0px",marginTop:"0px",height:"24px",padding:0});edit.setStyle(addStyle),$(document.getElementsByTagName("body")[0]).insert({bottom:edit}),modal.showContent("editbox",posSpan.getWidth()-offset.left+"","26",!0,!1,{opacity:.25,backgroundColor:"#fff"}),edit.setStyle({left:pos.left+offset.left+"px",top:pos.top+offset.top-scrollTop+"px"}),window.setTimeout(function(){edit.focus();var end=edit.getValue().lastIndexOf(".");if(-1==end)edit.select();else{var start=0;if(edit.setSelectionRange)edit.setSelectionRange(start,end);else if(edit.createTextRange){var range=edit.createTextRange();range.collapse(!0),range.moveStart("character",start),range.moveEnd("character",end),range.select()}}},300);var onOkAction=function(){var newValue=edit.getValue();hideLightBox(),modal.close(),callback(item.ajxpNode,newValue)};edit.observe("keydown",function(event){event.keyCode==Event.KEY_RETURN&&(Event.stop(event),onOkAction())}.bind(this));var buttons=modal.addSubmitCancel(edit,null,!1,"after");buttons.addClassName("inlineEdition");var ok=buttons.select('input[name="ok"]')[0];ok.observe("click",onOkAction);var origWidth=edit.getWidth()-44,newWidth=origWidth;70>origWidth&&(edit.setStyle({left:pos.left+offset.left-70+origWidth}),newWidth=70),"detail"==this._displayMode&&(origWidth-=20,newWidth-=20),edit.setStyle({width:newWidth+"px"}),buttons.select("input").invoke("setStyle",{margin:0,width:"22px",border:0,backgroundColor:"transparent"}),buttons.setStyle({position:"absolute",width:"46px",zIndex:2500,left:pos.left+offset.left+origWidth+"px",top:pos.top+offset.top-scrollTop+1+"px"});var closeFunc=function(){span.setStyle({color:""}),edit.remove(),buttons.remove()};span.setStyle({color:"#ddd"}),modal.setCloseAction(closeFunc)},getFromCache:function(cacheKey){var result;if(this._parsingCache.get(cacheKey))result=this._parsingCache.get(cacheKey);else{result=$H();var columns;switch(cacheKey){case"visibleColumns":columns=this.getVisibleColumns();break;case"hiddenColumns":columns=$A();var hColumns=this.hiddenColumns;hColumns.each(function(colName){var colObject=this.columnsDef.detect(function(element){return element.attributeName==colName});colObject&&columns.push(colObject)}.bind(this));break;case"tBody":var tBody=$(this._htmlElement).down("tbody");return this._parsingCache.set("tBody",tBody),tBody;default:columns=this.getColumnsDef()}columns.each(function(column){if(column.modifier&&!column.modifierFunc)try{column.modifierFunc=function(){var args=Array.from(arguments);column.modifierFuncWrapped&&column.modifierFuncWrapped.apply(null,args),ResourcesManager.detectModuleToLoadAndApply(column.modifier,function(){column.modifierFuncWrapped=eval(column.modifier),column.modifierFuncWrapped.apply(null,args)})}}catch(e){}result.set(column.attributeName,column)}),this._parsingCache.set(cacheKey,result)}return result},clearParsingCache:function(){this._parsingCache=new $H},ajxpNodeToTableRow:function(ajxpNode,replaceItem){var metaData=ProtoCompat.map2hash(ajxpNode.getMetadata()),newRow=new Element("tr",{id:"item-"+slugString(ajxpNode.getPath())}),tBody=this.getFromCache("tBody");metaData.each(function(pair){Prototype.Browser.IE&&"ID"==pair.key&&newRow.setAttribute("ajxp_sql_"+pair.key,pair.value)});for(var attributeList=this.getFromCache("visibleColumns"),attKeys=attributeList.keys(),i=0;i<attKeys.length;i++){var s=attKeys[i],tableCell=new Element("td"),fullview="";if(this._fullview&&(fullview=" full"),"ajxp_label"==s){var textLabel=new Element("span",{id:"ajxp_label",className:"text_label"+fullview}).update(metaData.get("text")),backgroundPosition=this.options.iconBgPosition||"4px 2px",backgroundImage='url("'+resolveImageSource(metaData.get("icon"),"/images/mimes/ICON_SIZE",16)+'")';if(metaData.get("overlay_class")&&ajaxplorer.currentThemeUsesIconFonts)metaData.get("overlay_class").split(",").each(function(c){textLabel.insert(new Element("span",{className:c+" overlay-class-span"}))});else if(metaData.get("overlay_icon")&&Modernizr.multiplebgs){var ovIcs=metaData.get("overlay_icon").split(",");switch(ovIcs.length){case 1:backgroundPosition="14px 11px, "+backgroundPosition,backgroundImage='url("'+resolveImageSource(ovIcs[0],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(metaData.get("icon"),"/images/mimes/ICON_SIZE",16)+'")';break;case 2:backgroundPosition="2px 11px, 14px 11px, "+backgroundPosition,backgroundImage='url("'+resolveImageSource(ovIcs[0],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[1],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(metaData.get("icon"),"/images/mimes/ICON_SIZE",16)+'")';break;case 3:backgroundPosition="14px 2px, 2px 11px, 14px 11px, "+backgroundPosition,backgroundImage='url("'+resolveImageSource(ovIcs[0],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[1],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[2],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(metaData.get("icon"),"/images/mimes/ICON_SIZE",16)+'")';break;case 4:default:backgroundPosition="2px 2px, 14px 2px, 2px 11px, 14px 11px, "+backgroundPosition,backgroundImage='url("'+resolveImageSource(ovIcs[0],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[1],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[2],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(ovIcs[3],"/images/overlays/ICON_SIZE",8)+'"), url("'+resolveImageSource(metaData.get("icon"),"/images/mimes/ICON_SIZE",16)+'")'}}textLabel.setStyle({paddingLeft:"24px",backgroundRepeat:"no-repeat",backgroundPosition:backgroundPosition,backgroundImage:backgroundImage});var innerSpan=new Element("span",{className:"list_selectable_span",style:"cursor:default;display:block;"}).update(textLabel);innerSpan.ajxpNode=ajxpNode,tableCell.insert(innerSpan),(void 0==this.options.draggable||this.options.draggable===!0)&&window.setTimeout(function(){if(this.htmlElement){if("ajxp_recycle"!=ajxpNode.getAjxpMime()){if(!this.htmlElement)return;new AjxpDraggable(innerSpan,{revert:!0,ghosting:!0,scroll:$("tree_container")?"tree_container":null,containerScroll:this.htmlElement.down("div.table_rows_container")},this,"filesList"),this.protoMenu&&this.protoMenu.addElements(innerSpan)}ajxpNode.isLeaf()||void 0!==this.options.droppable&&this.options.droppable!==!0||AjxpDroppables.add(innerSpan,ajxpNode)}}.bind(this),500)}else if("ajxp_modiftime"==s){var date=new Date;date.setTime(1e3*parseInt(metaData.get(s))),newRow.ajxp_modiftime=date,tableCell.innerHTML='<span class="text_label'+fullview+'">'+formatDate(date)+"</span>"}else{var metaValue=metaData.get(s)||"";tableCell.innerHTML='<span class="text_label'+fullview+'">'+metaValue+"</span>"}"grid"==this.gridStyle&&(tableCell.setAttribute("valign","top"),tableCell.setStyle({verticalAlign:"top",borderRight:"1px solid #eee"}),this.even&&tableCell.setStyle({borderRightColor:"#fff"}),""==tableCell.innerHTML&&(tableCell.innerHTML="&nbsp;")),this._headerResizer&&!this._headerResizer.options.useCSS3&&tableCell.addClassName("resizer_"+i),newRow.appendChild(tableCell),attributeList.get(s).modifierFunc&&attributeList.get(s).modifierFunc(tableCell,ajxpNode,"row",attributeList.get(s))}return this.getFromCache("hiddenColumns").each(function(pair){pair.value.modifierFunc&&pair.value.modifierFunc(null,ajxpNode,"row",pair.value,newRow)}),tBody.appendChild(newRow),replaceItem?replaceItem.hasClassName("even")&&$(newRow).addClassName("even"):(this.even&&$(newRow).addClassName("even"),this.even=!this.even),this.addInlineToolbar(textLabel?textLabel:tableCell,ajxpNode),newRow},ajxpNodeToDiv:function(ajxpNode){var newRow=new Element("div",{className:"thumbnail_selectable_cell",id:"item-"+slugString(ajxpNode.getPath())}),innerSpan=new Element("span",{style:"cursor:default;"}),img=this._previewFactory.generateBasePreview(ajxpNode),textNode=ajxpNode.getLabel(),label=new Element("div",{className:"thumbLabel",title:textNode.stripTags()}).update(textNode);if(innerSpan.insert({bottom:img}),innerSpan.insert({bottom:label}),newRow.insert({bottom:innerSpan}),newRow.IMAGE_ELEMENT=img,newRow.LABEL_ELEMENT=label,ajxpNode.getMetadata().get("overlay_icon")){var ovDiv=new Element("div"),ovIcs=$A(ajxpNode.getMetadata().get("overlay_icon").split(",")),bgPos=$A(),bgImg=$A(),bgRep=$A(),index=0;ovIcs.each(function(ic){bgPos.push("0px "+(12*index+(index>0?2:0))+"px"),bgImg.push("url('"+resolveImageSource(ovIcs[index],"/images/overlays/ICON_SIZE",12)+"')"),bgRep.push("no-repeat"),index++}),ovDiv.setStyle({position:"absolute",top:"3px",right:"2px",height:12*ovIcs.length+(ovIcs.length>1?2*(ovIcs.length-1):0)+"px",width:"12px",backgroundImage:bgImg.join(", "),backgroundPosition:bgPos.join(", "),backgroundRepeat:bgRep.join(", ")}),ajxpNode.getMetadata().get("overlay_class")&&ajaxplorer.currentThemeUsesIconFonts&&(ajxpNode.getMetadata().get("overlay_class").split(",").each(function(ovC){ovDiv.insert(new Element("span",{className:ovC+" overlay-class-span"}))}),ovDiv.addClassName("overlay_icon_div")),innerSpan.insert({after:ovDiv})}return this._htmlElement.insert(newRow),this.getFromCache("columns").each(function(pair){pair.value.modifierFunc&&pair.value.modifierFunc(newRow,ajxpNode,"thumb",pair.value)}),this._previewFactory.enrichBasePreview(ajxpNode,newRow),ajxpNode.isRecycle()||window.setTimeout(function(){this.htmlElement&&(new AjxpDraggable(newRow,{revert:!0,ghosting:!0,scroll:$("tree_container")?"tree_container":null,containerScroll:this.htmlElement.down(".selectable_div")},this,"filesList"),ajxpNode.isLeaf()||void 0!==this.options.droppable&&this.options.droppable!==!0||AjxpDroppables.add(newRow,ajxpNode))}.bind(this),500),this.addInlineToolbar(newRow,ajxpNode),newRow},ajxpNodeToLargeDiv:function(ajxpNode){var largeRow=new Element("div",{className:"thumbnail_selectable_cell detailed",id:"item-"+slugString(ajxpNode.getPath())+"-cont"}),metadataDiv=new Element("div",{className:"thumbnail_cell_metadata"}),newRow=new Element("div",{className:"thumbnail_selectable_cell",id:ajxpNode.getPath()}),metaData=ajxpNode.getMetadata(),innerSpan=new Element("span",{style:"cursor:default;"}),img=this._previewFactory.generateBasePreview(ajxpNode),textNode=ajxpNode.getLabel(),label=new Element("div",{className:"thumbLabel",title:textNode.stripTags()}).update(textNode);if(innerSpan.insert({bottom:img}),newRow.insert({bottom:innerSpan}),newRow.IMAGE_ELEMENT=img,newRow.LABEL_ELEMENT=label,ajxpNode.getMetadata().get("overlay_icon")){var ovDiv=new Element("div"),ovIcs=$A(ajxpNode.getMetadata().get("overlay_icon").split(",")),bgPos=$A(),bgImg=$A(),bgRep=$A(),index=0;ovIcs.each(function(ic){bgPos.push("0px "+(12*index+(index>0?2:0))+"px"),bgImg.push("url('"+resolveImageSource(ovIcs[index],"/images/overlays/ICON_SIZE",12)+"')"),bgRep.push("no-repeat"),index++}),ovDiv.setStyle({position:"absolute",top:"3px",right:"2px",height:12*ovIcs.length+(ovIcs.length>1?2*(ovIcs.length-1):0)+"px",width:"12px",backgroundImage:bgImg.join(", "),backgroundPosition:bgPos.join(", "),backgroundRepeat:bgRep.join(", ")}),ajxpNode.getMetadata().get("overlay_class")&&ajaxplorer.currentThemeUsesIconFonts?(ajxpNode.getMetadata().get("overlay_class").split(",").each(function(ovC){ovDiv.insert(new Element("span",{className:ovC+" overlay-class-span"}))}),ovDiv.addClassName("overlay_icon_div")):newRow.setStyle({position:"relative"}),innerSpan.insert({after:ovDiv})}largeRow.insert(newRow),largeRow.insert(label),largeRow.insert(metadataDiv);var addedCell=0;metaData.get("ajxp_description")&&(addedCell++,metadataDiv.insert(new Element("span",{className:"metadata_chunk metadata_chunk_description"}).update(metaData.get("ajxp_description"))));for(var attributeList=this.getFromCache("visibleColumns"),first=!1,attKeys=attributeList.keys(),i=0;i<attKeys.length;i++){var s=attKeys[i],cell=new Element("span",{className:"metadata_chunk metadata_chunk_standard metadata_chunk_"+s});if("ajxp_label"!=s){if("ajxp_modiftime"==s){var date=new Date;date.setTime(1e3*parseInt(metaData.get(s))),newRow.ajxp_modiftime=date,cell.update('<span class="text_label">'+formatDate(date)+"</span>")}else if("ajxp_dirname"==s&&metaData.get("filename")){var dirName=getRepName(metaData.get("filename"));cell.update('<span class="text_label">'+(dirName?dirName:"/")+"</span>")}else{if("filesize"==s&&"-"==metaData.get(s))continue;var metaValue=metaData.get(s)||"";if(!metaValue)continue;cell.update('<span class="text_label">'+metaValue+"</span>")}first||cell.insert({top:new Element("span",{className:"icon-angle-right"})}),metadataDiv.insert(cell),addedCell++,first=!1,attributeList.get(s).modifierFunc&&attributeList.get(s).modifierFunc(cell,ajxpNode,"detail",attributeList.get(s))}}return addedCell||largeRow.addClassName("metadata_empty"),this._htmlElement.insert(largeRow),this.getFromCache("hiddenColumns").each(function(pair){pair.value.modifierFunc&&pair.value.modifierFunc(largeRow,ajxpNode,"detail",pair.value)}),this._previewFactory.enrichBasePreview(ajxpNode,newRow),ajxpNode.isRecycle()||window.setTimeout(function(){this.htmlElement&&(new AjxpDraggable(largeRow,{revert:!0,ghosting:!0,scroll:$("tree_container")?"tree_container":null,containerScroll:this.htmlElement.down(".selectable_div")},this,"filesList"),ajxpNode.isLeaf()||void 0!==this.options.droppable&&this.options.droppable!==!0||AjxpDroppables.add(largeRow,ajxpNode))}.bind(this),500),this.addInlineToolbar(largeRow,ajxpNode),largeRow},addInlineToolbar:function(element,ajxpNode){if(this._inlineToolbarOptions){var options=this._inlineToolbarOptions;this._inlineToolbarOptions.unique||(options=Object.extend(this._inlineToolbarOptions,{attachToNode:ajxpNode}));var tBarElement=new Element("div",{id:"FL-tBar-"+this._instanciatedToolbars.size(),className:"FL-inlineToolbar"+(this._inlineToolbarOptions.unique?" FL-inlineToolbarUnique":" FL-inlineToolbarMultiple")});element.insert(tBarElement);var aT=new ActionsToolbar(tBarElement,options);if(aT.actions=ProtoCompat.map2hash(pydio.getController().actions),aT.initToolbars(),!this._inlineToolbarOptions.unique){var dm=this._dataModel?this._dataModel:ajaxplorer.getContextHolder();aT.registeredButtons.each(function(button){button.stopObserving("click"),button.observe("click",function(event){Event.stop(event),dm.setSelectedNodes([ajxpNode]),window.setTimeout(function(){button.ACTION.apply([ajxpNode])},20)})})}this._instanciatedToolbars.push(aT)}},partSizeCellRenderer:function(element,ajxpNode,type,metadataDef){if(element&&("row"==type?element.setAttribute("data-sorter_value",ajxpNode.getMetadata().get("bytesize")):element.setAttribute("data-"+metadataDef.attributeName+"-sorter_value",ajxpNode.getMetadata().get("bytesize")),ajxpNode.getMetadata().get("target_bytesize"))){var percent=parseInt(parseInt(ajxpNode.getMetadata().get("bytesize"))/parseInt(ajxpNode.getMetadata().get("target_bytesize"))*100),uuid="ajxp_"+(new Date).getTime(),div=new Element("div",{style:"padding-left:3px;",className:"text_label"}).update('<span class="percent_text" style="line-height:19px;padding-left:5px;">'+percent+"%</span>"),span=new Element("span",{id:uuid}).update("0%"),options={animate:!0,showText:!1,width:80,boxImage:window.ajxpResourcesFolder+"/images/progress_box_80.gif",barImage:window.ajxpResourcesFolder+"/images/progress_bar_80.gif",height:8,visualStyle:"position:relative;"};if("detail"==type&&element.down(".thumbnail_cell_metadata")?element.down(".thumbnail_cell_metadata").update(div):element.update(div),div.insert({top:span}),ajxpNode.getMetadata().get("process_stoppable")){var stopButton=new Element("a",{className:"pg_cancel_button"}).update("X");stopButton.observe("click",function(){var conn=new Connexion;conn.setParameters({action:"stop_dl",file:ajxpNode.getPath(),dir:this.getCurrentContextNode().getPath()}),conn.onComplete=function(transport){"stop"==transport.responseText&&$(uuid).pe&&($(uuid).pe.stop(),$(uuid).pgBar.setPercentage(0),window.setTimeout(function(){pydio.getController().fireAction("refresh")},2))},conn.sendAsync()}.bind(this)),div.insert({bottom:stopButton})}span.setAttribute("data-target_size",ajxpNode.getMetadata().get("target_bytesize")),window.setTimeout(function(){span.pgBar=new JS_BRAMUS.jsProgressBar(span,percent,options);var pe=new PeriodicalExecuter(function(){if(!$(uuid))return void pe.stop();var conn=new Connexion;conn.discrete=!0,conn.setParameters({action:"update_dl_data",file:ajxpNode.getPath()}),conn.onComplete=function(transport){if("stop"==transport.responseText)pe.stop(),pydio.getController().fireAction("refresh");else{var newPercentage=parseInt(parseInt(transport.responseText)/parseInt($(uuid).getAttribute("data-target_size"))*100);$(uuid).pgBar.setPercentage(newPercentage),$(uuid).next("span.percent_text").update(newPercentage+"%")}},conn.sendAsync()},2);$(uuid).pe=pe},2)}},resizeThumbnails:function(one_element,skipResize){var elList;elList=one_element?[one_element]:this._htmlElement.select("div.thumbnail_selectable_cell"),"detail"==this._displayMode&&(elList=this._htmlElement.select("div.thumbnail_selectable_cell.detailed"));var ellipsisDetected,tSize=0;if(elList.each(function(element){try{var image_element=element.IMAGE_ELEMENT||element.down("img"),label_element=element.LABEL_ELEMENT||element.down(".thumbLabel")}catch(e){return}var elementsAreSiblings=label_element&&-1!==label_element.siblings().indexOf(image_element);if(tSize=this.getAdjustedThumbSize(element),element.removeClassName("fl-displayMode-thumbsize-small"),element.removeClassName("fl-displayMode-thumbsize-medium"),element.removeClassName("fl-displayMode-thumbsize-large"),element.addClassName(80>tSize?"fl-displayMode-thumbsize-small":150>tSize?"fl-displayMode-thumbsize-medium":"fl-displayMode-thumbsize-large"),element.down("div.thumbnail_selectable_cell")?element.down("div.thumbnail_selectable_cell").setStyle({width:tSize+5+"px",height:tSize+10+"px"}):element.setStyle({width:tSize+25+"px",height:tSize+10+"px"}),this._previewFactory.setThumbSize(tSize),image_element&&this._previewFactory.resizeThumbnail(image_element),void 0==ellipsisDetected&&(ellipsisDetected="ellipsis"==label_element.getStyle("textOverflow")),label_element&&!ellipsisDetected){var el_width=elementsAreSiblings?tSize+25:element.getWidth()-tSize-10,charRatio=6,nbChar=parseInt(el_width/charRatio),label=String(label_element.getAttribute("title"));label_element.innerHTML=label.truncate(nbChar,"...")}}.bind(this)),this.options.horizontalScroll){var scrollElement=this.htmlElement.down(".selectable_div");scrollElement.setStyle({width:elList.length*(this._thumbSize+46)+"px"})}return this.options.fit&&"content"==this.options.fit&&!skipResize&&this.resize(),tSize},getAdjustedThumbSize:function(referenceElement){var tSize="detail"==this._displayMode?this._detailThumbSize:this._thumbSize;if("thumb"==this._displayMode&&!this._fixedThumbSize){var w=this._htmlElement.getWidth(),margin=parseInt(referenceElement.getStyle("marginLeft"))+parseInt(referenceElement.getStyle("marginRight")),realBlockSize=tSize+25+margin,number=Math.ceil(w/realBlockSize),blockSize=w/number;tSize=blockSize-25-margin}return tSize},redistributeBackgrounds:function(){var allItems=this.getItems();this.even=!1;for(var i=0;i<allItems.length;i++)this.even?$(allItems[i]).addClassName("even").removeClassName("odd"):$(allItems[i]).removeClassName("even").addClassName("odd"),this.even=!this.even},removeCurrentLines:function(skipFireChange){this.notify("rows:willClear"),this._instanciatedToolbars&&this._instanciatedToolbars.size()&&(this._instanciatedToolbars.invoke("destroy"),this._instanciatedToolbars=$A());var rows;rows=$(this._htmlElement).select("list"==this._displayMode?"tr":"div.thumbnail_selectable_cell");for(var i=0;i<rows.length;i++){try{rows[i].ajxpNode&&(rows[i].REPLACE_OBS&&rows[i].ajxpNode.stopObserving("node_replaced",rows[i].REPLACE_OBS),rows[i].REMOVE_OBS&&rows[i].ajxpNode.stopObserving("node_removed",rows[i].REMOVE_OBS)),rows[i].innerHTML="",rows[i].IMAGE_ELEMENT&&(rows[i].IMAGE_ELEMENT.destroyElement&&rows[i].IMAGE_ELEMENT.destroyElement(),rows[i].IMAGE_ELEMENT=null,delete rows[i].IMAGE_ELEMENT)}catch(e){}rows[i].parentNode&&rows[i].remove()}skipFireChange||this.fireChange(),this.notify("rows:didClear")},setOnLoad:function(){if(this.options.silentLoading)return void(this.loading=!0);if(!this.loading){this.htmlElement.setStyle({position:"relative"});var element=this.htmlElement;addLightboxMarkupToElement(element);var img=new Element("img",{src:ajxpResourcesFolder+"/images/loadingImage.gif"}),overlay=this.htmlElement.down("#element_overlay");overlay.insert(img),img.setStyle({marginTop:Math.max(0,(overlay.getHeight()-img.getHeight())/2)+"px"}),this.loading=!0}},removeOnLoad:function(){return this.options.silentLoading?void(this.loading=!1):(this.htmlElement&&removeLightboxFromElement(this.htmlElement),void(this.loading=!1))},fireChange:function(){this._fireChange&&this.hasFocus&&(this._dataModel?this._dataModel.setSelectedNodes(this.getSelectedNodes()):ajaxplorer.updateContextData(null,this.getSelectedNodes(),this))},fireDblClick:function(e){if("ajxp_recycle"!=this.getCurrentContextNode().getAjxpMime()){var selRaw=this.getSelectedItems();if(selRaw&&selRaw.length){var selNode=selRaw[0].ajxpNode;return this._doubleClickListener?void this._doubleClickListener(selNode):void(this._dataModel||(selNode.isLeaf()?pydio.getController().fireDefaultAction("file"):pydio.getController().fireDefaultAction("dir",selNode)))}}},selectFile:function(fileName,multiple){fileName=getBaseName(fileName);for(var allItems=this.getItems(),i=0;i<allItems.length;i++)getBaseName(allItems[i].ajxpNode.getPath())==getBaseName(fileName)?this.setItemSelected(allItems[i],!0):null==multiple&&this.setItemSelected(allItems[i],!1)},enableTextSelection:function(target){target.origOnSelectStart&&(target.onselectstart=target.origOnSelectStart),target.unselectable="off",target.style.MozUserSelect="text"},disableTextSelection:function(target,deep){target.onselectstart&&(target.origOnSelectStart=target.onselectstart,
target.onselectstart=function(){return!1}),target.unselectable="on",target.style.MozUserSelect="none",$(target).addClassName("no_select_bg"),deep&&$(target).select("td,img,div,span").each(function(td){this.disableTextSelection(td,!1)}.bind(this))},keydown:function(event){if(ajaxplorer.blockNavigation||this.blockNavigation)return!1;if(9==event.keyCode&&!ajaxplorer.blockNavigation)return!1;if(!this.hasFocus)return!0;var keyCode=event.keyCode;if("thumb"!=this._displayMode&&keyCode!=Event.KEY_UP&&keyCode!=Event.KEY_DOWN&&keyCode!=Event.KEY_RETURN&&keyCode!=Event.KEY_END&&keyCode!=Event.KEY_HOME)return!0;if("thumb"==this._displayMode&&keyCode!=Event.KEY_UP&&keyCode!=Event.KEY_DOWN&&keyCode!=Event.KEY_LEFT&&keyCode!=Event.KEY_RIGHT&&keyCode!=Event.KEY_RETURN&&keyCode!=Event.KEY_END&&keyCode!=Event.KEY_HOME)return!0;var items=this._selectedItems;if(0==items.length)return!1;var oldFireChange=this._fireChange;this._fireChange=!1;var selectedBefore=this.getSelectedItems();Event.stop(event);var nextItem,nextItemIndex,currentItem,shiftKey=event.shiftKey;currentItem=items[items.length-1];var i,allItems=this.getItems(),currentItemIndex=this.getItemIndex(currentItem),selectLine=!1;if(event.keyCode==Event.KEY_RETURN){for(i=0;i<items.length;i++)this.setItemSelected(items[i],!1);return this.setItemSelected(currentItem,!0),this.fireDblClick(null),this._fireChange=oldFireChange,!1}if(event.keyCode==Event.KEY_END?(nextItem=allItems[allItems.length-1],shiftKey&&this._multiple&&(selectLine=!0,nextItemIndex=allItems.length-1)):event.keyCode==Event.KEY_HOME?(nextItem=allItems[0],shiftKey&&this._multiple&&(selectLine=!0,nextItemIndex=0)):event.keyCode==Event.KEY_UP?"thumb"!=this._displayMode?nextItem=this.getPrevious(currentItem):(nextItemIndex=this.findOverlappingItem(currentItemIndex,!1),null!=nextItemIndex&&(nextItem=allItems[nextItemIndex],selectLine=!0)):event.keyCode==Event.KEY_LEFT?nextItem=this.getPrevious(currentItem):event.keyCode==Event.KEY_DOWN?"thumb"!=this._displayMode?nextItem=this.getNext(currentItem):(nextItemIndex=this.findOverlappingItem(currentItemIndex,!0),null!=nextItemIndex&&(nextItem=allItems[nextItemIndex],selectLine=!0)):event.keyCode==Event.KEY_RIGHT&&(nextItem=this.getNext(currentItem)),null==nextItem)return this._fireChange=oldFireChange,!1;if(shiftKey&&this._multiple){if(selectLine)if(nextItemIndex>=currentItemIndex)for(i=currentItemIndex+1;nextItemIndex>i;i++)this.setItemSelected(allItems[i],!allItems[i]._selected);else for(i=nextItemIndex+1;currentItemIndex>i;i++)this.setItemSelected(allItems[i],!allItems[i]._selected)}else for(i=0;i<items.length;i++)this.setItemSelected(items[i],!1);this.setItemSelected(nextItem,!nextItem._selected);var found,changed=selectedBefore.length!=this._selectedItems.length;if(!changed)for(i=0;i<selectedBefore.length;i++){found=!1;for(var j=0;j<this._selectedItems.length;j++)if(selectedBefore[i]==this._selectedItems[j]){found=!0;break}if(!found){changed=!0;break}}return this._fireChange=oldFireChange,changed&&this._fireChange&&this.fireChange(),!1},findOverlappingItem:function(currentItemIndex,bDown){if(!bDown&&0==currentItemIndex)return null;var allItems=this.getItems();if(bDown&&currentItemIndex==allItems.length-1)return null;var searchingPosY,i,element=$(allItems[currentItemIndex]),pos=Position.cumulativeOffset(element),dims=Element.getDimensions(element),searchingPosX=pos[0]+parseInt(dims.width/2);if(bDown){for(searchingPosY=pos[1]+parseInt(3*dims.height/2),i=currentItemIndex+1;i<allItems.length;i++)if(Position.within($(allItems[i]),searchingPosX,searchingPosY))return i;return null}for(searchingPosY=pos[1]-parseInt(dims.height/2),i=currentItemIndex-1;i>-1;i--)if(Position.within($(allItems[i]),searchingPosX,searchingPosY))return i;return null},isItem:function(node){return"list"==this._displayMode?!(null==node||"TR"!=node.tagName&&"tr"!=node.tagName||"TBODY"!=node.parentNode.tagName&&"tbody"!=node.parentNode.tagName||node.parentNode.parentNode!=this._htmlElement):null!=node&&("DIV"==node.tagName||"div"==node.tagName)&&node.parentNode==this._htmlElement},getItems:function(){if("list"==this._displayMode)return this._htmlElement.rows||[];for(var tmp=[],j=0,cs=this._htmlElement.childNodes,l=cs.length,i=0;l>i;i++)1==cs[i].nodeType&&(tmp[j++]=cs[i]);return tmp},getItemIndex:function(el){if("list"==this._displayMode)return el.rowIndex;for(var j=0,cs=this._htmlElement.childNodes,l=cs.length,i=0;l>i;i++){if(cs[i]==el)return j;1==cs[i].nodeType&&j++}return-1},getItem:function(nIndex){if("list"==this._displayMode)return this._htmlElement.rows[nIndex];for(var j=0,cs=this._htmlElement.childNodes,l=cs.length,i=0;l>i;i++)if(1==cs[i].nodeType){if(j==nIndex)return cs[i];j++}return null}}),Class.create("FoldersTree",AjxpPane,{__implements:["IFocusable","IContextMenuable"],initialize:function($super,oElement,options){if($super(oElement,options),this.treeContainer=new Element("div",{id:"tree_container",style:"overflow:auto;height:100%;width:100%;"}),this.options.replaceScroller&&(this.scroller=new Element("div",{id:"tree_scroller",className:"scroller_track",style:"right:"+(parseInt(oElement.getStyle("marginRight"))-parseInt(oElement.getStyle("paddingRight")))+"px"}),this.scroller.insert('<div id="scrollbar_handle" class="scroller_handle"></div>'),oElement.insert(this.scroller),this.treeContainer.setStyle({overflow:"hidden"})),this.registeredObservers=$H(),oElement.insert(this.treeContainer),disableTextSelection(this.treeContainer),this.options.replaceScroller){this.scrollbar=new Control.ScrollBar("tree_container","tree_scroller");var scrollbarLayoutObserver=this.scrollbar.recalculateLayout.bind(this.scrollbar);document.observe("ajaxplorer:tree_change",scrollbarLayoutObserver),this.registeredObservers.set("ajaxplorer:tree_change",scrollbarLayoutObserver)}this.options={},options&&(this.options=options);var thisObject=this,action=function(e){ajaxplorer&&(pydio.UI.focusOn(thisObject),this.ajxpNode&&(ajaxplorer.getUserSelection().getContextNode()!=this.ajxpNode&&pydio.getController().fireDefaultAction("dir",this.ajxpNode),ajaxplorer.getUserSelection().setSelectedNodes([this.ajxpNode],thisObject)))},filter=this.createFilter(),fakeRootNode=new AjxpNode("/",!0,MessageHash[391],"folder.png");fakeRootNode._isLoaded=!0,this.tree=new AJXPTree(fakeRootNode,action,filter),this.treeContainer.update(this.tree.toString()),$(this.tree.id).ajxpNode=this.tree.ajxpNode,$(this.tree.id).observe("click",function(e){this.action(e),Event.stop(e)}.bind(this.tree)),AjxpDroppables.add(this.tree.id,this.tree.ajxpNode),this.tree.open||this.tree.loading||this.tree.toggle(),this.treeContainer.observe("click",function(){pydio.UI.focusOn(this)}.bind(this)),this.rootNodeId=this.tree.id;var ctxChangedObs=function(event){var path=event.memo.getPath();window.setTimeout(function(e){this.setSelectedPath(path)}.bind(this),100)}.bind(this);document.observe("ajaxplorer:context_changed",ctxChangedObs),this.registeredObservers.set("ajaxplorer:context_changed",ctxChangedObs);var rootNodeObs=function(event){var ajxpRootNode=event.memo;this.tree.setAjxpRootNode(ajxpRootNode),this.changeRootLabel(ajxpRootNode.getLabel(),ajxpRootNode.getIcon())}.bind(this);document.observe("ajaxplorer:root_node_changed",rootNodeObs),this.registeredObservers.set("ajaxplorer:root_node_changed",rootNodeObs);var compConfChanged=function(event){if("FoldersTree"==event.memo.className){for(var config=event.memo.classConfig.get("all"),options=XPathSelectNodes(config,"property"),i=0;i<options.length;i++)this.options[options[i].getAttribute("name")]=options[i].getAttribute("value");this.tree&&(this.tree.filter=this.createFilter())}}.bind(this);document.observe("ajaxplorer:component_config_changed",compConfChanged),this.registeredObservers.set("ajaxplorer:component_config_changed",compConfChanged)},destroy:function($super){this.registeredObservers.each(function(pair){document.stopObserving(pair.key,pair.value)}),this.scrollbar&&this.scrollbar.destroy(),this.tree&&this.tree.destroy();try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}$super()},createFilter:function(){var displayOptions=this.options.display||"dz";displayOptions.indexOf("a")>-1&&(displayOptions="dzf"),displayOptions.indexOf("z")>-1&&window.zipEnabled===!1&&(displayOptions=displayOptions.split("z").join("")),this.options.display=displayOptions;var d=displayOptions.indexOf("d")>-1,z=displayOptions.indexOf("z")>-1,f=displayOptions.indexOf("f")>-1;return function(ajxpNode){return(d&&!ajxpNode.isLeaf()||f&&ajxpNode.isLeaf()||z&&("zip"==ajxpNode.getAjxpMime()||"ajxp_browsable_archive"==ajxpNode.getAjxpMime()))&&"ajxp_recycle"!=ajxpNode.getParent().getAjxpMime()}},focus:function(){webFXTreeHandler.selected&&(webFXTreeHandler.selected.focus(),webFXTreeHandler.selected.ajxpNode&&ajaxplorer.getUserSelection().setSelectedNodes([webFXTreeHandler.selected.ajxpNode],this)),webFXTreeHandler.setFocus(!0),this.hasFocus=!0},blur:function(){webFXTreeHandler.selected&&webFXTreeHandler.selected.blur(),webFXTreeHandler.setFocus(!1),this.hasFocus=!1},resize:function(){this.options.fit&&"content"==this.options.fit||fitHeightToBottom(this.treeContainer,this.options.fitParent),this.scrollbar&&this.scrollbar.recalculateLayout(parseInt(this.treeContainer.getHeight())),document.fire("ajaxplorer:resize-FoldersTree-"+this.htmlElement.id,this.htmlElement.getDimensions())},showElement:function(show){show?this.treeContainer.show():this.treeContainer.hide()},setContextualMenu:function(protoMenu){Event.observe(this.rootNodeId+"","contextmenu",function(event){this.select(),this.action(),Event.stop(event)}.bind(webFXTreeHandler.all[this.rootNodeId])),protoMenu.addElements("#"+this.rootNodeId),webFXTreeHandler.contextMenu=protoMenu},getNodeByPath:function(path){for(var key in webFXTreeHandler.all)if(webFXTreeHandler.all[key]&&webFXTreeHandler.all[key].ajxpNode&&webFXTreeHandler.all[key].ajxpNode.getPath()==path)return webFXTreeHandler.all[key];return void 0},setSelectedPath:function(path){if(""==path||"/"==path)return void this.tree.select();for(var parts=this.cleanPathToArray(path),crtPath="",i=0;i<parts.length;i++){crtPath+="/"+parts[i];var node=this.getNodeByPath(crtPath);node&&node.childNodes.length&&node._webfxtree_expand()}node&&node.select()},cleanPathToArray:function(url){for(var splitPath=url.split("/"),path=$A(),j=0,i=0;i<splitPath.length;i++)""!=splitPath[i]&&(path[j]=splitPath[i],j++);return path},changeRootLabel:function(newLabel,newIcon){this.changeNodeLabel(this.tree.id,newLabel,newIcon)},changeNodeLabel:function(nodeId,newLabel,newIcon){if($(nodeId+"-label").update(newLabel),newIcon){var realNode=webFXTreeHandler.all[nodeId];realNode.icon=newIcon,realNode.openIcon=newIcon}},switchCurrentLabelToEdition:function(callback){var sel=webFXTreeHandler.selected;if(sel){var scrollTop,nodeId=webFXTreeHandler.selected.id,item=this.treeContainer.down("#"+nodeId),offset={top:0,left:0},span=item.down("a");offset.top=1,offset.left=43,scrollTop=this.treeContainer.scrollTop;var pos=item.cumulativeOffset(),edit=(span.innerHTML,new Element("input",{value:item.ajxpNode.getLabel("text"),id:"editbox"}).setStyle({zIndex:5e3,position:"absolute",marginLeft:"0px",marginTop:"0px",height:"24px",padding:0}));$(document.getElementsByTagName("body")[0]).insert({bottom:edit}),modal.showContent("editbox",item.getWidth()-offset.left+"","20",!0,!1,{opacity:.25,backgroundColor:"#fff"}),edit.setStyle({left:pos.left+offset.left+"px",top:pos.top+offset.top-scrollTop+"px"}),window.setTimeout(function(){edit.focus();var end=edit.getValue().lastIndexOf(".");if(-1==end)edit.select();else{var start=0;if(edit.setSelectionRange)edit.setSelectionRange(start,end);else if(edit.createTextRange){var range=edit.createTextRange();range.collapse(!0),range.moveStart("character",start),range.moveEnd("character",end),range.select()}}},300);var onOkAction=function(){var newValue=edit.getValue();hideLightBox(),modal.close(),callback(item.ajxpNode,newValue)};edit.observe("keydown",function(event){event.keyCode==Event.KEY_RETURN&&(Event.stop(event),onOkAction())}.bind(this));var buttons=modal.addSubmitCancel(edit,null,!1,"after");buttons.addClassName("inlineEdition");var ok=buttons.select('input[name="ok"]')[0];ok.observe("click",onOkAction);var origWidth=edit.getWidth()-44,newWidth=origWidth;70>origWidth&&(edit.setStyle({left:pos.left+offset.left-70+origWidth}),newWidth=70),edit.setStyle({width:newWidth+"px"}),buttons.select("input").invoke("setStyle",{margin:0,width:"22px",border:0,backgroundColor:"transparent"}),buttons.setStyle({position:"absolute",width:"46px",zIndex:2500,left:pos.left+offset.left+origWidth+"px",top:pos.top+offset.top-scrollTop-1+"px"});var closeFunc=function(){span.setStyle({color:""}),edit.remove(),buttons.remove()};span.setStyle({color:"#ddd"}),modal.setCloseAction(closeFunc)}}}),Class.create("SearchEngine",AjxpPane,{htmlElement:void 0,_inputBox:void 0,_resultsBoxId:void 0,_searchButtonName:void 0,state:"idle",_runningQueries:void 0,_queriesIndex:0,_ajxpOptions:void 0,_queue:void 0,_searchMode:"local",_even:!1,_rootNode:null,_dataModel:null,_fileList:null,initialize:function($super,mainElementName,ajxpOptions){this._ajxpOptions={toggleResultsVisibility:!1},$(mainElementName).getAttribute("data-globalOptions")&&(this._ajxpOptions=$(mainElementName).getAttribute("data-globalOptions").evalJSON()),ajxpOptions&&(this._ajxpOptions=Object.extend(this._ajxpOptions,ajxpOptions)),$super($(mainElementName),this._ajxpOptions),this._ajxpOptions.metaColumns||(this._ajxpOptions.metaColumns={}),this.updateSearchModeFromRegistry(),this.searchModeObserver=this.updateSearchModeFromRegistry.bind(this),this._dataModel=new PydioDataModel(!0),this._rootNode=new AjxpNode("/",!1,"Results","folder.png"),this._dataModel.setRootNode(this._rootNode),this.initGUI(),this._dataModel.observe("selection_changed",function(){var selectedNode=this._dataModel.getSelectedNodes()[0];selectedNode&&(this._ajxpOptions.openSearchInput&&this.closeSearchInput(),ajxpOptions.leavesOpenOnSelect&&selectedNode.isLeaf()?pydio.UI.openCurrentSelectionInEditor(null,selectedNode):ajaxplorer.goTo(selectedNode),this._dataModel.setSelectedNodes([]))}.bind(this))},updateSearchModeFromRegistry:function(){if(this.htmlElement){$(this._resultsBoxId)&&!this._rootNode?$(this._resultsBoxId).update(""):this._rootNode&&this._rootNode.clear();var reg=ajaxplorer.getXmlRegistry(),indexerNode=XPathSelectSingleNode(reg,"plugins/indexer");if(null!=indexerNode){if(indexerNode.getAttribute("indexed_meta_fields"))if(this.indexedFields=indexerNode.getAttribute("indexed_meta_fields").evalJSON(),this.indexedFields.indexed_meta_fields){var addColumns=this.indexedFields.additionnal_meta_columns;this.indexedFields=$A(this.indexedFields.indexed_meta_fields),this._ajxpOptions.metaColumns||(this._ajxpOptions.metaColumns={});for(var key in addColumns)addColumns.hasOwnProperty(key)&&(this._ajxpOptions.metaColumns[key]=addColumns[key])}else this.indexedFields=$A(this.indexedFields);else this.indexedFields=$A();this._searchMode="remote"}else this._searchMode="local";this.htmlElement&&this.htmlElement.down("#search_meta")&&this.htmlElement.down("#search_meta").remove(),this.htmlElement.down("#search_form")&&this.htmlElement.down("#search_form").down("#search_meta")&&this.htmlElement.down("#search_form").down("#search_meta").remove(),this._ajxpOptions&&this._ajxpOptions.metaColumns&&(this._ajxpOptions.toggleResultsVisibility&&this.htmlElement&&this.htmlElement.down("#"+this._ajxpOptions.toggleResultsVisibility)?this.htmlElement.down("#"+this._ajxpOptions.toggleResultsVisibility).insert({top:'<div id="search_meta"></div>'}):this.htmlElement.down("#search_form")&&this.htmlElement.down("#search_form").insert({bottom:'<div id="search_meta"></div>'}),this.htmlElement.down("#search_meta")&&this.loadRenderersAndInitMetadataForm(this.htmlElement.down("#search_meta"),this._ajxpOptions.metaColumns))}},loadRenderersAndInitMetadataForm:function(formPanel,metadataColumns){if(!this._ajxpOptions.metaColumnsRenderers)return void this.initMetadataForm(formPanel,metadataColumns);var collectClasses=$H();$H(this._ajxpOptions.metaColumnsRenderers).each(function(pair){collectClasses.set(pair.value.split(".",1).shift(),!0)}.bind(this)),ResourcesManager.loadClassesAndApply(collectClasses.keys(),function(){this.initMetadataForm(formPanel,metadataColumns)}.bind(this))},initMetadataForm:function(formPanel,metadataColumns){var searchChooser=new Element("div",{id:"basic_search"}).update('<span class="toggle_button open"><span class="icon-chevron-left"></span> '+MessageHash[486]+'</span><span class="toggle_button close"><span class="icon-chevron-right"></span> '+MessageHash[487]+'</span> <span class="search_label open">'+MessageHash[344]+' : </span><span class="search_label close">'+MessageHash[488]+' <span id="refresh_search_button" class="icon-refresh" title="Apply filter now"></span></span><span id="search_meta_options"></span></div>');formPanel.insert(this._ajxpOptions.searchChooserAsResultsHeader?{after:searchChooser}:searchChooser),formPanel.insert('<div style="height: 100%;"><div class="scroller_track"><div class="scroller_handle"></div></div> <div id="search_meta_detailed"><div class="advanced_search_section_title"><span class="icon-circle"></span> '+MessageHash[489]+'</div><div class="advanced_search_section search_section_freemeta"></div></div></div>');var oThis=this;searchChooser.select(".toggle_button").invoke("observe","click",function(){formPanel.toggleClassName("toggle_open"),searchChooser.toggleClassName("toggle_open"),window.setTimeout(function(){oThis.resize()},150),formPanel.hasClassName("toggle_open")&&!formPanel.down("#basename").getValue()&&oThis._inputBox.getValue()&&(formPanel.down("#basename").setValue(oThis._inputBox.getValue()),formPanel.down("#basename").up(".advanced_search_section").addClassName("visible")),oThis._closeAdvancedPanel=function(){formPanel.hasClassName("toggle_open")&&(formPanel.toggleClassName("toggle_open"),searchChooser.toggleClassName("toggle_open"))},oThis._advancedPanelOpen=formPanel.hasClassName("toggle_open")});var simpleMeta=searchChooser.down("#search_meta_options"),advancedMeta=formPanel.down("#search_meta_detailed").down(".advanced_search_section");this.initMetaOption(simpleMeta,advancedMeta,"filename",MessageHash[1],!0);for(var key in metadataColumns)if(metadataColumns.hasOwnProperty(key)){if(this.indexedFields&&!this.indexedFields.include(key))continue;this.initMetaOption(simpleMeta,advancedMeta,key,metadataColumns[key],!1)}var docPropertyTemplate='<div class="advanced_search"><div class="advanced_search_section_title"><span class="icon-circle"></span> '+MessageHash[490]+'</div><div class="advanced_search_section search_section_date"><span class="c4"><span class="icon-calendar"></span> '+MessageHash[491]+' </span><input id="ajxp_modiftime_from" class="c3" type="text" placeholder="YYYY/MM/DD"><span class="c6">'+MessageHash[492]+'</span><input class="c3" type="text"  id="ajxp_modiftime_to" placeholder="YYYY/MM/DD"><div id="modiftime_fixed_radio"><span id="ajxp_modiftime_fixed" class="c3" data-value="AJXP_SEARCH_RANGE_TODAY" type="text">'+MessageHash[493]+'</span><span id="ajxp_modiftime_fixed" class="c3" data-value="AJXP_SEARCH_RANGE_YESTERDAY" type="text">'+MessageHash[494]+'</span><span id="ajxp_modiftime_fixed" class="c3" data-value="AJXP_SEARCH_RANGE_LAST_WEEK" type="text">'+MessageHash[495]+'</span><span id="ajxp_modiftime_fixed" class="c3" data-value="AJXP_SEARCH_RANGE_LAST_MONTH" type="text">'+MessageHash[496]+'</span><span id="ajxp_modiftime_fixed" class="c3" data-value="AJXP_SEARCH_RANGE_LAST_YEAR" type="text">'+MessageHash[497]+'</span></div></div><div class="advanced_search_section_title"><span class="icon-circle"></span> '+MessageHash[498]+'</div><div class="advanced_search_section search_section_property"><span class="c4"><span class="icon-file"></span> '+MessageHash[499]+' </span><input id="ajxp_mime" class="c3" type="text" placeholder="'+MessageHash[500]+'"><span class="c6">'+MessageHash[501]+'</span><span class="c3" id="ajxp_folder"><span class="icon-folder-open"></span>'+MessageHash[502]+'</span><br><span class="c4"><span class="icon-cloud-download"></span> '+MessageHash[503]+'</span><input  id="ajxp_bytesize_from" type="text" class="c3" placeholder="'+MessageHash[504]+'..."><span class="c6"> '+MessageHash[505]+' </span><input  id="ajxp_bytesize_to" type="text" class="c3" placeholder="'+MessageHash[504]+'..."></div></div>';formPanel.down("#search_meta_detailed").insert({bottom:docPropertyTemplate}),this._ajxpOptions.searchChooserAsResultsHeader?(formPanel.down("#search_meta_detailed").insert({top:searchChooser.down("span.search_label.close")}),formPanel.down("#refresh_search_button").observe("click",function(e){this.search()}.bind(this))):searchChooser.down("#refresh_search_button").observe("click",function(e){this.search()}.bind(this)),formPanel.select("input").each(function(el){el.observe("focus",pydio.UI.disableAllKeyBindings.bind(ajaxplorer)),el.observe("blur",pydio.UI.enableAllKeyBindings.bind(ajaxplorer)),el.observe("keydown",function(event){event.keyCode==Event.KEY_RETURN&&oThis.search()})});var radios=formPanel.down("#modiftime_fixed_radio").select("span.c3");radios.each(function(el){el.observe("click",function(e){el.hasClassName("selected")?el.removeClassName("selected"):(radios.invoke("removeClassName","selected"),el.addClassName("selected")),formPanel.down("#ajxp_modiftime_from").disabled=formPanel.down("#ajxp_modiftime_to").disabled=el.hasClassName("selected"),oThis.search()})}),formPanel.down("#ajxp_folder").observe("click",function(e){formPanel.down("#ajxp_folder").toggleClassName("selected"),formPanel.down("#ajxp_mime").disabled=formPanel.down("#ajxp_folder").hasClassName("selected"),oThis.search()}),formPanel.select(".advanced_search_section_title").invoke("observe","click",function(ev){Event.findElement(ev,".advanced_search_section_title").next(".advanced_search_section").toggleClassName("visible"),oThis.resize()}),this.scrollbar=new Control.ScrollBar(formPanel.down("#search_meta_detailed"),formPanel.down(".scroller_track"))},parseMetadataForm:function(){var formPanel=this.htmlElement.down("#search_meta");if(!formPanel)return!1;if(!formPanel.hasClassName("toggle_open"))return!1;var metadata=$H();return formPanel.select("input,select,span.c3.selected").each(function(el){if("input"==el.tagName.toLowerCase()||"select"==el.tagName.toLowerCase()){if(!el.getValue()||el.disabled)return;var name=el.id||el.name;name&&metadata.set(name,el.getValue())}else"ajxp_folder"==el.id?metadata.set("ajxp_mime","ajxp_folder"):"ajxp_modiftime_fixed"==el.id&&metadata.set("ajxp_modiftime",el.readAttribute("data-value"))}),(metadata.get("ajxp_modiftime_from")||metadata.get("ajxp_modiftime_to"))&&(metadata.get("ajxp_modiftime_from")||metadata.set("ajxp_modiftime_from","1970/01/01"),metadata.get("ajxp_modiftime_to")||metadata.set("ajxp_modiftime_to","2150/01/01"),metadata.set("ajxp_modiftime","["+metadata.get("ajxp_modiftime_from").replace(/\//g,"")+" TO "+metadata.get("ajxp_modiftime_to").replace(/\//g,"")+"]"),metadata.unset("ajxp_modiftime_from"),metadata.unset("ajxp_modiftime_to")),(metadata.get("ajxp_bytesize_from")||metadata.get("ajxp_bytesize_to"))&&(metadata.get("ajxp_bytesize_from")||metadata.set("ajxp_bytesize_from",0),metadata.get("ajxp_bytesize_to")||metadata.set("ajxp_bytesize_to",1099511627776),metadata.set("ajxp_bytesize","["+metadata.get("ajxp_bytesize_from")+" TO "+metadata.get("ajxp_bytesize_to")+"]"),metadata.unset("ajxp_bytesize_to"),metadata.unset("ajxp_bytesize_from")),metadata},initGUI:function(){if(this.htmlElement){if(this.htmlElement.insert('<div id="search_panel"><div id="search_form"><input style="float:left;" type="text" id="search_txt" placeholder="'+MessageHash[87]+'" name="search_txt" onfocus="blockEvents=true;" onblur="blockEvents=false;"><a href="" id="search_button" class="icon-search" ajxp_message_title_id="184" title="'+MessageHash[184]+'"><img width="16" height="16" align="absmiddle" src="'+ajxpResourcesFolder+'/images/actions/16/search.png" border="0"/></a><span class="search_advanced_direct_access">'+MessageHash[486].toLocaleLowerCase()+' <span class="icon-caret-down"></span></span><a class="icon-remove" href="" id="stop_search_button" ajxp_message_title_id="185" title="'+MessageHash[185]+'"><img width="16" height="16" align="absmiddle" src="'+ajxpResourcesFolder+'/images/actions/16/fileclose.png" border="0" /></a></div><div id="search_results"></div></div>'),this._ajxpOptions.toggleResultsVisibility&&(this.htmlElement.down("#search_results").insert({before:"<div style='display: none;' id='"+this._ajxpOptions.toggleResultsVisibility+"'></div>"}),this.htmlElement.down("#"+this._ajxpOptions.toggleResultsVisibility).insert(this.htmlElement.down("#search_results"))),this.htmlElement.down("div.panelHeader")&&this.htmlElement.down("div#search_panel").insert({top:this.htmlElement.down("div.panelHeader")}),this.metaOptions=[],this.htmlElement.select("#search_meta").invoke("remove"),this.htmlElement.select(".meta_toggle_button").invoke("remove"),this._ajxpOptions&&this._ajxpOptions.metaColumns){this._ajxpOptions.toggleResultsVisibility&&this.htmlElement&&this.htmlElement.down("#"+this._ajxpOptions.toggleResultsVisibility)?this.htmlElement.down("#"+this._ajxpOptions.toggleResultsVisibility).insert({top:'<div id="search_meta"></div>'}):this.htmlElement.down("#search_form")&&this.htmlElement.down("#search_form").insert({bottom:'<div id="search_meta"></div>'});var searchMeta=this.htmlElement.down("#search_meta");searchMeta&&this.loadRenderersAndInitMetadataForm(searchMeta,this._ajxpOptions.metaColumns)}else this.htmlElement.down("#search_form").insert('<div style="clear:left;height:9px;"></div>');this._inputBox=this.htmlElement.down("#search_txt"),this._resultsBoxId="search_results",this._searchButtonName="search_button",this._runningQueries=$A(),this._queue=$A(),$("stop_"+this._searchButtonName).addClassName("disabled");var groupByData="mimestring_id";void 0!==this.options.groupByData&&(groupByData=this.options.groupByData),this._fileList=new FilesList($(this._resultsBoxId),{dataModel:this._dataModel,columnsDef:[{attributeName:"ajxp_label",messageId:1,sortType:"String"},{attributeName:"ajxp_dirname",messageString:"Path",sortType:"String"},{attributeName:"mimestring_id",messageString:"Type",sortType:"String"}],groupByData:groupByData,displayMode:"detail",fixedDisplayMode:"detail",defaultSortTypes:["String","String","String"],columnsTemplate:"search_results",selectable:!0,draggable:!1,replaceScroller:!0,fit:"height",fitParent:this.options.toggleResultsVisibility,detailThumbSize:this.options.detailThumbSize?this.options.detailThumbSize:22,skipSelectFirstOnFocus:!0}),pydio.UI.registerFocusable(this._fileList),this.htmlElement.select("a",'div[id="search_results"]').each(function(element){disableTextSelection(element)}),this._inputBox.observe("keydown",function(e){return e.keyCode==Event.KEY_RETURN&&(Event.stop(e),this.search()),e.keyCode!=Event.KEY_TAB}.bind(this)),this._inputBox.observe("input",function(e){this._inputBox.getValue().length>2&&(bufferCallback("searchByTyping",300,this.searchWhenTyping.bind(this)),bufferCallback("fullSearch",2e3,this.searchCompleteTypedResults.bind(this)))}.bind(this));var opener=function(e){return pydio.UI.disableShortcuts(),pydio.UI.disableNavigation(),this.hasFocus=!0,this._inputBox.select(),this.hasResults&&this._ajxpOptions.toggleResultsVisibility&&!$(this._ajxpOptions.toggleResultsVisibility).visible()&&this.showToggleResult(!0),this._ajxpOptions.openSearchInput&&this.openSearchInput(),this._advancedPanelOpen&&this.htmlElement.down("input#basename")&&this.htmlElement.down("input#basename").focus(),!1}.bind(this);this._inputBox.observe("focus",opener),this._inputBox.observe("click",opener),this._inputBox.observe("blur",function(e){pydio.UI.enableShortcuts(),pydio.UI.enableNavigation(),this.hasFocus=!1,this._ajxpOptions.openSearchInput&&window.setTimeout(function(){this._ajxpOptions.toggleResultsVisibility&&$(this._ajxpOptions.toggleResultsVisibility).visible()||this.closeSearchInput()}.bind(this),150)}.bind(this)),$(this._searchButtonName).observe("click",function(e){return Event.stop(e),this._ajxpOptions.openSearchInput&&!this.searchInputIsOpen()?this._inputBox.focus():this.search(),!1}.bind(this)),$("stop_"+this._searchButtonName).onclick=function(){return this.interrupt(),!1}.bind(this),this.htmlElement.down("span.search_advanced_direct_access").observe("click",function(){this.openSearchInput(!0),this.updateStateSearching(),this.updateStateFinished(),window.setTimeout(function(){this.htmlElement.down(".toggle_button").click()}.bind(this),250)}.bind(this)),this.refreshObserver=function(e){"use strict";this._inputBox.setValue(""),this.clearResults(),$(this.options.toggleResultsVisibility)&&this.showToggleResult(!1)}.bind(this),document.observe("ajaxplorer:repository_list_refreshed",this.refreshObserver),this._dataModel.setContextNode(this._dataModel.getRootNode(),!0),this.resize()}},searchInputIsOpen:function(){return this.htmlElement.hasClassName("search_active")},openSearchInput:function(withResult){var container=this.htmlElement;container.absolutize();var leftPos=285;this.options.openSearchStickLeftTo&&(leftPos=parseInt($(this.options.openSearchStickLeftTo).getWidth())+5);var pos=container.positionedOffset(),width=pos.left+container.getWidth()-leftPos;container.setStyle({width:width+"px",left:leftPos+"px"}),container.addClassName("search_active"),container.addClassName("skipSibling"),(withResult||this._inputBox.getValue())&&window.setTimeout(function(){this.showToggleResult(!0),this.resize()}.bind(this),1e3)},closeSearchInput:function(){var container=this.htmlElement;container.removeClassName("search_active"),this.showToggleResult(!1),this._inputBox.blur(),window.setTimeout(function(){container.hasClassName("search_active")||(this.htmlElement.down("#search_meta")&&this.htmlElement.down("#search_meta").removeClassName("toggle_open"),container.relativize(),container.setStyle({position:"relative"}),container.removeClassName("skipSibling"),container.up("[ajxpClass]").ajxpPaneObject.resize())}.bind(this),1e3)},showToggleResult:function(show){if(show){var panel=$(this._ajxpOptions.toggleResultsVisibility);panel.setStyle({display:"block"}),this.updateSearchResultPosition(panel)}else $(this._ajxpOptions.toggleResultsVisibility).setStyle({display:"none"});this._fileList&&this._fileList.showElement(show)},showElement:function(show){this.htmlElement&&(show?this.htmlElement.show():this.htmlElement.hide())},resize:function($super){if($(this._resultsBoxId).addClassName("forceComputeFit"),this._ajxpOptions.toggleResultsVisibility?($(this._ajxpOptions.toggleResultsVisibility).addClassName("forceComputeFit"),fitHeightToBottom($(this._ajxpOptions.toggleResultsVisibility),this._ajxpOptions.toggleResultsFitTo?$(this._ajxpOptions.toggleResultsFitTo):null,this._ajxpOptions.fitMarginBottom?this._ajxpOptions.fitMarginBottom:0),fitHeightToBottom($(this._resultsBoxId)),this._ajxpOptions.toggleResultsFitTo&&$(this._ajxpOptions.toggleResultsFitTo)&&$(this._ajxpOptions.toggleResultsVisibility)&&$(this._ajxpOptions.toggleResultsVisibility).setStyle({width:parseInt($(this._ajxpOptions.toggleResultsFitTo).getWidth())-(void 0!==this._ajxpOptions.toggleResultsOffsetRight?this._ajxpOptions.toggleResultsOffsetRight:20)+"px"})):fitHeightToBottom($(this._resultsBoxId),null,this._ajxpOptions.fitMarginBottom?this._ajxpOptions.fitMarginBottom:0),this.htmlElement&&this.htmlElement.down("#search_meta")){var formPanel=this.htmlElement.down("#search_meta");formPanel.addClassName("forceComputeFit"),"left"==formPanel.getStyle("float")&&(fitHeightToBottom(formPanel),formPanel.select(".advanced_search_section").invoke("addClassName","visible"),formPanel.select(".toggle_button").invoke("hide")),fitHeightToBottom(formPanel.down("#search_meta_detailed"),formPanel),this.scrollbar&&this.scrollbar.recalculateLayout(formPanel.down("#search_meta_detailed").getHeight())}this._fileList&&this._fileList.resize(),
this.htmlElement&&this.htmlElement.visible()},destroy:function(){if(this._fileList&&(pydio.UI.unregisterFocusable(this._fileList),this._fileList.destroy(),this._fileList=null),this.htmlElement){var ajxpId=this.htmlElement.id;this.htmlElement.update("")}document.stopObserving("ajaxplorer:repository_list_refreshed",this.refreshObserver),document.stopObserving("ajaxplorer:registry_loaded",this.searchModeObserver),this.boundSizeEvents&&this.boundSizeEvents.each(function(pair){document.stopObserving(pair.key,pair.value)}),this.htmlElement=null;try{pydio.UI.removeInstanceFromCache(ajxpId)}catch(e){}},initMetaOption:function(element,advancedPanel,optionValue,optionLabel,checked){var option=new Element("span",{value:optionValue,className:"search_meta_opt"}).update('<span class="icon-ok"></span>'+optionLabel);checked&&option.addClassName("checked"),element.childElements().length&&element.insert(", "),element.insert(option),option.observe("click",function(event){option.toggleClassName("checked")});var fName="filename"==optionValue?"basename":"ajxp_meta_"+optionValue;if(advancedPanel.insert('<div><span class="c4" style="width: 35%;"><span class="icon-tag"></span> '+optionLabel+'</span><input style="width: 35%;" type="text" class="c3" name="'+optionValue+'" id="'+fName+'"></div>'),this._ajxpOptions.metaColumnsRenderers&&this._ajxpOptions.metaColumnsRenderers[optionValue]){var input=advancedPanel.down("#"+fName),func=eval(this._ajxpOptions.metaColumnsRenderers[optionValue]);Object.isFunction(func)&&func(input,advancedPanel)}this.metaOptions.push(option)},hasMetaSearch:function(){var found=!1;return this.metaOptions.each(function(opt){"filename"!=opt.getAttribute("value")&&opt.hasClassName("checked")&&(found=!0)}),found},getSearchColumns:function(){var cols=$A();return this.metaOptions.each(function(opt){opt.hasClassName("checked")&&cols.push(opt.getAttribute("value"))}),cols},focus:function(){this.htmlElement&&this.htmlElement.visible()&&(this._inputBox.activate(),this.hasFocus=!0,this._ajxpOptions.openSearchInput&&this.openSearchInput())},blur:function(){this._inputBox&&this._inputBox.blur(),this._ajxpOptions.openSearchInput&&this.closeSearchInput(),this.hasFocus=!1},searchWhenTyping:function(){"remote"==this._searchMode&&this.search(9)},searchCompleteTypedResults:function(){if("remote"==this._searchMode){var text=this._inputBox.value.toLowerCase();text==this.crtText?ProtoCompat.map2values(this._rootNode.getChildren()).length>=9&&this.search(50,!0):this.search(50,!1)}},search:function(limit,skipClear){var searchQuery,text=this._inputBox.value.toLowerCase(),metadata=this.parseMetadataForm();if(metadata){var parts=$A();metadata.each(function(pair){parts.push(pair.key+":"+pair.value)}),searchQuery=parts.join(" AND ")}else searchQuery=text;if(""!=searchQuery){this.crtText=searchQuery,skipClear||(this.updateStateSearching(),this.clearResults());var folder=ajaxplorer.getContextNode().getPath();"/"==folder&&(folder=""),window.setTimeout(function(){this.searchFolderContent(folder,ajaxplorer.getContextNode().getMetadata().get("remote_indexation"),limit)}.bind(this),0)}},interrupt:function(){"idle"!=this._state&&(this._state="interrupt",this._queue=$A())},updateStateSearching:function(){this._state="searching",$(this._searchButtonName).addClassName("disabled"),$("stop_"+this._searchButtonName).removeClassName("disabled"),this._ajxpOptions.toggleResultsVisibility&&($(this._ajxpOptions.toggleResultsVisibility).down("div.panelHeader.toggleResults")||($(this._ajxpOptions.toggleResultsVisibility).insert({top:"<div class='panelHeader toggleResults'><span class='results_string'>Results</span><span class='close_results icon-remove-sign'></span><div id='display_toolbar'></div></div>"}),this.tb=new ActionsToolbar($(this._ajxpOptions.toggleResultsVisibility).down("#display_toolbar"),{submenuClassName:"panelHeaderMenu",submenuPosition:"bottom right",toolbarsList:["ajxp-search-result-bar"],skipBubbling:!0,skipCarousel:!0,submenuOffsetTop:2}),this.tb.actionsLoaded({memo:pydio.getController().actions}),this.tb.element.select("a").invoke("show"),this.resultsDraggable=new Draggable(this._ajxpOptions.toggleResultsVisibility,{handle:"panelHeader",zindex:999,starteffect:function(element){},endeffect:function(element){}})),$(this._ajxpOptions.toggleResultsVisibility).down("span.close_results")&&$(this._ajxpOptions.toggleResultsVisibility).down("span.close_results").observe("click",function(){this._ajxpOptions.openSearchInput?this.closeSearchInput():this.showToggleResult(!1),this._closeAdvancedPanel&&this._closeAdvancedPanel()}.bind(this)),$(this._ajxpOptions.toggleResultsVisibility).visible()||($(this._ajxpOptions.toggleResultsVisibility).setStyle({position:"absolute"}),this.showToggleResult(!0)),this.resize())},updateSearchResultPosition:function(panel){var top=this._inputBox.positionedOffset().top+this._inputBox.getHeight()+(void 0!==this._ajxpOptions.toggleResultsOffsetTop?this._ajxpOptions.toggleResultsOffsetTop:3),left=this._inputBox.positionedOffset().left;left+this._fileList.htmlElement.getWidth()>document.viewport.getWidth()+10&&(left=document.viewport.getWidth()-this._fileList.htmlElement.getWidth()-15),panel.setStyle({top:top+"px",left:left+"px"})},updateStateFinished:function(interrupt){this._state="idle",this._inputBox.disabled=!1,$(this._searchButtonName).removeClassName("disabled"),$("stop_"+this._searchButtonName).addClassName("disabled")},clear:function(){this.clearResults(),this._inputBox&&(this._inputBox.value="")},clearResults:function(){this.hasResults=!1,this._rootNode.clear(),this._even=!1},addResult:function(folderName,ajxpNode,metaFound){var noRes=$(this._resultsBoxId).down("#no-results-found");if(noRes&&noRes.remove(),this._rootNode)return void this._rootNode.addChild(ajxpNode);var fileName=ajxpNode.getLabel(),icon=ajxpNode.getIcon();""==folderName&&(folderName="/"),"remote"==this._searchMode&&(folderName=getRepName(ajxpNode.getPath()));var isFolder=!1;null==icon&&(isFolder=!0,icon="folder.png","/"!=folderName&&(folderName+="/"),folderName+=fileName);var stringToDisplay,imgPath=resolveImageSource(icon,"/images/mimes/16",16),imageString='<img align="absmiddle" width="16" height="16" src="'+imgPath+'"> ';stringToDisplay=metaFound?fileName+" ("+this.highlight(metaFound,this.crtText,20)+") ":this.highlight(fileName,this.crtText);var divElement=new Element("div",{title:MessageHash[224]+" "+folderName,className:this._even?"even":""}).update(imageString+stringToDisplay);this._even=!this._even,$(this._resultsBoxId).insert(divElement),"remote"==this._searchMode&&ajxpNode.getMetadata().get("search_score")&&divElement.insert(new Element("span",{className:"searchScore"}).update("SCORE "+ajxpNode.getMetadata().get("search_score"))),isFolder?divElement.observe("click",function(e){ajaxplorer.goTo(folderName)}):divElement.observe("click",function(e){ajaxplorer.goTo(folderName+"/"+fileName)}),this.hasResults=!0},addNoResultString:function(){$(this._resultsBoxId).down("#no-results-found")||this._rootNode&&ProtoCompat.map2values(this._rootNode.getChildren()).length||$(this._resultsBoxId).insert({top:new Element("div",{id:"no-results-found"}).update(MessageHash[478])})},appendFolderToQueue:function(path,remoteIndexation){this._queue.push({path:path,remoteIndexation:remoteIndexation?remoteIndexation:!1})},searchNext:function(){if(this._queue.length){var element=this._queue.first();this._queue.shift(),this.searchFolderContent(element.path,element.remoteIndexation)}else this.updateStateFinished()},buildNodeProviderProperties:function(currentFolder,remote_indexation){var props={};return"remote"==this._searchMode?(props.get_action="search",props.query=this.crtText,this.hasMetaSearch()&&(props.fields=this.getSearchColumns().join(","))):remote_indexation?(props.get_action=remote_indexation,props.query=this.crtText,this.hasMetaSearch()&&(props.fields=this.getSearchColumns().join(",")),props.dir=currentFolder):(props.get_action="ls",props.options="a"+(this.hasMetaSearch()?"l":""),props.dir=currentFolder),props},searchFolderContent:function(currentFolder,remote_indexation,limit){if("interrupt"==this._state)return void this.updateStateFinished();var connexion;"remote"==this._searchMode?(connexion=new Connexion,connexion.discrete=!0,connexion.addParameter("get_action","search"),connexion.addParameter("query",this.crtText),limit&&connexion.addParameter("limit",limit),this.hasMetaSearch()&&connexion.addParameter("fields",this.getSearchColumns().join(",")),connexion.onComplete=function(transport){pydio.getController().parseXmlMessage(transport.responseXML),this.removeOnLoad($(this._resultsBoxId)),this._parseResults(transport.responseXML,currentFolder),this.updateStateFinished()}.bind(this),this.setOnLoad($(this._resultsBoxId)),connexion.sendAsync()):remote_indexation?(connexion=new Connexion,connexion.addParameter("get_action",remote_indexation),connexion.addParameter("query",this.crtText),connexion.addParameter("dir",currentFolder),this.hasMetaSearch()&&connexion.addParameter("fields",this.getSearchColumns().join(",")),connexion.onComplete=function(transport){this.removeOnLoad($(this._resultsBoxId)),this._parseResults(transport.responseXML,currentFolder),this.searchNext()}.bind(this),this.setOnLoad($(this._resultsBoxId)),connexion.sendAsync()):(connexion=new Connexion,connexion.addParameter("get_action","ls"),connexion.addParameter("options","a"+(this.hasMetaSearch()?"l":"")),connexion.addParameter("dir",currentFolder),connexion.onComplete=function(transport){this._parseXmlAndSearchString(transport.responseXML,currentFolder),this.searchNext()}.bind(this),connexion.sendAsync())},_parseXmlAndSearchString:function(oXmlDoc,currentFolder){if("interrupt"==this._state)return void this.updateStateFinished();if(null==oXmlDoc||null==oXmlDoc.documentElement);else for(var nodes=XPathSelectNodes(oXmlDoc.documentElement,"tree"),i=0;i<nodes.length;i++)if("tree"==nodes[i].tagName){var node=this.parseAjxpNode(nodes[i]);if(this._searchNode(node,currentFolder),!node.isLeaf()){var newPath=node.getPath();this.appendFolderToQueue(newPath,node.getMetadata().get("remote_indexation"))}}},_parseResults:function(oXmlDoc,currentFolder){if("interrupt"==this._state||null==oXmlDoc||null==oXmlDoc.documentElement)return void this.updateStateFinished();var nodes=XPathSelectNodes(oXmlDoc.documentElement,"tree");if(nodes.length){var noRes=$(this._resultsBoxId).down("#no-results-found");noRes&&noRes.remove()}else this.addNoResultString();for(var i=0;i<nodes.length;i++)if("tree"==nodes[i].tagName){var ajxpNode=this.parseAjxpNode(nodes[i]);if(this.hasMetaSearch()){for(var searchCols=this.getSearchColumns(),added=!1,k=0;k<searchCols.length;k++){var meta=ajxpNode.getMetadata().get(searchCols[k]);meta&&-1!=meta.toLowerCase().indexOf(this.crtText)&&(this.addResult(currentFolder,ajxpNode,meta),added=!0)}added||this.addResult(currentFolder,ajxpNode)}else this.addResult(currentFolder,ajxpNode)}this._fileList&&this._fileList._sortableTable.sort(0)},_searchNode:function(ajxpNode,currentFolder){var searchCols,searchFileName=!0;if(this.hasMetaSearch()&&(searchCols=this.getSearchColumns(),searchCols.indexOf("filename")||(searchFileName=!1)),searchFileName&&-1!=ajxpNode.getLabel().toLowerCase().indexOf(this.crtText))return this.addResult(currentFolder,ajxpNode),void(this._fileList&&this._fileList._sortableTable.sort(0));if(searchCols)for(var i=0;i<searchCols.length;i++){var meta=ajxpNode.getMetadata().get(searchCols[i]);if(meta&&-1!=meta.toLowerCase().indexOf(this.crtText))return this.addResult(currentFolder,ajxpNode,meta),void(this._fileList&&this._fileList._sortableTable.sort(0))}},parseAjxpNode:function(xmlNode){return pydio.getContextHolder().getAjxpNodeProvider().parseAjxpNode(xmlNode)},highlight:function(haystack,needle,truncate){var start=haystack.toLowerCase().indexOf(needle);if(-1==start)return haystack;var end=start+needle.length;if(truncate&&haystack.length>truncate){var newStart=Math.max(Math.round((end+start)/2-truncate/2),0),newEnd=Math.min(Math.round((end+start)/2+truncate/2),haystack.length);haystack=haystack.substring(newStart,newEnd),newStart>0&&(haystack="..."+haystack),newEnd<haystack.length&&(haystack+="..."),start=haystack.toLowerCase().indexOf(needle),end=start+needle.length}return haystack.substring(0,start)+"<em>"+haystack.substring(start,end)+"</em>"+haystack.substring(end)},setOnLoad:function(element){addLightboxMarkupToElement(element);var img=new Element("img",{src:ajxpResourcesFolder+"/images/loadingImage.gif",style:"margin-top: 10px;"});$(element).down("#element_overlay").insert(img),this.loading=!0},removeOnLoad:function(element){removeLightboxFromElement(element),this.loading=!1}}),Class.create("FetchedResultPane",FilesList,{_rootNode:null,_dataLoaded:!1,initialize:function($super,mainElementName,ajxpOptions){var dataModel=this.initDataModel(ajxpOptions);if($super($(mainElementName),Object.extend({dataModel:dataModel,columnsDef:[{attributeName:"ajxp_label",messageId:1,sortType:"String"},{attributeName:"filename",messageString:"Path",sortType:"String"},{attributeName:"is_file",messageString:"Type",sortType:"String",defaultVisibility:"hidden"}],displayMode:"detail",fixedDisplayMode:"detail",defaultSortTypes:["String","String","String","MyDate"],columnsTemplate:"search_results",defaultSortColumn:2,defaultSortDescending:!1,selectable:!0,draggable:!1,droppable:!1,noContextualMenu:!0,containerDroppableAction:null,emptyChildrenMessage:"",replaceScroller:!0,forceClearOnRepoSwitch:!1,fit:"height",detailThumbSize:22,updateGlobalContext:!1,selectionChangeCallback:function(){if(this._dataLoaded){var selectedNode=this._dataModel.getSelectedNodes()[0];selectedNode&&ajaxplorer.goTo(selectedNode)}}.bind(this)},ajxpOptions)),this.options.updateGlobalContext?this._registerObserver(dataModel,"selection_changed",function(){if(this._dataLoaded){var selectedNodes=this._dataModel.getSelectedNodes();selectedNodes&&ajaxplorer.getContextHolder().setSelectedNodes(selectedNodes,this)}}.bind(this),!0):this.options.selectionChangeCallback&&this._registerObserver(dataModel,"selection_changed",this.options.selectionChangeCallback,!0),this.options.forceClearOnRepoSwitch){var repoSwitchObserver=function(){this._rootNode.clear(),this._dataLoaded=!1,this.htmlElement&&this.htmlElement.visible()&&this.showElement(!0)}.bind(this);this._registerObserver(document,"ajaxplorer:repository_list_refreshed",repoSwitchObserver)}this.hiddenColumns.push("is_file"),void 0!=this.options.defaultSortColumn&&this._sortableTable.sort(this.options.defaultSortColumn,this.options.defaultSortDescending),mainElementName.addClassName("class-FetchedResultPane"),ajxpOptions.reloadOnServerMessage&&(this._registerObserver(ajaxplorer,"server_message",function(event){var newValue=XPathSelectSingleNode(event,ajxpOptions.reloadOnServerMessage);newValue&&this.reloadDataModel()}.bind(this),!0),this._registerObserver(ajaxplorer,"server_message:"+ajxpOptions.reloadOnServerMessage,function(){this.reloadDataModel()}.bind(this),!0)),ajxpOptions.containerDroppableAction&&Droppables.add(this.htmlElement,{hoverclass:"droppableZone",accept:"ajxp_draggable",onDrop:function(draggable,droppable,event){draggable.getAttribute("user_selection")?pydio.getController().fireAction(ajxpOptions.containerDroppableAction):draggable.ajxpNode&&pydio.getController().fireAction(ajxpOptions.containerDroppableAction,draggable.ajxpNode)}})},destroy:function($super){$super(),this.options.containerDroppableAction&&Droppables.remove(this.htmlElement)},reloadDataModel:function(){this._dataLoaded&&(this.options.silentLoading||this._rootNode.clear(),this._dataLoaded=!1,this.htmlElement&&this.htmlElement.visible()&&(this._dataModel.requireContextChange(this._rootNode,!0),this._dataLoaded=!0))},initDataModel:function(ajxpOptions){var dataModel=new PydioDataModel(!0),rNodeProvider=new RemoteNodeProvider;if(dataModel.setAjxpNodeProvider(rNodeProvider),rNodeProvider.initProvider(ajxpOptions.nodeProviderProperties),this._rootNode=new AjxpNode("/",!1,ajxpOptions.rootNodeLabel?ajxpOptions.rootNodeLabel:"Results","folder.png",rNodeProvider),dataModel.setRootNode(this._rootNode),ajxpOptions.emptyChildrenMessage){var emptyMessage=MessageHash[ajxpOptions.emptyChildrenMessage]?MessageHash[ajxpOptions.emptyChildrenMessage]:ajxpOptions.emptyChildrenMessage;this._rootNode.observe("loaded",function(){this.htmlElement.select("div.no-results-found").invoke("remove"),ProtoCompat.map2values(this._rootNode.getChildren()).length||this.htmlElement.insert({bottom:'<div class="no-results-found">'+emptyMessage+"</div>"})}.bind(this))}return dataModel},showElement:function(show){this.htmlElement&&(show&&!this._dataLoaded&&(this._dataModel.requireContextChange(this._rootNode,!0),this._dataLoaded=!0),show?(this._dataModel.getSelectedNodes()&&this._dataModel.publish("selection_changed",this._dataModel),this.htmlElement.show()):(this._dataModel.setSelectedNodes($A()),this.htmlElement.hide()))},getActions:function(){return $H()}}),Class.create("InfoPanel",AjxpPane,{initialize:function($super,htmlElement,options){options||(options={replaceScroller:!0}),$super(htmlElement,Object.extend(Object.clone(options),{replaceScroller:!1})),disableTextSelection(htmlElement);var id=htmlElement.id,container=new Element("div",{className:"panelContent",id:"ip_content_"+id});options.replaceScroller&&(this.scroller=new Element("div",{id:"ip_scroller_"+id,className:"scroller_track"}),this.scroller.insert(new Element("div",{id:"ip_scrollbar_handle_"+id,className:"scroller_handle"})),this.htmlElement.insert(this.scroller),container.setStyle({overflow:"hidden"})),this.htmlElement.insert(container),options.replaceScroller&&(this.scrollbar=new Control.ScrollBar("ip_content_"+id,"ip_scroller_"+id,{fixed_scroll_distance:50})),window.ajxpMobile&&attachMobileScroll(container,"vertical"),this.contentContainer=container,this.setContent("<br><br><center><i>"+MessageHash[132]+"</i></center>"),this.mimesTemplates=new Hash,this.registeredMimes=new Hash,this.primaryTemplates=new Hash,this.updateHandler=function(objectOrEvent){bufferCallback("InfoPanelUpdater",100,function(){this.update(objectOrEvent)}.bind(this))}.bind(this),this.componentConfigHandler=function(event){"InfoPanel"==event.memo.className&&this.parseComponentConfig(event.memo.classConfig.get("all"))}.bind(this),this.userLogHandler=this.clearPanels.bind(this),this.options.skipObservers||(document.observe("ajaxplorer:actions_refreshed",this.updateHandler),document.observe("ajaxplorer:component_config_changed",this.componentConfigHandler),document.observe("ajaxplorer:user_logged",this.userLogHandler))},open:function($super,node){this.htmlElement.up("div.dialogBox").setStyle({width:Math.min(450,document.viewport.getWidth())+"px"}),this.htmlElement.up("div.dialogContent").setStyle({padding:0}),this.htmlElement.down("#ip_content_info_panel").setStyle({position:"relative",top:0,left:0,width:"100%",height:Math.min(450,document.viewport.getHeight()-28)+"px",overflow:"auto"});try{this.htmlElement.down("#ip_content_modal_action_form").remove(),this.htmlElement.down("#ip_scroller_modal_action_form").remove()}catch(e){}modal.refreshDialogPosition()},destroy:function(){this.options.skipObservers||(document.stopObserving("ajaxplorer:actions_refreshed",this.updateHandler),document.stopObserving("ajaxplorer:component_config_changed",this.componentConfigHandler),document.stopObserving("ajaxplorer:user_logged",this.userLogHandler)),this.empty(),this.scrollbar&&(this.scrollbar.destroy(),this.scroller.remove()),this.htmlElement.update("");try{pydio.UI.removeInstanceFromCache(this.htmlElement.id)}catch(e){}this.htmlElement=null},clearPanels:function(){this.mimesTemplates=new Hash,this.registeredMimes=new Hash},empty:function(){this.currentPreviewElement&&this.currentPreviewElement.destroyElement&&(this.currentPreviewElement.destroyElement(),this.currentPreviewElement=null),this.actionsToolbars&&(this.actionsToolbars.invoke("destroy"),delete this.actionsToolbars),this.htmlElement&&this.htmlElement.select(".class-FetchedResultPane").each(function(el){el.ajxpPaneObject.destroy()}),this.setContent("")},update:function(objectOrEvent){if(this.htmlElement){var passedNode;objectOrEvent.__className&&"AjxpNode"==objectOrEvent.__className&&(passedNode=objectOrEvent),this.insertedTemplates=$A();var userSelection=ajaxplorer.getUserSelection(),contextNode=userSelection.getContextNode();if(this.empty(),this.clearPanelHeaderIcons(),this.scrollbar&&this.scrollbar.recalculateLayout(),contextNode){var repoOptions={};if(ajaxplorer.user&&ajaxplorer.user.getActiveRepository()){var repo=ajaxplorer.user.repositories.get(ajaxplorer.user.getActiveRepository());repo&&(repoOptions={ws_label:repo.getLabel(),ws_badge:repo.getHtmlBadge()})}if(!passedNode&&userSelection.isEmpty()){var currentRep;userSelection.getContextNode()&&(currentRep=getBaseName(userSelection.getContextNode().getPath())),""==currentRep&&$("repo_path")&&(currentRep=$("repo_path").value);for(var items=ProtoCompat.map2values(userSelection.getContextNode().getChildren()),size=0,folderNumber=0,filesNumber=0,i=0;i<items.length;i++){items[i].isLeaf()?filesNumber++:folderNumber++;var itemData=items[i].getMetadata();itemData.get("bytesize")&&""!=itemData.get("bytesize")&&(size+=parseInt(itemData.get("bytesize")))}var options=Object.extend({filelist_folders_count:folderNumber,filelist_files_count:filesNumber,filelist_totalsize:roundSize(size,MessageHash?MessageHash[266]:"B"),current_folder:currentRep},repoOptions);this.evalTemplateForMime("/"==contextNode.getPath()&&this.registeredMimes.get("ajxp_root_node")?"ajxp_root_node":"no_selection","/"==contextNode.getPath()?contextNode:null,options);try{!folderNumber&&$(this.contentContainer).select('[id="filelist_folders_count"]').length&&$(this.contentContainer).select('[id="filelist_folders_count"]')[0].hide(),!filesNumber&&$(this.contentContainer).select('[id="filelist_files_count').length&&$(this.contentContainer).select('[id="filelist_files_count"]')[0].hide(),!size&&$(this.contentContainer).select('[id="filelist_totalsize"]').length&&$(this.contentContainer).select('[id="filelist_totalsize"]')[0].hide()}catch(e){}return this.addActions("empty"),this.scrollbar&&this.scrollbar.recalculateLayout(),this.updateTitle(),void disableTextSelection(this.contentContainer)}if(!passedNode&&!userSelection.isUnique())return this.registeredMimes.get("generic_multiple")&&this.evalTemplateForMime("generic_multiple",null,{selectedCountSentence:userSelection.getFileNames().length+" "+MessageHash[128]},userSelection.getSelectedNodes()),this.addActions("multiple"),this.scrollbar&&this.scrollbar.recalculateLayout(),void disableTextSelection(this.contentContainer);if(passedNode)uniqNode=passedNode;else var uniqNode=userSelection.getUniqueNode();this.updateTitle(uniqNode.getLabel());var isFile=!1;uniqNode&&(isFile=uniqNode.isLeaf()),!isFile&&uniqNode&&uniqNode.isRoot()?this.evalTemplateForMime("ajxp_root_node",uniqNode,repoOptions):this.evalTemplateForMime(isFile?"generic_file":"generic_dir",uniqNode);var extension=getAjxpMimeType(uniqNode),metadata=uniqNode.getMetadata();this.registeredMimes.each(function(pair){"use strict";pair.key==extension&&this.evalTemplateForMime(extension,uniqNode),0===pair.key.indexOf("meta:")&&metadata.get(pair.key.replace("meta:",""))&&this.evalTemplateForMime(pair.key,uniqNode)}.bind(this)),this.contentContainer.select("[data-ajxpAction]").each(function(act){"no-action"!=act.getAttribute("data-ajxpAction")?act.observe("click",function(event){window.pydio.getController().fireAction(event.target.getAttribute("data-ajxpAction"))}.bind(this)):act.setStyle({cursor:"default"});var panelPointer=act.up("div.panelHeader").next();this.contributePanelHeaderIcon(act.getAttribute("class"),act.getAttribute("title"),act.getAttribute("data-ajxpAction"),panelPointer)}.bind(this)),this.addActions("unique");var fakes=this.contentContainer.select('div[id="preview_rich_fake_element"]');fakes&&fakes.length&&(this.currentPreviewElement=this.getPreviewElement(uniqNode,!1),$(fakes[0]).replace(this.currentPreviewElement),this.resize()),this.scrollbar&&this.scrollbar.recalculateLayout(),disableTextSelection(this.contentContainer)}}},setContent:function(sHtml){this.htmlElement&&this.contentContainer.update(sHtml)},updateTitle:function(title){if(this.htmlElement){title||(title=MessageHash[131]);var panelTitle=this.htmlElement.down("div.panelHeader");panelTitle&&panelTitle.down("span[ajxp_message_id]")&&panelTitle.down("span[ajxp_message_id]").update(title)}},clearPanelHeaderIcons:function(){if(this.htmlElement){var div=this.htmlElement.down("div.folded_icons");div&&div.update("")}},contributePanelHeaderIcon:function(iconClass,iconTitle,ajxpAction,panelPointer){if(this.htmlElement&&this.htmlElement.down("div.panelHeader")){var div=this.htmlElement.down("div.folded_icons");if(div){if(div.down("span."+iconClass))return}else div=new Element("div",{className:"folded_icons"}),this.htmlElement.down("div.panelHeader").insert(div);var ic=new Element("span",{className:iconClass,title:iconTitle});div.insert(ic),ajxpAction&&(ic.addClassName("clickable"),ic.observe("click",function(){pydio.getController().fireAction(ajxpAction)}.bind(this))),panelPointer&&modal.simpleTooltip(ic,panelPointer,"bottom left","foldedPanel_tooltip","element",!0)}},showElement:function(show){this.htmlElement&&(show?this.htmlElement.show():this.htmlElement.hide())},resize:function(){this.contentContainer.removeClassName("double").removeClassName("triple").removeClassName("small").removeClassName("tiny");var previewMaxHeight=200,currentWidth=parseInt(this.contentContainer.getWidth());if(280>currentWidth&&this.contentContainer.addClassName("small"),100>currentWidth&&this.contentContainer.addClassName("tiny"),currentWidth>500&&(this.contentContainer.addClassName("double"),previewMaxHeight=300),currentWidth>750&&(this.contentContainer.addClassName("triple"),previewMaxHeight=450),fitHeightToBottom(this.contentContainer,null),previewMaxHeight=Math.min(previewMaxHeight,parseInt(this.contentContainer.getHeight())-parseInt(this.contentContainer.getStyle("paddingTop"))),this.scrollbar&&this.scrollbar.recalculateLayout(parseInt(this.contentContainer.getHeight())),this.htmlElement&&this.currentPreviewElement&&this.currentPreviewElement.visible()){var squareDim=Math.min(parseInt(this.htmlElement.getWidth()-40));this.currentPreviewElement.resizePreviewElement({width:squareDim,height:squareDim,maxHeight:previewMaxHeight})}this.htmlElement&&document.fire("ajaxplorer:resize-InfoPanel-"+this.htmlElement.id,this.htmlElement.getDimensions())},evalTemplateForMime:function(mimeType,fileNode,tArgs,multipleNodes){if(this.htmlElement&&this.registeredMimes.get(mimeType)){var registeredTemplates=this.registeredMimes.get(mimeType);if("generic_file"==mimeType)var realExtension=getAjxpMimeType(fileNode),genericId=this.primaryTemplates.get(mimeType),primaryId=this.primaryTemplates.get(realExtension);else var skipId=this.primaryTemplates.get(mimeType);for(var i=0;i<registeredTemplates.length;i++)if(!(skipId&&skipId==registeredTemplates[i]||this.insertedTemplates.indexOf(registeredTemplates[i])>-1)){var templateData=this.mimesTemplates.get(registeredTemplates[i]);primaryId&&genericId&&genericId==registeredTemplates[i]&&(templateData=this.mimesTemplates.get(primaryId));var tString=templateData[0],tAttributes=templateData[1],tMessages=templateData[2],tModifier=templateData[3],tPosition=templateData[4];tArgs||(tArgs={});var panelWidth=this.htmlElement.getWidth(),oThis=this;if(fileNode||multipleNodes){var metadata;metadata=fileNode?fileNode.getMetadata():$H(),tAttributes.each(function(attName){if("basename"==attName&&metadata.get("filename"))this[attName]=getBaseName(metadata.get("filename"));else if("compute_image_dimensions"==attName){if(metadata.get("image_width")&&metadata.get("image_height")){var width=metadata.get("image_width"),height=metadata.get("image_height"),newHeight=150;newHeight>height&&(newHeight=height);var newWidth=newHeight*width/height,dimAttr='height="'+newHeight+'"';newWidth>panelWidth-16&&(dimAttr='width="100%"')}else dimAttr='height="64" width="64"';this[attName]=dimAttr}else if("preview_rich"==attName)this[attName]=oThis.getPreviewElement(fileNode,!0,!0);else if("preview_simple"==attName)if(multipleNodes){var s="",simpleTpl=new Template('<div class="info_panel_multiple_tile"><div class="tile_preview">#{preview}</div><div class="tile_label">#{label}</div></div>');multipleNodes.each(function(n){var p=oThis.getPreviewElement(n,!1,!1),args={label:getBaseName(n.getMetadata().get("filename"))};Object.isString(p)?args.preview=p:Object.isElement(p)&&p.outerHTML&&(args.preview=p.outerHTML),s+=simpleTpl.evaluate(args)}),this[attName]=s}else this[attName]=oThis.getPreviewElement(fileNode,!1,!1);else if("encoded_filename"==attName&&metadata.get("filename"))this[attName]=encodeURIComponent(metadata.get("filename"));else if("escaped_filename"==attName&&metadata.get("filename"))this[attName]=escape(encodeURIComponent(metadata.get("filename")));else if("formated_date"==attName&&metadata.get("ajxp_modiftime")){var modiftime=metadata.get("ajxp_modiftime");if(modiftime instanceof Object)this[attName]=formatDate(modiftime);else{var date=new Date;date.setTime(1e3*parseInt(metadata.get("ajxp_modiftime"))),this[attName]=formatDate(date)}}else if("uri"==attName){var url=document.location.href;"/"==url[url.length-1]?url=url.substr(0,url.length-1):url.lastIndexOf("/")>-1&&(url=url.substr(0,url.lastIndexOf("/"))),this[attName]=url}else metadata.get(attName)?this[attName]=metadata.get(attName):this[attName]=""}.bind(tArgs))}tMessages.each(function(pair){this[pair.key]=MessageHash[pair.value]}.bind(tArgs));var template=new Template(tString);if(this.contentContainer.down("div.infoPanelAllMetadata")?this.contentContainer.down("div.infoPanelAllMetadata").insert(template.evaluate(tArgs)):this.contentContainer.insert(template.evaluate(tArgs)),this.insertedTemplates.push(registeredTemplates[i]),tModifier){var cContainer=this.contentContainer;ResourcesManager.detectModuleToLoadAndApply(tModifier,function(){if(cContainer){try{var modifierFunc=eval(tModifier)}catch(e){window.console&&console.error("InfoPanel: trying to eval function "+tModifier+" failed!",e)}modifierFunc&&modifierFunc(cContainer,fileNode)}})}}this.contentContainer.down("#info_panel_primary")&&this.contentContainer.down("div.infoPanelAllMetadata")&&this.contentContainer.select("[data-infoPanelPosition]").each(function(ip){"first"==ip.readAttribute("data-infoPanelPosition")?this.contentContainer.down("#info_panel_primary").insert({after:ip}):"last"==ip.readAttribute("data-infoPanelPosition")&&this.contentContainer.down("div.infoPanelAllMetadata").insert(ip)}.bind(this))}},addActions:function(selectionType){if(this.contentContainer.down("div.toolbar_placeholder")&&this.contentContainer.select("div.toolbar_placeholder").each(function(placeholder){var tbId=placeholder.readAttribute("data-toolbarId");this.actionsToolbars||(this.actionsToolbars=$A());var bar=new ActionsToolbar(placeholder,{toolbarsList:$A([tbId]),manager:pydio.getController()});bar.actionsLoaded(),bar.registeredButtons&&bar.registeredButtons.each(function(B){B.ACTION.fireSelectionChange(ajaxplorer.getContextHolder())}),this.actionsToolbars.push(bar),placeholder.select("a.disabled,a.action_hidden").invoke("remove"),placeholder.select("a").length>1?(placeholder.addClassName("has_many"),placeholder.up("div").addClassName("one_has_many")):placeholder.addClassName("one_or_less")}.bind(this)),!this.options.skipActions){var actions=pydio.getController().getActionsForAjxpWidget("InfoPanel",this.htmlElement.id);if(actions.length){var actionString='<div class="panelHeader infoPanelGroup">'+MessageHash[5]+'</div><div class="infoPanelActions">',count=0;actions.each(function(action){if(!("empty"==selectionType&&action.context.selection||"multiple"==selectionType&&action.selectionContext.unique||"unique"==selectionType&&(!action.context.selection||action.selectionContext.multipleOnly))){var id="";action.options.name&&(id='id="action_instance_'+action.options.name+'"'),
actionString+='<a href="" '+id+" onclick=\"pydio.getController().fireAction('"+action.options.name+'\');return false;"><img src="'+resolveImageSource(action.options.src,"/images/actions/ICON_SIZE",16)+'" width="16" height="16" align="absmiddle" border="0"> '+action.options.title+"</a>",count++}}.bind(this)),actionString+="</div>",count&&this.contentContainer.insert(actionString)}}},getPreviewElement:function(ajxpNode,getTemplateElement,rich){void 0==rich&&(rich=!0);var editors=pydio.Registry.findEditorsForMime(ajxpNode.getAjxpMime(),!0);if(editors&&editors.length){pydio.Registry.loadEditorResources(editors[0].resourcesManager);var editorClass=Class.getByName(editors[0].editorClass);if(editorClass)return this.contributePanelHeaderIcon("icon-eye-close","Preview","open_with"),getTemplateElement?'<div id="preview_rich_fake_element"></div>':editorClass.prototype.getPreview(ajxpNode,rich)}return'<img src="'+resolveImageSource(ajxpNode.getIcon(),"/images/mimes/ICON_SIZE",64)+'" height="64" width="64">'},parseComponentConfig:function(configNode){for(var panels=XPathSelectNodes(configNode,"infoPanel|infoPanelExtension"),i=0;i<panels.length;i++){var panelMimes=panels[i].getAttribute("mime"),attributes=$A(panels[i].getAttribute("attributes").split(",")),theme=panels[i].getAttribute("theme"),winTheme=window.ajxpBootstrap.parameters.get("theme");if(!theme||-1!=theme.split(",").indexOf(winTheme)){for(var messages=new Hash,modifier=panels[i].getAttribute("modifier")||"",position=panels[i].getAttribute("position")||"",htmlContent="",panelChilds=panels[i].childNodes,j=0;j<panelChilds.length;j++)if("messages"==panelChilds[j].nodeName)for(var messagesList=panelChilds[j].childNodes,k=0;k<messagesList.length;k++)"message"==messagesList[k].nodeName&&messages.set(messagesList[k].getAttribute("key"),messagesList[k].getAttribute("id"));else"html"==panelChilds[j].nodeName&&panelChilds[j].firstChild&&(htmlContent=panelChilds[j].firstChild.nodeValue);var tId=HasherUtils.hex_md5(htmlContent);if(!this.mimesTemplates.get(tId)){this.mimesTemplates.set(tId,$A([htmlContent,attributes,messages,modifier,position]));var primary=panels[i].getAttribute("primary");$A(panelMimes.split(",")).each(function(mime){var registered=this.registeredMimes.get(mime)||$A([]);registered.push(tId),this.registeredMimes.set(mime,registered),primary&&this.primaryTemplates.set(mime,tId)}.bind(this))}}}}}),Class.create("PropertyPanel",{initialize:function(userSelection,htmlElement){this.rights=["4","2","1"],this.accessors=["u","g","a"],this.accessLabels=[MessageHash[288],MessageHash[289],MessageHash[290]],this.rightsLabels=["r","w","x"],this.htmlElement=$(htmlElement).select("[id='properties_box']")[0],userSelection.isUnique()?this.origValue=userSelection.getUniqueNode().getMetadata().get("file_perms"):this.origValue="",this.createChmodForm(),this.valueInput.observe(Prototype.Browser.IE?"change":"input",function(e){this.updateBoxesFromValue(this.valueInput.value)}.bind(this)),this.updateBoxesFromValue(this.valueInput.value),userSelection.hasDir()&&this.createRecursiveBox()},valueChanged:function(){return this.origValue!=this.valueInput.value},createChmodForm:function(){this.checks=$H({});var chmodTable=new Element("table",{style:"font-size:11px;"}),tHead=new Element("thead"),tBody=new Element("tbody");chmodTable.insert(tHead),chmodTable.insert(tBody);var headerRow=new Element("tr"),emptyLabel=new Element("td");headerRow.insert(emptyLabel),tHead.insert(headerRow);var i,j;for(j=0;3>j;j++)headerRow.insert(new Element("td").update(this.rightsLabels[j]+"&nbsp;&nbsp;").setStyle({textAlign:"center"}));for(i=0;3>i;i++){var permRow=new Element("tr"),label=new Element("td").setStyle({textAlign:"right",paddingRight:"2px",width:"35px"});for(label.insert(this.accessLabels[i]),tBody.insert(permRow),permRow.insert(label),j=0;3>j;j++){var check=this.createCheckBox(this.accessors[i],this.rights[j]);permRow.insert(check)}}this.valueInput=new Element("input",{value:this.origValue,name:"chmod_value"}).setStyle({width:"95%"});var valueRow=new Element("tr");tBody.insert(valueRow),valueRow.insert(new Element("td")),valueRow.insert(new Element("td",{colspan:3}).update(this.valueInput)),this.htmlElement.insert(chmodTable)},createCheckBox:function(accessor,right){var box=new Element("input",{type:"checkbox",id:accessor+"_"+right}).setStyle({width:"14px",height:"14px",borderWidth:"0"}),div=new Element("td",{align:"center"}).insert(box).setStyle({width:"25px"});return box.observe("click",function(e){this.updateValueFromBoxes()}.bind(this)),this.checks.set(accessor+"_"+right,box),div},createRecursiveBox:function(){var recuDiv=new Element("div",{style:"padding-top:8px;"}),recurBox=new Element("input",{type:"checkbox",name:"recursive"}).setStyle({width:"14px",height:"14px",borderWidth:"0"});recuDiv.insert(recurBox),recuDiv.insert(MessageHash[291]),this.htmlElement.insert(recuDiv);var choices={both:"Both",file:"Files",dir:"Folders"},choicesDiv=new Element("div");recuDiv.insert(choicesDiv);for(var key in choices)if(choices.hasOwnProperty(key)){var choiceDiv=new Element("div",{style:"padding-left:25px"}),choiceDivBox=new Element("input",{type:"radio",name:"recur_apply_to",value:key,style:"width:25px;border:0;"});choiceDiv.insert(choiceDivBox),"both"==key&&(choiceDivBox.checked=!0),choiceDiv.insert(choices[key]),choicesDiv.insert(choiceDiv)}choicesDiv.hide(),recurBox.observe("click",function(e){recurBox.checked?choicesDiv.show():choicesDiv.hide(),modal.refreshDialogAppearance()})},updateValueFromBoxes:function(){for(var value="0",i=0;3>i;i++)value+=this.updateValueForAccessor(this.accessors[i]);this.valueInput.value=value},updateValueForAccessor:function(accessor){for(var value=0,i=0;3>i;i++)value+=this.checks.get(accessor+"_"+this.rights[i]).checked?parseInt(this.rights[i]):0;return value},updateBoxesFromValue:function(value){if(4==value.length)for(var i=0;3>i;i++)this.valueToBoxes(parseInt(value.charAt(i+1)),this.accessors[i])},valueToBoxes:function(value,accessor){for(var i=0;3>i;i++)this.checks.get(accessor+"_"+this.rights[i]).checked=!1;if(0!=value){var toCheck=$A([]);switch(value){case 1:toCheck.push("1");break;case 2:toCheck.push("2");break;case 3:toCheck.push("1"),toCheck.push("2");break;case 4:toCheck.push("4");break;case 5:toCheck.push("4"),toCheck.push("1");break;case 6:toCheck.push("4"),toCheck.push("2");break;case 7:toCheck.push("2"),toCheck.push("4"),toCheck.push("1")}toCheck.each(function(ch){this.checks.get(accessor+"_"+ch).checked=!0}.bind(this))}}}),Class.create("AbstractEditor",{__implements:["IAjxpWidget"],defaultActions:new Hash,toolbarSeparator:'<div class="separator"></div>',fullScreenMode:!1,editorOptions:null,inputNode:null,initialize:function(oContainer,options){this.editorOptions=Object.extend({fullscreen:!0,closable:!0,floatingToolbar:!1,context:modal},options||{}),this.htmlElement=this.element=$(oContainer),window.pydio.Parameters.get("currentThemeUsesIconFonts")?this.defaultActions=new Hash({fs:'<a id="fsButton" class="icon-resize-full"><span message_id="235"></span></a>',nofs:'<a id="nofsButton" class="icon-resize-small" style="display:none;"><span message_id="236"></span></a>',close:'<a id="closeButton" class="icon-remove-sign"><span message_id="86"></span></a>'}):this.defaultActions=new Hash({fs:'<a id="fsButton" class="icon-resize-full"><img src="'+ajxpResourcesFolder+'/images/actions/22/window_fullscreen.png"  width="22" height="22" alt="" border="0"><br><span message_id="235"></span></a>',nofs:'<a id="nofsButton" class="icon-resize-small" style="display:none;"><img src="'+ajxpResourcesFolder+'/images/actions/22/window_nofullscreen.png"  width="22" height="22" alt="" border="0"><br><span message_id="236"></span></a>',close:'<a id="closeButton" class="icon-remove-sign"><img src="'+ajxpResourcesFolder+'/images/actions/22/fileclose.png"  width="22" height="22" alt="" border="0"><br><span message_id="86"></span></a>'}),this.editorOptions.closable||this.defaultActions.unset("close"),this.editorOptions.actions&&(this.defaultActions=$H(Object.extend(this.defaultActions._object,this.editorOptions.actions))),this.createTitleSpans(),this.initActions(),this.editorOptions.context.setCloseAction&&this.editorOptions.context.setCloseAction(function(){this.close()}.bind(this))},showElement:function(show){show?(pydio.UI.disableAllKeyBindings(),this.element.show(),this.inputNode&&ajaxplorer.updateContextData(null,[this.inputNode],this)):(pydio.UI.enableAllKeyBindings(),this.element.hide())},getDomNode:function(){return this.element},destroy:function(){this.close()},validateClose:function(){return!(this.isModified&&!window.confirm(MessageHash[201]))},initActions:function(){this.actions=new Hash,this.registeredActions=new Hash;var actionBarSel=this.element.select(".action_bar");actionBarSel.length?this.actionBar=actionBarSel[0]:(this.actionBar=new Element("div",{className:"action_bar"}),this.element.insert({top:this.actionBar})),this.actionBar.addClassName("editor_action_bar"),this.editorOptions.fullscreen||(this.defaultActions.unset("fs"),this.defaultActions.unset("nofs")),this.actionBar.insert({top:this.toolbarSeparator}),this.actionBar.insert({bottom:this.toolbarSeparator}),this.actionBar.insert({bottom:this.defaultActions.values().join("\n")}),this.actionBar.select("a").each(function(link){link.onclick=function(){return!1},link.href="#",link.select("br").invoke("remove"),link.select("img").invoke("addClassName","actionbar_button_icon"),link.select("span").invoke("addClassName","actionbar_button_label");var span=link.select("span[message_id]")[0],title=MessageHash[span.readAttribute("message_id")];if(span&&span.update(title),this.actions.set(link.id,link),link.getAttribute("access_key")){var aK=link.getAttribute("access_key");Event[aK]&&(aK=Event[aK]),this.registeredActions.set(aK,link.id),(isNaN(parseFloat(aK))||!isFinite(aK))&&(title+=" ("+aK+")")}link.setAttribute("title",title)},this),this.registeredActions.size()&&(this.keyObs=function(e){pydio.UI.blockEditorShortcuts||(this.registeredActions.get(e.keyCode)?this.actions.get(this.registeredActions.get(e.keyCode)).onclick():this.registeredActions.get(String.fromCharCode(e.keyCode).toLowerCase())&&this.actions.get(this.registeredActions.get(String.fromCharCode(e.keyCode).toLowerCase())).onclick())}.bind(this),Event.observe(document,"keydown",this.keyObs),this.element.observe("editor:close",function(){Event.stopObserving(document,"keydown",this.keyObs)}.bind(this))),this.actions.get("closeButton")&&(this.actions.get("closeButton").observe("click",function(){hideLightBox(!0)}.bind(this)),this.editorOptions.context.setCloseValidation&&this.editorOptions.context.setCloseValidation(function(){return!(this.isModified&&!window.confirm(MessageHash[201]))}.bind(this)),window.ajxpMobile&&this.actionBar.insert({top:this.actions.get("closeButton")})),this.actions.get("fsButton")&&(this.actions.get("fsButton").observe("click",this.setFullScreen.bind(this)),this.actions.get("nofsButton").observe("click",this.exitFullScreen.bind(this)),this.actions.get("fsButton").show(),this.actions.get("nofsButton").hide()),this.editorOptions.floatingToolbar&&this.makeToolbarFloatable(),this.editorOptions.toolbarStyle&&this.actionBar.addClassName(this.editorOptions.toolbarStyle),attachMobileScroll(this.actionBar,"horizontal");var obs=this.resize.bind(this);modal.observe("modal:resize",obs),this.element.observe("editor:close",function(){modal.stopObserving("modal:resize",obs)})},makeToolbarFloatable:function(){this.element.up("div.dialogContent")&&this.element.up("div.dialogContent").setStyle({position:"relative"}),this.actionBar.absolutize();var crtIndex=parseInt(this.element.getStyle("zIndex"));crtIndex||(crtIndex=1e3),this.actionBar.setStyle({zIndex:crtIndex+1e3,width:"",top:""}),this.actionBar.addClassName("floatingBar"),this.actionBar.down("div.separator").remove(),this.actionBarPlacer=function(){var anchor=this.floatingToolbarAnchor?this.floatingToolbarAnchor:this.contentMainContainer;if(anchor){var w=this.actionBar.getWidth(),elW=anchor.getWidth();this.actionBar.setStyle({left:Math.max(0,(elW-w)/2)+anchor.positionedOffset().left+"px"}),this.actionBar.setStyle({top:anchor.getHeight()-this.actionBar.getHeight()-30+"px"})}}.bind(this),this.element.observe("editor:resize",this.actionBarPlacer),this.element.observe("editor:close",function(){this.element.stopObserving("editor:resize",this.actionBarPlacer)}.bind(this)),window.setTimeout(this.actionBarPlacer,100),new Draggable(this.actionBar)},createTitleSpans:function(){this.crtTitle=new Element("span"),this.filenameSpan=new Element("span",{className:"filenameSpan"}),this.crtTitle.insert({bottom:this.filenameSpan}),this.modifSpan=new Element("span",{className:"modifiedSpan"}),this.crtTitle.insert({bottom:this.modifSpan}),this.element.fire("editor:updateTitle",this.crtTitle),this.editorOptions.editorData.icon_class?this.element.fire("editor:updateIconClass",this.editorOptions.editorData.icon_class):this.editorOptions.editorData.icon&&this.element.fire("editor:updateIconSrc",this.editorOptions.editorData.icon)},open:function(nodeOrNodes){this.inputNode=nodeOrNodes},updateTitle:function(title){this.filenameSpan&&this.filenameSpan.update(title),this.fullScreenMode&&this.refreshFullScreenTitle(),this.editorOptions.editorData.icon_class?this.element.fire("editor:updateIconClass",this.editorOptions.editorData.icon_class):this.editorOptions.editorData.icon&&this.element.fire("editor:updateIconSrc",this.editorOptions.editorData.icon),this.element.fire("editor:updateTitle",this.crtTitle)},setModified:function(isModified){this.isModified=isModified,this.modifSpan&&(this.modifSpan.update(isModified?"*":""),this.element.fire("editor:updateTitle",this.crtTitle)),this.actions.get("saveButton")&&(isModified?this.actions.get("saveButton").removeClassName("disabled"):this.actions.get("saveButton").addClassName("disabled")),this.fullScreenMode&&this.refreshFullScreenTitle(),this.element.fire("editor:modified",isModified)},_supportsBrowserFullScreen:function(element){return element.requestFullScreen||element.webkitRequestFullScreen||element.mozRequestFullScreen},_browserFullScreen:function(element){if(element.setStyle({width:"100%"}),element.select("#computer_fullscreen").invoke("remove"),element.requestFullScreen)element.requestFullScreen();else if(element.webkitRequestFullScreen)element.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);else{if(!element.mozRequestFullScreen)return!1;element.mozRequestFullScreen()}return!0},setFullScreen:function(){if(this.contentMainContainer||(this.contentMainContainer=this.element),this.originalHeight=this.contentMainContainer.getHeight(),this.originalWindowTitle=document.title,"Modal"!=this.editorOptions.context.__className&&(this.originalParentId=this.element.parentNode.id),this.element.fire("editor:enterFS"),this.element.absolutize(),this.actionBar.setStyle({marginTop:0}),$(document.body).insert(this.element),this.element.setStyle({top:0,left:0,marginBottom:0,backgroundColor:"#fff",width:"100%",height:parseInt(document.viewport.getHeight())+"px",zIndex:3e3}),this.actions.get("fsButton").hide(),this.actions.get("nofsButton").show(),this.fullScreenListener=function(){this.element.setStyle({height:parseInt(document.viewport.getHeight())+"px"}),this.resize()}.bind(this),Event.observe(window,"resize",this.fullScreenListener),this.refreshFullScreenTitle(),this.resize(),this.fullScreenMode=!0,this.element.fire("editor:enterFSend"),this._supportsBrowserFullScreen(this.element)&&!this.element.down("#computer_fullscreen")){var rightPos=this.editorOptions.floatingToolbar?10:100,button=new Element("span",{id:"computer_fullscreen",className:"icon-resize-full",style:"display: block; cursor:pointer; position:absolute; right:"+rightPos+"px; top:10px;color:white;font-size:15px;"}).update("&nbsp;&nbsp;"+MessageHash[512]);button.observe("click",function(){this._browserFullScreen(this.element)}.bind(this)),this.element.insert(button)}},exitFullScreen:function(){if(this.fullScreenMode){this._supportsBrowserFullScreen(this.element)&&this.element.down("#computer_fullscreen")&&this.element.down("#computer_fullscreen").remove(),this.element.fire("editor:exitFS"),Event.stopObserving(window,"resize",this.fullScreenListener);var dContent,w;this.originalParentId?(dContent=$(this.originalParentId),w="auto"):(dContent=$$(".dialogContent")[0],w=parseInt(dContent.getWidth())+"px"),dContent.setStyle({position:"relative"}),dContent.insert(this.element),this.element.relativize(),this.element.setStyle({position:"relative"}),this.element.setStyle({top:0,left:0,width:w,height:parseInt(dContent.getHeight())+"px",zIndex:100}),this.resize(this.originalHeight),this.actions.get("fsButton").show(),this.actions.get("nofsButton").hide(),document.title=this.originalWindowTitle,this.fullScreenMode=!1,this.originalParent=null,this.element.fire("editor:exitFSend")}},resize:function(size){this.contentMainContainer&&(size?this.contentMainContainer.setStyle({height:size+"px"}):fitHeightToBottom(this.contentMainContainer,this.element)),this.element.fire("editor:resize",size)},close:function(){return this.fullScreenMode&&this.exitFullScreen(),this.element.fire("editor:close"),this.editorOptions.context.setCloseAction&&this.editorOptions.context.setCloseAction(null),!1},refreshFullScreenTitle:function(){document.title="Pydio - "+this.filenameSpan.innerHTML.stripTags().replace("&nbsp;","")},setOnLoad:function(element){element||(element=this.element),addLightboxMarkupToElement(element);var img=new Element("img",{src:ajxpResourcesFolder+"/images/loadingImage.gif"});$(element).down("#element_overlay").insert(img),this.loading=!0},removeOnLoad:function(element){element||(element=this.element),removeLightboxFromElement(element),this.loading=!1},getPreview:function(ajxpNode,rich){var src=AbstractEditor.prototype.getThumbnailSource(ajxpNode);src||(src=ajxpNode.isLeaf()?resolveImageSource("mime_empty.png","/images/mimes/ICON_SIZE",64):resolveImageSource("folder.png","/images/mimes/ICON_SIZE",64));var imgObject=new Element("img",{src:src,width:64,height:64,align:"absmiddle",border:0});return imgObject.resizePreviewElement=function(dimensionObject){dimensionObject.maxWidth=dimensionObject.maxHeight=64;var styleObject=fitRectangleToDimension({width:64,height:64},dimensionObject);if(dimensionObject.width>=64){var newHeight=parseInt(styleObject.height),mT=parseInt((dimensionObject.width-64)/2)+dimensionObject.margin,mB=dimensionObject.width+2*dimensionObject.margin-newHeight-mT-1;styleObject.marginTop=mT+"px",styleObject.marginBottom=mB+"px"}this.setStyle(styleObject)}.bind(imgObject),imgObject},getThumbnailSource:function(ajxpNode){return resolveImageSource(ajxpNode.getIcon(),"/images/mimes/ICON_SIZE",64)}}),Class.create("Modal",{pageLoading:!0,initialize:function(){},currentLightBoxElement:null,currentLightBoxModal:null,initForms:function(){this.elementName="generic_dialog_box",this.htmlElement=$(this.elementName),this.dialogTitle=this.htmlElement.down(".dialogTitle"),this.dialogContent=this.htmlElement.down(".dialogContent"),this.cachedForms=new Hash},prepareHeader:function(sTitle,sIconSrc,sIconClass){var hString='<span class="titleString">';""!=sIconSrc&&(hString='<span class="titleString"><img src="'+sIconSrc.replace("22","16")+'" width="16" height="16" align="top"/>&nbsp;');var closeBtn;window.ajaxplorer.currentThemeUsesIconFonts?(sIconClass&&(hString='<span class="titleString"><span class=\''+sIconClass+" ajxp_icon_span'></span>"),closeBtn='<span id="modalCloseBtn" class="icon-remove" style="cursor:pointer;float:right;"></span>'):closeBtn='<img id="modalCloseBtn" style="cursor:pointer;float:right;margin-top:2px;" src="'+ajxpResourcesFolder+'/images/actions/16/window_close.png" />',hString+='<span class="string-only-title">'+sTitle+"</span></span>",this.dialogTitle.update(closeBtn+hString)},setContextTitle:function(title,iconClass,iconImg){title&&this.dialogTitle.down(".string-only-title").update(title)},showDialogForm:function(sTitle,sFormId,fOnLoad,fOnComplete,fOnCancel,bOkButtonOnly,skipButtons,useNextButtons){this.clearContent(this.dialogContent),this.htmlElement.className="dialogBox form-"+sFormId;var newForm;if("FORM"==$(sFormId).tagName)newForm=$(sFormId),newForm.show();else{var formDiv=$(sFormId);newForm=new Element("form",{name:"modal_action_form",id:"modal_action_form",autocomplete:"off"}),newForm.insert(formDiv.cloneNode(!0));var reloadIFrame,reloadIFrameSrc;if($(newForm).getElementsByTagName("iframe")[0]&&(reloadIFrame=$(newForm).getElementsByTagName("iframe")[0],reloadIFrameSrc=$(newForm).getElementsByTagName("iframe")[0].getAttribute("src")),formDiv.getAttribute("action")){var actionField=document.createElement("input");actionField.setAttribute("type","hidden"),actionField.setAttribute("name","get_action"),actionField.setAttribute("value",formDiv.getAttribute("action")),newForm.appendChild(actionField)}}this.cachedForms.get(sFormId)&&"login_form_dynamic"!=sFormId||skipButtons||this.addSubmitCancel(newForm,fOnCancel,bOkButtonOnly,"bottom",useNextButtons),this.dialogContent.appendChild(newForm);var boxPadding=$(sFormId).getAttribute("box_padding");boxPadding||(boxPadding=10),this.dialogContent.setStyle({padding:boxPadding+"px"}),this.dialogTitle.select("#modalCloseBtn")[0]&&(fOnCancel?this.dialogTitle.select("#modalCloseBtn")[0].observe("click",function(){fOnCancel(this.getForm()),hideLightBox()}.bind(this)):this.dialogTitle.select("#modalCloseBtn")[0].observe("click",function(){hideLightBox()})),fOnComplete?newForm.onsubmit=function(){try{fOnComplete(this.getForm())}catch(e){alert("Unexpected Error : please report!\n"+e)}return!1}.bind(this):newForm.onsubmit=function(){return pydio.getController().submitForm(this.getForm()),hideLightBox(),!1}.bind(this);var overlayStyle=void 0;if($(sFormId).getAttribute("overlayStyle")&&(overlayStyle=$(sFormId).getAttribute("overlayStyle").evalJSON()),this.showContent(this.elementName,$(sFormId).getAttribute("box_width"),$(sFormId).getAttribute("box_height"),null,$(sFormId).getAttribute("box_resize")&&"true"==$(sFormId).getAttribute("box_resize"),overlayStyle,sFormId),$(newForm).select(".dialogFocus").length){var objToFocus=$(newForm).select(".dialogFocus")[0];setTimeout(function(){objToFocus.focus()},500)}var repDisplay;$(newForm).select(".replace_rep").length&&(repDisplay=$(newForm).select(".replace_rep")[0],repDisplay.innerHTML=ajaxplorer.getContextHolder().getContextNode().getPath()),$(newForm).select(".replace_file").length&&(repDisplay=$(newForm).select(".replace_file")[0],repDisplay.innerHTML=getBaseName(ajaxplorer.getUserSelection().getUniqueFileName())),$(newForm).select(".dialogEnterKey").length&&Prototype.Browser.IE&&$(newForm).select(".dialogEnterKey").each(function(el){el.enterObserver||(el.observe("keypress",function(event){event.keyCode==Event.KEY_RETURN&&newForm.onsubmit()}),el.enterObserver=!0)}),this.currentForm=newForm,null!=fOnLoad&&(fOnLoad(this.currentForm),this.refreshDialogAppearance()),Prototype.Browser.WebKit&&reloadIFrame&&reloadIFrameSrc&&(reloadIFrame.src=reloadIFrameSrc)},showContent:function(elementName,boxWidth,boxHeight,skipShadow,boxAutoResize,overlayStyle,formId){pydio.UI.disableShortcuts(),pydio.UI.disableNavigation(),pydio.UI.blurAll();var winWidth=document.viewport.getWidth(),winHeight=document.viewport.getHeight();if(this.currentListensToWidth=!1,this.currentListensToHeight=!1,$(elementName).setStyle({width:"auto",height:"auto"}),null!=boxWidth){if(-1==boxWidth.indexOf("%")&&parseInt(boxWidth)>winWidth&&(boxWidth="90%"),boxWidth.indexOf("%")>-1){var percentWidth=parseInt(boxWidth);boxWidth=parseInt(winWidth*percentWidth/100),this.currentListensToWidth=percentWidth}$(elementName).setStyle({width:boxWidth+"px"})}if(null!=boxHeight){if(boxHeight.indexOf("%")>-1){var percentHeight=parseInt(boxHeight);boxHeight=parseInt(winHeight*percentHeight/100),this.currentListensToHeight=percentHeight}$(elementName).setStyle({height:boxHeight+"px"})}else $(elementName).setStyle({height:"auto"}),$(elementName).down(".dialogContent").setStyle({height:"auto"});boxAutoResize&&(this.currentListensToWidth||this.currentListensToHeight)?(this.currentResizeListener=function(){if(this.currentListensToWidth){var winWidth=document.viewport.getWidth();boxWidth=parseInt(winWidth*this.currentListensToWidth/100),$(elementName).setStyle({width:boxWidth+"px"})}if(this.currentListensToHeight){var winHeight=document.viewport.getHeight(),boxH=parseInt(winHeight*this.currentListensToHeight/100);$(elementName).setStyle({height:boxH+"px"}),fitHeightToBottom($(elementName).down(".dialogContent"))}this.notify("modal:resize")}.bind(this),Event.observe(window,"resize",this.currentResizeListener)):(this.currentResizeListener=function(){this.refreshDialogPosition()}.bind(this),Event.observe(window,"resize",this.currentResizeListener)),this._bufferedRefreshDialogPosition(),displayLightBoxById(elementName,overlayStyle,formId?"form-"+formId:null),$(elementName).style.position="absolute",Prototype.Browser.Gecko?$(elementName).style.position="fixed":Prototype.Browser.IE&&!Prototype.Browser.IE10plus&&($(elementName).select("select").invoke("show"),refreshPNGImages(this.dialogContent)),this.currentResizeListener&&this.currentResizeListener()},openEditorDialog:function(editorData,editorArgument){if(!editorData.formId)return void ajaxplorer.displayMessage("ERROR",'Error, you must define a formId attribute in your &lt;editor&gt; manifest (or set it as openable="false")');var editorKlass=editorData.editorClass;this.prepareHeader(editorData.text,resolveImageSource(editorData.icon,"/images/actions/ICON_SIZE",16),editorData.icon_class);var loadFunc=function(oForm){"string"==typeof editorKlass?pydio.getController().editor=eval("new "+editorKlass+"(oForm, {editorData:editorData, context:modal})"):pydio.getController().editor=new editorKlass(oForm,{editorData:editorData,context:modal}),pydio.getController().editor.open(editorArgument?editorArgument:ajaxplorer.getUserSelection().getUniqueNode()),pydio.getController().editor.getDomNode().observe("editor:updateTitle",function(event){this.setContextTitle(event.memo)}.bind(this))}.bind(this);this.showDialogForm("",editorData.formId,loadFunc,null,null,!0,!0)},showSimpleModal:function(element,content,okCallback,cancelCallback,position){var box=new Element("div",{className:"dialogBox css_boxshadow",style:"display:block;"});if(box.insert(content),content.addClassName("dialogContent"),addLightboxMarkupToElement(element),Prototype.Browser.IE&&!Prototype.Browser.IE10plus){$("all_forms").insert(box);var outBox=element.up(".dialogBox");box.setStyle(outBox?{display:"block",zIndex:outBox.getStyle("zIndex"),top:parseInt(outBox.getStyle("top")),left:parseInt(outBox.getStyle("left"))}:{display:"block",zIndex:2e3,top:parseInt(element.getStyle("top")),left:parseInt(element.getStyle("left"))})}else $(element).down("#element_overlay").insert({after:box}),$(element).down("#element_overlay").setStyle({opacity:.9}),element.up("div.dialogBox");this.currentLightBoxElement=$(element),this.currentLightBoxModal=box,this.addSubmitCancel(content,cancelCallback,null==cancelCallback,position),content.down(".dialogButtons").select("input").each(function(button){null==cancelCallback&&"close"==button.getAttribute("name")||"ok"==button.getAttribute("name")?button.observe("click",function(event){Event.stop(event);var res=okCallback();res&&Effect.BlindUp(box,{duration:.4,afterFinish:function(){content.down("div.dialogButtons").remove(),$(element).down("#element_overlay").setStyle({opacity:0}),box.remove(),removeLightboxFromElement(element),this.currentLightBoxElement=null,this.currentLightBoxModal=null}.bind(this)})}.bind(this)):(button.stopObserving("click"),button.observe("click",function(event){Event.stop(event);var res=cancelCallback();res&&Effect.BlindUp(box,{duration:.4,afterFinish:function(){content.down("div.dialogButtons").remove(),$(element).down("#element_overlay")&&$(element).down("#element_overlay").setStyle({opacity:0}),box.remove(),removeLightboxFromElement(element),this.currentLightBoxElement=null,this.currentLightBoxModal=null}.bind(this)})}.bind(this)))})},createTopCaret:function(element){"use strict";element.insert({top:'<span class="icon-caret-up ajxp-caret-up"></span>'});var caret=element.down("span.ajxp-caret-up");caret.setStyle({left:(element.getWidth()-caret.getWidth())/2+"px"})},getForm:function(){return this.currentForm},_dialogPositionRefreshBuffer:null,refreshDialogPosition:function(checkHeight,elementToScroll){this._dialogPositionRefreshBuffer&&window.clearTimeout(this._dialogPositionRefreshBuffer),this._dialogPositionRefreshBuffer=window.setTimeout(function(){this._bufferedRefreshDialogPosition(checkHeight,elementToScroll)}.bind(this),200)},_bufferedRefreshDialogPosition:function(checkHeight,elementToScroll){var winWidth=document.viewport.getWidth(),winHeight=document.viewport.getHeight(),element=$(this.elementName),boxWidth=element.getWidth(),boxHeight=element.getHeight(),dContent=element.down(".dialogContent"),dContentScrollHeight=dContent.scrollHeight,dTitle=element.down(".dialogTitle");if(checkHeight&&boxHeight>parseInt(90*winHeight/100)){var maxHeight=parseInt(90*winHeight/100),crtScrollHeight=elementToScroll.getHeight(),crtOffset=boxHeight-crtScrollHeight;maxHeight>crtOffset&&(elementToScroll.setStyle({overflow:"auto",height:maxHeight-crtOffset+"px"}),window.ajxpMobile&&attachMobileScroll(dContent,"vertical"),boxHeight=element.getHeight())}else!checkHeight&&dContentScrollHeight>winHeight?(dContent.setStyle("absolute"==dTitle.getStyle("position")?{height:winHeight+"px",overflow:"auto"}:{height:winHeight-parseInt(dTitle.getHeight())-20+"px",overflow:"auto"}),window.ajxpMobile&&attachMobileScroll(dContent,"vertical"),boxHeight=element.getHeight()):dContentScrollHeight>=dContent.getHeight()&&!this.currentListensToHeight&&(dContent.setStyle({height:"auto"}),boxHeight=element.getHeight());if("absolute"==dTitle.getStyle("position")){var innerH=0;$A(dContent.childNodes).each(function(c){c.getHeight&&(innerH+=c.getHeight())});var topPadding=Math.min(25*winHeight/100,Math.max(0,parseInt((winHeight-innerH)/2)));dContent.setStyle({paddingTop:topPadding+"px"})}var offsetLeft=parseInt((winWidth-parseInt(boxWidth))/2),offsetTop=parseInt((winHeight-parseInt(boxHeight))/3);element.offsetLeft&&element.offsetTop?new Effect.Morph($(this.elementName),{style:"top:"+offsetTop+"px;left:"+offsetLeft+"px",duration:.4,afterFinish:this.refreshDialogAppearance.bind(this)}):(element.setStyle({top:offsetTop+"px",left:offsetLeft+"px"}),this.refreshDialogAppearance())},refreshDialogAppearance:function(){},clearContent:function(object){if(object.select("form").length){var oThis=this;object.select("form").each(function(currentForm){if("hidden_iframe"==currentForm.target||"login_form"==currentForm.id||"login_form_dynamic"==currentForm.id||"user_pref_form"==currentForm.id)currentForm.hide(),oThis.cachedForms.set(currentForm.id,!0);else try{object.removeChild(currentForm)}catch(e){}})}},addSubmitCancel:function(oForm,fOnCancel,bOkButtonOnly,position,useNextButton){var contDiv=new Element("div",{className:"dialogButtons"});useNextButton&&contDiv.setStyle({direction:"rtl"});var okButton=new Element("input",{type:"image",name:bOkButtonOnly&&"close"==bOkButtonOnly?"close":"ok",src:ajxpResourcesFolder+"/images/actions/22/"+(bOkButtonOnly?"close"==bOkButtonOnly?"dialog_close":"dialog_ok_apply":useNextButton?"forward":"dialog_ok_apply")+".png",height:22,width:22,title:MessageHash[bOkButtonOnly&&"close"==bOkButtonOnly?49:48]});if(okButton.addClassName("dialogButton"),okButton.addClassName("dialogFocus"),contDiv.insert(okButton),!bOkButtonOnly){var caButton=new Element("input",{type:"image",name:"can",height:22,width:22,src:ajxpResourcesFolder+"/images/actions/22/dialog_close.png",title:MessageHash[49],className:"dialogButton"});fOnCancel?caButton.observe("click",function(e){return fOnCancel(this.getForm()),hideLightBox(),Event.stop(e),!1}.bind(this)):caButton.observe("click",function(e){return hideLightBox(),
Event.stop(e),!1}),contDiv.insert(caButton)}position||(position="bottom");var obj={};return obj[position]=contDiv,$(oForm).insert(obj),oForm.hasButtons=!0,contDiv},simpleTooltip:function(element,title,position,className,hookTo,updateOnShow){position||(position="bottom right"),hookTo||(hookTo="pointer"),element.observe("mouseover",function(event){this.tooltip?(this.tooltip.writeAttribute("class",""),this.tooltip.addClassName("simple_tooltip"),className&&this.tooltip.addClassName(className)):(this.tooltip=new Element("div",{className:"simple_tooltip"}),className&&this.tooltip.addClassName(className),$$("body")[0].insert(this.tooltip)),this.tooltip.update(updateOnShow?title.cloneNode(!0):element.readAttribute("data-simpleTooltipTitle")?element.readAttribute("data-simpleTooltipTitle"):title);var baseX="element"==hookTo?Element.cumulativeOffset(element).left:Event.pointerX(event),baseY="element"==hookTo?Element.cumulativeOffset(element).top:Event.pointerY(event);"element"==hookTo&&(baseY-=Element.cumulativeScrollOffset(element).top);var y=baseY+10;-1!=position.indexOf("middle")?y-=10+parseInt(this.tooltip.getHeight())/2-parseInt(element.getHeight())/2:-1!=position.indexOf("bottom")?y-=13+parseInt(element.getHeight()):-1!=position.indexOf("top")&&(y-=13+parseInt(this.tooltip.getHeight()));var x;-1!=position.indexOf("center")?(x=baseX-(this.tooltip.getWidth()-element.getWidth())/2,0>x&&(x=baseX,this.tooltip.addClassName("arrow_tip_arrow_left"))):x=-1!=position.indexOf("right")?baseX+10+parseInt(element.getWidth()):baseX-10-parseInt(this.tooltip.getWidth()),this.tooltip.setStyle({top:y+"px",left:x+"px"}),this.tipTimer&&window.clearTimeout(this.tipTimer),element.addClassName("simple_tooltip_observer_active"),this.tooltip.show()}.bind(this)),element.observe("mouseout",function(event){this.tooltip&&(this.tipTimer=window.setTimeout(function(){this.tooltip.hide()}.bind(this),200),element.removeClassName("simple_tooltip_observer_active"))}.bind(this)),element.addClassName("simple_tooltip_observer")},closeMessageDiv:function(){this.messageDivOpen&&(new Effect.MessageFade(this.messageBox),this.messageDivOpen=!1)},tempoMessageDivClosing:function(){this.messageDivOpen=!0,this.closeTimer&&window.clearTimeout(this.closeTimer),this.closeTimer=window.setTimeout(function(){this.closeMessageDiv()}.bind(this),6e3)},displayMessage:function(messageType,message){if(this.messageBox||(this.messageBox=new Element("div",{title:MessageHash[98],id:"message_div",className:"messageBox"}),$(document.body).insert(this.messageBox),this.messageContent=new Element("div",{id:"message_content"}),this.messageBox.update(this.messageContent),this.messageBox.observe("click",this.closeMessageDiv.bind(this))),message=message.stripScripts(),message=message.replace(new RegExp("(\\n)","g"),"<br>"),"ERROR"==messageType?(this.messageBox.removeClassName("logMessage"),this.messageBox.addClassName("errorMessage")):(this.messageBox.removeClassName("errorMessage"),this.messageBox.addClassName("logMessage")),this.messageDivOpen)return-1===this.messageContent.innerHTML.indexOf(message)&&this.messageContent.insert("<br>"+message),void this.tempoMessageDivClosing();this.messageContent.update(message);var container;container=pydio.UI.getMessageBoxReference()?pydio.UI.getMessageBoxReference():$($("content_pane")?"content_pane":ajxpBootstrap.parameters.get("MAIN_ELEMENT"));var containerOffset=Position.cumulativeOffset(container),containerDimensions=container.getDimensions(),boxWidth=parseInt(90*containerDimensions.width/100),leftPosition=containerOffset[0]+parseInt(5*containerDimensions.width/100);this.messageBox.setStyle({bottom:"20px",left:leftPosition+"px",width:boxWidth+"px"}),new Effect.MessageAppear(this.messageBox),window.console&&("ERROR"==messageType?window.console.error(message):window.console.info(message)),this.tempoMessageDivClosing()},setLoadingStepCounts:function(count){this.loadingStepsCount=count,this.loadingStep=count},incrementStepCounts:function(add){this.loadingStepsCount+=add,this.loadingStep+=add},updateLoadingProgress:function(state){this.loadingStep--;var percent=1-this.loadingStep/this.loadingStepsCount;document.fire("ajaxplorer:loader_state_update",{percent:parseFloat(percent)}),state&&$("progressState")&&$("progressState").update(state),0==this.loadingStep&&(this.pageLoading=!1)},setCloseValidation:function(func){this.closeValidation=func},setCloseAction:function(func){this.closeFunction=func},close:function(){this.closeFunction&&this.closeFunction(),this.currentResizeListener&&(Event.stopObserving(window,"resize",this.currentResizeListener),this.currentResizeListener=null)}});var modal=new Modal;Class.create("BookmarksBar",{bookmarksMenuOptions:{className:"menu bookmarksMenu",mouseClick:"left",createAnchor:!1,topOffset:2,leftOffset:0,fade:!0,zIndex:2e3},initialize:function(oElement,options){this.element=$(oElement),this.currentCount=0,this.bookmarks=$A([]),options&&options.bookmarksMenuOptions&&(this.bookmarksMenuOptions.menuTitle=MessageHash[145],this.bookmarksMenuOptions=Object.extend(this.bookmarksMenuOptions,options.bookmarksMenuOptions)),this.createMenu(),this.regObserver=function(event){this.parseXml(event.memo)}.bind(this),document.observe("ajaxplorer:registry_loaded",this.regObserver),document.observeOnce("ajaxplorer:actions_loaded",function(){var bmAction=pydio.getController().actions.get("bookmark");bmAction&&(this.addBookmarkObject={name:bmAction.getKeyedText(),alt:bmAction.options.title,image:ajxpResourcesFolder+"/images/actions/16/bookmark_add.png",callback:function(e){document.notify("ajaxplorer:add_bookmark")}.bind(this)})}.bind(this)),this.bmObserver=function(){var node=ajaxplorer.getUserSelection().getUniqueNode();node.getMetadata().get("ajxp_bookmarked")&&"true"==node.getMetadata().get("ajxp_bookmarked")?this.removeBookmark(node.getPath(),function(){ajaxplorer.fireNodeRefresh(node)}):this.addBookmark(node.getPath(),node.getLabel(),function(){ajaxplorer.fireNodeRefresh(node)})}.bind(this),document.observe("ajaxplorer:add_bookmark",this.bmObserver)},destroy:function(){document.stopObserving("ajaxplorer:add_bookmark",this.bmObserver),document.stopObserving("ajaxplorer:registry_loaded",this.regObserver),this.bmMenu&&this.bmMenu.destroy()},parseXml:function(registry){this.clear();for(var childNodes=XPathSelectNodes(registry,"user/bookmarks/bookmark"),i=0;i<childNodes.length;i++){var bookmark={name:childNodes[i].getAttribute("title"),alt:childNodes[i].getAttribute("path"),image:ajxpResourcesFolder+"/images/mimes/16/folder.png",icon_class:"icon-bookmark-empty"};bookmark.callback=function(e){ajaxplorer.goTo(this.alt)}.bind(bookmark),bookmark.moreActions=this.getContextActions(bookmark.alt,bookmark.name),this.bookmarks.push(bookmark)}this.bmMenu&&(this.bmMenu.options.menuItems=this.bookmarks,this.bmMenu.refreshList()),this.bookmarks.length&&this.element&&this.element.removeClassName("inline_disabled"),modal.pageLoading&&modal.updateLoadingProgress("Bookmarks Loaded")},createMenu:function(){this.element&&(this.bmMenu=new Proto.Menu(Object.extend(this.bookmarksMenuOptions,{anchor:this.element,menuItems:this.bookmarks})))},clear:function(){this.currentCount=0,this.addBookmarkObject?this.bookmarks=$A([this.addBookmarkObject,{separator:!0}]):this.bookmarks=$A(),this.element&&this.element.addClassName("inline_disabled"),this.bmMenu&&(this.bmMenu.options.menuItems=this.bookmarks,this.bmMenu.refreshList())},getContextActions:function(bmPath,bmTitle){var removeAction={name:MessageHash[146],alt:MessageHash[146],image:ajxpResourcesFolder+"/images/actions/16/delete_bookmark.png",icon_class:"icon-remove",disabled:!1,className:"edit",callback:function(e){this.removeBookmark(bmPath)}.bind(this)},renameAction={name:MessageHash[6],alt:MessageHash[6],image:ajxpResourcesFolder+"/images/actions/16/applix.png",icon_class:"icon-edit",disabled:!1,className:"edit",callback:function(e){this.toggleRenameForm(bmPath,bmTitle)}.bind(this)};return $A([renameAction,removeAction])},toggleRenameForm:function(bmPath,bmTitle){modal.prepareHeader(MessageHash[225],ajxpResourcesFolder+"/images/actions/16/bookmark.png");var onLoad=function(newForm){$(newForm).bm_path.value=bmPath,$(newForm).bm_title.value=bmTitle},onComplete=function(){this.renameBookmark(modal.getForm().bm_path.value,modal.getForm().bm_title.value),hideLightBox(!0)}.bind(this);modal.showDialogForm("Rename","rename_bookmark",onLoad,onComplete)},load:function(actionsParameters,silently,onComplete){if(ajaxplorer&&ajaxplorer.user){var connexion=new Connexion;actionsParameters||(actionsParameters=new Hash),actionsParameters.set("get_action","get_bookmarks"),connexion.setParameters(actionsParameters),onComplete?connexion.onComplete=function(transport){onComplete(),ajaxplorer.notify("server_message:tree/reload_bookmarks")}:connexion.onComplete=function(transport){document.observeOnce("ajaxplorer:registry_part_loaded",function(event){"user/bookmarks"==event.memo&&this.parseXml(ajaxplorer.getXmlRegistry())}.bind(this)),ajaxplorer.loadXmlRegistry(!1,"user/bookmarks"),this.bmMenu&&(this.bmMenu.refreshList(),silently||this.bmMenu.show()),ajaxplorer.notify("server_message:tree/reload_bookmarks")}.bind(this),connexion.sendAsync()}},addBookmark:function(path,title,onComplete){var parameters=new Hash;parameters.set("bm_action","add_bookmark"),parameters.set("bm_path",path),title&&parameters.set("bm_title",title),this.load(parameters,!1,onComplete)},removeBookmark:function(path,onComplete){var parameters=new Hash;parameters.set("bm_action","delete_bookmark"),parameters.set("bm_path",path),this.load(parameters,!1,onComplete)},renameBookmark:function(path,title){var parameters=new Hash;parameters.set("bm_action","rename_bookmark"),parameters.set("bm_path",path),parameters.set("bm_title",title),this.load(parameters)}}),Class.create("FormManager",{modalParent:null,initialize:function(modalParent){modalParent&&(this.modalParent=modalParent)},parseParameters:function(xmlDocument,query){var res=$A();return $A(XPathSelectNodes(xmlDocument,query)).each(function(node){res.push(this.parameterNodeToHash(node))}.bind(this)),res},parameterNodeToHash:function(paramNode){for(var paramsAtts=paramNode.attributes,paramsHash=new Hash,collectCdata=!1,i=0;i<paramsAtts.length;i++){var attName=paramsAtts.item(i).nodeName,value=paramsAtts.item(i).value;"label"!=attName&&"description"!=attName&&"group"!=attName&&0!==attName.indexOf("group_switch_")||!MessageHash[value]||(value=MessageHash[value]),"cdatavalue"!=attName?paramsHash.set(attName,value):collectCdata=!0}return collectCdata&&paramsHash.set("value",paramNode.firstChild.value),paramsHash.set("xmlNode",paramNode),paramsHash},createParametersInputs:function(form,parametersDefinitions,showTip,values,disabled,skipAccordion,addFieldCheckbox,startAccordionClosed){var b=document.body,groupDivs=$H({}),replicableGroups=$H({});parametersDefinitions.each(function(param){var label=param.get("label");if(param.get("labelId")&&(label=MessageHash[param.get("labelId")]),!param.get("group_switch_name")){var name=param.get("name"),type=param.get("type"),desc=param.get("description"),conn=new Connexion;if(!form.down('[name="'+name+'"]')){param.get("descriptionId")&&(desc=MessageHash[param.get("descriptionId")]);var group=param.get("group")||MessageHash[439];param.get("groupId")&&(group=MessageHash[param.get("groupId")]);var mandatory=!1;param.get("mandatory")&&"true"==param.get("mandatory")&&(mandatory=!0);var defaultValue="",defaultValueExists=!1;values&&void 0!==values.get(name)?(defaultValue=values.get(name),defaultValueExists=!0):addFieldCheckbox||void 0===param.get("default")||(defaultValue=param.get("default"),defaultValueExists=!0);var element,disabledString=disabled||param.get("readonly")?' disabled="true" ':"",commonAttributes={name:name,"data-ajxp_type":type,"data-ajxp_mandatory":mandatory?"true":"false"};if((disabled||param.get("readonly"))&&(commonAttributes.disabled="true"),"string"==type||"integer"==type||"array"==type||"hidden"==type)element=new Element("input",Object.extend({type:"hidden"==type?"hidden":"text",className:"SF_input",value:defaultValue},commonAttributes));else if("button"==type)element=new Element("div",{className:"SF_input SF_inlineButton"}).update('<span class="icon-play-circle"></span>'+param.get("description")),element.observe("click",function(event){element.addClassName("SF_inlineButtonWorking");var testValues=$H(),choicesValue=param.get("choices").split(":"),firstPart=choicesValue.shift();return"run_client_action"==firstPart?(element.removeClassName("SF_inlineButtonWorking"),void pydio.getController().fireAction(choicesValue.shift())):(testValues.set("get_action",firstPart),this.serializeParametersInputs(form,testValues,"DRIVER_OPTION_"),choicesValue.length>1&&(testValues.set("action_plugin_id",choicesValue.shift()),testValues.set("action_plugin_method",choicesValue.shift())),-1!==name.indexOf("/")&&testValues.set("button_key",getRepName(name)),conn.setMethod("post"),conn.setParameters(testValues),conn.onComplete=function(transport){element.removeClassName("SF_inlineButtonWorking"),transport.responseText.startsWith("SUCCESS:")?ajaxplorer.displayMessage("SUCCESS",transport.responseText.replace("SUCCESS:","")):ajaxplorer.displayMessage("ERROR",transport.responseText.replace("ERROR:","")),element.siblings().each(function(el){el.pe&&el.pe.onTimerEvent()})},void conn.sendAsync())}.bind(this));else if("monitor"==type)element=new Element("div",{className:"SF_input SF_inlineMonitoring"}).update("loading..."),element.pe=new PeriodicalExecuter(function(){element.addClassName("SF_inlineMonitoringWorking");var testValues=$H();this.serializeParametersInputs(form,testValues,"DRIVER_OPTION_");var choicesValue=param.get("choices").split(":");testValues.set("get_action",choicesValue.shift()),choicesValue.length>1&&(testValues.set("action_plugin_id",choicesValue.shift()),testValues.set("action_plugin_method",choicesValue.shift())),-1!==name.indexOf("/")&&testValues.set("button_key",getRepName(name)),conn.discrete=!0,conn.setMethod("post"),conn.setParameters(testValues),conn.onComplete=function(transport){element.removeClassName("SF_inlineMonitoringWorking"),element.update(transport.responseText)},conn.sendAsync()}.bind(this),10),element.pe.onTimerEvent();else if("textarea"==type)defaultValue&&(defaultValue=defaultValue.replace(new RegExp("__LBR__","g"),"\n")),element='<textarea class="SF_input" style="height:70px;" data-ajxp_type="'+type+'" data-ajxp_mandatory="'+(mandatory?"true":"false")+'" name="'+name+'"'+disabledString+">"+defaultValue+"</textarea>";else if("password"==type)element='<input type="password" autocomplete="off" data-ajxp_type="'+type+'" data-ajxp_mandatory="'+(mandatory?"true":"false")+'" name="'+name+'" value="'+defaultValue+'"'+disabledString+' class="SF_input">';else if("password-create"==type)element=new Element("input",{type:"text",autocomplete:"off","data-ajxp_type":"password","data-ajxp_mandatory":mandatory?"true":"false",name:name,value:defaultValue,className:"SF_input"});else if("boolean"==type){var selectTrue,selectFalse;void 0!==defaultValue&&(("true"==defaultValue||"1"==defaultValue||defaultValue===!0)&&(selectTrue=!0),("false"==defaultValue||"0"==defaultValue||defaultValue===!1)&&(selectFalse=!0)),selectTrue||selectFalse||(selectFalse=!0),element='<input type="radio" data-ajxp_type="'+type+'" class="SF_box" name="'+name+'" id="'+name+'-true" value="true" '+(selectTrue?"checked":"")+disabledString+'><label for="'+name+'-true">'+MessageHash[440]+"</label>",element=element+'<input type="radio" data-ajxp_type="'+type+'" class="SF_box" name="'+name+'" id="'+name+'-false"  '+(selectFalse?"checked":"")+' value="false"'+disabledString+'><label for="'+name+'-false">'+MessageHash[441]+"</label>",element='<div class="SF_input">'+element+"</div>"}else if("select"==type){var choices,json_list,json_file;if(Object.isString(param.get("choices")))if(param.get("choices").startsWith("json_list:"))choices=["loading|"+MessageHash[466]+"..."],json_list=param.get("choices").split(":")[1];else if(param.get("choices").startsWith("json_file:"))choices=["loading|"+MessageHash[466]+"..."],json_file=param.get("choices").split(":")[1];else if("AJXP_AVAILABLE_LANGUAGES"==param.get("choices")){var object=window.ajxpBootstrap.parameters.get("availableLanguages");choices=[];for(key in object)object.hasOwnProperty(key)&&choices.push(key+"|"+object[key])}else"AJXP_AVAILABLE_REPOSITORIES"==param.get("choices")?(choices=[],ajaxplorer.user&&ProtoCompat.map2hash(ajaxplorer.user.repositories).each(function(pair){choices.push(pair.value.getId()+"|"+pair.value.getLabel())})):choices=param.get("choices").split(",");else choices=param.get("choices");choices||(choices=[]);var multiple=param.get("multiple")?"multiple='true'":"";element='<select class="SF_input" name="'+name+'" data-ajxp_mandatory="'+(mandatory?"true":"false")+'" '+multiple+">",mandatory||multiple||(element+='<option value=""></option>');for(var k=0;k<choices.length;k++){var cLabel,cValue,cSplit=choices[k].split("|");cValue=cSplit[0],cLabel=cSplit.length>1?cSplit[1]:cValue;var selectedString="";param.get("multiple")?$A(defaultValue.split(",")).each(function(defV){defV==cValue&&(selectedString=" selected")}):selectedString=defaultValue==cValue?" selected":"",element+='<option value="'+cValue+'"'+selectedString+">"+cLabel+"</option>"}element+="</select>"}else if("image"==type&&param.get("uploadAction")){if(defaultValue){var imgSrc=conn._baseUrl+"&get_action="+param.get("loadAction")+"&binary_id="+defaultValue;param.get("binary_context")&&(imgSrc+="&"+param.get("binary_context"))}else param.get("defaultImage")&&(imgSrc=param.get("defaultImage"));element="<div class='SF_image_block'><img src='"+imgSrc+"' class='SF_image small'><span class='SF_image_link image_update'>"+(param.get("uploadLegend")?param.get("uploadLegend"):MessageHash[457])+"</span><span class='SF_image_link image_remove'>"+(param.get("removeLegend")?param.get("removeLegend"):MessageHash[458])+"</span><input type='hidden' name='"+param.get("name")+"' data-ajxp_type='binary'><input type='hidden' name='"+param.get("name")+"_original_binary' value='"+defaultValue+"' data-ajxp_type='string'></div>"}else if(0===type.indexOf("group_switch:")){var switchName=type.split(":")[1],switchValues={};defaultValue="",values&&values.get(name)&&(defaultValue=values.get(name));var potentialSubSwitches=$A();parametersDefinitions.each(function(p){"use strict";if(p.get("group_switch_name")){if(p.get("group_switch_name")!=switchName)return p=new Hash(p._object),void potentialSubSwitches.push(p);switchValues[p.get("group_switch_value")]||(switchValues[p.get("group_switch_value")]={label:p.get("group_switch_label"),fields:[],values:$H(),fieldsKeys:{}}),p=new Hash(p._object),p.unset("group_switch_name"),p.set("name",name+"/"+p.get("name"));var vKey=p.get("name");switchValues[p.get("group_switch_value")].fieldsKeys[vKey]||(switchValues[p.get("group_switch_value")].fields.push(p),switchValues[p.get("group_switch_value")].fieldsKeys[vKey]=vKey,values&&values.get(vKey)&&switchValues[p.get("group_switch_value")].values.set(vKey,values.get(vKey)))}});var selector=new Element("select",{className:"SF_input",name:name,"data-ajxp_mandatory":mandatory?"true":"false","data-ajxp_type":type});mandatory||selector.insert(new Element("option")),$H(switchValues).each(function(pair){"use strict";var options={value:pair.key};defaultValue&&defaultValue==pair.key&&(options.selected="true"),selector.insert(new Element("option",options).update(pair.value.label)),potentialSubSwitches.length&&potentialSubSwitches.each(function(sub){pair.value.fields.push(sub)})}),selector.SWITCH_VALUES=$H(switchValues),element=new Element("div").update(selector);var subFields=new Element("div");if(element.insert(subFields),form.ajxpPaneObject&&(subFields.ajxpPaneObject=form.ajxpPaneObject),selector.FIELDS_CONTAINER=subFields,selector.observe("change",function(e){"use strict";var target=e.target;if(target.FIELDS_CONTAINER.update(""),target.getValue()){var data=target.SWITCH_VALUES.get(target.getValue());this.createParametersInputs(target.FIELDS_CONTAINER,data.fields,!0,null,!1,!0),selector.getAttribute("data-disableShortcutsOnForm")&&this.disableShortcutsOnForm(target.FIELDS_CONTAINER)}}.bind(this)),selector.getValue()){var data=selector.SWITCH_VALUES.get(selector.getValue());this.createParametersInputs(selector.FIELDS_CONTAINER,data.fields,!0,values,!1,!0)}}var div;if("legend"!=type){if(div=new Element("div",{className:"SF_element"+(addFieldCheckbox?" SF_elementWithCheckbox":"")}),"hidden"==type&&div.setStyle({display:"none"}),div.insert(new Element("div",{className:"SF_label"}).update("<span>"+label+(mandatory?"*":"")+"</span>")),addFieldCheckbox){var cBox=new Element("input",{type:"checkbox",className:"SF_fieldCheckBox",name:"SFCB_"+name});cBox.checked=defaultValueExists,div.insert(cBox)}div.insert(element)}else div=new Element("div",{className:"dialogLegend"}).update(desc);if("image"==type)div.down("span.SF_image_link.image_update").observe("click",function(){this.createUploadForm(form,div.down("img"),param)}.bind(this)),div.down("span.SF_image_link.image_remove").observe("click",function(){this.confirmExistingImageDelete(form,div.down("img"),div.down('input[name="'+param.get("name")+'"]'),param)}.bind(this));else if("password-create"==type){var button=new Element("span",{className:"icon-refresh ajxpPasswordGenerate"});element.insert({after:button}),div.setStyle({position:"relative"}),button.observe("click",function(){element.setValue(Math.random().toString(36).slice(-10))}),button.setStyle({position:"absolute",right:"19px",top:"12px",fontSize:"14px",cursor:"pointer"});var fObs=function(){var val=element.getValue();val?button.hide():button.show()};element.observe("keyup",fObs),element.observe("blur",fObs)}if(desc&&"legend"!=type){var ttSpan=div.down(".SF_label").down("span");modal.simpleTooltip(ttSpan,'<div class="simple_tooltip_title">'+label+"</div>"+desc,"middle left","right_arrow_tip","element"),ttSpan.writeAttribute("data-tooltipLabel",label),ttSpan.writeAttribute("data-tooltipDescription",desc)}var key,conn=new Connexion;if(json_list)element=div.down("select"),defaultValue&&(element.defaultValue=defaultValue),conn.setParameters({get_action:json_list}),conn.onComplete=function(transport){var json=transport.responseJSON;if(element.down("option").update(json.LEGEND?json.LEGEND:"Select..."),json.HAS_GROUPS){for(key in json.LIST)if(json.LIST.hasOwnProperty(key)){var opt=new Element("OPTGROUP",{label:key});element.insert(opt);for(var index=0;index<json.LIST[key].length;index++)element.insert(new Element("OPTION").update(json.LIST[key][index].action))}}else for(key in json.LIST)if(json.LIST.hasOwnProperty(key)){var option=new Element("OPTION",{value:key}).update(json.LIST[key]);key==defaultValue&&option.setAttribute("selected","true"),element.insert(option)}element.fire("chosen:updated")},conn.sendAsync();else if(json_file){var req=new Connexion(json_file);req.onComplete=function(transport){element=div.down("select"),defaultValue&&(element.defaultValue=defaultValue),element.down('option[value="loading"]').remove(),$A(transport.responseJSON).each(function(entry){var option=new Element("OPTION",{value:entry.key}).update(entry.label);entry.key==defaultValue&&option.setAttribute("selected","true"),element.insert(option)}),element.fire("chosen:updated")},req.sendAsync()}if(param.get("replicationGroup")){var repGroup,repGroupName=param.get("replicationGroup");repGroup=replicableGroups.get(repGroupName)?replicableGroups.get(repGroupName):new Element("div",{id:"replicable_"+repGroupName,className:"SF_replicableGroup"}),repGroup.insert(div),replicableGroups.set(repGroupName,repGroup),div=repGroup}if(skipAccordion)form.insert({bottom:div});else{var gDiv=groupDivs.get(group)||new Element("div",{className:"accordion_content"});b.insert(div);var ref=parseInt(form.getWidth())+(Prototype.Browser.IE?40:0);if(ref>(Prototype.Browser.IE?40:0)){var lab=div.down(".SF_label");if(lab&&"left"==lab.getStyle("float")){var fontSize=lab.getStyle("fontSize");lab.setStyle({fontSize:fontSize}),lab.setStyle({width:parseInt(39*ref/100)+"px"}),parseInt(lab.getHeight())>Math.round(parseFloat(lab.getStyle("lineHeight"))+Math.round(parseFloat(lab.getStyle("paddingTop")))+Math.round(parseFloat(lab.getStyle("paddingBottom"))))&&lab.next().setStyle({marginTop:lab.getStyle("lineHeight")}),lab.setStyle({width:"39%"})}}gDiv.insert(div),groupDivs.set(group,gDiv)}}}}.bind(this)),replicableGroups.size()&&replicableGroups.each(function(pair){var repGroup=pair.value,replicationButton=new Element("a",{className:"SF_replication_Add",title:"Replicate this group"}).update("&nbsp;").observe("click",function(event){this.replicateRow(repGroup,1,form)}.bind(this));if(repGroup.insert({bottom:replicationButton}),repGroup.insert({bottom:new Element("div",{className:"SF_rgClear"})}),values)for(var hasReplicates=!0,replicIndex=1;hasReplicates;){var repInputs=repGroup.select("input,select,textarea");if(!repInputs.length)break;repInputs.each(function(element){var name=element.name;hasReplicates&=null!=values.get(name+"_"+replicIndex)}),hasReplicates&&(this.replicateRow(repGroup,1,form,values),replicIndex++)}}.bind(this)),groupDivs.size()&&(groupDivs.each(function(pair){var title=new Element("div",{className:"accordion_toggle",tabIndex:0}).update(pair.key);title.observe("focus",function(){form.SF_accordion&&form.SF_accordion.showAccordion!=title.next(0)&&form.SF_accordion.activate(title)}),form.insert(title),form.insert(pair.value)}),form.SF_accordion=new accordion(form,{classNames:{toggle:"accordion_toggle",toggleActive:"accordion_toggle_active",content:"accordion_content"},defaultSize:{width:"360px",height:null},direction:"vertical"}),startAccordionClosed||form.SF_accordion.activate(form.down("div.accordion_toggle")),addFieldCheckbox&&form.select("input.SF_fieldCheckBox").each(function(cb){cb.observe("click",function(event){var fElements,cbox=event.target,state=!cbox.checked,fElement=cbox.next("input.SF_input,select.SF_input,div.SF_input");fElements=fElement&&"div"==fElement.nodeName.toLowerCase()?fElement.select("input"):$A([fElement]),fElements.each(function(el){el&&el[state?"disable":"enable"]&&el[state?"disable":"enable"]()}),state?cbox.previous("div.SF_label").addClassName("SF_disabled"):cbox.previous("div.SF_label").removeClassName("SF_disabled")}),cb.checked||(cb.checked=!0,cb.click())}))},createUploadForm:function(modalParent,imgSrc,param){this.modalParent&&(modalParent=this.modalParent);var conn=new Connexion,url=conn._baseUrl+"&get_action="+param.get("uploadAction");param.get("binary_context")&&(url+="&"+param.get("binary_context")),$("formManager_hidden_iframe")||$("hidden_frames").insert(new Element("iframe",{id:"formManager_hidden_iframe",name:"formManager_hidden_iframe"}));var pane=new Element("div");pane.update("<form id='formManager_uploader' enctype='multipart/form-data' target='formManager_hidden_iframe' method='post' action='"+url+"'><div class='dialogLegend'>Select an image on your computer</div> <input type='file' name='userfile' style='width: 270px;'></form>"),modal.showSimpleModal(modalParent,pane,function(){return window.formManagerHiddenIFrameSubmission=function(result){imgSrc.src=conn._baseUrl+"&get_action="+param.get("loadAction")+"&tmp_file="+result.trim(),imgSrc.next("input[type='hidden']").setValue(result.trim()),this.triggerEvent(imgSrc.next("input[type='hidden']"),"change"),imgSrc.next("input[type='hidden']").setAttribute("data-ajxp_type","binary"),window.formManagerHiddenIFrameSubmission=null}.bind(this),pane.down("#formManager_uploader").submit(),!0}.bind(this),function(){return!0}.bind(this))},triggerEvent:function(element,eventName){if(document.createEvent){var evt=document.createEvent("HTMLEvents");return evt.initEvent(eventName,!0,!0),element.dispatchEvent(evt)}return element.fireEvent?element.fireEvent("on"+eventName):void 0},observeFormChanges:function(form,callback,bufferize){var realCallback,randId="timer-"+parseInt(1e3*Math.random());realCallback=bufferize?function(){window[randId]&&window.clearTimeout(window[randId]),window[randId]=window.setTimeout(function(){callback()},bufferize)}:callback,form.select("div.SF_element").each(function(element){element.select("input,textarea,select").invoke("observe","change",realCallback),element.select("input,textarea").invoke("observe","keydown",function(event){event.keyCode!=Event.KEY_DOWN&&event.keyCode!=Event.KEY_UP&&event.keyCode!=Event.KEY_RIGHT&&event.keyCode!=Event.KEY_LEFT&&event.keyCode!=Event.KEY_TAB&&realCallback()})}.bind(this)),form.ajxpPaneObject&&form.ajxpPaneObject.observe("after_replicate_row",function(replicate){replicate.select("div.SF_element").each(function(element){element.select("input,textarea,select").invoke("observe","change",realCallback),element.select("input,textarea").invoke("observe","keydown",function(event){event.keyCode!=Event.KEY_DOWN&&event.keyCode!=Event.KEY_UP&&event.keyCode!=Event.KEY_RIGHT&&event.keyCode!=Event.KEY_LEFT&&event.keyCode!=Event.KEY_TAB&&realCallback()})}.bind(this))})},disableShortcutsOnForm:function(form){form.select("input,textarea,select").invoke("observe","focus",function(event){"select"==event.target.nodeName.toLowerCase()&&event.target.writeAttribute("data-disableShortcutsOnForm","true"),pydio.UI.disableAllKeyBindings()}),form.select("input,textarea,select").invoke("observe","blur",function(){pydio.UI.enableAllKeyBindings()}),form.select(".SF_replicableGroup").invoke("writeAttribute","data-disableShortcutsOnForm","true")},confirmExistingImageDelete:function(modalParent,imgSrc,hiddenInput,param){window.confirm("Do you want to remove the current image?")&&(hiddenInput.setValue("ajxp-remove-original"),imgSrc.src=param.get("defaultImage"),this.triggerEvent(imgSrc.next("input[type='hidden']"),"change"))},serializeParametersInputs:function(form,parametersHash,prefix,skipMandatoryWarning){prefix=prefix||"";var missingMandatory=$A(),checkboxesActive=!1;form.select("input,textarea").each(function(el){"text"==el.type||"hidden"==el.type||"password"==el.type||"textarea"==el.nodeName.toLowerCase()?("true"!=el.getAttribute("data-ajxp_mandatory")||""!=el.value||el.disabled||missingMandatory.push(el),parametersHash.set(prefix+el.name,el.value)):"radio"==el.type&&el.checked&&parametersHash.set(prefix+el.name,el.value),el.getAttribute("data-ajxp_type")&&parametersHash.set(prefix+el.name+"_ajxptype",el.getAttribute("data-ajxp_type")),form.down('[name="SFCB_'+el.name+'"]')&&(checkboxesActive=!0,parametersHash.set(prefix+el.name+"_checkbox",form.down('[name="SFCB_'+el.name+'"]').checked?"checked":"unchecked")),el.up(".SF_replicableGroup")&&parametersHash.set(prefix+el.name+"_replication",el.up(".SF_replicableGroup").id)}),form.select("select").each(function(el){"true"!=el.getAttribute("data-ajxp_mandatory")||""!=el.getValue()||el.disabled||missingMandatory.push(el),el.getAttribute("data-ajxp_type")&&parametersHash.set(prefix+el.name+"_ajxptype",el.getAttribute("data-ajxp_type")),parametersHash.set(prefix+el.name,el.getValue()),form.down('[name="SFCB_'+el.name+'"]')&&(checkboxesActive=!0,parametersHash.set(prefix+el.name+"_checkbox",form.down('[name="SFCB_'+el.name+'"]').checked?"checked":"unchecked")),el.up(".SF_replicableGroup")&&parametersHash.set(prefix+el.name+"_replication",el.up(".SF_replicableGroup").id)}),checkboxesActive&&parametersHash.set("sf_checkboxes_active","true"),skipMandatoryWarning||missingMandatory.each(function(el){el.addClassName("SF_failed"),form.SF_accordion&&el.up("div.accordion_content").previous("div.accordion_toggle")&&el.up("div.accordion_content").previous("div.accordion_toggle").addClassName("accordion_toggle_failed")});var allKeys=parametersHash.keys();allKeys.sort(),allKeys.reverse();var treeKeys={};return allKeys.each(function(key){if(-1!==key.indexOf("/")&&!key.endsWith("_ajxptype")){for(var parentKey,typeKey=key+"_ajxptype",parts=key.split("/"),parentName=parts.shift();parts.length>0;)parentKey||(parentKey=treeKeys),parentKey[parentName]||(parentKey[parentName]={}),
parentKey=parentKey[parentName],parentName=parts.shift();var type=parametersHash.unset(typeKey);if(parentKey&&!parentKey[parentName])if("boolean"==type){var v=parametersHash.get(key);parentKey[parentName]="true"==v||1==v||v===!0}else"integer"==type?parentKey[parentName]=parseInt(parametersHash.get(key)):parentKey[parentName]=parametersHash.get(key);else parentKey&&type.startsWith("group_switch:")&&(parentKey[parentName].group_switch_value=parametersHash.get(key));parametersHash.unset(key)}}),$H(treeKeys).each(function(pair){parametersHash.get(pair.key+"_ajxptype")&&parametersHash.get(pair.key+"_ajxptype").startsWith("group_switch:")&&!pair.value.group_switch_value&&(pair.value.group_switch_value=parametersHash.get(pair.key)),parametersHash.set(pair.key,Object.toJSON(pair.value)),parametersHash.set(pair.key+"_ajxptype","text/json")}),missingMandatory.size()},replicateRow:function(templateRow,number,form,values){form.ajxpPaneObject&&form.ajxpPaneObject.notify("before_replicate_row",templateRow);var repIndex=templateRow.getAttribute("data-ajxp-replication-index");repIndex=null===repIndex?0:parseInt(repIndex);for(var index=0;number>index;index++){repIndex++,templateRow.setAttribute("data-ajxp-replication-index",repIndex);var tr=$(templateRow.cloneNode(!0));tr.id&&(tr.id=tr.id+"_"+repIndex);var inputs=tr.select("input","select","textarea");inputs.each(function(input){var newName=input.getAttribute("name")+"_"+repIndex;input.writeAttribute("data-originalName",input.getAttribute("name")),input.setAttribute("name",newName),form&&Prototype.Browser.IE&&(form[newName]=input),input.setValue(values&&values.get(newName)?values.get(newName):"")}),templateRow.insert({after:tr}),tr.select(".SF_replication_Add").length&&tr.select(".SF_replication_Add").invoke("remove"),index==number-1&&templateRow.select(".SF_replication_Add").length&&tr.insert(templateRow.select(".SF_replication_Add")[0]),tr.select(".simple_tooltip_observer[data-toolTipLabel]").each(function(sT){var label=sT.readAttribute("data-tooltipLabel"),desc=sT.readAttribute("data-tooltipDescription");modal.simpleTooltip(sT,'<div class="simple_tooltip_title">'+label+"</div>"+desc,"middle left","right_arrow_tip","element")});var removeButton=new Element("a",{className:"SF_replication_Remove",title:"Remove this group"}).update("&nbsp;").observe("click",function(){tr.select(".SF_replication_Add").length&&tr.previous(".SF_replicableGroup").insert(tr.select(".SF_replication_Add")[0]),tr.remove()});tr.insert(removeButton)}tr.readAttribute("data-disableShortcutsOnForm")&&this.disableShortcutsOnForm(tr),form.ajxpPaneObject&&form.ajxpPaneObject.notify("after_replicate_row",tr)},fetchValueToForm:function(form,fields,value,suffix){$A(fields).each(function(fieldName){if(value[fieldName]){var realFieldName;realFieldName=null!=suffix?fieldName+"_"+suffix:fieldName;var element=form[realFieldName];if(element){var nodeName=element.nodeName.toLowerCase();switch(nodeName){case"input":"checkbox"==element.getAttribute("type")?element.value==value[fieldName]&&(element.checked=!0):element.value=value[fieldName];break;case"select":element.select("option").each(function(option){option.value==value[fieldName]&&(option.selected=!0)});break;case"textarea":element.update(value[fieldName]),element.value=value[fieldName]}}}})},fetchMultipleValueToForm:function(form,fields,values){var index=0;$A(values).each(function(value){this.fetchValueToForm(form,fields,value,index),index++}.bind(this))},destroyForm:function(form){form.select("div.SF_inlineMonitoring").each(function(el){el.pe&&el.pe.stop()})}}),Class.create("DataModelProperty",{__implements:["IAjxpWidget"],initialize:function(element,options){this.element=element,this.element.ajxpPaneObject=this,options=Object.extend({dmID:"ajaxplorer-global"},options);var dm;"ajaxplorer-global"==options.dmID?dm=ajaxplorer.getContextHolder():$(options.dmID)&&$(options.dmID).ajxpPaneObject&&$(options.dmID).ajxpPaneObject.getDataModel&&(dm=$(options.dmID).ajxpPaneObject.getDataModel()),dm&&(this.observer=function(){switch(options.property){case"root_children":var l=ProtoCompat.map2values(dm.getRootNode().getChildren()).length;element.update(l?l:"");break;case"root_label":element.update(dm.getRootNode().getLabel());break;case"metadata":if(options.metadata_sum){var sum=0;ProtoCompat.map2values(dm.getRootNode().getChildren()).each(function(c){c.getMetadata().get(options.metadata_sum)&&(sum+=parseInt(c.getMetadata().get(options.metadata_sum)))}),element.update(sum?sum:"")}}}.bind(this),dm.getRootNode().observe("loaded",this.observer),this.dm=dm)},resize:function(){},showElement:function(show){},getDomNode:function(){},destroy:function(){this.dm&&this.dm.getRootNode()&&this.dm.getRootNode().stopObserving(this.observer);try{pydio.UI.removeInstanceFromCache(this.element.id)}catch(e){}this.element=null}}),Class.create("MultiDownloader",{initialize:function(list_target,downloadUrl){this.list_target=list_target,this.count=0,this.id=0,this.downloadUrl=downloadUrl},setDownloadUrl:function(downloadUrl){this.downloadUrl=downloadUrl},addListRow:function(fileName,label){this.count++;var new_row=new Element("div"),new_row_button=new Element("a");new_row_button.href=this.downloadUrl+fileName,new_row_button.insert('<img src="'+ajxpResourcesFolder+'/images/actions/16/download_manager.png" height="16" width="16" align="absmiddle" border="0"> '+(label?label:getBaseName(fileName))),new_row_button.multidownloader=this,new_row_button.onclick=function(){this.parentNode.parentNode.removeChild(this.parentNode),this.multidownloader.count--,0==this.multidownloader.count&&this.multidownloader.triggerEnd&&this.multidownloader.triggerEnd(),gaTrackEvent("Data","Download",fileName)},new_row.insert(new_row_button),$(this.list_target).insert(new_row)},emptyList:function(){},setOnLoad:function(){if(!this.loading){addLightboxMarkupToElement(this.list_target);var img=new Element("img",{src:ajxpResourcesFolder+"/images/loadingImage.gif"}),overlay=$(this.list_target).down("#element_overlay");overlay.insert(img),img.setStyle({marginTop:Math.max(0,(overlay.getHeight()-img.getHeight())/2)}),this.loading=!0}},removeOnLoad:function(){removeLightboxFromElement(this.list_target),this.loading=!1}}),Class.create("ActivityMonitor",{_serverSessionTime:0,_warningTime:0,_logoutTime:0,_warningMinutes:3,_renewMinutes:10,_logoutMinutes:0,_lastActive:0,_state:"active",_longTaskRunning:!1,initialize:function(serverSessionTime,clientSessionTime,warningMinutes){if(serverSessionTime){if(serverSessionTime<=60*this._renewMinutes&&(this._renewMinutes=2),-1==clientSessionTime)return this._renewTime=serverSessionTime-60*this._renewMinutes,void(this.serverInterval=window.setInterval(this.serverObserver.bind(this),Math.min(Math.pow(2,31)-1,1e3*this._renewTime)));this._serverSessionTime=serverSessionTime,warningMinutes?(this._warningMinutes=warningMinutes,this._warningTime=clientSessionTime-60*this._warningMinutes):this._warningTime=!1,this._logoutTime=clientSessionTime-60*this._logoutMinutes,this._renewTime=serverSessionTime-60*this._renewMinutes,this._lastActive=this.getNow();var activityObserver=this.activityObserver.bind(this);document.observe("ajaxplorer:user_logged",function(){this._lastActive=this.getNow(),this.interval&&window.clearInterval(this.interval),this.serverInterval&&window.clearInterval(this.serverInterval),$(document.body).stopObserving("keypress",activityObserver),$(document.body).stopObserving("mouseover",activityObserver),$(document.body).stopObserving("mousemove",activityObserver),document.stopObserving("ajaxplorer:server_answer",activityObserver),this._state="inactive",ajaxplorer.user&&(this._state="active",$(document.body).observe("keypress",activityObserver),$(document.body).observe("mouseover",activityObserver),$(document.body).observe("mousemove",activityObserver),document.observe("ajaxplorer:server_answer",activityObserver),this.interval=window.setInterval(this.idleObserver.bind(this),5e3),this.serverInterval=window.setInterval(this.serverObserver.bind(this),Math.min(Math.pow(2,31)-1,1e3*this._renewTime)))}.bind(this)),document.observe("ajaxplorer:longtask_starting",function(){this._longTaskRunning=!0}.bind(this)),document.observe("ajaxplorer:longtask_finished",function(){this._longTaskRunning=!1}.bind(this))}},activityObserver:function(event){event&&event.memo&&event.memo.discrete||"warning"!=this._state&&(this.timer&&window.clearTimeout(this.timer),this.timer=window.setTimeout(this.activityUpdater.bind(this),1e3))},activityUpdater:function(){this._lastActive=this.getNow()},serverObserver:function(){new Ajax.Request(window.ajxpServerAccessPath,{method:"get",parameters:{get_action:"ping"}})},idleObserver:function(){if("inactive"!=this._state){if(this._longTaskRunning)return void this.activityUpdater();var idleTime=this.getNow()-this._lastActive;return idleTime>=this._logoutTime?(this.removeWarningState(),this._state="active",this.interval&&window.clearInterval(this.interval),this.serverInterval&&window.clearInterval(this.serverInterval),void window.setTimeout(function(){pydio.getController().fireDefaultAction("expire")},1e3)):void(this._warningTime&&idleTime>=this._warningTime&&("active"==this._state&&this.setWarningState(),this.updateWarningTimer(this._logoutTime-idleTime)))}},exitIdleState:function(){this.removeWarningState(),this.activityUpdater(),this._state="active",window.clearInterval(this.interval),this.interval=window.setInterval(this.idleObserver.bind(this),5e3)},setWarningState:function(){if(this._state="warning",window.clearInterval(this.interval),this.interval=window.setInterval(this.idleObserver.bind(this),1e3),!this.warningPane){var mess=MessageHash[375].replace("__IDLE__",Math.round(this._warningTime/60)+"mn");mess=mess.replace("__LOGOUT__",'<span class="warning_timer"></span>'),this.warningPane=new Element("div",{id:"activity_monitor_warning",className:"dialogBox",style:"padding:3px"}).update('<div class="dialogContent">'+mess+'<br><span class="click_anywhere">'+MessageHash[376]+"</span></div>"),$(document.body).insert(this.warningPane),displayLightBoxById("activity_monitor_warning"),$("overlay").setStyle({cursor:"pointer"}),$("overlay").observeOnce("click",this.exitIdleState.bind(this)),$("activity_monitor_warning").observeOnce("click",this.exitIdleState.bind(this)),new Effect.Shake(this.warningPane)}},updateWarningTimer:function(time){var stringTime=Math.floor(time/60)+"mn"+time%60+"s";this.warningPane.down("span.warning_timer").update(stringTime),this.warningPane.visible()&&time%60%10==0&&new Effect.Shake(this.warningPane.down("div.dialogContent"))},removeWarningState:function(){this.opaFx&&this.opaFx.cancel(),$("overlay").setStyle({cursor:"default",opacity:.4}),hideLightBox()},getNow:function(){return Math.round((new Date).getTime()/1e3)}}),Class.create("PydioUI",{__ajxpClassRegexp:new RegExp(/ajxpClass="([0-9a-zA-Z]+)"/g),initialize:function(pydioObject){this._pydio=pydioObject,this._guiCompRegistry=$A(),this._guiComponentsConfigs=$H(),this._focusables=[],this.blockShortcuts=!1,this.blockNavigation=!1,this.blockEditorShortcuts=!1,this._editorOpener=null,this._messageBoxReference=null,this._instancesCache=$H(),this.modal=window.modal},removeInstanceFromCache:function(instanceId){this._instancesCache.unset(instanceId)},registerEditorOpener:function(ajxpWidget){this._editorOpener=ajxpWidget,this._editorObserver=function(tabId){var tabData=ajxpWidget.tabulatorData.detect(function(tabInfo){return tabInfo.id==tabId});tabData&&tabData.ajxpNode&&this._pydio.getContextHolder().setSelectedNodes([tabData.ajxpNode])}.bind(this),ajxpWidget.observe("switch",this._editorObserver)},unregisterEditorOpener:function(ajxpWidget){this._editorOpener==ajxpWidget&&(this._editorOpener.stopObserving("switch",this._editorObserver),this._editorOpener=null)},getEditorOpener:function(){return this._editorOpener},openCurrentSelectionInEditor:function(editorData,forceNode){var selectedNode=forceNode?forceNode:this._pydio.getContextHolder().getUniqueNode();if(selectedNode){if(!editorData){var selectedMime=getAjxpMimeType(selectedNode),editors=this._pydio.Registry.findEditorsForMime(selectedMime,!1);editors.length&&editors[0].openable&&(editorData=editors[0])}if(editorData){this._pydio.Registry.loadEditorResources(editorData.resourcesManager);var editorOpener=this.getEditorOpener();!editorOpener||editorData.modalOnly?modal.openEditorDialog(editorData):editorOpener.openEditorForNode(selectedNode,editorData)}else this._pydio.Controller.getActionByName("download")&&this._pydio.Controller.getActionByName("download").apply()}},registerAsMessageBoxReference:function(element){this._messageBoxReference=element},clearMessageBoxReference:function(){this._messageBoxReference=null},getMessageBoxReference:function(){return $(this._messageBoxReference)},insertForm:function(formId,formCode){$("all_forms").down("#"+formId)||$("all_forms").insert(formCode)},removeForm:function(formId){var existing=$("all_forms").down("#"+formId);existing&&existing.remove()},initObjects:function(){this.contextMenu=new Proto.Menu({selector:"",className:"menu desktop",menuItems:[],fade:!1,zIndex:2e3});var protoMenu=this.contextMenu,pydioObject=this._pydio;protoMenu.options.beforeShow=function(e){this.options.lastElement=Event.element(e),this.options.menuItems=pydioObject.getController().getContextActions(Event.element(e),["inline"]),this.refreshList()}.bind(protoMenu),protoMenu.options.beforeHide=function(e){this.options.lastElement=null}.bind(protoMenu),document.observe("ajaxplorer:actions_refreshed",function(){this.options.lastElement&&(this.options.menuItems=pydioObject.getController().getContextActions(this.options.lastElement,["inline"]),this.refreshList())}.bind(protoMenu)),pydioObject.getXmlRegistry()&&pydioObject.Controller.loadActionsFromRegistry(pydioObject.getXmlRegistry()),pydioObject.observe("registry_loaded",function(event){Prototype.Browser.IE&&ResourcesManager.loadAutoLoadResources(event.memo),pydioObject.Controller.loadActionsFromRegistry(event.memo)}.bind(this)),document.observe("ajaxplorer:context_changed",function(event){var path=this.getContextNode().getPath(),appTitle=pydioObject.Parameters.get("customWording").title||"Pydio";document.title=appTitle+" - "+(getBaseName(path)?getBaseName(path):"/")}.bind(pydioObject)),modal.updateLoadingProgress("Actions Initialized"),this.activityMonitor=new ActivityMonitor(window.ajxpBootstrap.parameters.get("session_timeout"),window.ajxpBootstrap.parameters.get("client_timeout"),window.ajxpBootstrap.parameters.get("client_timeout_warning")),this.guiLoaded=!1;var mainElement=$(ajxpBootstrap.parameters.get("MAIN_ELEMENT")),classNames=$H();mainElement.select("[ajxpClass]").each(function(el){classNames.set(el.readAttribute("ajxpClass"),!0)}),classNames=classNames.keys(),ResourcesManager.loadClassesAndApply(classNames,function(){this.buildGUI(mainElement),document.fire("ajaxplorer:before_gui_load"),this._guiCompRegistry&&this.initAjxpWidgets(this._guiCompRegistry),this.guiLoaded=!0,document.fire("ajaxplorer:gui_loaded"),document.observe("ajaxplorer:repository_list_refreshed",function(e){mainElement.classNames().findAll(function(c){return c.startsWith("ajxp_ws-")}).each(function(cName){mainElement.removeClassName(cName)}),e.memo.active&&e.memo.list&&mainElement.addClassName("ajxp_ws-"+e.memo.list.get(e.memo.active).getSlug())}),modal.updateLoadingProgress("GUI Initialized"),this.initTabNavigation(),this.blockShortcuts=!1,this.blockNavigation=!1,this.bgManagerPane=new BackgroundManagerPane,modal.updateLoadingProgress("Navigation loaded")}.bind(this))},initAjxpWidgets:function(compRegistry){var lastInst;if(compRegistry.length){for(var i=compRegistry.length;i>0;i--){var el=compRegistry[i-1],ajxpId=el.ajxpId;compRegistry[i-1]=new el.ajxpClass(el.ajxpNode,el.ajxpOptions),this._instancesCache.set(ajxpId,compRegistry[i-1]),lastInst=compRegistry[i-1]}lastInst&&lastInst.resize();for(var j=0;j<compRegistry.length;j++){var obj=compRegistry[j];Class.objectImplements(obj,"IFocusable")&&(obj.setFocusBehaviour(),this.registerFocusable(obj)),Class.objectImplements(obj,"IContextMenuable")&&obj.setContextualMenu(this.contextMenu),Class.objectImplements(obj,"IActionProvider")&&this._pydio.Controller.updateGuiActions(ProtoCompat.hash2map(obj.getActions()))}}},buildGUI:function(domNode,compRegistry){if(1==domNode.nodeType){this._guiCompRegistry||(this._guiCompRegistry=$A([])),compRegistry||(compRegistry=this._guiCompRegistry),domNode=$(domNode);var ajxpClassName=domNode.readAttribute("ajxpClass")||"",ajxpClass=Class.getByName(ajxpClassName),ajxpId=domNode.readAttribute("id")||"",ajxpOptions={};if(domNode.readAttribute("ajxpOptions"))try{ajxpOptions=domNode.readAttribute("ajxpOptions").evalJSON()}catch(e){alert("Error while parsing JSON for GUI template part "+ajxpId+"!")}ajxpClass&&ajxpId&&Class.objectImplements(ajxpClass,"IAjxpWidget")&&compRegistry.push({ajxpId:ajxpId,ajxpNode:domNode,ajxpClass:ajxpClass,ajxpOptions:ajxpOptions}),$A(domNode.childNodes).each(function(node){this.buildGUI(node,compRegistry)}.bind(this))}},findAjxpClassesInText:function(cdataContent){for(var match=this.__ajxpClassRegexp.exec(cdataContent),requiredClasses=$H();null!=match;)requiredClasses.set(match[1],!0),match=this.__ajxpClassRegexp.exec(cdataContent);return requiredClasses},refreshTemplateParts:function(){var parts=XPathSelectNodes(this._pydio.getXmlRegistry(),"client_configs/template_part"),toUpdate={},restoreUpdate={},requiredClasses=$H(),requiredComponents=$H();this.templatePartsToRestore||(this.templatePartsToRestore=$A());for(var i=0;i<parts.length;i++)if(!parts[i].getAttribute("theme")||parts[i].getAttribute("theme")==ajxpBootstrap.parameters.get("theme")){var ajxpId=parts[i].getAttribute("ajxpId"),ajxpClassName=parts[i].getAttribute("ajxpClass"),ajxpOptionsString=parts[i].getAttribute("ajxpOptions");parts[i].getAttribute("components")&&parts[i].getAttribute("components").split(",").forEach(function(v){requiredComponents.set(v,!0)});var cdataContent="";parts[i].firstChild&&4==parts[i].firstChild.nodeType&&""!=parts[i].firstChild.nodeValue&&(cdataContent=parts[i].firstChild.nodeValue),ajxpId&&(toUpdate[ajxpId]=[ajxpClassName,ajxpOptionsString,cdataContent],requiredClasses=requiredClasses.merge(this.findAjxpClassesInText(cdataContent)))}this.templatePartsToRestore.each(function(key){var part=this.findOriginalTemplatePart(key);if(part){var ajxpClassName=part.getAttribute("ajxpClass"),ajxpOptionsString=part.getAttribute("ajxpOptions"),cdataContent=part.innerHTML;restoreUpdate[key]=[ajxpClassName,ajxpOptionsString,cdataContent]}}.bind(this));var callback=function(){var futurePartsToRestore=$A();for(var id in restoreUpdate)this.refreshGuiComponent(id,restoreUpdate[id][0],restoreUpdate[id][1],restoreUpdate[id][2]);for(id in toUpdate){var ajxpClass=Class.getByName(toUpdate[id][0]);ajxpClass&&Class.objectImplements(ajxpClass,"IAjxpWidget")&&(this.refreshGuiComponent(id,toUpdate[id][0],toUpdate[id][1],toUpdate[id][2]),futurePartsToRestore.push(id))}this.templatePartsToRestore=futurePartsToRestore,this.refreshGuiComponentConfigs()}.bind(this);requiredComponents.keys().size()?ResourcesManager.loadWebComponentsAndApply(requiredComponents.keys(),callback):ResourcesManager.loadClassesAndApply(requiredClasses.keys(),callback)},refreshGuiComponent:function(ajxpId,ajxpClassName,ajxpOptionsString,cdataContent){if(this._instancesCache.get(ajxpId)){var oldObj=this._instancesCache.get(ajxpId);if(!oldObj.__className){if(!$(ajxpId))return;oldObj=$(ajxpId).ajxpPaneObject}if(!oldObj)return void alert("Cannot find GUI component "+ajxpId+" to be refreshed!");if(oldObj.__className!=ajxpClassName||oldObj.__ajxpOptionsString!=ajxpOptionsString){var ajxpOptions={};if(ajxpOptionsString&&(ajxpOptions=ajxpOptionsString.evalJSON()),oldObj.htmlElement)var anchor=oldObj.htmlElement;if(oldObj.destroy(),cdataContent&&anchor){anchor.insert(cdataContent);var compReg=$A();$A(anchor.children).each(function(el){this.buildGUI(el,compReg)}.bind(this)),compReg.length&&this.initAjxpWidgets(compReg)}var ajxpClass=Class.getByName(ajxpClassName),obj=new ajxpClass($(ajxpId),ajxpOptions);Class.objectImplements(obj,"IFocusable")&&(obj.setFocusBehaviour(),this._pydio.registerFocusable(obj)),Class.objectImplements(obj,"IContextMenuable")&&obj.setContextualMenu(this.contextMenu),Class.objectImplements(obj,"IActionProvider")&&this._pydio.Controller.updateGuiActions(obj.getActions()),$(ajxpId).up("[ajxpClass]")&&$(ajxpId).up("[ajxpClass]").ajxpPaneObject&&$(ajxpId).up("[ajxpClass]").ajxpPaneObject.scanChildrenPanes&&$(ajxpId).up("[ajxpClass]").ajxpPaneObject.scanChildrenPanes($(ajxpId).up("[ajxpClass]").ajxpPaneObject.htmlElement,!0),obj.__ajxpOptionsString=ajxpOptionsString,this._instancesCache.unset(oldObj),this._instancesCache.set(ajxpId,obj),obj.resize()}}},refreshGuiComponentConfigs:function(){this._guiComponentsConfigs=$H();var nodes=XPathSelectNodes(this._pydio.getXmlRegistry(),"client_configs/component_config");if(nodes.length){for(var i=0;i<nodes.length;i++)try{this.setGuiComponentConfig(nodes[i])}catch(e){window.console&&console.error("Error while setting ComponentConfig",e)}var element=$(window.ajxpBootstrap.parameters.get("MAIN_ELEMENT"));element&&element.ajxpPaneObject&&element.ajxpPaneObject.resize&&window.setTimeout(function(){element.ajxpPaneObject.resize()},500)}},setGuiComponentConfig:function(domNode){var className=domNode.getAttribute("className"),classId=domNode.getAttribute("classId")||null,classConfig=new Hash;classId?classConfig.set(classId,domNode):classConfig.set("all",domNode);var cumul=this._guiComponentsConfigs.get(className);cumul||(cumul=$A()),cumul.push(classConfig),this._guiComponentsConfigs.set(className,cumul),document.fire("ajaxplorer:component_config_changed",{className:className,classConfig:classConfig})},getGuiComponentConfigs:function(className){return this._guiComponentsConfigs.get(className)},initTemplates:function(passedTarget,mainElementName){if(this._pydio.getXmlRegistry()){for(var tNodes=XPathSelectNodes(this._pydio.getXmlRegistry(),"client_configs/template"),i=0;i<tNodes.length;i++){var target=tNodes[i].getAttribute("element"),themeSpecific=tNodes[i].getAttribute("theme");if(!(themeSpecific&&window.ajxpBootstrap.parameters.get("theme")&&window.ajxpBootstrap.parameters.get("theme")!=themeSpecific||mainElementName&&target!=mainElementName||!($(target)||$$(target).length||passedTarget))){target=$(target)?$(target):$$(target)[0],passedTarget&&(target=passedTarget);var position=tNodes[i].getAttribute("position"),obj={};obj[position]=tNodes[i].firstChild.nodeValue,target.insert(obj),obj[position].evalScripts()}}modal.updateLoadingProgress("Html templates loaded")}},findOriginalTemplatePart:function(ajxpId){var tmpElement=new Element("div",{style:"display:none;"});$$("body")[0].insert(tmpElement),this.initTemplates(tmpElement,window.ajxpBootstrap.parameters.get("MAIN_ELEMENT"));var tPart=tmpElement.down('[id="'+ajxpId+'"]');return tPart&&(tPart=tPart.clone(!0)),tmpElement.remove(),tPart},getRegisteredComponentsByClassName:function(className){return this._guiCompRegistry.select(function(guiComponent){return guiComponent.__className==className})},updateI18nTags:function(){var messageTags=$$("[ajxp_message_id]");messageTags.each(function(tag){var messageId=tag.getAttribute("ajxp_message_id");try{tag.update(MessageHash[messageId])}catch(e){}})},loadSeedOrCaptcha:function(seedInputField,existingCaptcha,captchaAnchor,captchaPosition){var connexion=new Connexion;connexion.addParameter("get_action","get_seed"),connexion.onComplete=function(transport){if(transport.responseJSON){seedInputField.value=transport.responseJSON.seed;var src=window.ajxpServerAccessPath+"&get_action=get_captcha&sid="+Math.random(),refreshSrc=ajxpResourcesFolder+"/images/actions/16/reload.png";if(existingCaptcha)existingCaptcha.src=src;else{var insert={},string='<div class="main_captcha_div" style="padding-top: 4px;"><div class="dialogLegend" ajxp_message_id="389">'+MessageHash[389]+"</div>";string+='<div class="captcha_container"><img id="captcha_image" align="top" src="'+src+'" width="170" height="80"><img align="top" style="cursor:pointer;" id="captcha_refresh" src="'+refreshSrc+'" with="16" height="16"></div>',string+='<div class="SF_element">',string+='		<div class="SF_label" ajxp_message_id="390">'+MessageHash[390]+'</div> <div class="SF_input"><input type="text" class="dialogFocus dialogEnterKey" style="width: 100px; padding: 0px;" name="captcha_code"></div>',string+="</div>",string+='<div style="clear:left;margin-bottom:7px;"></div></div>',insert[captchaPosition]=string,captchaAnchor.insert(insert),modal.refreshDialogPosition(),modal.refreshDialogAppearance(),$("captcha_refresh").observe("click",function(){$("captcha_image").src=window.ajxpServerAccessPath+"&get_action=get_captcha&sid="+Math.random()})}}else seedInputField.value=transport.responseText,existingCaptcha&&(existingCaptcha.up(".main_captcha_div").remove(),modal.refreshDialogPosition(),modal.refreshDialogAppearance())},connexion.sendSync()},focusOn:function(object){this._focusables&&-1!=this._focusables.indexOf(object)&&(this._focusables.each(function(obj){obj!=object&&obj.blur()}),object.focus())},blurAll:function(){this._focusables.each(function(f){f.hasFocus&&(this._lastFocused=f),f.blur()}.bind(this))},registerFocusable:function(widget){-1==this._focusables.indexOf(widget)&&widget.htmlElement&&this._focusables.push(widget)},unregisterFocusable:function(widget){this._focusables=this._focusables.without(widget)},focusLast:function(){this._lastFocused&&this.focusOn(this._lastFocused)},initTabNavigation:function(){Event.observe(document,"keydown",function(e){if(e.keyCode==Event.KEY_TAB){if(this.blockNavigation)return;var objects=[];$A(this._focusables).each(function(el){el.htmlElement&&el.htmlElement.visible()&&objects.push(el)});for(var shiftKey=e.shiftKey,foundFocus=!1,i=0;i<objects.length;i++)if(objects[i].hasFocus){objects[i].blur();var nextIndex;nextIndex=shiftKey?i>0?i-1:objects.length-1:i<objects.length-1?i+1:0,objects[nextIndex].focus(),foundFocus=!0;break}!foundFocus&&objects[0]&&this.focusOn(objects[0]),Event.stop(e)}this.blockShortcuts||e.ctrlKey||e.metaKey||e.keyCode!=Event.KEY_DELETE&&(e.keyCode>90||e.keyCode<65)||this._pydio.Controller.fireActionByKey(e,e.keyCode==Event.KEY_DELETE?"key_delete":String.fromCharCode(e.keyCode).toLowerCase())}.bind(this))},disableShortcuts:function(){this.blockShortcuts=!0},enableShortcuts:function(){this.blockShortcuts=!1},disableNavigation:function(){this.blockNavigation=!0},enableNavigation:function(){this.blockNavigation=!1},disableAllKeyBindings:function(){this.blockNavigation=this.blockShortcuts=this.blockEditorShortcuts=!0},enableAllKeyBindings:function(){this.blockNavigation=this.blockShortcuts=this.blockEditorShortcuts=!1}});